{template 'web/common/header'}<div class="wrapper wrapper-content animated fadeInRight"  style="margin-top: 0px; padding-top: 0px;">    <div class="row">        <div class="col-sm-12">            <div class="ibox float-e-margins" style="margin-bottom: 0px;">                <div class="ibox-title" style="margin-top: 0px;padding-top: 5px;">                    <h5><button type="button" id="btn_addGoodsPackage" class="btn btn-w-m btn-danger" ><i class="fa fa-plus-square-o"></i> 新增商品套餐</button></h5>                </div>            </div>        </div>            <div class="col-sm-5">                <div class="ibox-content" style="margin-top: 0px;margin-bottom: 0px;padding-top: 0px;padding-bottom: 0px;">                    <div class="panel-body" id="searchpackagetoolbar"  style="margin-top: 0px;margin-bottom: 0px;padding-top: 0px;padding-bottom: 0px;">                        <form  class="form-horizontal" role="form" id="search_goodsPackage" style="margin-top: 0px;margin-bottom: 0px;padding-top: 0px;padding-bottom: 0px;">                            <input type="hidden" name="c" value="site" />                            <input type="hidden" name="a" value="entry" />                            <input type="hidden" name="m" value="{php echo $this->module['name']}" />                            <input type="hidden" name="do" value="goodspackage" />                            <input type="hidden" name="op" value="goodspackagelist" />                            <input type="hidden" name="storeid" value="{$storeid}" />                            <div class="form-group"  style="margin-top: 0px;margin-bottom: 0px;padding-top: 0px;padding-bottom: 0px;">                                <label class="col-sm-1 control-label" style="padding-top: 0px;width: 10%">套餐名称</label>                                <div class="col-sm-1" style="width: 35%">                                    <input class="form-control" name="search_packageKeyword" id="search_packageKeyword" type="text" value="{$_GPC['search_packageKeyword']}">                                </div>                                <label class="col-sm-1 control-label"  style="padding-top: 0px;width: 10%">套餐分类</label>                                <div class="col-sm-1"  style="width: 30%">                                    <div class="input-group" style="width: 100%">                                        <select data-placeholder="请选择套餐类别(可搜索名称)"  class="chosen-select" name="goodsPackageType_id" id="goodsPackageType_id"  style="width: 100%" tabindex="4">                                            {if in_array('0', $thisgoodstypelist) }                                            <option value="0"   hassubinfo="true" selected>选择套餐分类</option>                                            {else}                                            <option value="0"   hassubinfo="true">选择套餐分类</option>                                            {/if}                                            {loop $goodstypelist $index $goodstypeitem}                                            <option value="{$goodstypeitem['id']}"   hassubinfo="true"  {if in_array($goodstypeitem['id'], $thisgoodstypelist)}selected{/if}>{$goodstypeitem['gt_name']}</option>                                            {/loop}                                        </select>                                    </div>                                </div>                                <div class="col-sm-1"  style="width: 10%">                                    <button class="btn btn-outline btn-primary" type="button" onclick="btnSerachGoodsPackage()" id="btn_searchpackagesubmit"><i class="fa fa-search"></i> 搜索</button>                                </div>                            </div>                        </form>                    </div>                    <table id="goodspackagetabledata" data-mobile-responsive="true"></table>                </div>            </div>            <div class="col-sm-7"  style="margin-top: 0px;margin-bottom: 0px;padding-top: 0px;padding-bottom: 0px;">                <form action="{php echo $this->createWebUrl('goodspackage', array('op' => 'add','id' => $item['id']))}" id="goodspackagelimit" class="form-horizontal" method="post" enctype="multipart/form-data" onsubmit="return check(this);"  style="margin-top: 0px;margin-bottom: 0px;padding-top: 0px;padding-bottom: 0px;">                    <input type="hidden" name="id" id="hiddenpackageid" value="{$item['id']}">                    <div class="panel-group" id="accordion" style="margin-top: 0px;margin-bottom: 0px;padding-top: 0px;padding-bottom: 0px;">                    <div class="panel panel-primary"  style="margin-top: 5px;margin-bottom: 0px;padding-top: 0px;padding-bottom: 0px;">                        <div class="panel-heading">                            <h5 class="panel-title"><a style="color:#FFF;display:block;" data-toggle="collapse" data-parent="#accordion" href="#collapseOne"><i class="fa fa-hand-pointer-o"></i> 套餐基本信息</a></h5>                        </div>                        <div id="collapseOne" class="panel-collapse collapse in">                            <div class="panel-body">                                <div class="row">                                    <label class="col-sm-1 control-label" style="margin: 0px; width: 7%">套餐名称</label>                                    <div class="col-sm-3" style="width: 27%">                                        <input class="form-control" name="packageName" id="packageName" type="text" value="{$item['goo_name']}">                                    </div>                                    <label class="col-sm-1 control-label" style="margin: 0px; width: 7%">套餐编码</label>                                    <div class="col-sm-3" style="width: 26%">                                        <input class="form-control" name="packageBarcode" id="packageBarcode" type="text" value="{$item['goo_code']}">                                    </div>                                    <label class="col-sm-1 control-label" style="margin: 0px; width: 7%">套餐类别</label>                                    <div class="col-sm-3" style="width: 26%">                                        <div class="input-group" style="width: 100%">                                            {if $item['id']}                                            <select data-placeholder="请选择套餐类别(可搜索名称)"  class="chosen-select" name="packageGoodsType" id="packageGoodsType"  style="width: 100%" tabindex="4">                                                {if in_array('0', $thisgoodspackagetypelist) }                                                <option value="0"   hassubinfo="true" selected>无套餐分类</option>                                                {else}                                                <option value="0"   hassubinfo="true">无套餐分类</option>                                                {/if}                                                {loop $goodspackagetypelist $index $goodstypeitem}                                                <option value="{$goodstypeitem['id']}"   hassubinfo="true"  {if in_array($goodstypeitem['id'], $thisgoodspackagetypelist)}selected{/if}>{$goodstypeitem['gt_name']}</option>                                                {/loop}                                            </select>                                            {else}                                            <select data-placeholder="请选择套餐类别(可搜索名称)"  class="chosen-select" name="packageGoodsType" id="packageGoodsType"  style="width: 100%" tabindex="4">                                                {if in_array('0', $thisgoodstypelist) }                                                <option value="0"   hassubinfo="true" selected>无套餐分类</option>                                                {else}                                                <option value="0"   hassubinfo="true">无套餐分类</option>                                                {/if}                                                {loop $goodstypelist $index $goodstypeitem}                                                <option value="{$goodstypeitem['id']}"   hassubinfo="true"  {if in_array($goodstypeitem['id'], $thisgoodstypelist)}selected{/if}>{$goodstypeitem['gt_name']}</option>                                                {/loop}                                            </select>                                            {/if}                                            <SCRIPT>                                                var config = {                                                    '.chosen-select': {},                                                    '.chosen-select-deselect': {                                                        allow_single_deselect: true                                                    },                                                    '.chosen-select-no-single': {                                                        disable_search_threshold: 10                                                    },                                                    '.chosen-select-no-results': {                                                        no_results_text: '暂无选项！'                                                    },                                                    '.chosen-select-width': {                                                        width: "95%"                                                    }                                                }                                                for (var selector in config) {                                                    $(selector).chosen(config[selector]);                                                }                                            </SCRIPT>                                        </div>                                    </div>                                </div>                                <div class="row"style="margin-top: 5px;margin-bottom: 5px;">                                    <label class="col-sm-1 control-label" style="margin: 0px; width: 7%">助记码</label>                                    <div class="col-sm-3" style="width: 27%">                                        <input class="form-control" name="packagePinYin" id="packagePinYin" type="text" value="{$item['goo_pinYin']}">                                    </div>                                    <label class="col-sm-1 control-label" style="margin: 0px; width: 7%">套餐简称</label>                                    <div class="col-sm-3" style="width: 26%">                                        <input class="form-control" name="packageNick" id="packageNick" type="text" value="{$item['goo_nick']}">                                    </div>                                    <label class="col-sm-1 control-label" style="margin: 0px; width: 7%">套餐价格</label>                                    <div class="col-sm-3" style="width: 26%">                                        <input class="form-control" name="packagePrice" id="packagePrice" type="text" value="{$item['goo_price']}">                                    </div>                                </div>                                <div class="row"style="margin-top: 5px;margin-bottom: 5px; display: none">                                    <label class="col-sm-1 control-label" style="margin: 0px; width: 7%">是否特价</label>                                    <div class="col-sm-3" style="width: 27%">                                        <div class="radio radio-info radio-inline">                                            <input type="radio" name="ifSetBarGainPrice" id="ifSetBarGainPrice1" value="1" {if $item['goo_ifSetBarGainPrice']==1}checked="checked" {/if}>                                            <label for="ifSetBarGainPrice1"> 特价</label>                                        </div>                                        <div class="radio radio-inline radio-danger">                                            <input type="radio" name="ifSetBarGainPrice" id="ifSetBarGainPrice2" value="0" {if $item['goo_ifSetBarGainPrice']==0 || empty($item['goo_ifSetBarGainPrice'])}checked="checked" {/if}>                                            <label for="ifSetBarGainPrice2"> 不特价 </label>                                        </div>                                    </div>                                    <label class="col-sm-1 control-label" style="margin: 0px; width: 7%">是否积分</label>                                    <div class="col-sm-3" style="width: 26%">                                        <div class="radio radio-info radio-inline">                                            <input type="radio" name="ifAllowBargainPoint" id="ifAllowBargainPoint1" value="1" {if $item['goo_ifAllowBargainPoint']==1}checked="checked" {/if}>                                            <label for="ifAllowBargainPoint1"> 积分 </label>                                        </div>                                        <div class="radio radio-inline radio-danger">                                            <input type="radio" name="ifAllowBargainPoint" id="ifAllowBargainPoint2" value="0" {if $item['goo_ifAllowBargainPoint']==0  || empty($item['goo_ifAllowBargainPoint'])}checked="checked" {/if}>                                            <label for="ifAllowBargainPoint2"> 不积分 </label>                                        </div>                                    </div>                                    <label class="col-sm-1 control-label" style="margin: 0px; width: 7%">是否打折</label>                                    <div class="col-sm-3" style="width: 26%">                                        <div class="radio radio-info radio-inline">                                            <input type="radio" name="ifAllowBargainDiscount" id="ifAllowBargainDiscount1" value="1" {if $item['goo_ifAllowBargainDiscount']==1}checked="checked" {/if}>                                            <label for="ifAllowBargainDiscount1"> 打折 </label>                                        </div>                                        <div class="radio radio-inline radio-danger">                                            <input type="radio" name="ifAllowBargainDiscount" id="ifAllowBargainDiscount2" value="0" {if $item['goo_ifAllowBargainDiscount']==0 || empty($item['goo_ifAllowBargainDiscount'])}checked="checked" {/if}>                                            <label for="ifAllowBargainDiscount2"> 不打折 </label>                                        </div>                                    </div>                                </div>                                <div class="row" id="goodspackageimg">                                    <label class="col-sm-1 control-label" style="margin: 0px; width: 7%">套餐图片</label>                                    <div class="col-sm-11" style="width: 93%">                                        {php echo tpl_form_field_image('packagePicture', $item['goo_picture'], '', array('thumb' => 0,'extras' => array('image'=> ' width="80" ')));}                                    </div>                                </div>                            </div>                        </div>                    </div>                    <div class="panel panel-primary" style="margin-top: 5px;margin-bottom: 5px;padding-top: 0px;padding-bottom: 0px;">                        <div class="panel-heading">                            <h4 class="panel-title"><a style="color:#FFF;display:block;" data-toggle="collapse" data-parent="#accordion" href="#collapseTwo"><i class="fa fa-hand-pointer-o"></i> 添加套餐明细</a></h4>                        </div>                        <div id="collapseTwo" class="panel-collapse collapse ">                        <div class="panel-body">                            <div class="btn-group" id="goodsPackageDetailToolbar" role="group" >                                <button type="button" id="btn_goodsDetailList" class="btn btn-primary" data-toggle="modal" data-target="#getGoodsId">                                    <i class="fa fa-plus-square"></i> 添加套餐商品明细                                </button>                                <button type="button" class="btn btn-warning" id="btn_deleteGoodsDetailList" style="margin-left: 5px;margin-right: 5px;">                                    <i class="fa fa-trash"></i> 删除                                </button>                                <div class="input-group m-b"><span class="input-group-btn">                                            <button type="button" class="btn btn-outline btn-primary">套餐汇总参考总价</button></span>                                    <input type="text" class="form-control" id="btn_pachagePriceCount" readonly>                                    <span class="input-group-btn"><button type="button" class="btn btn-danger">元</button> </span>                                </div>                            </div>                            <table id="goodsPackageDetailTableData" data-mobile-responsive="true"></table>                        </div>                        </div>                    </div>                    <div class="panel panel-primary" style="margin-top: 0px;margin-bottom: 0px;padding-top: 0px;padding-bottom: 0px;">                        <div class="panel-heading">                           套餐详细描述                        </div>                        <div class="panel-body">                            {php echo tpl_ueditor('packagecontent',$item['goo_content'],array('height'=>'135'));}                        </div>                        <div class="panel-footer" style="text-align: center;margin-top: 0px;margin-bottom: 0px;padding-top: 0px;padding-bottom: 0px;background-color: #1ab394;border-color: #1ab394;">                            <input type="hidden" name="token" value="{$_W['token']}" />                            <input  value="提交" class="btn btn-danger" type="submit" id="btn_savePackagesubmit" name="btn_savePackagesubmit">                        </div>                    </div>                    </div>                </form>            </div>        <div class="loadmask"></div>    </div></div><div class="modal inmodal fade" id="getGoodsId" tabindex="-1" role="dialog"  aria-hidden="true">    <div class="modal-dialog modal-lg" role="document">        <div class="modal-header" style="min-height:40px;">            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>            <h4 class="modal-title" style="float: left;">请选择商品</h4>        </div>        <div class="modal-content">            <div class="ibox-content" id="searchtoolbar" style="padding-top: 10px; padding-bottom: 0px;">                <form id="search_goods" class="form-horizontal" role="form">                    <input type="hidden" name="c" value="site" />                    <input type="hidden" name="a" value="entry" />                    <input type="hidden" name="m" value="{php echo $this->module['name']}" />                    <input type="hidden" name="do" value="goods" />                    <input type="hidden" name="op" value="goodslisttabledata" />                    <input type="hidden" name="storeid" value="{$storeid}" />                    <div class="form-group"  style="margin:0px;padding: 0px;">                        <label class="col-sm-1 control-label" style="margin: 0px;">商品编码</label>                        <div class="col-sm-2">                            <input class="form-control" name="codekeyword" id="search_codekeyword" type="text" value="{$_GPC['codekeyword']}">                        </div>                        <label class="col-sm-1 control-label"  style="margin: 0px;">商品助记码</label>                        <div class="col-sm-2">                            <input class="form-control" name="pinYinkeyword" id="search_pinYinkeyword" type="text" value="{$_GPC['pinYinkeyword']}">                        </div>                        <label class="col-sm-1 control-label" style="margin: 0px;">商品名称</label>                        <div class="col-sm-3">                            <input class="form-control" name="keyword" id="search_keyword" type="text" value="{$_GPC['keyword']}">                        </div>                        <div class="col-sm-2">                            <button class="btn btn-outline btn-primary" type="button" onclick="serachGoods()" id="btn_searchsubmit"><i class="fa fa-search"></i> 搜索</button>                        </div>                    </div>                </form>            </div>            <div class="ibox-content" style="padding-top: 10px; padding-bottom: 10px;">                <table id="goodslisttabledata" data-mobile-responsive="true"></table>            </div>            <div class="modal-footer">                <button type="button" class="btn btn-white" data-dismiss="modal" id="btn_closeGoodsId">关闭</button>                <button type="button" class="btn btn-primary" id="btn_SaveGoodsId">提交</button>            </div>        </div>    </div></div><script type="text/javascript">    $(document).ready(function(){        var hiddenpackageid = $("#hiddenpackageid").val();        /****模态商品数据----start  **/        getgoodsdata();        //总价参考汇总        getpricecount();        /****模态商品数据----end  **/        /****右侧遮罩层----start  **/        if(hiddenpackageid){            $(".loadmask").hide();        }else{            $(".loadmask").show();        }        $("#btn_addGoodsPackage").click(function(){            $(".loadmask").hide();        });        /****右侧遮罩层----end  **/        /****左侧商品套餐列表----start  **/        $('#goodspackagetabledata').bootstrapTable({            url: '{php echo $this->createWebUrl('goodspackage', array('op' => 'goodspackagelist'));}',            method:"post",            dataType: "json",            contentType: "application/x-www-form-urlencoded",            cache:false,  //是否使用缓存            search:false, //显示搜索框            showPaginationSwitch:false,//是否显示数据条数选择框            toolbar: '#searchpackagetoolbar',            striped:true,//隔行变色            queryParamsType:'',            queryParams: querypackageParamspage,//传递参数（*）            sidePagination: "server",           //分页方式：client客户端分页，server服务端分页（*）            pageNumber:1,                       //初始化加载第一页，默认第一页            pageSize: 11,                       //每页的记录行数（*）            pageList: [11, 22, 44, 88],            pagination: true,            height: 600,            selectItemName:"id",            uniqueId: "id",            columns: [{                field: 'goo_code',                title: '套餐编码',                align: "center",                valign: "middle"                //sortable: true            },{                field: 'goo_name',                title: '套餐名称',                align: "center",                valign: "middle"            },{                field: 'goodsTypeId',                title: '套餐分类',                align: "center",                valign: "middle"            },{                field: 'id',                title: '操作',                align: "center",                valign: "middle",                formatter:actionFormatter            }, ]        });        //得到查询的参数        function querypackageParamspage (params) {            var temp = {  //这里的键的名字和控制器的变量名必须一直，这边改动，控制器也需要改成一样的                pageSize: params.pageSize,  //页面大小                pageNumber: params.pageNumber, //页码                searchPackageNamestr: $("#search_packageKeyword").val(),//后台请求传的查询参数                searchGoodsPackageTypestr:$("#goodsPackageType_id").val(),//                sortOrder: params.sortOrder,//排序//                sortName:params.sortName//排序字段            };            return temp;        };        //操作按钮渲染设置        function actionFormatter(value, row, index) {            var id = value;            var result = "";            result += "<button type=\"button\" class='btn btn-xs btn-primary' onclick=\"ViewByPackage(" + id + ")\" title='查看套餐明细'><i class='fa fa-eye'></i></button>";            result += "<button type=\"button\" class='btn btn-xs btn-warning' id='EditViewByPackage' onclick=\"EditViewByPackage('" + id + "')\" title='编辑'><span class='glyphicon glyphicon-pencil'></span></button>";            result += "<button type=\"button\" class='btn btn-xs btn-danger' onclick=\"DeleteByPackage('" + id + "')\" title='删除'><span class='glyphicon glyphicon-remove'></span></button>";            return result;        }        /****左侧商品套餐列表----end  **/        /****右侧侧商品套餐明细列表----start  **/        //删除商品行        $("#btn_deleteGoodsDetailList").click(function(){            var ids = $.map($('#goodsPackageDetailTableData').bootstrapTable('getSelections'), function (row) {                return row.id;            });            if (ids.length < 1 ) {                swal("操作有误", "请选择要删除的项目！","error");            }else{                $('#goodsPackageDetailTableData').bootstrapTable('remove', {                    field: 'id',                    values: ids                });               // swal("操作成功", "","success");                swal({                        title: "操作成功",                        type: "success",                    },                    function(){                        $('#goodsPackageDetailTableData').bootstrapTable('resetView');                        getpricecount();                    });            }        });        //编辑商品行        var editDetailUrl =''        if(hiddenpackageid){             editDetailUrl = "{php echo $this->createWebUrl('goodspackage', array('op' => 'goodspackagedetaillist'))}&id=" + hiddenpackageid ;            $("#btn_goodsDetailList").hide();            $("#btn_deleteGoodsDetailList").hide();            $("#btn_addGoodsPackage").hide();        }else{             editDetailUrl = "{php echo $this->createWebUrl('goodspackage', array('op' => 'goodspackagedetaillist'))}";        }        $('#goodsPackageDetailTableData').bootstrapTable({            url: editDetailUrl,            dataType: "json",            contentType: "application/x-www-form-urlencoded",            toolbar: '#goodsPackageDetailToolbar',            queryParamsType:'',            queryParams: querypackagedetalParamspage,//传递参数（*）            sidePagination: "server",           //分页方式：client客户端分页，server服务端分页（*）            pageNumber:1,                       //初始化加载第一页，默认第一页            pageSize: 10,                       //每页的记录行数（*）            pageList: [10, 25, 50, 100],            clickToSelect: true,            pagination: true,            height: 470,            uniqueId: "id",            columns: [{                field : 'id',                radio: true,                formatter:detail_idFormatterid            },{                title: 'ID',                field : 'goods_id',                align : 'center',                valign: "middle",                width:60,                formatter:detail_goodIdFormatter            },{                title : '商品名称',                field : 'gpd_goodsName',                align : 'center',                valign: "middle",                formatter:gpd_goodsNameFormatter            },{                field: 'gpd_goodsBarcode',                title: '商品编号',                align: "center",                valign: "middle",                formatter:gpd_goodsBarcodeFormatter            },{                field: 'gpd_goodsPrice',                title: '售价（单位：元）',                align: "center",                valign: "middle",                formatter:gpd_goodsPriceFormatter            },{                field: 'gpd_goodsNumber',                title: '数量',                align: "center",                valign: "middle",                formatter:gpd_goodsNumberFormatter            },{                field: 'gpd_priceSubtotal',                title: '小计金额（单位：元）',                align: "center",                valign: "middle",                formatter:gpd_priceSubtotalFormatter            }]        });        //得到查询的参数        function querypackagedetalParamspage (params) {            var temp = {  //这里的键的名字和控制器的变量名必须一直，这边改动，控制器也需要改成一样的                pageSize: params.pageSize,  //页面大小                pageNumber: params.pageNumber, //页码            };            return temp;        };        //获取商品信息的文本框渲染设置        function actionGoodsIdFormatter(value, row, index) {            var id = value;            //var indexa = index+1;            var result = "";            //return "<select name=\"gpd_goodsBarcode\" data-placeholder=\"选择省份...\" class=\"chosen-select\" style=\"width:100px;\" tabindex=\"2\"><option value=\"620000\" hassubinfo=\"true\">甘肃省</option><option value=\"630000\" hassubinfo=\"true\">青海省</option></select>";            //result += "<a href='javascript:;' class='btn btn-xs btn-primary' onclick=\"EditViewById('" + id + "', view='view')\" title='查看'><i class='fa fa-eye'></i></a>";           // result += "<input type='text' class='form-control' data-pk=\""+index+"\"  name=\"gpd_goodsPrice_" + index + "\"  id=\"gpd_goodsPrice_" + index + "\"  >";            result += "<input type='text' class='form-control'  name='gpd_goodsPrice[]' value=\""+value+"\"  >";            return result;        }        function detail_idFormatterid(value, row, index) {            var index = index+1;            if(value){                var result = "<input type='hidden' class='form-control'  name='ArrDetailData[id][]' readonly  value=\""+value+"\" id=\"detail_id_" + index + "\" >";            }else{                var result = "<input type='hidden' class='form-control'  name='ArrDetailData[id][]' readonly  value=\""+index+"\" id=\"detail_id_" + index + "\" >";            }            return result;        }        function detail_goodIdFormatter(value, row, index) {            var index = index+1;            if(value){                var result = "<input type='text' class='form-control'  name='ArrDetailData[goods_id][]' readonly  value=\""+value+"\" id=\"goods_id_" + index + "\" >";            }else{                var result = "<input type='text' class='form-control'  name='ArrDetailData[goods_id][]' readonly  value=\""+index+"\" id=\"goods_id_" + index + "\" >";            }            return result;        }        function gpd_goodsNameFormatter(value, row, index) {            var index = index+1;            var result = "<input type='text' class='countGoodsName form-control' readonly  name='ArrDetailData[gpd_goodsName][]' value=\""+value+"\"  id=\"gpd_goodsName_" + index + "\" >";            return result;        }        function gpd_goodsBarcodeFormatter(value, row, index) {            var index = index+1;            var result = "<input type='text' class='form-control' readonly  name='ArrDetailData[gpd_goodsBarcode][]' value=\""+value+"\"  id=\"gpd_goodsBarcode_" + index + "\" >";            return result;        }        function gpd_goodsPriceFormatter(value, row, index) {            var index = index+1;            var result = "<input type='text' class='form-control' readonly  name='ArrDetailData[gpd_goodsPrice][]' value=\""+value+"\" id=\"gpd_goodsPrice_" + index + "\" >";            return result;        }        function gpd_goodsNumberFormatter(value, row, index) {            var index = index+1;            var result = "<input type='text' class='form-control'  name='ArrDetailData[gpd_goodsNumber][]'   onclick=\"changeGoodsNumber('" + value + "')\" value=\""+value+"\"  id=\"gpd_goodsNumber_" + index + "\" >";            return result;        }        function gpd_priceSubtotalFormatter(value, row, index) {            var index = index+1;            var result = "<input type='text' class='form-control'  name='ArrDetailData[gpd_priceSubtotal][]' value=\""+value+"\"  id=\"gpd_priceSubtotal_" + index + "\" >";            return result;        }        /****右侧侧商品套餐明细列表----end  **/    });    //套餐列表查询按钮事件    function btnSerachGoodsPackage() {        $("#goodspackagetabledata").bootstrapTable('refresh');    }    /****模态商品数据函数----start  **/    function getgoodsdata () {        $('#goodslisttabledata').bootstrapTable({            url: '{php echo $this->createWebUrl('goods', array('op' => 'getgoodslisttabledata'));}',            method:"post",            dataType: "json",            contentType: "application/x-www-form-urlencoded",            cache:false,  //是否使用缓存            search:false, //显示搜索框            showPaginationSwitch:false,//是否显示数据条数选择框            queryParamsType:'',            queryParams: queryParams,//传递参数（*）            sidePagination: "server",           //分页方式：client客户端分页，server服务端分页（*）            pageNumber:1,                       //初始化加载第一页，默认第一页            pageSize: 6,                       //每页的记录行数（*）            pageList: [6, 18, 36, 72],            pagination: true,            clickToSelect: true,            selectItemName:"id",            height: 270,            uniqueId: "id",            columns: [{                radio: true            }, {                field: 'id',                title: '商品ID'            }, {                field: 'goo_code',                title: '商品编码'            },  {                field: 'goo_name',                title: '商品名称'            },{                field: 'goo_goodsOrService',                title: '商品分类',                formatter:googoodsOrService            }, {                field: 'goo_number',                title: '商品库存',                formatter:googoodsnumber            },{                field: 'goo_pinYin',                title: '助记码'            }, ]        });        //得到查询的参数        function queryParams (params) {            var temp = {  //这里的键的名字和控制器的变量名必须一直，这边改动，控制器也需要改成一样的                pageSize: params.pageSize,  //页面大小                pageNumber: params.pageNumber, //页码                searchcodekeywordstr: $("#search_codekeyword").val(),//后台请求传的查询参数                searchpinYinkeywordstr:$("#search_pinYinkeyword").val(),                searchkeywordstr:$("#search_keyword").val(),            };            return temp;        };    }    function googoodsOrService (value, row, index) {        if(value == 1){            var result = "<span class='badge badge-primary'>实物商品</span>";        }else{            var result = "<span class='badge badge-success'>服务商品</span>";        }        return result;    }    function googoodsnumber (value, row, index) {        var rowvalue = row ;        var number = value;        var result = "";        if(number == 0 && rowvalue['goo_goodsOrService'] != 1){            result += "<span class='label label-warning' >无限制</span>";        }else{            result += number;        }        return result;    }    $("#btn_SaveGoodsId").click(function () {        var arrselections = $("#goodslisttabledata").bootstrapTable('getSelections');        var idData = arrselections[0].id;        if ( idData<= 0) {            swal("操作有误", "请选择要设置的项目！","error");            return;        }        else{            $.ajax({                type: "post",                dataType: 'jsonp',                url: "{php echo $this->createWebUrl('goods', array('op' => 'ajaxgetgoodsonedata'))}",                data: { idData:idData },                success: function (data) {                    //添加商品行                   // $('#goodsPackageDetailTableData').bootstrapTable('append', insertRowData(data));                    $('#goodsPackageDetailTableData').bootstrapTable('insertRow', {                        index: $('#goodsPackageDetailTableData').bootstrapTable('getOptions').totalRows,                        row: {                            goods_id:idData,                            gpd_goodsName:data.goo_name,                            gpd_goodsBarcode:data.goo_code,                            gpd_goodsPrice:data.goo_price,                            gpd_goodsNumber:1,                            gpd_priceSubtotal:data.goo_price                }                    });                    $('#goodsPackageDetailTableData').bootstrapTable('resetView');                },                error: function () {                    swal("操作有误", "请关闭重新操作！","error");                },                complete: function () {                    getpricecount();                }            });        }    });    function serachGoods() {        $("#goodslisttabledata").bootstrapTable('refresh');    }    /****模态商品数据函数----end  **/    /****交互数据操作函数----start  **/    function changeGoodsNumber(getgoodsNumber){        //获取行号        $('#goodsPackageDetailTableData').on("click-row.bs.table",function(e, row, $element) {            var  index= $element.data('index')+1;            $("#gpd_goodsNumber_"+index).keyup(function () {               var x = parseInt($("#gpd_goodsNumber_"+index).val());               var y = parseFloat($("#gpd_goodsPrice_"+index).val());               var z = parseFloat($("#gpd_priceSubtotal_"+index).attr("value",x*y));               var xValue = parseInt($("#goods_id_"+index).val());               var url = "{php echo $this->createWebUrl('goods', array('op' => 'ajaxCheckgoodsNumberdata'))}";               var params = {                    'goodsid': xValue,                    'goodsNumber': x,                };               $.ajax({                    url: url,                    type: "post",                    data: params,                    dataType: 'json',                    success: function (data) {                        if (data['message']['code'] == 0) {                            getpricecount();                        } else {                            swal({                                title: "操作有误",                                text: data['message']['msg'],                                type: "error",                            },                             function(){                                $("#gpd_goodsNumber_"+index).val("1");                                $("#gpd_goodsNumber_"+index).focus();                             });                        }                    }                });            });        });    }    /****交互数据操作函数----end  **/    /****获取参考总价函数----start  **/    function getpricecount(){        var count = 0;        //var colcount = parseInt($('#goodsPackageDetailTableData').bootstrapTable('getOptions').totalRows +1);        var colcount = $(".countGoodsName").length+1;        var numArr = []; // 定义一个空数组        for (var i = 1; i < colcount; i++) {            numArr.push($('#gpd_priceSubtotal_'+i).val()); // 将文本框的值添加到数组中        }        for(var a=0;a<numArr.length;a++){            count +=parseFloat(numArr[a]);        }        $("#btn_pachagePriceCount").attr("value",count);    }    /****获取参考总价函数----end  **/    /****套餐列表功能菜单----start  **/    function ViewByPackage(packageid){        var url = "{php echo $this->createWebUrl('goodspackage', array('op' => 'viewpackagedetail'))}&id=" + packageid;        parent.layer.open({            type: 2,            title: '套餐明细',            maxmin: false,            shadeClose: false, //点击遮罩关闭层            area : ['800px' , '600px'],            content: url        });    }    function EditViewByPackage(packageid){        var packageid = parseInt(packageid);        var url = "{php echo $this->createWebUrl('goodspackage', array('op' => 'add'))}&id=" + packageid;        $(window).attr('location',url);    }    function DeleteByPackage(packageid){        var packageid = parseInt(packageid);        swal({                title: "确定删除吗？",                text: "你将无法恢复该数据信息！",                type: "warning",                showCancelButton: true,                cancelButtonText: "取消删除！",                confirmButtonColor: "#DD6B55",                confirmButtonText: "确定删除！",                closeOnConfirm: false            },            function(){                $.ajax({                    type: "post",                    url: "{php echo $this->createWebUrl('goodspackage', array('op' => 'ajaxdelete', 'storeid' => $storeid))}",                    data: { packageid:packageid },                    success: function (data, status) {                        if (status == "success") {                            swal({                                title: "操作成功！",                                text: data.error,                                timer: 2000,                                type:"success",                                showConfirmButton: true                            },function(){                                $("#goodspackagetabledata").bootstrapTable('refresh');                            });                        }                    },                    error: function () {                        swal("操作有误", "请选择要删除的项目！","error");                    },                    complete: function () {                        $("#goodspackagetabledata").bootstrapTable('refresh');                    }                });            });    }    /****套餐列表功能菜单----start  **/    // 处理新增刷新数据的bug    function insertRowData(data){        var rows = [];        rows.push({            gpd_goodsName:data.goo_name,            gpd_goodsBarcode:data.goo_code,            gpd_goodsPrice:data.goo_price,            gpd_goodsNumber:1,            gpd_priceSubtotal:data.goo_price        });        return rows;    }    function reloadRowData(obj, row, key, index){        row[key] = obj.val();        $('#goodsPackageDetailTableData').bootstrapTable('getOptions').data.splice(index, 1, row);    }</script><script>    $("#goodspackagelimit").validate({        rules:{            packageName: {                required: true,                maxlength:20,            },            packageBarcode: {                required: true,                maxlength:13,                minlength:13,                digits:true,            },            packagePinYin: {                required: true,                daxie1:true,                maxlength:12,            },            packagePicture: {                url: false,            },            packageNick: {                required: true,                maxlength:15,                Chinese1:true,            },            packagePrice: {                required: true,                jiage1:true,            },        },        messages: {            packageName: {                required: "请输入套餐名称",                maxlength: $.validator.format( "不能超过20个字" ),            },            packageBarcode: {                required: "请输入套餐编码",                digits:"请输入正确的套餐编码",                maxlength: $.validator.format( "请输入13位套餐编码" ),                minlength: $.validator.format( "请输入13位套餐编码" ),            },            packagePinYin: {                required: "请填写助记码（套餐大写首字母）",                maxlength: "不能超过10位"            },            packageNick: {                required: "请填写套餐简称（必须中文）",                maxlength: "不能超过15个汉字"            },            packagePrice: {                required: "价格不能为空",            },        }    });    jQuery.validator.addMethod("daxie1", function(value, element) {        return this.optional(element) || /^[A-Z]+$/.test(value);    }, "只能输入大写英文字母，如:套餐名称首字母大写。");    jQuery.validator.addMethod("Chinese1", function (value, element) {        var mobile = /^[\u4e00-\u9fa5]+(·[\u4e00-\u9fa5]+)*$/;        return this.optional(element) || (mobile.test(value));    }, "请填写中文。");    jQuery.validator.addMethod("jiage1", function(value, element) {        return this.optional(element) || /^(0|[1-9][0-9]{0,9})(\.[0-9]{1,2})?$/.test(value);    }, "请填写正确的价格。");</script>{template 'web/common/footer'}