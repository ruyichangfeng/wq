{template 'web/common/header'}
{template 'web/messagebursts/common'}
<style>
    .fixed-table-toolbar .bs-bars{
        width: 100%;
    }
</style>
<div class="wrapper wrapper-content" style="padding-top: 0px;padding-bottom: 0px;">
    <div class="row">
        <div class="col-sm-5" style="padding-left: 5px;padding-right: 5px;">
            <div class="ibox-content" style="margin-top: 0px;margin-bottom: 0px;padding-top: 0px;padding-bottom: 0px;padding-left: 5px;padding-right: 5px;">
                <div class="panel-body" id="searchgoodstoolbar"  style="margin-top: 0px;margin-bottom: 0px;padding-top: 0px;padding-bottom: 0px;">
                    <form  class="form-horizontal" role="form" id="search_goods" style="margin-top: 0px;margin-bottom: 0px;padding-top: 0px;padding-bottom: 0px;">
                        <input type="hidden" name="c" value="site" />
                        <input type="hidden" name="a" value="entry" />
                        <input type="hidden" name="m" value="{php echo $this->module['name']}" />
                        <input type="hidden" name="do" value="memberconsume" />
                        <input type="hidden" name="op" value="goodslistdata" />
                        <input type="hidden" name="storeid" value="{$storeid}" />
                        <div class="form-group" style="margin-bottom: 0px;margin-top: 2px;">
                            <label class="col-sm-1 control-label" style="padding-top: 0px;">商品分类</label>
                            <div class="col-sm-4" >
                                <div class="input-group">
                                    <select data-placeholder="请选择套餐类别(可搜索名称)"  class="chosen-select" name="search_goodsTypeId" id="search_goodsTypeId"   tabindex="4">
                                        {if in_array('0', $thisgoodstypelist) }
                                        <option value="0"   hassubinfo="true" selected>选择商品分类</option>
                                        {else}
                                        <option value="0"   hassubinfo="true">选择商品分类</option>
                                        {/if}
                                        {loop $goodstypelist $index $goodstypeitem}
                                        <option value="{$goodstypeitem['id']}"   hassubinfo="true"  {if in_array($goodstypeitem['id'], $thisgoodstypelist)}selected{/if}>{$goodstypeitem['gt_name']}</option>
                                        {/loop}
                                    </select>
                                </div>
                            </div>
                            <label class="col-sm-1 control-label"  style="padding-top: 0px;">商品名称</label>
                            <div class="col-sm-6" >
                                <input class="form-control" name="search_goodsKeyword"  id="search_goodsKeyword" type="text" value="{$_GPC['search_goodsKeyword']}">
                            </div>
                        </div>
                        <div class="form-group" style="margin-bottom: 0px;margin-top: 2px;">
                            <label class="col-sm-1 control-label"  style="padding-top: 0px;">商品编码</label>
                            <div class="col-sm-6" style="padding-right: 0px;">
                                <input class="form-control" name="search_InquiregoodsCode" onkeydown="btnSerachGoods();"  id="search_InquiregoodsCode" type="text" value="{$_GPC['search_InquiregoodsCode']}">
                            </div>
                            <div class="col-sm-1" style="padding-left: 10px;padding-right: 0px;">
                                <button class="btn btn-outline btn-primary" type="button" onclick="btnSerachGoods()" id="btn_searchgoodssubmit"><i class="fa fa-search"></i> 搜索</button>
                            </div>
                            <div class="col-sm-4" style="padding-left: 10px;padding-right: 0px;text-align: right;">
                                <button type="button" class="btn btn-xs btn-outline btn-default"><i class="fa fa-question-circle" style="color: orangered"></i> 双击添加商品到右侧消费</button>
                            </div>
                        </div>
                    </form>
                </div>
                <table id="goodstabledata" data-mobile-responsive="true"></table>
            </div>
        </div>
        <div class="col-sm-7" style="padding-left: 0px;padding-right: 5px;">
            <div class="ibox float-e-margins" style="margin-bottom: 0px;" >
                <div class="ibox-title"  style="margin-top: 0px;margin-bottom: 0px;padding-top: 5px;padding-bottom: 0px;">
                    <form  class="form-horizontal" role="form" id="search_goodscode" style="margin-top: 0px;margin-bottom: 0px;padding-top: 0px;padding-bottom: 0px;">
                        <input type="hidden" name="c" value="site" />
                        <input type="hidden" name="a" value="entry" />
                        <input type="hidden" name="m" value="{php echo $this->module['name']}" />
                        <input type="hidden" name="do" value="memberconsume" />
                        <input type="hidden" name="op" value="goodslistdata" />
                        <input type="hidden" name="storeid" value="{$storeid}" />
                        <div class="form-group"  style="margin-top: 0px;margin-bottom: 0px;padding-top: 0px;padding-bottom: 0px;">
                            <label class="col-sm-2 control-label" style="padding-left:5px;">请输入商品编码</label>
                            <div class="col-sm-3" >
                                <input class="form-control" name="tmqSearch_goodsKeywordCode" id="tmqSearch_goodsKeywordCode" onkeydown="if(event.keyCode==13){$('#btn_addgoodssubmit').focus()}" type="text"   placeholder="输入消费编码">
                            </div>
                            <div class="col-sm-1"  style="width: 7%;">
                                <button class="btn btn-primary" type="button" onclick="addMemberConsume();return false;" id="btn_addgoodssubmit"><i class="fa fa-plus-square-o"></i> 添加</button>
                            </div>
                            <div class="col-sm-1"  style="width: 7%;text-align: right;margin-left: 10px;">
                                <button class="btn btn-danger" type="button" onclick="btnShowConsumeSubmit()" id="btn_showconsumesubmit"><i class="fa fa-keyboard-o"></i> 开启操作收银</button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="ibox-content" style="margin-top: 0px;margin-bottom: 0px;padding-top: 0px;padding-bottom: 0px;padding-left: 5px;padding-right: 5px;">
                    <form role="form"   class="form-horizontal form" method="post" enctype="multipart/form-data" onsubmit="return check(this);" >
                        <input type="hidden" name="storeid" value="{$storeid}" />
                        <table class="table table-bordered table-hover" id="consumeCart" data-unique-id="goods_id"  data-toggle="table" data-height="410" style=" margin-bottom: 5px;" data-mobile-responsive="true" >
                            <thead>
                            <tr>
                                <th data-field="goods_id">ID</th>
                                <th>消费项目</th>
                                <th>规格</th>
                                <th>单价(元)</th>
                                <th>数量</th>
                                <th>折扣系数</th>
                                <th>小计金额(元)</th>
                                <th>折后金额(元)</th>
                                <th>获得积分</th>
                                <th>备注</th>
                                <th>操作</th>
                            </tr>
                            </thead>
                            <tbody id="consumeCartBody">
                            {loop $cart $item}
                            {if $item['chud_consumeNumber']>0}
                            <tr goodsid="{$item['goods_id']}">

                                <td>{$item['goods_id']}</td>
                                <td>{$item['chud_goo_name']}</td>
                                <td><input type='text' readonly  class='i-add-btn form-control' id="chud_goo_specification_{$item['goods_id']}" class="chud_goo_specification_{$item['goods_id']}" value="{$item['chud_goo_specification']}" ></td>
                                <td><input type='text' class='i-add-btn form-control' id="chud_goo_price_{$item['goods_id']}" value="{$item['chud_goo_price']}" ></td>
                                <td><input type='text' class='i-add-btn form-control' id="chud_consumeNumber_{$item['goods_id']}" value="{$item['chud_consumeNumber']}" ></td>
                                <td><input type='text' class='i-add-btn form-control' id="chud_coefficient_{$item['goods_id']}" value="{$item['chud_bargainScale']}" ></td>
                                <td>{php echo $item['chud_goo_price'] * $item['chud_consumeNumber']}</td>
                                <td>{$item['chud_discountedAmount']}</td>
                                <td>{$item['chud_givePoints']}</td>
                                <td><input type='text' class='i-add-btn form-control' id="chud_note_{$item['goods_id']}" value="{$item['chud_note']}" ></td>
                                <td>
                                    <button type="button" title="将商品移除列表" name="ArrDetailData[goods_id][{$item['goods_id']}]" onclick="doDeleteSelectBtn({$item['goods_id']},{$item['consumehangup_id']},'{$item['chud_goo_specification']}')"  class="btn btn-info btn-sm">删除</button>
                                </td>
                            </tr>
                            {/if}
                            {/loop}
                            </tbody>
                        </table>
                        <div class="hr-line-dashed" style="margin-top: 3px; margin-bottom: 0px;"></div>
                        <div class="ibox-content" style="margin-top: 0px;margin-bottom: 0px;padding-top: 0px;padding-bottom: 0px;padding-left: 0px;padding-right: 0px;z-index: 10;">
                            <ul class="todo-list m-t" style=" margin-top: 5px;">
                                <li>
                                    <span class="m-l-xs">总数量：</span>
                                    <small class="label label-info" style="font-size:small" id="carttotalcount"><i class="fa fa-database"></i> {$totalcount}件</small>
                                    <input type="hidden" id="hidde_carttotalcount" name="hidde_carttotalcount" value="{$totalcount}"/>
                                    <span class="m-l-xs">总金额：</span>
                                    <small class="label label-info" style="font-size: large" id="carttotalprice"><i class="fa fa-rmb"></i> {$totalprice}元</small>
                                    <input type="hidden" id="hidde_carttotalprice" name="hidde_carttotalprice" value="{$totalprice}"/>
                                    <span class="m-l-xs">获得积分：</span>
                                    <small class="label label-info" style="font-size:small" id="carttotalintegral"><i class="fa fa-gift"></i> {$discountgive}积分</small>
                                    <input type="hidden" id="hidde_carttotalintegral" name="hidde_carttotalintegral" value="{$discountgive}"/>
                                </li>
                            </ul>
                        </div>
                        {template 'web/common/panel-member-card-info'}
                        <div class="shop-preview col-xs-12 col-sm-12 col-lg-12" id="showconsumecontrolpanel">
                            <div class="text-center alert alert-info alert-dismissable" style="margin-bottom: 0px;">
                                <button aria-hidden="true" id="hideconsumecontrolpanel" class="close" type="button" onclick="btnHideConsumeSubmit()">×</button>
                                <button class="btn btn-lg btn-primary " type="button"  onclick="btn_showReadCard()"><i class="fa fa-search-plus"></i>&nbsp;读&nbsp;卡&nbsp;</button>
                                <button class="btn btn-lg btn-warning "  name="btn_yeshangup" id="btn_yeshangup" type="button" onclick="btn_DoYesHangUp()"><i class="fa fa-thumb-tack"></i>&nbsp;挂&nbsp;单&nbsp;</button>
                                <button class="btn btn-lg btn-success "  name="btn_nohangup" id="btn_nohangup" type="button"  data-toggle="modal" data-target="#consumeHangUpData" ><i class="fa fa-retweet"></i>&nbsp;解&nbsp;挂&nbsp;</button>
                                <button class="btn btn-lg btn-primary " type="button" id="btn_printConsumeOrder" ><i class="fa fa-print"></i>&nbsp;打&nbsp;印&nbsp;</button>
                                <button class="btn btn-lg btn-info ClearAll-btn" type="button" id="btn_clearConsumeOrder" ><i class="fa fa-trash-o"></i>&nbsp;清&nbsp;空&nbsp;</button>
                                <button class="btn btn-lg btn-danger " type="button" name="btn_saveConsumeOrder" id="btn_saveConsumeOrder"  onclick="btn_checkMemberInfoIsTrue()" data-toggle="modal" data-target="#consumeOrderData" ><i class="fa fa-money"></i>&nbsp;结&nbsp;账&nbsp;</button>
                            </div>
                        </div>
                        {template 'web/common/payadvancedcommon'}
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal inmodal fade" id="rechargeGoodsId" tabindex="-1" role="dialog"  aria-hidden="true" style="height: 600px;">
    <div class="modal-dialog modal-lg" role="document">
        <div class="ibox-title">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
        </div>
        <div class="modal-content">
            <div class="ibox-content">
                <table id="Coupontabledata" data-mobile-responsive="true"></table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-white" data-dismiss="modal" id="btn_closeGoodsId">关闭</button>
                <button type="button" class="btn btn-primary" id="btn_SaveGoodsId">提交</button>
            </div>
        </div>
    </div>
</div>
<div class="modal inmodal fade" id="consumeHangUpData" tabindex="-1" role="dialog"  aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-header" style="min-height: 40px;">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
            <h4 class="modal-title" style="float: left;">请选择挂单中消费</h4>
        </div>
        <div class="modal-content">

            <div class="ibox-content"  style="padding-top: 5px; padding-bottom: 5px;">
                <form id="search_consumeHangUpData" class="form-horizontal" role="form">
                    <input type="hidden" name="c" value="site" />
                    <input type="hidden" name="a" value="entry" />
                    <input type="hidden" name="m" value="{php echo $this->module['name']}" />
                    <input type="hidden" name="do" value="memberconsume" />
                    <input type="hidden" name="op" value="getConsumeHangUp" />
                    <input type="hidden" name="storeid" value="{$storeid}" />
                    <div class="form-group"  style="margin:0px;padding: 0px; width: 100%">
                        <div class="col-sm-9">
                            <input class="form-control" name="search_ConsumeHangUpNoteKeyword" id="search_ConsumeHangUpNoteKeyword" type="text" value="{$_GPC['search_ConsumeHangUpNoteKeyword']}"  placeholder="请输入挂单备注">
                        </div>
                        <div class="col-sm-3">
                            <button class="btn btn-outline btn-primary" type="button" onclick="serachconsumeHangUpData()" id="btn_search_ConsumeHangUpsubmit"><i class="fa fa-search"></i> 搜索</button>
                            <button class="btn btn-outline btn-primary" type="button" onclick="serachconsumeHangUpData()" id="btn_refresh_ConsumeHangUpsubmit"><i class="fa fa-refresh"></i> 刷新</button>
                            <input type="hidden" name="token" value="{$_W['token']}" />
                        </div>
                    </div>
                </form>
            </div>
            <div class="ibox-content" style="margin:0px;padding-left: 10px;padding-right: 10px;">
                <table id="consumeHangUpDataTable"  data-mobile-responsive="true"  style="padding: 0px;margin: 0px"></table>
            </div>
            <div class="ibox-content" id="show_consumeHangUpDetailTable"  style="margin:0px;padding-top: 0px; padding-bottom: 0px;padding-left: 10px;padding-right: 10px;">
                <table class="table table-bordered table-hover" id="consumeHangUpDetailTable" data-toggle="table" data-height="160"  style="padding: 0px;margin: 0px" data-mobile-responsive="true">
                    <tbody>
                    </tbody>
                </table>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-white" data-dismiss="modal" id="btn_closeConsumeHangUpId">关闭</button>
                <button type="button" class="btn btn-primary" id="btn_SaveConsumeHangUpId" data-dissmiss="modal"><span aria-hidden="true">解挂</span></button>
                <button type="button" class="btn btn-info" id="btn_PrintConsumeHangUpId"><i class="fa fa-print"></i> 打印</button>
            </div>
        </div>
    </div>
</div>

<style>
    .shop-preview {
        position: fixed;
        padding: 0 0;
        bottom: 0;
        right: 0;
        z-index: 100;
        width: 59%;
    }
    .shop-preview div {
        filter:alpha(opacity=20);
        /*background: rgba(255, 254, 220, 0.8);*/
    }
</style>
<script>
    key('q', function(){
        payStyle_Check(2);
    });
    key('a', function(){
        payStyle_Check(1);
    });
    key('z', function(){
        payStyle_Check(3);
    });

    //积分抵现设置开关
    var cmpresultdata = 0;
    var cmpdata = "{php echo util::set('cmp300',$setdata)}";
    var cmpstatedata = "{php echo util::set('cmp301',$setdata)}";
    if(cmpstatedata == 1){
        cmpresultdata = cmpdata;
    }else{
        cmpresultdata = 0.00000000000000001;
    }
    $(document).ready(function(){
        //取付款模态内焦点
        $('#consumeOrderData').on('shown.bs.modal',function(e){
            $('#hidden_TextPayCode2').focus();
        });
        $("#tmqSearch_goodsKeywordCode").focus();
        //收银台函数
        funPayShowAsHideInfo();
        //改变数量总价的按钮事件
        doSelectBtn();
        /****挂单解挂按钮事件----start  **/
        btnYesOrNoHangUp();
        getConsumeHangUpData();
        $("#show_consumeHangUpDetailTable").hide();
        /****挂单解挂按钮事件----end  **/

            //会员登记完跳转过来的事件
        var memberCardNumValue = "{php echo $memberCardNumLocation}";
        if(memberCardNumValue.length > 0){
            btn_showReadCardLocation(memberCardNumValue);
        }
        /****左侧商品列表----start  **/
        $('#goodstabledata').bootstrapTable({
            url: "{php echo $this->createWebUrl('goods', array('op' => 'consumegoodslistdata'));}",
            method:"post",
            dataType: "json",
            contentType: "application/x-www-form-urlencoded",
            cache:false,  //是否使用缓存
            search:false, //显示搜索框
            clickToSelect: true,
            showPaginationSwitch:false,//是否显示数据条数选择框
            toolbar: '#searchgoodstoolbar',
            striped:true,//隔行变色
            queryParamsType:'',
            queryParams: querygoodsParamspage,//传递参数（*）
            sidePagination: "server",           //分页方式：client客户端分页，server服务端分页（*）
            pageNumber:1,                       //初始化加载第一页，默认第一页
            pageSize: 11,                       //每页的记录行数（*）
            pageList: [11, 22, 44, 88],
            pagination: true,
            height: 700,
            rowStyle: packageroestyle,
            selectItemName:"id",
            uniqueId: "id",
            columns: [{
                radio: true
            },{
                field: 'goo_code',
                title: '商品编码',
                align: "center",
                valign: "middle"
            },{
                field: 'goo_name',
                title: '商品名称',
                align: "center",
                valign: "middle"
            },{
                field: 'goo_price',
                title: '商品售价',
                align: "center",
                valign: "middle"
            },{
                field: 'goo_number',
                title: '库存',
                align: "center",
                valign: "middle",
                formatter:NumberFormatter
            },{
                field: 'goo_goodsOrService',
                title: '商品类型',
                align: "center",
                valign: "middle",
                formatter:typeFormatter
            },{
                field: 'id',
                title: '查看',
                align: "center",
                valign: "middle",
                formatter:actionFormatter
            },]
        });
        //得到查询的参数
        function querygoodsParamspage (params) {
            var temp = {  //这里的键的名字和控制器的变量名必须一直，这边改动，控制器也需要改成一样的
                pageSize: params.pageSize,  //页面大小
                pageNumber: params.pageNumber, //页码
                searchGoodsNamestr: $("#search_goodsKeyword").val(),//后台请求传的查询参数
                searchGoodsTypestr:$("#search_goodsTypeId").val(),
                search_InquiregoodsCode:$("#search_InquiregoodsCode").val(),
                sortOrder: params.sortOrder,//排序
                sortName:params.sortName//排序字段

            };
            return temp;
        };

        //商品类型渲染设置
        function NumberFormatter(value, row, index) {
            //var rowvalue = JSON.stringify(row) ;
            var rowvalue = row ;
            var number = value;
            var result = "";
            if(number == 0 && rowvalue['goo_goodsOrService'] != 1){
                result += "<span class='label label-warning' >无限制</span>";
            }else{
                result += number;
            }
            return result;
        }
        function typeFormatter(value, row, index) {
            var id = value;
            var result = "";
            if(id == 1){
                result += "<span class='label label-primary' >实物商品</span>";
            }else if(id == 2){
                result += "<span class='label label-info' > 服务商品 </span>";
            }else{
                result += "<span class='label label-danger' STYLE=\"font-size:13px;\"> 套餐商品 </span>";
            }
            return result;
        }
        function actionFormatter(value, row, index) {
            var id = value;
            var result = "<button type='button'  class='btn btn-outline btn-sm btn-primary' onclick=\"ViewByGoods(" + id + ")\" title='查看商品详情'><i class='fa fa-eye'></i></button>";
            return result;
        }
        //套餐商品行样式设置
        function packageroestyle(row, index) {
            var result = "";
            if(row.goo_goodsOrService == 1){
                result={css:{'color':'#000000'}};
            }
            else if(row.goo_goodsOrService == 2){
                result = {css:{'color':'#1ab394'}};
            }
            else{
                result = {css:{'color':'#9B0000'}};
            }
            return result
        }

        /****左侧商品套餐列表----end  **/

        /****右侧侧商品明细列表----start  **/
        //添加左侧商品到右侧
        $('#goodstabledata').on("dbl-click-row.bs.table",function(e, row, $element) {
            var consumehangupid =$("#consumeCart tbody  tr:eq(1)").attr("data-consumehangupid");
            var memberCardNum = $("#memberCardNum").val();
            var memberId = $("#memberId").val();
            var  goodnumstr = '';
            var  goods_id= row.id;
            var goodsnum = parseInt($("#chud_consumeNumber_"+goods_id).val());

            if(goodsnum){
                goodnumstr = goodsnum;
            }else{
                goodnumstr = 1;
            }
            var url = "{php echo $this->createWebUrl('UpdateConsumeNumOfGoods', array('storeid' => $storeid))}";
            var params = {
                'goodsid': goods_id,
                'consumehangupid': consumehangupid,
                'optype':'add',
                'consumeNum': goodnumstr,
                'memberCardNum':memberCardNum,
                'memberId':memberId
            };
            $.ajax({
                url: url,
                type: "post",
                data: params,
                dataType: 'json',
                success: function (data) {
                    if (data['message']['specification'] == 1) {
                        var specificationjson  = JSON.parse(data['message']['specificationjson']);
                        new $.flavr({
                            title   : '模板选择器',
                            content : '<div id="select_templ"></div>',
                            buttons : {
                                close : {text:'关闭'}
                            },
                            closeOverlay : true,
                            closeEsc     : true
                        });

                        var urlStrValue = "{php echo $this->createWebUrl('goodsinventoryin', array('op' => ajaxselectspecification))}";
                        $.ajax({
                            url: urlStrValue,
                            cache: false,
                            data:{specificationjson:specificationjson,params:params, consumehangupid: consumehangupid},
                        }).done(function (html) {
                            $("#select_templ").append(html);
                        });

                    }
                    else if(data['message']['code'] != 0){
                        swal({
                            title: "操作有误",
                            text: data['message']['msg'],
                            type: "error",
                        });
                        return;

                    }
                    else {
                        $('#consumeCartBody').html(data['message']['cart']);
                        $('#carttotalprice').html('<i class="fa fa-rmb"></i> '+ parseFloat(data['message']['totalprice'])+ ' 元');
                        $('#carttotalcount').html('<i class="fa fa-database"></i> '+ data['message']['totalcount']+' 件');
                        $('#carttotalintegral').html('<i class="label label-info"></i> '+ data['message']['discountgive']+' 积分');
                        //discountgive = "<i class='label label-info'></i> "+ data['message']['discountgive']+" 积分";

                        $("#hidde_carttotalintegral").attr("value",data['message']['discountgive']);
                        $("#hidde_carttotalcount").attr("value",data['message']['totalcount']);
                        $("#hidde_carttotalprice").attr("value",data['message']['totalprice']);
                        $("#handleMoneyCount").attr("value",data['message']['totalprice']);
                        $("#realMoneyCount").attr("value",data['message']['totalprice']);
                        $("#hidden_realMoneyCount").attr("value",data['message']['totalprice']);
                        $('#consumeCart').bootstrapTable('resetView');
                        //alert(data['message']['msg']);
                        doSelectBtn();
                        btnYesOrNoHangUp();
                    }
                }
            });
        });

        /****右侧侧商品明细列表----end  **/
    });

    //商品列表查询按钮事件
    function btnSerachGoods() {
        $("#goodstabledata").bootstrapTable('refresh');
    }
    //查看商品详情
    function ViewByGoods(goodsid){
        var url = "{php echo $this->createWebUrl('goodspackage', array('op' => 'viewpackagedetail'))}&id=" + goodsid;
        parent.layer.open({
            type: 2,
            title: '商品详情',
            maxmin: false,
            shadeClose: true, //点击遮罩关闭层
            area : ['800px' , '600px'],
            content: url
        });
    }
    //收银操作按钮事件
    function btnShowConsumeSubmit() {
        $("#showconsumecontrolpanel").show();
        $("#btn_showconsumesubmit").hide();
        $("#btn_hideconsumesubmit").show();
    }
    function btnHideConsumeSubmit() {
        $("#showconsumecontrolpanel").hide();
        $("#btn_showconsumesubmit").show();
        $("#btn_hideconsumesubmit").hide();
    }

    //消费商品操作列表
    //删除消费项目与清空购物车
    function doDeleteSelectBtn(goods_id,consumehangup_id,chud_goo_specification) {
        var consumehangupid = parseInt(consumehangup_id); //挂单id
        var goodsid = parseInt(goods_id);
        var goo_specification = chud_goo_specification;
        var goodsnum = parseInt($("#chud_consumeNumber_"+goodsid).val());
        var url = "{php echo $this->createWebUrl('UpdateConsumeNumOfGoods', array('storeid' => $storeid))}";
        var params = {
            'optype':'del',
            'goodsid': goodsid,
            'consumehangupid': consumehangupid,
            'consumeNum': goodsnum,
            'goo_specification': goo_specification,
        };
        $.ajax({
            url: url,
            type: "post",
            data: params,
            dataType: 'json',
            success: function (data) {
                if (data['message']['code'] != 0) {
                    swal("操作有误", "请选择要删除的项目！","error");
                    return;
                } else {
                    swal({
                        title: "操作成功！",
                        text: "成功将此商品移除消费列表。",
                        timer: 2000,
                        type:"success",
                        showConfirmButton: true
                    },function(){
                        totalprice = "<i class='fa fa-rmb'></i> "+  data['message']['totalprice']+" 元";
                        totalcount = "<i class='fa fa-database'></i> "+ data['message']['totalcount']+" 件";
                        totalcount = "<i class='fa fa-gift'></i> "+ data['message']['discountgive']+" 积分";
                        goodscount = data['message']['goodscount'];

                        $("#hidde_carttotalintegral").attr("value",data['message']['discountgive']);
                        $("#hidde_carttotalcount").attr("value",data['message']['totalcount']);
                        $("#hidde_carttotalprice").attr("value",data['message']['totalprice']);
                        $('#consumeCartBody').html(data['message']['cart']);
                        $('#carttotalprice').html(totalprice);
                        $('#carttotalcount').html(totalcount);
                        $("#handleMoneyCount").attr("value",data['message']['totalprice']);
                        $("#realMoneyCount").attr("value",data['message']['totalprice']);
                        $('#consumeCart').bootstrapTable('resetView');
                        doSelectBtn();
                        btnYesOrNoHangUp();

                    });
//                    setTimeout(function(){
//                        window.location.reload();
//                    }, 3000);

                }
            }
        });
//        swal({
//                title: "确定删除吗？",
//                text: "你将无法恢复该数据信息！",
//                type: "warning",
//                showCancelButton: true,
//                cancelButtonText: "取消删除！",
//                confirmButtonColor: "#DD6B55",
//                confirmButtonText: "确定删除！",
//                closeOnConfirm: false
//            },
//            function(){
//                $.ajax({
//                    type: "post",
//                    dataType: 'json',
//                    url: "{php echo $this->createWebUrl('memberconsume', array('op' => 'ajaxdelete', 'storeid' => $storeid))}",
//                    data: { deldetailid:deldetailid },
//                    success: function (data) {
//                        if (data['message']['code'] != 0) {
//                            swal("操作有误", "请选择要删除的项目！","error");
//                            return;
//                        } else {
//                            swal({
//                                title: "操作成功！",
//                                text: "成功将此商品移除消费列表。",
//                                timer: 2000,
//                                type:"success",
//                                showConfirmButton: true
//                            },function(){
//                                totalprice = "<i class='fa fa-rmb'></i> "+  data['message']['totalprice']+" 元";
//                                totalcount = "<i class='fa fa-database'></i> "+ data['message']['totalcount']+" 件";
//                                goodscount = data['message']['goodscount'];
//
//                                $('#consumeCart').html(data['message']['cart']);
//                                $('#carttotalprice').html(totalprice);
//                                $('#carttotalcount').html(totalcount);
//                                doSelectBtn();
//                            });
//
//                        }
//                    }
//                });
//            });
    }
    function doSelectBtn() {
        var cmp319 = "{php echo $cmp319statedata}";
        var btnAdd = $(".i-add-btn");
        var btnClean = $(".ClearAll-btn");

        btnClean.on('click', function () {
            swal({
                    title: "确定清空吗？",
                    text: "你将无法对当前消费列表进行操作！",
                    type: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#DD6B55",
                    confirmButtonText: "确定",
                    cancelButtonText: "取消",
                    closeOnConfirm: false
                },
                function(){
                    var url = "{php echo $this->createWebUrl('DeleteAllMemberConsume', array('storeid' => $storeid))}";
                    var params = {};
                    $.ajax({
                        url: url,
                        type: "post",
                        data: params,
                        dataType: 'json',
                        success: function (data) {

                        },
                        complete: function () {
                            swal("清空完成", "","success");
                            $('#consumeCartBody').html('');
                            $('#carttotalprice').html('<i class="fa fa-rmb"></i> 0 元');
                            $('#carttotalcount').html('<i class="fa fa-database"></i> 0 件');
                            $('#carttotalintegral').html('<i class="fa fa-gift"></i> 0 积分');

                            $("#hidde_carttotalintegral").attr("value","");
                            $("#hidde_carttotalprice").attr("value","");
                            $("#hidde_carttotalcount").attr('value',"");


                            $("#handleMoneyCount").attr("value","");
                            $("#realMoneyCount").attr("value","");
                            $("#hidden_consumehangupId").attr('value',"");
                            $('#consumeCart').bootstrapTable('resetView');
                            btnYesOrNoHangUp();
                            btn_clearMemberInfo();
                        }
                    });
                });
        });

        btnAdd.on('change', function () {
            var goodsid = this.parentNode.parentNode.getAttribute('data-uniqueid'); //商品编号id
            var goo_specification = $(this).parents("tr").find(".i-add-btn").val();
            var goodsnum = $(this).parents("tr").find("#chud_consumeNumber_"+goodsid).val();
            var coefficient = $(this).parents("tr").find("#chud_coefficient_"+goodsid).val();
            var consumeGoodNote = $(this).parents("tr").find("#chud_note_"+goodsid).val();
            var goodsprice = $(this).parents("tr").find("#chud_goo_price_"+goodsid).val();


            //  var goodsindex = this.parentNode.parentNode.getAttribute('data-index'); //商品索引index

            var consumehangupid = this.parentNode.parentNode.getAttribute('data-consumehangupid'); //商品编号id
            //var goodsnum = parseInt($("#chud_consumeNumber_"+goodsid).val());
            //    var goodsprice = $("#chud_goo_price_"+goodsid).val();
            //  var consumeGoodNote = $("#chud_note_"+goodsid).val();
            //  var coefficient = $("#chud_coefficient_"+goodsid).val();
            var memberCardNum = $("#memberCardNum").val();
            var memberId = $("#memberId").val();
            var url = "{php echo $this->createWebUrl('UpdateConsumeNumOfGoods', array('storeid' => $storeid))}";
            if(cmp319 ==1){
                var params = {
                    'goodsid': goodsid,
                    'consumehangupid': consumehangupid,
                    'consumeNum': goodsnum,
                    'nowgoodsprice': goodsprice,
                    'consumeGoodNote': consumeGoodNote,
                    'memberCardNum':memberCardNum,
                    'memberId':memberId,
                    'coefficient':coefficient,
                    'goo_specification':goo_specification,
                };
            }
            else{
                var params = {
                    'goodsid': goodsid,
                    'consumehangupid': consumehangupid,
                    'consumeNum': goodsnum,
                    'consumeGoodNote': consumeGoodNote,
                    'memberCardNum':memberCardNum,
                    'memberId':memberId,
                    'coefficient':coefficient,
                    'goo_specification':goo_specification,
                };
            }
            $.ajax({
                url: url,
                type: "post",
                data: params,
                dataType: 'json',
                success: function (data) {
                    if (data['message']['code'] != 0) {
                        swal({
                            title: "操作有误",
                            text: data['message']['msg'],
                            type: "error",
                        });
                        return;
                    } else {


                        totalprice = "<i class='fa fa-rmb'></i> "+  data['message']['totalprice']+" 元";
                        totalcount = "<i class='fa fa-database'></i> "+ data['message']['totalcount']+" 件";
                        discountgive = "<i class='label label-info'></i> "+ data['message']['discountgive']+" 积分";
                        $("#hidde_carttotalintegral").attr("value",data['message']['discountgive']);
                        $("#hidde_carttotalcount").attr("value",data['message']['totalcount']);
                        $("#hidde_carttotalprice").attr("value",data['message']['totalprice']);
                        $('#consumeCartBody').html(data['message']['cart']);
                        $('#carttotalprice').html(totalprice);
                        $('#carttotalcount').html(totalcount);
                        $('#carttotalintegral').html(discountgive);
                        $("#handleMoneyCount").attr("value",data['message']['totalprice']);
                        $("#realMoneyCount").attr("value",data['message']['totalprice']);
                        $("#hidden_realMoneyCount").attr("value",data['message']['totalprice']);
                        $('#consumeCart').bootstrapTable('resetView');
                        doSelectBtn();
                        btnYesOrNoHangUp();
                    }
                }
            });
        });

    }

    /****挂单按钮启用事件----start  **/
    function btnYesOrNoHangUp(){

        var numCartData = $("#consumeCart tbody").find("tr").length;
        var Td_numCartText = $("#consumeCart tbody").find("tr").find("td").text();
        //alert(Td_numCartText);
        if(numCartData<1 || Td_numCartText == '没有找到匹配的记录' || Td_numCartText == ''){
            $('#btn_yeshangup').attr("disabled", true);
            $('#btn_nohangup').attr("disabled", false);
            $('#btn_saveConsumeOrder').attr("disabled", true);
            $('#btn_printConsumeOrder').attr("disabled", true);
            $('#btn_clearConsumeOrder').attr("disabled", true);

        }else{
            $('#btn_yeshangup').attr("disabled", false);
            $('#btn_nohangup').attr("disabled", true);
            $('#btn_saveConsumeOrder').attr("disabled", false);
            $('#btn_printConsumeOrder').attr("disabled", true);
            $('#btn_clearConsumeOrder').attr("disabled", false);
        }
    }
    function btn_DoYesHangUp(){
        swal({
                title: "确定要执行【挂单】操作吗？",
                type: "warning",
                showCancelButton: true,
                confirmButtonColor: "#DD6B55",
                confirmButtonText: "确定挂单",
                cancelButtonText: "取消挂单",
                closeOnConfirm: false,
                closeOnCancel: false
            },
            function(isConfirm){
                if (isConfirm) {
                    swal({
                            title: "挂单备注",
                            text: "请您输入挂单备注：",
                            type: "input",
                            showCancelButton: true,
                            closeOnConfirm: false,
                            confirmButtonText: "确定",
                            cancelButtonText: "取消",
                            animation: "slide-from-top",
                            inputPlaceholder: "例如：客户延时结账等等"
                        },
                        function(inputValue){
                            if (inputValue === false) return false;

                            if (inputValue === "") {
                                swal.showInputError("您想要输入挂单备注！");
                                return false
                            }
                            swal({
                                    title: "输入成功",
                                    text: "您的备注信息是：" + inputValue,
                                    type: "success",
                                },
                                function(){
                                    var memberId = $('#memberId').val();
                                    var consumeNote = inputValue;
                                    var url = "{php echo $this->createWebUrl('memberconsume', array('op' => 'addYesHangUp'))}";
                                    var params = {
                                        'memberId': memberId,
                                        'consumeNote': consumeNote
                                    };
                                    $.ajax({
                                        url: url,
                                        type: "post",
                                        data: params,
                                        dataType: 'json',
                                        success: function (data) {
                                            if (data['message']['code'] == 0) {
                                                $('#consumeCartBody').html('');
                                                $('#carttotalprice').html('<i class="fa fa-rmb"></i> 0 元');
                                                $('#carttotalcount').html('<i class="fa fa-database"></i> 0 件');
                                                $("#handleMoneyCount").attr("value","");
                                                $("#realMoneyCount").attr("value","");

                                                btnYesOrNoHangUp();
                                                btn_clearMemberInfo();
                                                swal("挂单成功！", "","success");
                                            }
                                            else{
                                                swal("挂单失败！", "","error");
                                            }
                                        },
                                        complete: function () {
                                            setTimeout(function(){
                                                window.location.reload();
                                            }, 2000);
                                        }
                                    });
                                });
                        });
                } else {
                    swal("取消！", "挂单操作已经取消。","error");
                }
            });
    }
    function btn_DoNoHangUp(consumeHangUpID){
        var  getconsumehangupid= parseInt(consumeHangUpID);
        var detailUrl = "{php echo $this->createWebUrl('memberconsume', array('op' => 'getConsumeHangUpDetailData','storeid' => $storeid))}";
        var params = {
            'getconsumehangupid': getconsumehangupid,
        };
        $.ajax({
            url: detailUrl,
            type: "post",
            data: params,
            dataType: 'json',
            success: function (data) {
                if (data['message']['code'] != 0) {
                    swal({
                        title: "操作有误",
                        text: data['message']['msg'],
                        type: "error",
                    });
                    return;
                } else {
                    $('#consumeHangUpData').modal('hide')
                    totalprice = "<i class='fa fa-rmb'></i> "+  data['message']['totalprice']+" 元";
                    totalcount = "<i class='fa fa-database'></i> "+ data['message']['totalcount']+" 件";
                    discountgive = "<i class='label label-info'></i> "+ data['message']['pointscount']+" 积分";

                    $('#consumeCartBody').html(data['message']['cart']);
                    $('#carttotalcount').html(totalcount);
                    $("#hidde_carttotalcount").attr("value",data['message']['totalcount']);
                    $('#carttotalprice').html(totalprice);
                    $("#hidde_carttotalprice").attr("value",data['message']['totalprice']);
                    $('#carttotalintegral').html(discountgive);
                    $("#hidde_carttotalintegral").attr("value",data['message']['pointscount']);

                    $("#handleMoneyCount").attr("value",data['message']['totalprice']);
                    $("#realMoneyCount").attr("value",data['message']['totalprice']);
                    $("#hidden_realMoneyCount").attr("value",data['message']['totalprice']);
                    $("#preferentialMoney").attr('value',0.00);
                    $("#hidden_consumehangupId").attr('value',data['message']['back_consumehangupid']);
                    $("#show_consumeHangUpDetailTable").hide();
                    $('#consumeCart').bootstrapTable('resetView');
                    doSelectBtn();
                    btnYesOrNoHangUp();

                }
            }
        });
    }
    function getConsumeHangUpData () {
        $('#consumeHangUpDataTable').bootstrapTable({
            url: '{php echo $this->createWebUrl('goods', array('op' => 'getConsumeHangUp'));}',
            method:"post",
            dataType: "json",
            contentType: "application/x-www-form-urlencoded",
            cache:false,  //是否使用缓存
            search:false, //显示搜索框
            showPaginationSwitch:false,//是否显示数据条数选择框
            queryParamsType:'',
            queryParams: queryconsumeHangUpParams,//传递参数（*）
            sidePagination: "server",           //分页方式：client客户端分页，server服务端分页（*）
            pageNumber:1,                       //初始化加载第一页，默认第一页
            pageSize: 5,                       //每页的记录行数（*）
            pageList: [5, 10, 20, 50],
            pagination: true,
            clickToSelect: true,
            singleSelect:true,
            selectItemName:"id",
            height: 200,
            uniqueId: "id",
            columns: [{
                radio: true
            }, {
                field: 'chu_hangUpCode',
                title: '挂单编码'
            }, {
                field: 'chu_memberCardNum',
                title: '会员卡号'
            }, {
                field: 'chu_hangUpNote',
                title: '挂单备注'
            },{
                field: 'chu_hangUpDate',
                title: '挂单日期'
            },{
                field: 'id',
                title: '操作',
                formatter:actionFormatter
            }, ]
        });
        //得到查询的参数
        function queryconsumeHangUpParams (params) {
            var temp = {  //这里的键的名字和控制器的变量名必须一直，这边改动，控制器也需要改成一样的
                pageSize: params.pageSize,  //页面大小
                pageNumber: params.pageNumber, //页码
                consumeHangUpNotestr: $("#search_ConsumeHangUpNoteKeyword").val(),//后台请求传的查询参数

            };
            return temp;
        };
        function actionFormatter(value, row, index) {
            var result = "<button type='button'  class='btn btn-outline btn-sm btn-primary' onclick=\"DeleteByHangUpData(" + value + ")\" title='删除挂单数据'><i class=\"fa fa-trash-o\"></i></button>";
            return result;
        }
        //挂单详情
        $('#consumeHangUpDataTable').on("click-row.bs.table",function(e, row, $element) {
            $("#show_consumeHangUpDetailTable").show();
            var  consumehangupid= row.id;
            var  detailUrl= "{php echo $this->createWebUrl('memberconsume', array('op' => 'getConsumeHangUpDetailData','storeid' => $storeid))}";
            $("#btn_SaveConsumeHangUpId").attr("onclick","btn_DoNoHangUp("+consumehangupid+")");
            var params = {
                'consumehangupid': consumehangupid,
            };
            $.ajax({
                url: detailUrl,
                type: "post",
                data: params,
                dataType: 'json',
                success: function (data) {
                    if (data['message']['code'] != 0) {
                        swal({
                            title: "操作有误",
                            text: data['message']['msg'],
                            type: "error",
                        });
                        return;
                    } else {
                        if(data['message']['back_MemberCardNum']){
                            btn_showNoHangUpReadCard(data['message']['back_MemberCardNum']);
                        }else{
                            btn_clearMemberInfo();
                        }
                        $('#consumeHangUpDetailTable').html(data['message']['consumehangupdetail']);

                    }
                }
            });
        });
    }
    //搜索
    function serachconsumeHangUpData() {
        $("#consumeHangUpDataTable").bootstrapTable('refresh');
    }
    //删除挂单数据
    function DeleteByHangUpData(consumehangupid){
        var consumehangupid = parseInt(consumehangupid);
        swal({
                title: "确定删除吗？",
                text: "你将无法恢复该数据信息！",
                type: "warning",
                showCancelButton: true,
                cancelButtonText: "取消删除！",
                confirmButtonColor: "#DD6B55",
                confirmButtonText: "确定删除！",
                closeOnConfirm: false
            },
            function(){
                $.ajax({
                    type: "post",
                    url: "{php echo $this->createWebUrl('memberconsume', array('op' => 'ajaxdeleteHangUpData', 'storeid' => $storeid))}",
                    data: { consumehangupid:consumehangupid },
                    success: function (data, status) {
                        if (status == "success") {
                            swal({
                                title: "操作成功！",
                                text: data.error,
                                timer: 2000,
                                type:"success",
                                showConfirmButton: true
                            },function(){
                                $("#consumeHangUpDataTable").bootstrapTable('refresh');
                                $("#show_consumeHangUpDetailTable").hide();
                            });
                        }
                    },
                    error: function () {
                        swal("操作有误", "请选择要删除的项目！","error");
                    },
                    complete: function () {

                    }

                });
            });
    }
    /****挂单按钮启用事件----end  **/

    //会员登记完跳转过来读卡
    function btn_showReadCardLocation(memberCardNumValue) {
        var memberCardNum = memberCardNumValue;
        var url = "{php echo $this->createWebUrl('memberconsume', array('op' => 'ajaxGetMemberIfo','storeid' => $storeid))}";
        var params = {
            'memberCardNum': memberCardNum,
        };
        $.ajax({
            url: url,
            type: "post",
            data: params,
            dataType: 'json',
            success: function (data) {
                //alert(data['message']['code']);
                if (data['message']['code'] != 0) {
                    swal({
                        title: "读卡失败",
                        text: "卡号错误或不存在卡号，请重新读卡！",
                        confirmButtonText: "确定",
                        type: "error",
                    });
                    return;
                } else {
                    var memberIdstr = data['message']['back_MemberId'];
                    var memberCardNumstr = data['message']['back_MemberCardNum'];
                    var memberNamestr = data['message']['back_MemberName'];
                    var membercardlevelstr = data['message']['back_Membercardlevel'];
                    var memberMobilestr = data['message']['back_MemberMobile'];
                    var memberPointsCountstr = data['message']['back_MemberPointsCount'];
                    var memberMoneyCountstr = data['message']['back_MemberMoneyCount'];
                    var memberSpecifiedEndTimestr = data['message']['back_MemberSpecifiedEndTime'];
                    var memberConsumeNotestr = data['message']['back_MemberConsumeNote'];
                    $("#memberId").attr("value",memberIdstr);
                    $("#memberCardNum").attr("value",memberCardNumstr);
                    $("#memberName").attr("value",memberNamestr);
                    $("#membercardlevel").attr("value",membercardlevelstr);
                    $("#memberMobile").attr("value",memberMobilestr);
                    $("#memberPointsCount").attr("value",memberPointsCountstr);
                    $("#memberMoneyCount").attr("value",memberMoneyCountstr);
                    $("#specifiedEndTime").attr("value",memberSpecifiedEndTimestr);
                    $("#memberNote").attr("value",memberConsumeNotestr);
                    if(memberMoneyCountstr>0){
                        $("#span_validPayRecharge").text("可用储值" +memberMoneyCountstr+"元");
                        $(".ifTrue_RechargePayCheckbox").show();
                    }
                    if(memberPointsCountstr>0){
                        $("#span_validPayPoints").text("可用积分" +memberPointsCountstr+"，可抵现" + Math.floor(memberPointsCountstr / parseFloat(cmpresultdata))+" 元");
                        if(cmpstatedata == 1){
                            $(".ifTrue_PointsPayCheckbox").show();
                        }
                    }
                    swal("读卡成功！", "会员卡号是：" + memberCardNumstr,"success");
                    doSelectBtn();
                    btnYesOrNoHangUp();
                    Coupontabledatamember();
                }
            }

        });
    }
    //读卡操作
    function btn_showReadCard() {
        swal({
                title: "读卡操作",
                text: "请刷卡或输入会员卡号：",
                type: "input",
                showCancelButton: true,
                closeOnConfirm: false,
                confirmButtonText: "确定(1)",
                cancelButtonText: "取消",
                confirmButtonColor: "#DD6B55",
                animation: "slide-from-top",
                inputPlaceholder: "输入卡号|手机号|身份证号"
            },
            function(inputCardValue){
                if (inputCardValue === false) return false;

                if (inputCardValue === "") {
                    swal.showInputError("会员卡不能为空！");
                    return false
                }
                var memberCardNum = inputCardValue;
                var url = "{php echo $this->createWebUrl('memberconsume', array('op' => 'ajaxGetMemberIfo','storeid' => $storeid))}";
                var params = {
                    'memberCardNum': memberCardNum,
                };
                $.ajax({
                    url: url,
                    type: "post",
                    data: params,
                    dataType: 'json',
                    success: function (data) {
                        //alert(data['message']['code']);
                        if (data['message']['code'] != 0) {
                            swal({
                                title: "读卡失败",
                                text: "卡号错误或不存在卡号，请重新读卡！",
                                confirmButtonText: "确定",
                                type: "error",
                            });
                            return;
                        } else {
                            var memberIdstr = data['message']['back_MemberId'];
                            var memberCardNumstr = data['message']['back_MemberCardNum'];
                            var memberNamestr = data['message']['back_MemberName'];
                            var membercardlevelstr = data['message']['back_Membercardlevel'];
                            var memberMobilestr = data['message']['back_MemberMobile'];
                            var memberPointsCountstr = data['message']['back_MemberPointsCount'];
                            var memberMoneyCountstr = data['message']['back_MemberMoneyCount'];
                            var memberSpecifiedEndTimestr = data['message']['back_MemberSpecifiedEndTime'];
                            var memberConsumeNotestr = data['message']['back_MemberConsumeNote'];
                            $("#memberId").attr("value",memberIdstr);
                            $("#memberCardNum").attr("value",memberCardNumstr);
                            $("#memberName").attr("value",memberNamestr);
                            $("#membercardlevel").attr("value",membercardlevelstr);
                            $("#memberMobile").attr("value",memberMobilestr);
                            $("#memberPointsCount").attr("value",memberPointsCountstr);
                            $("#memberMoneyCount").attr("value",memberMoneyCountstr);
                            $("#specifiedEndTime").attr("value",memberSpecifiedEndTimestr);
                            $("#memberNote").attr("value",memberConsumeNotestr);
                            if(memberMoneyCountstr>0){
                                $("#span_validPayRecharge").text("可用储值" +memberMoneyCountstr+"元");
                                $(".ifTrue_RechargePayCheckbox").show();
                            }
                            if(memberPointsCountstr>0){
                                $("#span_validPayPoints").text("可用积分" +memberPointsCountstr+"，可抵现" + Math.floor(memberPointsCountstr / parseFloat(cmpresultdata))+" 元");
                                if(cmpstatedata == 1){
                                    $(".ifTrue_PointsPayCheckbox").show();
                                }
                            }
                            swal("读卡成功！", "会员卡号是：" + memberCardNumstr,"success");
                            doSelectBtn();
                            btnYesOrNoHangUp();
                            Coupontabledatamember();
                        }
                    }

                });
            });
    }
    function btn_showNoHangUpReadCard(getCardValue) {
        var memberCardNum = getCardValue;
        var url = "{php echo $this->createWebUrl('memberconsume', array('op' => 'ajaxGetMemberIfo','storeid' => $storeid))}";
        var params = {
            'memberCardNum': memberCardNum,
        };
        $.ajax({
            url: url,
            type: "post",
            data: params,
            dataType: 'json',
            success: function (data) {
                //alert(data['message']['code']);
                if (data['message']['code'] != 0) {
                    swal({
                        title: "读卡失败",
                        text: "卡号错误或不存在卡号，请重新读卡！",
                        confirmButtonText: "确定",
                        type: "error",
                    });
                    return;
                } else {
                    var memberIdstr = data['message']['back_MemberId'];
                    var memberCardNumstr = data['message']['back_MemberCardNum'];
                    var memberNamestr = data['message']['back_MemberName'];
                    var membercardlevelstr = data['message']['back_Membercardlevel'];
                    var memberMobilestr = data['message']['back_MemberMobile'];
                    var memberPointsCountstr = data['message']['back_MemberPointsCount'];
                    var memberMoneyCountstr = data['message']['back_MemberMoneyCount'];
                    var memberSpecifiedEndTimestr = data['message']['back_MemberSpecifiedEndTime'];
                    var memberConsumeNotestr = data['message']['back_MemberConsumeNote'];
                    $("#memberId").attr("value",memberIdstr);
                    $("#memberCardNum").attr("value",memberCardNumstr);
                    $("#memberName").attr("value",memberNamestr);
                    $("#membercardlevel").attr("value",membercardlevelstr);
                    $("#memberMobile").attr("value",memberMobilestr);
                    $("#memberPointsCount").attr("value",memberPointsCountstr);
                    $("#memberMoneyCount").attr("value",memberMoneyCountstr);
                    $("#specifiedEndTime").attr("value",memberSpecifiedEndTimestr);
                    $("#memberNote").attr("value",memberConsumeNotestr);
                    if(memberMoneyCountstr>0){
                        $("#span_validPayRecharge").text("可用储值" +memberMoneyCountstr+"元");
                        $(".ifTrue_RechargePayCheckbox").show();
                    }else{
                        $("#span_validPayRecharge").text("可用储值0.00元");
                        $(".ifTrue_RechargePayCheckbox").show();
                    }
                    if(memberPointsCountstr>0){
                        $("#span_validPayPoints").text("可用积分" +memberPointsCountstr+"，可抵现"+ Math.floor(memberPointsCountstr / parseFloat(cmpresultdata))+" 元");
                        if(cmpstatedata == 1){
                            $(".ifTrue_PointsPayCheckbox").show();
                        }
                    }else{
                        $("#span_validPayPoints").text("可用积分0.00");
                        if(cmpstatedata == 1){
                            $(".ifTrue_PointsPayCheckbox").show();
                        }
                    }
                    doSelectBtn();
                    btnYesOrNoHangUp();
                }
            }

        });

    }
    //清空会员信息
    function btn_clearMemberInfo() {
        $("#memberId").attr("value","");
        $("#memberCardNum").attr("value","");
        $("#memberName").attr("value","");
        $("#membercardlevel").attr("value","");
        $("#memberMobile").attr("value","");
        $("#memberPointsCount").attr("value","");
        $("#memberMoneyCount").attr("value","");
        $("#specifiedEndTime").attr("value","");
        $("#memberNote").attr("value","");
    }
    //收款优惠
    function funPayShowAsHideInfo() {
        //储值和积分文本框默认不可用
        $("#get_memberMoneyCount").attr("readonly",true);
        $("#get_memberPointsCount").attr("readonly",true);
        //结账优惠价格光标焦点事件
        $("#handleMoneyCount").attr('value',{$totalprice});
        $("#preferentialMoney").attr('value',"");
        $("#realMoneyCount").attr('value',{$totalprice});
        $("#hidden_realMoneyCount").attr('value',{$totalprice});
        /****开启关闭操作收银按钮事件----start  **/
        $("#btn_showconsumesubmit").hide();
        /****开启关闭操作收银按钮事件----end  **/

        /****开启关闭储值积分支付复选框事件----start  **/
        $(".ifTrue_RechargePayCheckbox").hide();
        $(".ifTrue_PointsPayCheckbox").hide();
        $(".ifTrue_CouponPayCheckbox").hide();
        /****开启关闭储值积分支付复选框事件----end  **/
    }
    //储值积分勾选文本框启用事件
    $("#preferentialMoney").on('keyup', function () {
        var handleMoneyCount = Math.round(parseFloat($("#handleMoneyCount").val()) * 100) / 100;
        var preferentialMoney = Math.round(parseFloat($("#preferentialMoney").val()) * 100) / 100;
        var realMoneyCount = Math.round(parseFloat(handleMoneyCount - preferentialMoney) * 100) / 100;

        if(preferentialMoney > handleMoneyCount){
            swal("操作异常！", "不能超出实付金额","error");
        }else{
            $("#realMoneyCount").attr('value',realMoneyCount);
            $("#hidden_realMoneyCount").attr('value',realMoneyCount.toFixed(2));
        }

        // $("#hidden_realMoneyCount").attr('value',realMoneyCount);
    });
    function btn_checkMemberInfoIsTrue() {
        var memberCardNum = $("#memberCardNum").val();
        var hidde_carttotalprice = $("#hidde_carttotalprice").val();
        var hidde_carttotalintegral = $("#hidde_carttotalintegral").val();
        if(memberCardNum.length > 0){
            var url = "{php echo $this->createWebUrl('memberconsume', array('op' => 'ajaxGetMemberIfo','storeid' => $storeid))}";
            var params = {
                'memberCardNum': memberCardNum,
                'hidde_carttotalprice': hidde_carttotalprice,
                'hidde_carttotalintegral': hidde_carttotalintegral,
            };
            $.ajax({
                url: url,
                type: "post",
                data: params,
                dataType: 'json',
                success: function (data) {
                    //alert(data['message']['code']);
                    if (data['message']['code'] == 0) {
                        var memberCardSpecifiedEndTime = data['message']['back_TIMESTAMP_MemberSpecifiedEndTime'];
                        var memberSpecifiedEndTime = data['message']['back_MemberSpecifiedEndTime'];
                        var memberPointsCountstr = data['message']['back_MemberPointsCount'];
                        var memberMoneyCountstr = data['message']['back_MemberMoneyCount'];
                        var MemberCardLeveldiscount = data['message']['back_MemberCardLeveldiscount'];
                        var MemberCardLevelinitPoint = data['message']['back_MemberCardLevelinitPoint'];
                        //$("#hidde_carttotalintegral").attr('value',MemberCardLevelinitPoint);
                        var now_timestamp = Date.parse(new Date()) / 1000;
                        if(memberCardSpecifiedEndTime < now_timestamp){
                            swal({
                                title: "会员卡异常！",
                                text: "会员卡于<strong>[ "+memberSpecifiedEndTime+" ]</strong>过期，储值与积分已冻结。",
                                type:"warning",
                                html: true
                            });
                            $(".ifTrue_RechargePayCheckbox").hide();
                            $(".ifTrue_PointsPayCheckbox").hide();
                            $(".ifTrue_CouponPayCheckbox").hide();
                        }
                        else{
                            $(".ifTrue_RechargePayCheckbox").show();
                            if(cmpstatedata == 1){
                                $(".ifTrue_PointsPayCheckbox").show();
                            }
                            $(".ifTrue_CouponPayCheckbox").show();
                        }
                    }
                }

            });
        }
    }
    //校验比对会员可用储值和积分
    function btn_checkcoupon(){
        //var CouponPayCheckbox = parseInt($("#CouponPayCheckbox").val());
        var realMoneyCount = parseFloat($("#realMoneyCount").val());
        if($("#CouponPayCheckbox").is(":checked")){
            $('.rechargeGoodsName_Id').html('<button type="button" class="btn btn-default"  name="rechargeGoodsName_Id"  id="rechargeGoodsName_Id" data-toggle="modal" data-target="#rechargeGoodsId">选择卡券</button>');

        }else{
            $('.rechargeGoodsName_Id').html('<button type="button" class="btn btn-default"  name="rechargeGoodsName_Id"  id="rechargeGoodsName_Id" >选择卡券</button>');
            $("#get_PreferentialNumber").attr("readonly",true);
            $("#get_PreferentialNumber").attr("value","0.00");
            $("#hidden_realMoneyCount").attr("value",realMoneyCount.toFixed(2));

        }

    }
    function btn_checkMemberRechargeIsTrue() {

        var value_RechargePayCheckbox_checked = parseInt($("#RechargePayCheckbox").val());
        var realMoneyCount = parseFloat($("#realMoneyCount").val());
        var memberCardNum = $("#memberCardNum").val();
        var url = "{php echo $this->createWebUrl('memberconsume', array('op' => 'ajaxGetMemberIfo','storeid' => $storeid))}";
        var params = {
            'memberCardNum': memberCardNum,
        };
        if(value_RechargePayCheckbox_checked === 2 && $("#RechargePayCheckbox").is(":checked")){
            $.ajax({
                url: url,
                type: "post",
                data: params,
                dataType: 'json',
                success: function (data) {
                    //alert(data['message']['code']);
                    if (data['message']['code'] == 0) {
                        var memberMoneyCountstr = parseFloat(data['message']['back_MemberMoneyCount']);
                        if(memberMoneyCountstr <= 0 ){
                            $("#get_memberMoneyCount").attr("value",memberMoneyCountstr);
                            $("#get_memberMoneyCount").attr("readonly",true);
                            btn_checkMemberLaseMoneyCount();
                        }else if(memberMoneyCountstr <= realMoneyCount){
                            $("#get_memberMoneyCount").attr("readonly",false);
                            $("#get_memberMoneyCount").attr("value",memberMoneyCountstr);
                            btn_checkMemberLaseMoneyCount();

                        }else if(memberMoneyCountstr > realMoneyCount){
                            $("#get_memberMoneyCount").attr("readonly",false);
                            $("#get_memberMoneyCount").attr("value",realMoneyCount);
                            btn_checkMemberLaseMoneyCount();
                        }
                    }
                }

            });
        }
        else{
            $("#get_memberMoneyCount").attr("value","0.00");
            btn_checkMemberLaseMoneyCount();
            $("#get_memberMoneyCount").attr("readonly",true);
            $("#hidden_realMoneyCount").attr("value",realMoneyCount.toFixed(2));

        }
    }
    function btn_checkMemberPointsIsTrue() {
        var value_PointsPayCheckbox_checked = parseInt($("#PointsPayCheckbox").val());
        var realMoneyCount = parseFloat($("#realMoneyCount").val());
        var rate_pointsAsMoney = parseFloat(cmpresultdata);
        var memberCardNum = $("#memberCardNum").val();
        var url = "{php echo $this->createWebUrl('memberconsume', array('op' => 'ajaxGetMemberIfo','storeid' => $storeid))}";
        var params = {
            'memberCardNum': memberCardNum,
        };
        if(value_PointsPayCheckbox_checked === 3 && $("#PointsPayCheckbox").is(":checked")){
            $.ajax({
                url: url,
                type: "post",
                data: params,
                dataType: 'json',
                success: function (data) {
                    //alert(data['message']['code']);
                    if (data['message']['code'] == 0) {
                        var memberPointsCountstr = Math.floor(parseFloat(data['message']['back_MemberPointsCount']) / rate_pointsAsMoney);
                        if(memberPointsCountstr <= 0){
                            $("#get_memberPointsCount").attr("value",memberPointsCountstr);
                            $("#get_memberPointsCount").attr("readonly",true);
                            btn_checkMemberLaseMoneyCount();
                        }else if(memberPointsCountstr <= realMoneyCount){
                            $("#get_memberPointsCount").attr("readonly",false);
                            $("#get_memberPointsCount").attr("value",memberPointsCountstr);
                            btn_checkMemberLaseMoneyCount();
                        }else if(memberPointsCountstr > realMoneyCount){
                            $("#get_memberPointsCount").attr("readonly",false);
                            $("#get_memberPointsCount").attr("value",realMoneyCount);
                            btn_checkMemberLaseMoneyCount();
                        }
                    }
                }

            });
        }else{
            $("#get_memberPointsCount").attr("value","0.00");
            btn_checkMemberLaseMoneyCount();
            $("#get_memberPointsCount").attr("readonly",true);
            $("#hidden_realMoneyCount").attr("value",realMoneyCount.toFixed(2));
        }
    }
    function btn_checkMemberLaseMoneyCount() {
        var realMoneyCount = parseFloat($("#realMoneyCount").val()).toFixed(2);
        var x = parseFloat($("#get_memberMoneyCount").val()).toFixed(2);
        var y = parseFloat($("#get_memberPointsCount").val()).toFixed(2);
        if((x.length == 0 || x == 0) && (y.length == 0 || y == 0)){
            $("#hidden_realMoneyCount").attr("value",realMoneyCount);
        }else if((x.length == 0 || x == 0) && (y.length > 0 || y > 0)){
            $("#hidden_realMoneyCount").attr("value",realMoneyCount - y);
        }else if((x.length > 0 || x > 0) && (y.length == 0 || y == 0)){
            $("#hidden_realMoneyCount").attr("value",realMoneyCount - x);
        }else if((x.length > 0 || x > 0) && (y.length > 0 || y > 0)){
            if(x >= realMoneyCount && y < realMoneyCount){
                $("#hidden_realMoneyCount").attr("value","0.00");
                $("#get_memberMoneyCount").attr("value",realMoneyCount- y);
            }else if(x < realMoneyCount && y >= realMoneyCount){
                $("#hidden_realMoneyCount").attr("value","0.00");
                $("#get_memberPointsCount").attr("value",realMoneyCount- x);
            }else if(x >= realMoneyCount){
                $("#hidden_realMoneyCount").attr("value","0.00");
                $("#get_memberPointsCount").attr("value","0.00");
            }else if(y >= realMoneyCount){
                $("#hidden_realMoneyCount").attr("value","0.00");
                $("#get_memberMoneyCount").attr("value","0.00");
            }else if(x < realMoneyCount && y < realMoneyCount && (x + y)>realMoneyCount){
                $("#hidden_realMoneyCount").attr("value","0.00");
                $("#get_memberMoneyCount").attr("value",x);
                $("#get_memberPointsCount").attr("value",realMoneyCount- x);
            }else if(x < realMoneyCount && y < realMoneyCount && (x + y)<realMoneyCount){
                $("#hidden_realMoneyCount").attr("value",realMoneyCount- x - y);
                $("#get_memberMoneyCount").attr("value",x);
                $("#get_memberPointsCount").attr("value",y);
            }

        }else{
            swal("操作异常！", "请刷新当前页面重新操作。","error")
        }
    }


    //条码枪添加消费商品
    function addMemberConsume(){
        var getSearch_goodsKeywordCode = $("#tmqSearch_goodsKeywordCode").val();
        //alert(getSearch_goodsKeywordCode);
        var consumehangupid =$("#consumeCart tbody  tr:eq(1)").attr("data-consumehangupid");
        var  goodnumstr = 1;
        var memberCardNum = $("#memberCardNum").val();
        var memberId = $("#memberId").val();
        var url = "{php echo $this->createWebUrl('UpdateConsumeNumOfGoods', array('storeid' => $storeid))}";
        var params = {
            'goodscode': getSearch_goodsKeywordCode,
            'optype':'ScanCode',
            'consumeNum': goodnumstr,
            'memberCardNum':memberCardNum,
            'memberId':memberId
        };

        $.ajax({
            url: url,
            type: "post",
            data: params,
            dataType: 'json',
            success: function (data) {
                if (data['message']['specification'] == 1) {
                    var specificationjson  = JSON.parse(data['message']['specificationjson']);
                  //  alert(data['message']['specificationjson']);
                    new $.flavr({
                        title   : '模板选择器',
                        content : '<div id="select_templ"></div>',
                        buttons : {
                            close : {text:'关闭'}
                        },
                        closeOverlay : true,
                        closeEsc     : true
                    });
                    var params_new = {
                        'goodsid': data['message']['goodsid'],
                        'goodscode': getSearch_goodsKeywordCode,
                        'optype':'add',
                        'consumeNum': goodnumstr,
                        'memberCardNum':memberCardNum,
                        'memberId':memberId
                    };
                    var urlStrValue = "{php echo $this->createWebUrl('goodsinventoryin', array('op' => ajaxselectspecification))}";
                    $.ajax({
                        url: urlStrValue,
                        cache: false,
                        data:{specificationjson:specificationjson,params:params_new, consumehangupid: consumehangupid},
                    }).done(function (html) {
                        $("#select_templ").append(html);
                    });

                }
                else if (data['message']['code'] != 0) {

                    $("#tmqSearch_goodsKeywordCode").val("");
                    $("#tmqSearch_goodsKeywordCode").focus();
                    return;
                } else {

                    $('#consumeCartBody').html(data['message']['cart']);
                    $('#carttotalprice').html('<i class="fa fa-rmb"></i> '+ data['message']['totalprice']+ ' 元');
                    $('#carttotalcount').html('<i class="fa fa-database"></i> '+ data['message']['totalcount']+' 件');
                    $('#carttotalintegral').html('<i class="label label-info"></i> '+ data['message']['discountgive']+' 积分');
                    $("#handleMoneyCount").attr("value",data['message']['totalprice']);
                    $("#realMoneyCount").attr("value",data['message']['totalprice']);
                    $("#hidden_realMoneyCount").attr("value",data['message']['totalprice']);
                    $('#consumeCart').bootstrapTable('resetView');
                    doSelectBtn();
                    btnYesOrNoHangUp();
                    $("#tmqSearch_goodsKeywordCode").val("");
                    $("#tmqSearch_goodsKeywordCode").focus();
                    return;
                }
            }
        });
    }
    //支付方式选择

    var dingshi1='';
    var dingshi2='';
    var imgsrc='{HLMMS_IMG}chenggong.gif';
    var imgsrc3='{HLMMS_IMG}dengdai.gif';
    var imgsrc1='{HLMMS_IMG}shibai.gif';
    function  payStyle_Check(payid){
        var imgsrc1='{HLMMS_IMG}dengdai.png';
        var imgsrc2='{HLMMS_IMG}ma.gif';
        for(var i=1; i<=3;i++){
            $('#payStyle_Check'+i).removeClass('main-right-top-active');
            $('#div_payResultShowOrHide'+i).hide();
            $('#payresult'+i+'-'+i).html('结果区域');
            if(i==1 || i==3 ){
                $('#payresult'+i).attr('src',imgsrc2);
            }else{
                $('#payresult'+i).attr('src',imgsrc2);
            }
        }

        $('#hidden_TextPayCode'+payid).val('');

        $('#payStyle_Check'+payid).addClass('main-right-top-active');
        $('#div_payResultShowOrHide'+payid).show();
        $('#radio_consumePayStyle'+payid).attr('checked', true);
        $('#hidden_TextPayCode'+payid).focus();

    }

    //刷卡
    function ShuaKaPay(){

        var pay_txt_PayNote=$("#txt_PayNote").val();
        var pay_hidden_realMoneyCount=$('#hidden_realMoneyCount').val();
        var pay_get_TextPayCode2=$('#hidden_TextPayCode2').val();
        if(pay_txt_PayNote==''){
            pay_txt_PayNote = "快速消费";
        }
        if(pay_hidden_realMoneyCount=='' || pay_hidden_realMoneyCount=='0' || pay_hidden_realMoneyCount=='0.0' || pay_hidden_realMoneyCount=='0.00'){
            swal("操作异常！", "收款金额不能为空或0,请采用现金支付方式！","error");
            return false;
        }
        var moneyformat=pay_hidden_realMoneyCount.substr(pay_hidden_realMoneyCount.length-1,1);
        if(moneyformat=='.'){
            swal("操作异常！", "收款金额格式错误！","error");
            return false;
        }
        if(PayNoteFomat(pay_txt_PayNote)){
            swal("操作异常！", "备注只能输入汉字！","error");
            return false;
        }
        if(moneryisnum(pay_hidden_realMoneyCount)){
            swal("操作异常！", "收款金额格式错误！","error");
            return false;
        }
        if(pay_get_TextPayCode2==''){
            swal("操作异常！", "付款码不能为空！","error");
            return false;
        }else{
            if(!/^\d{18}$/.test(pay_get_TextPayCode2)){
                swal("操作异常！", "付款码格式不对,应为长度为18位数字,请检查！","error");
                return false;
            }
        }
        var wechatCodePayUrl = "{php echo $this->createWebUrl('doMemberRechargePay', array())}";
        var wechatCodePayParams = {
            'txt_PayNote': pay_txt_PayNote,
            'hidden_realMoneyCount': pay_hidden_realMoneyCount,
            'pay_get_TextPayCode2': pay_get_TextPayCode2
        };
        $("#btn_SaveConsumeOrderData2").hide();
        $.ajax({
            url: wechatCodePayUrl,
            data: wechatCodePayParams,
            type: 'POST',
            dataType: 'json',
            success: function (data) {
                if (data['message']['status'] == 0) {

                    $('#payresult2').attr('src',imgsrc3);
                    dingshi1=setTimeout("PayResultQuery('"+data['message']['out_trade_no']+"','"+data['message']['out_trade_no_type']+"')",3000);
                    //alert(data['message']['msg']);
                } else {
                    $('#payresult2').attr('src',imgsrc1);
                    //alert(data['message']['msg']);
                    setTimeout('waitDoClosePayFalse()',3000);
                }
            }
        });
    }
    function PayResultQuery(out_trade_no,out_trade_no_type){
        if(out_trade_no_type == 'wechatpay'){
            var PayQueryUrl = "{php echo $this->createWebUrl('doAdvancedWechatPayQuery', array())}";
        }else{
            var PayQueryUrl = "{php echo $this->createWebUrl('doAdvancedAliPayQuery', array())}";
        }
        var order_id=out_trade_no;
        var order_type=out_trade_no_type;
        var pay_memberId=$('#memberId').val();
        var pay_memberCardNum=$("#memberCardNum").val();
        var pay_memberName= $("#memberName").val();
        var pay_txt_PayNote=$("#txt_PayNote").val();
        var pay_radio_consumePayStyle=$('input:radio[name="radio_consumePayStyle"]:checked').val();
        var pay_hidden_consumehangupId=$("#hidden_consumehangupId").val();
        var pay_realMoneyCount=$("#realMoneyCount").val();
        var pay_handleMoneyCount= $("#handleMoneyCount").val();
        var pay_preferentialMoney=$("#preferentialMoney").val();
        var pay_get_memberMoneyCount=$("#get_memberMoneyCount").val();
        var pay_get_memberPointsCount=$("#get_memberPointsCount").val();
        var pay_get_PreferentialNumber=$("#get_PreferentialNumber").val();
        var hidden_Cuuponid=$('#hidden_Cuuponid').val();
        var pay_hidden_realMoneyCount=$('#hidden_realMoneyCount').val();
        var hidden_resultPointsCount=$('#hidde_carttotalintegral').val();
        var consumeType="arsl5";
        if(pay_txt_PayNote==''){
            pay_txt_PayNote = "消费收银";
        }
        var PayParams = {
            'out_trade_no': order_id,
            'memberId': pay_memberId,
            'memberCardNum': pay_memberCardNum,
            'hidden_consumehangupId': pay_hidden_consumehangupId,
            'memberName': pay_memberName,
            'realMoneyCount': pay_realMoneyCount,
            'handleMoneyCount': pay_handleMoneyCount,
            'preferentialMoney': pay_preferentialMoney,
            'get_memberMoneyCount': pay_get_memberMoneyCount,
            'get_memberPointsCount': pay_get_memberPointsCount,
            'get_PreferentialNumber': pay_get_PreferentialNumber,
            'txt_PayNote': pay_txt_PayNote,
            'radio_consumePayStyle': pay_radio_consumePayStyle,
            'hidden_Cuuponid': hidden_Cuuponid,
            'hidden_realMoneyCount': pay_hidden_realMoneyCount,
            'hidden_resultPointsCount': hidden_resultPointsCount,
            'consumeType': consumeType
        };

        $.ajax({
            url: PayQueryUrl,
            type: 'POST',
            dataType: 'json',
            data: PayParams,
            success: function (data) {
                if (data['message']['status'] == 1) {
                    $('#payresult2').attr('src',imgsrc);
                    clearTimeout(dingshi1);
                    clearTimeout(dingshi2);
                    setTimeout('waitDoClosePayTrue()',3000);
                }else{
                    //alert(data['message']['msg']);
                    dingshi2=setTimeout("PayResultQuery('"+order_id+"','"+order_type+"')",3000);
                }
            }
        });
    }
    function moneryisnum(monery){
        var reg = new RegExp("^[0-9]+(.[0-9]{1,2})?$");
        if(!reg.test(monery)){
            return true;
        }
        return false;
    }
    function PayNoteFomat(value_txt_PayNote){
        var reg = new RegExp("^[\u4e00-\u9fa5]{0,}$");
        if(!reg.test(value_txt_PayNote)){
            return true;
        }
        return false;
    }
    //现金和一码付收款
    function cashPay(){
        var pay_memberId=$('#memberId').val();
        var pay_memberCardNum=$("#memberCardNum").val();
        var pay_memberName= $("#memberName").val();
        var pay_txt_PayNote=$("#txt_PayNote").val();
        var pay_radio_consumePayStyle=$('input:radio[name="radio_consumePayStyle"]:checked').val();
        var pay_hidden_consumehangupId=$("#hidden_consumehangupId").val();
        var pay_realMoneyCount=$("#realMoneyCount").val();
        var pay_handleMoneyCount= $("#handleMoneyCount").val();
        var pay_preferentialMoney=$("#preferentialMoney").val();
        var pay_get_memberMoneyCount=$("#get_memberMoneyCount").val();
        var pay_get_memberPointsCount=$("#get_memberPointsCount").val();
        var pay_get_PreferentialNumber=$("#get_PreferentialNumber").val();
        var hidden_Cuuponid=$('#hidden_Cuuponid').val();
        var pay_hidden_realMoneyCount=$('#hidden_realMoneyCount').val();
        var hidden_resultPointsCount=$('#hidde_carttotalintegral').val();

        if(pay_txt_PayNote==''){
            pay_txt_PayNote = "消费收银";
        }
//        if(pay_hidden_realMoneyCount=='' || pay_hidden_realMoneyCount=='0' || pay_hidden_realMoneyCount=='0.0' || pay_hidden_realMoneyCount=='0.00'){
//            swal("操作异常！", "收款金额不能为空或0！","error");
//            return false;
//        }
        var moneyformat=pay_hidden_realMoneyCount.substr(pay_hidden_realMoneyCount.length-1,1);
        if(moneyformat=='.'){
            swal("操作异常！", "收款金额格式错误！","error");
            return false;
        }
        if(PayNoteFomat(pay_txt_PayNote)){
            swal("操作异常！", "备注只能输入汉字！","error");
            return false;
        }
        if(moneryisnum(pay_hidden_realMoneyCount)){
            swal("操作异常！", "收款金额格式错误！","error");
            return false;
        }
        var cashPayUrl = "{php echo $this->createWebUrl('memberconsume', array('op' => 'saveCashConsumeData'))}";
        var cashPayParams = {
            'memberId': pay_memberId,
            'memberCardNum': pay_memberCardNum,
            'hidden_consumehangupId': pay_hidden_consumehangupId,
            'memberName': pay_memberName,
            'realMoneyCount': pay_realMoneyCount,
            'handleMoneyCount': pay_handleMoneyCount,
            'preferentialMoney': pay_preferentialMoney,
            'get_memberMoneyCount': pay_get_memberMoneyCount,
            'get_memberPointsCount': pay_get_memberPointsCount,
            'get_PreferentialNumber': pay_get_PreferentialNumber,
            'txt_PayNote': pay_txt_PayNote,
            'radio_consumePayStyle': pay_radio_consumePayStyle,
            'hidden_Cuuponid': hidden_Cuuponid,
            'hidden_realMoneyCount': pay_hidden_realMoneyCount,
            'hidden_resultPointsCount': hidden_resultPointsCount,
        };
        if(pay_radio_consumePayStyle == 1){
            $("#yiMaFuPayhidden").hide();
        }
        if(pay_radio_consumePayStyle == 3){
            $("#cashPayhidden").hide();
        }
        //alert(JSON.stringify(cashPayParams));
        $.ajax({
            url: cashPayUrl,
            data: cashPayParams,
            type: 'POST',
            dataType: 'json',
            success: function (data) {
                //alert(data['message']['code']);
                if (data['message']['code'] == 0) {
                    //alert(pay_radio_consumePayStyle);
                    if(pay_radio_consumePayStyle == 1){
                        $('#payresult1').attr('src',imgsrc);
                        $('#payresult1-1').html('支付成功，支付订单号：'+ data['message']['msg']);
                        setTimeout('waitDoClosePayTrue()',3000);
                    }else{
                        $('#payresult3').attr('src',imgsrc);
                        $('#payresult3-3').html('支付成功，支付订单号：'+ data['message']['msg']);
                        setTimeout('waitDoClosePayTrue()',3000);
                    }
                } else {
                    if(pay_radio_consumePayStyle  == 1){
                        $('#payresult1').attr('src',imgsrc1);
                        setTimeout('waitDoClosePayFalse()',3000);
                    }else{
                        $('#payresult3').attr('src',imgsrc1);
                        setTimeout('waitDoClosePayFalse()',3000);
                    }
                }
            }
        });
    }
    //延迟执行
    function waitDoClosePayTrue(){
        $('#consumeOrderData').modal('hide');
        swal("结账成功！", "","success");
        window.location.reload();
    }
    function waitDoClosePayFalse(){
        $('#consumeOrderData').modal('hide');
        swal("支付失败！", "操作异常，请重新操作结账。","error");
        window.location.reload();
    }



    function Coupontabledatamember(){

        $('#Coupontabledata').bootstrapTable({

            url: '{php echo $this->createWebUrl('couponmarket', array('op' => 'couponlist'));}',
            method:"post",
            dataType: "json",
            contentType: "application/x-www-form-urlencoded",
            cache:false,  //是否使用缓存
            search:false, //显示搜索框
            showPaginationSwitch:false,//是否显示数据条数选择框
            queryParamsType:'',
            queryParams: queryCouponParams,//传递参数（*）
            sidePagination: "server",           //分页方式：client客户端分页，server服务端分页（*）
            pageNumber:1,                       //初始化加载第一页，默认第一页
            pageSize: 10,                       //每页的记录行数（*）
            pageList: [10, 25, 50, 100],
            pagination: true,
            clickToSelect: true,
            selectItemName:"id",
            height: 260,
            uniqueId: "id",
            columns: [{
                radio: true
            },{
                field: 'cou_title',
                title: '名称',
            },{
                field: 'cou_type',
                title: '类型',
                formatter:coutypeFormatter
            }, {
                field: 'cou_extra',
                title: '名称',
                formatter:couextraFormatter
            }, {
                field: 'cou_date_info',
                title: '限制时间',
                formatter:coudateinfoFormatter
            }
            ]
        } );
        function queryCouponParams (params) {
            var temp = {  //这里的键的名字和控制器的变量名必须一直，这边改动，控制器也需要改成一样的
                pageSize: params.pageSize,  //页面大小
                pageNumber: params.pageNumber, //页码
                memberId:$("#memberId").val(),
            };
            return temp;
        };
        function coutypeFormatter(value, row, index) {
            var typeid = value;
            var result = "";
            if(typeid == 1){
                result += "折扣券";
            }
            else if(typeid == 2){

                result += "代金券";
            }
            else if(typeid == 3){

                result += "礼品券";
            }
            else if(typeid == 4){

                result += "团购券";
            }
            else if(typeid == 5){

                result += "优惠券";
            }
            return result;
        }
        function couextraFormatter(value, row, index) {
            var jsonvalue = jQuery.parseJSON(value);
            var result ="";
            if(jsonvalue.least_cost != null ){
                result += "满"+jsonvalue.least_cost +"减"+jsonvalue.reduce_cost ;
            }
            else if(jsonvalue.deal_detail != null){
                result += "团购详细"+jsonvalue.deal_detail ;
            }
            else if(jsonvalue.discount != null){
                result += "打"+jsonvalue.discount + "折" ;
            }
            else if(jsonvalue.gift != null){
                result += "礼品内容"+jsonvalue.gift ;
            }
            else if(jsonvalue.default_detail != null){
                result += "优惠详细"+jsonvalue.gift ;
            }
            return result;
        }
        function coudateinfoFormatter(value, row, index){
            var jsoncoudateinfo = jQuery.parseJSON(value);
            var result = jsoncoudateinfo.time_limit_start + "--" + jsoncoudateinfo.time_limit_end;
            return result;
        }
        $("#btn_SaveGoodsId").click(function () {

            var hidden_realMoneyCount =  $("#hidden_realMoneyCount").val()
            var arrselections = $("#Coupontabledata").bootstrapTable('getSelections');
            var ids="";
            for(var i=0;i<arrselections.length;i++){
                if(i==0 || i=="0"){
                    ids+=arrselections[i].id;
                }else{
                    ids+=","+arrselections[i].id;
                }
            }
            var idArrdata=ids.split(",")
            if (arrselections.length <= 0) {
                swal("操作有误", "请选择要设置的项目！","error");
                return;
            }
            else{
                $.ajax({
                    type: "post",
                    dataType: 'jsonp',
                    url: "{php echo $this->createWebUrl('couponmarket', array('op' => 'ajaxgetcoupondata'))}",
                    data: { idArr:idArrdata },
                    success: function (data) {
                        $('#rechargeGoodsId').modal('hide')
                        var jsoncouextra = jQuery.parseJSON(data.cou_extra);

                        if(data.cou_type == 1){
                            var discount = jsoncouextra.discount;
                            var nowrealMoneyCountdiscount = (discount * 0.01) * hidden_realMoneyCount;
                            var LessrealMoneyCount = hidden_realMoneyCount-nowrealMoneyCountdiscount;
                            $("#get_PreferentialNumber").attr("value",LessrealMoneyCount);
                            $("#hidden_realMoneyCount").attr("value",nowrealMoneyCountdiscount);
                            $("#get_PreferentialNumber").attr("readonly",true);
                            $("#hidden_Cuuponid").attr("value",data.id);
                        }
                        else if(data.cou_type == 2){
                            var reduce_cost = jsoncouextra.least_cost;
                            if(hidden_realMoneyCount > reduce_cost){
                                var nowrealMoneyCountdiscount =  hidden_realMoneyCount - jsoncouextra.reduce_cost;
                                $("#get_PreferentialNumber").attr("value",jsoncouextra.reduce_cost);
                                $("#hidden_realMoneyCount").attr("value",nowrealMoneyCountdiscount);
                                $("#get_PreferentialNumber").attr("readonly",true);
                                $("#hidden_Cuuponid").attr("value",data.id);
                            }else {
                                swal("未满足条件", "请关闭重新操作！","error");
                            }
                        }else{
                            $("#get_PreferentialNumber").attr("value","");
                            $("#get_PreferentialNumber").attr("readonly",false);
                            $("#hidden_Cuuponid").attr("value",data.id);
                        }
                    },
                    error: function () {
                        swal("操作有误", "请关闭重新操作！","error");
                    },
                    complete: function () {

                    }

                });
            }

        });
        function serachGoods() {
            $("#Coupontabledata").bootstrapTable('refresh');
        }
    }

    //手动更改储值和积分抵现支付金额
    $("#get_memberMoneyCount").on('keyup', function () {
        var a = Math.round(parseFloat($("#get_memberMoneyCount").val()) * 100) / 100;
        var b = Math.round(parseFloat($("#get_memberPointsCount").val()) * 100) / 100;
        var realMoneyCount = Math.round(parseFloat($("#realMoneyCount").val()) * 100) / 100;
        if(a+b >realMoneyCount){
            swal("操作异常！", "不能超出实付金额","error");
            $("#hidden_realMoneyCount").attr("value","0.00");
        }else{
            $("#hidden_realMoneyCount").attr("value",realMoneyCount - a- b);
        }

    });
    $("#get_memberPointsCount").on('keyup', function () {
        var a = Math.round(parseFloat($("#get_memberMoneyCount").val()) * 100) / 100;
        var b = Math.round(parseFloat($("#get_memberPointsCount").val()) * 100) / 100;
        var realMoneyCount = Math.round(parseFloat($("#realMoneyCount").val()) * 100) / 100;
        if(a+b >realMoneyCount){
            swal("操作异常！", "不能超出实付金额","error");
            $("#hidden_realMoneyCount").attr("value","0.00");
        }else{
            $("#hidden_realMoneyCount").attr("value",realMoneyCount - a- b);
        }

    });
    $("#get_PreferentialNumber").on('keyup', function () {
        var a = Math.round(parseFloat($("#get_memberMoneyCount").val()) * 100) / 100;
        var b = Math.round(parseFloat($("#get_memberPointsCount").val()) * 100) / 100;
        var c = Math.round(parseFloat($("#get_PreferentialNumber").val()) * 100) / 100;
        var realMoneyCount = Math.round(parseFloat($("#realMoneyCount").val()) * 100) / 100;
        if(a+b+c >realMoneyCount){
            swal("操作异常！", "不能超出实付金额","error");
            $("#hidden_realMoneyCount").attr("value","0.00");
        }else{
            $("#hidden_realMoneyCount").attr("value",realMoneyCount - a- b-c);
        }

    });


</script>
{template 'web/common/footer'}