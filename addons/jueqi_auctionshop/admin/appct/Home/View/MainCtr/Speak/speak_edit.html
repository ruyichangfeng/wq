<include file="Public/header.html" />
<link rel="stylesheet" type="text/css" href="__ROOT__/Public/lib/layui/css/modules/laydate/default/laydate.css" >
</head>
<body>
	<div class="x-body">
		<form class="layui-form">
			
			<div class="layui-form-item">			    
		      	<label class="layui-form-label">晒单时间</label>
		      	<div class="layui-input-block">
					<input type="text" name="createtime" lay-verify="required" class="layui-input" id="test1" placeholder="yyyy-MM-dd HH:mm:ss" value="<?php if(!empty($speak['createtime'])){echo date('Y-m-d H:i:s', $speak['createtime']);}else{echo date('Y-m-d H:i:s', time());}; ?>">
		      	</div>				      				    
			</div>
			
			<div class="layui-form-item">
				<label class="layui-form-label">选择用户</label>
				<div class="layui-input-block">					
					<input type="text" readonly="readonly" id="nickname" name="nickname" value="{$speak['nickname']}" class="layui-input">
					<input type="hidden" name="mid" id="mid" value="{$speak['mid']}">
				</div>
			</div>
			
			<div class="layui-form-item">
				<label class="layui-form-label">选择商品</label>
				<div class="layui-input-block">
					<input type="text" readonly="readonly" id="goodsname" name="goodsname" autocomplete="off" value="{$speak['goodsname']}" class="layui-input">
					<input type="hidden" name="goodsid" id="goodsid" value="{$speak['goodsid']}">
				</div>
			</div>
			<div class="layui-form-item">
				<label class="layui-form-label">星级</label>
				<div class="layui-input-block">
					<input type="text" lay-verify="required" name="star" autocomplete="off" value="{$speak['star']}" class="layui-input">
				</div>
			</div>
			<div class="layui-form-item">
				<label class="layui-form-label">内容</label>
				<div class="layui-input-block">
					<input type="text" lay-verify="required" name="content" autocomplete="off" value="{$speak['content']}" class="layui-input">
				</div>
			</div>
			
			 	
			<div class="layui-form-item">
                <label  class="layui-form-label">添加图片</label>
                <div class="layui-input-block">
	            
				  <input style="display: none;" type="file" id="pics"  onchange="previewImage(this,1,'speak_img_val')"   multiple  class="input-file">
	              <input style="display: none;" type="file" id="pics1"  onchange="previewImage(this,2,'speak_img1_val')"   multiple  class="input-file">
	              <input style="display: none;" type="file" id="pics2"  onchange="previewImage(this,3,'speak_img2_val')"   multiple  class="input-file">
	              
	              <div>
	                   <img id="imghead1" border="0"  style="margin-top: 5px;max-height:100px;"                   	
	                   <?php 
	                   	   if( empty($pics[0]) ){
	                   	   	   echo 'src="__ROOT__/Public/images/z_add.png"   onclick="$(\'#pics\').click();"';
	                   	   }else{
	                   	       echo 'src="__ROOT__/Uploads/'.$pics[0].'" onclick="$(\'#pics\').click();"';
	                   	   }
	                    ?>
	                   >
	                   
	                   <img id="imghead2" border="0"  style="margin-top: 5px;max-height:100px;"                   	
	                   <?php 
	                   	   if( empty($pics[1]) ){
	                   	   	   echo 'src="__ROOT__/Public/images/z_add.png"   onclick="$(\'#pics1\').click();"';
	                   	   }else{
	                   	       echo 'src="__ROOT__/Uploads/'.$pics[1].'" onclick="$(\'#pics1\').click();"';
	                   	   }
	                    ?>
	                   >
	                   
	                   <img id="imghead3" border="0"  style="margin-top: 5px;max-height:100px;"                   	
	                   <?php 
	                   	   if( empty($pics[2]) ){
	                   	   	   echo 'src="__ROOT__/Public/images/z_add.png"   onclick="$(\'#pics2\').click();"';
	                   	   }else{
	                   	       echo 'src="__ROOT__/Uploads/'.$pics[2].'" onclick="$(\'#pics2\').click();"';
	                   	   }
	                    ?>
	                   >
	                   
	                </div>
	                
                 </div>
            </div>
            
            
			<div class="layui-form-item">
				<label for="role" class="layui-form-label">
                        <span class="x-red">*</span>状态
                    </label>
				<div class="layui-input-inline">
					<select name="status">
						<option value="0" <?php if($speak['status']=='0' ){ echo 'selected';};?> >未审核</option>
						<option value="1" <?php if($speak['status']=='1' ){ echo 'selected';};?> >已审核</option>
					</select>
					<div class="layui-unselect layui-form-select layui-form-selected">
						<div class="layui-select-title"><input type="text" placeholder="请选择角色" value="" readonly="" class="layui-input layui-unselect"><i class="layui-edge"></i></div>
						<dl class="layui-anim layui-anim-upbit" style="">
							<dd lay-value="未审核" class="">未审核</dd>
							<dd lay-value="已审核" class="">已审核</dd>
						</dl>
					</div>
				</div>
			</div>
			<input type="hidden" name="id" value="{$speak['id']}" />
 			<input type="hidden"  id="speak_img_val" value="" >
 			<input type="hidden"  id="speak_img1_val" value="" >
 			<input type="hidden"  id="speak_img2_val" value="" >
 			
			<div class="layui-form-item" style="display: none;">
                <label for="L_sign" class="layui-form-label"></label>
               <button class="layui-btn" id="submitBtn" key="set-mine" lay-filter="save" lay-submit> </button>
            </div>

		</form>
	</div>

	<include file="Public/footer.html" />
	<script type="text/javascript" src="__ROOT__/Public/js/tools.js"></script> 
	<script type="text/javascript" src="__ROOT__/Public/lib/layui/lay/modules/laydates.js?2018"></script>
	<script type="text/javascript" src="__ROOT__/Public/js/jquery.min.js"></script>
	<script>
		layui.use(['form', 'layer','laydate'], function() {
			$ = layui.jquery;
			var form = layui.form;
			var layer = layui.layer;
			laydate = layui.laydate;//日期插件
			
			laydate.render({
		    	elem: '#test1' //指定元素
		    	,type: 'datetime'
		  	});
			
			form.on('submit(save)', function(data) {
				var tjing = parent.layer.msg('提交中...', {icon: 16,shade: 0.3,time: 60*1000}); 
		        var form=document.forms[0];
	  		    var formData = new FormData(form);  
	  		    
			    if($("#speak_img_val").val()!=''){
			      formData.append("pics",convertBase64UrlToBlob($("#speak_img_val").val()));
				} 
				if($("#speak_img1_val").val()!=''){
			      formData.append("pics1",convertBase64UrlToBlob($("#speak_img1_val").val()));
				} 
				if($("#speak_img2_val").val()!=''){
			      formData.append("pics2",convertBase64UrlToBlob($("#speak_img2_val").val()));
				} 

				$.ajax({
					type: 'POST',
					url: "{:U('Home/MainCtr/Speak/do_speak')}",
					data: formData,
					processData : false,         
			        contentType : false,    
					dataType: 'text',
					success: function(data) {
						if(data == '1') {
							var index = parent.layer.getFrameIndex(window.name);
							parent.layer.msg('提交成功', {
								icon: 1,
								offset: '40%',
								time: 2000,
								shade: 0.3
							}, function() {
								parent.location.reload();
							})
						} else if(data == '2') {
							parent.layer.msg('提交失败', {
								icon: 2,
								offset: '40%',
								time: 2000,
								shade: 0.3
							});
						} else {
							parent.layer.msg(data, {
								icon: 2,
								offset: '40%',
								time: 2000,
								shade: 0.3
							});
						}
					}
				});

				return false;
			});

		});
		
		
		function convertBase64UrlToBlob(urlData){
		    var bytes=window.atob(urlData.split(',')[1]);    
		    var ab = new ArrayBuffer(bytes.length);
		    var ia = new Uint8Array(ab);
		    for (var i = 0; i < bytes.length; i++) {
		        ia[i] = bytes.charCodeAt(i);
		    }
		    return new Blob( [ab] , {type : 'image/jpg'});
	    }
	    
	        
	   function previewImage(file,flag,ob){
	     var img =$('#imghead'+flag);
	     var oFile = file.files[0]; 
	    
	     if(!new RegExp("(jpg|jpeg|png)+","gi").test(oFile.type)){  
	          layer.msg("照片上传：文件类型必须是JPG、JPEG、PNG", {icon: 2,offset: '40%',time:2000,shade: 0.3});
	          return;  
	     }
	     var reader = new FileReader();  
	     var tjing =  parent.layer.msg('图片加载中', {icon: 16,shade: 0.3,time: 60*1000});
	     reader.onload = function(e) {  
	        var base64Img= e.target.result;
	        var _ir=ImageResizer({  
	        resizeMode:"auto"  
	        ,dataSource:base64Img  
	        ,dataSourceType:"base64"  
	        ,maxWidth:1200   
	        ,maxHeight:1200 
	        ,onTmpImgGenerate:function(img){ }   
	        ,success:function(resizeImgBase64,canvas){
			parent.layer.close(tjing);
			img.attr("src",resizeImgBase64);  
		    $('#'+ob).val(resizeImgBase64.substr(22));
			
	        },debug:false});            
	     };  
	     reader.readAsDataURL(oFile);  
	   }
	   
	   	$('#nickname').click(function(){
			parent.m_show('用户列表','{:U("Home/MainCtr/Insider/m_list")}','1000','');
		})	
		
		$('#goodsname').click(function(){
			parent.g_show('商品列表','{:U("Home/MainCtr/Insider/g_list",array("flag"=>"speak"))}','1000','');
		})
  
	</script>

</body>

</html>