{template 'web/common/header'}
<div class="wrapper wrapper-content animated fadeInRight">
    <div class="row">
        <div class="col-sm-12">
            <div class="ibox float-e-margins">
                <div class="ibox-content">
                    <form action="" id="goodsform" class="form-horizontal" method="post" enctype="multipart/form-data" onsubmit="return check(this);">
                            <div class="panel panel-default" id="step1">
                                <div class="panel-heading">
                                    {php echo $coupon_title}
                                </div>
                                <div class="panel-body" style="margin-left: 200px;">
                                    <div class="pull-left" style="width:320px;background:#F4F5F9;margin-right:0px;border:1px solid #E7E7EB">
                                        <style>
                                            .card-titlenews {
                                                background:url("{HLMMS_IMG}card.png")  no-repeat scroll 0 -84px transparent;
                                                color: #fff;
                                                font-size: 17px;
                                                height: 62px;
                                                line-height: 85px;
                                                text-align: center
                                            }
                                        </style>
                                        <div class="card-titlenews">{php echo $coupon_title}</div>
                                        <div class="card_section area" style="position: relative">
                                            <div class="shop-panel" id="color-purview" style="background: #a9d92d">
                                                <div class="logo-area">
                                                    <span class="logo pull-left"><img src="{php echo $setting['logourl'];}" alt=""/></span>
                                                    <div class="pull-left" style="height:38px;line-height:38px" id="brand_name">商户信息</div>
                                                    <div class="clear"></div>
                                                </div>
                                                <div class="msg-area">
                                                    <div class="tick-msg">
                                                        <p><b id="title-purview">{php echo $coupon_title}标题</b></p>
                                                        <p id="sub-title-purview">{php echo $coupon_title}副标题</p>
                                                    </div>
                                                    <p id="sub-time-purview" style="text-align: center">有效期:{php  echo date('Y-m-d')} ~ {php  echo date('Y-m-d', time() + 30 * 86400)}</p>

                                                </div>
                                                <div class="deco"></div>
                                                <div class="cicon">
                                                    <a href="javascript:;" data-id="form1"><i class="fa fa-pencil"></i></a>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card-dispose area">
                                            <div class="unset" id="destroy_title">
                                                <p>销券设置</p>

                                            </div>
                                            <div class="destroy_type_preview">
                                                <div class="barcode-area code_preview code_preview_3" style="display: block">
                                                    <div class="barcode"></div>
                                                    <p class="code_num">1513-2290-1878</p>
                                                </div>
                                                <div class="qrcode-area code_preview code_preview_2">
                                                    <div class="qrcode"></div>
                                                    <p class="code_num">1513-2290-1878</p>
                                                </div>
                                                <div class="sn-area code_preview code_preview_1">1513-2290-1878</div>
                                                <p style="text-align: center" id="notice-purview">请在付款时出示此券</p>
                                            </div>
                                            <div class="cicon">
                                                <a href="javascript:;" data-id="form2"><i class="fa fa-pencil"></i></a>
                                            </div>
                                        </div>
                                        <div class="shop-detail">
                                            <ul class="list">
                                                <li>
                                                    <div class="li-panel area">
                                                        <div class="li-content">{php echo $coupon_title}设置</div>
                                                        <span class="ricon fa fa-angle-right"></span>
                                                        <div class="cicon">
                                                            <a href="javascript:;" data-id="form3"><i class="fa fa-pencil"></i></a>
                                                        </div>
                                                    </div>
                                                </li>
                                            </ul>
                                        </div>
                                        <div class="shop-detail">
                                            <ul class="list">
                                                <li>
                                                    <div class="li-panel area" style="border-bottom: none">
                                                        <div class="li-content" id="promotion_url_name">个人中心</div>
                                                        <div class="ricon"><span id="promotion_url_sub_title">点击进入 </span><i class="fa fa-angle-right"></i></div>
                                                        <div class="cicon">
                                                            <a href="javascript:;" data-id="form6"><i class="fa fa-pencil"></i></a>
                                                        </div>
                                                    </div>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="pull-left alert form form-area" style="width:700px;position:relative;display:block;" id="form1">
                                        <div class="arrow_in"></div>
                                        <h4 style="margin-top:20px;">券面信息</h4>
                                        <input type="hidden" name="typenameid" id="typenameid" value="{php echo $typename}" />
                                        <div class="form-group">
                                            <label class="col-xs-12 col-sm-3 col-md-2 control-label">是否上架</label>
                                            <div class="col-sm-9 col-xs-12">
                                                <label class="radio radio-info radio-inline">
                                                    <input type="radio" name="goostatus" ID="goostatus1" value="1" checked/>
                                                    <label for="goostatus1"> 上架 </label>
                                                </label>
                                                <label class="radio radio-info radio-danger">
                                                    <input type="radio" name="goostatus" id="goostatus2" value="2">
                                                    <label for="goostatus2"> 下架 </label>
                                                </label>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="col-xs-12 col-sm-3 col-md-2 control-label"><span class="text-danger">*</span> 商户LOGO</label>
                                            <div class="col-sm-9 col-xs-12" id="logo_upload">
                                                {php echo tpl_form_field_image('merchantslogo', $item['goo_picture'])}
                                                <div class="help-block">商户LOGO大小不超过1M。像素为：300*300。仅支持JPG格式</div>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="col-xs-12 col-sm-3 col-md-2 control-label"><span class="text-danger">*</span> 商户名称</label>
                                            <div class="col-sm-9 col-xs-12">
                                                <input type="text" class="form-control" name="brand_names" id="brand_names"/>
                                                <div class="help-block">商户名字,字数上限为12个汉字。 </div>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="col-xs-12 col-sm-3 col-md-2 control-label"><span class="text-danger">*</span> 卡券颜色</label>

                                            {php echo tpl_coupon_colors('color', 'Color082');}

                                        </div>
                                        <div class="form-group">
                                            <label class="col-xs-12 col-sm-3 col-md-2 control-label"><span class="text-danger">*</span> {php echo $coupon_title}标题</label>
                                            <div class="col-sm-9 col-xs-12">
                                                <input type="text" class="form-control" name="title" id="title"/>
                                                <div class="help-block">建议填写{php echo $coupon_title}“减免金额”及自定义内容，描述卡券提供的具体优惠。不超过9个字符</div>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="col-xs-12 col-sm-3 col-md-2 control-label"> {php echo $coupon_title}副标题(可选)</label>
                                            <div class="col-sm-9 col-xs-12">
                                                <input type="text" class="form-control" name="sub_title"/>
                                                <div class="help-block">不超过18个字符</div>
                                            </div>
                                        </div>
                                        {if $typename == 1}
                                        <div class="form-group">
                                            <label class="col-xs-12 col-sm-3 col-md-2 control-label"><span class="text-danger">*</span> 折扣额度</label>
                                            <div class="col-sm-9 col-xs-12">
                                                <div class="input-group">
                                                    <input type="text" class="form-control" name="discount" value="80"/>
                                                    <span class="input-group-addon">折</span>
                                                </div>
                                                <div class="help-block">表示打折额度（百分比）。填30就是3折。填写整数</div>
                                            </div>
                                        </div>
                                        {elseif $typename == 2}
                                        <div class="form-group">
                                            <label class="col-xs-12 col-sm-3 col-md-2 control-label"><span class="text-danger">*</span> 减免金额</label>
                                            <div class="col-sm-9 col-xs-12">
                                                <div class="input-group">
                                                    <span class="input-group-addon">满</span>
                                                    <input type="text" class="form-control" name="least_cost" value=""/>
                                                    <span class="input-group-addon">减</span>
                                                    <input type="text" class="form-control" name="reduce_cost"/>
                                                    <span class="input-group-addon">元</span>
                                                </div>
                                            </div>
                                        </div>
                                        {elseif $typename == 3}
                                        <div class="form-group">
                                            <label class="col-xs-12 col-sm-3 col-md-2 control-label"><span class="text-danger">*</span> 礼品券详情</label>
                                            <div class="col-sm-9 col-xs-12">
                                                <textarea name="gift" id="gift" class="form-control" rows="7"></textarea>
                                            </div>
                                        </div>
                                        {elseif $typename == 4}
                                        <div class="form-group">
                                            <label class="col-xs-12 col-sm-3 col-md-2 control-label"><span class="text-danger">*</span> 团购券详情</label>
                                            <div class="col-sm-9 col-xs-12">
                                                <textarea name="deal_detail" id="deal_detail" class="form-control" rows="7"></textarea>
                                            </div>
                                        </div>
                                        {elseif $typename == 5}
                                        <div class="form-group">
                                            <label class="col-xs-12 col-sm-3 col-md-2 control-label"><span class="text-danger">*</span> 优惠券详情</label>
                                            <div class="col-sm-9 col-xs-12">
                                                <textarea name="default_detail" id="default_detail" class="form-control" rows="7"></textarea>
                                            </div>
                                        </div>
                                        {/if}
                                        <div class="form-group">
                                            <label class="col-xs-12 col-sm-3 col-md-2 control-label" style="padding-top:15px"> 有效期</label>
                                            <div class="col-sm-9 col-xs-12">
                                                <div class="radio radio-info radio-inline">
                                                    <input type="radio" name="time_type" id="time_type1" value="1" checked>
                                                    <label style="margin-left: 10px; margin-right: 20px;" for="time_type1"> 固定日期 </label>
                                                    {php  echo tpl_form_field_daterange('time_limit', array('start' => date('Y-m-d'), 'end' => date('Y-m-d', time() + 30*86400)));}
                                                </div>
                                                <div class="radio radio-info radio-inline">
                                                    <div class="col-sm-3"  style="padding-top:6px; padding-left: 9px;">
                                                        <input type="radio" value="2" name="time_type" id="time_type2"/>
                                                        <label for="time_type2">领取后 </label>
                                                    </div>
                                                    <div class="col-sm-3">
                                                        <select name="deadline" id="deadline" class="form-control">
                                                            <?php
										for($i=0; $i<=90; $i++) {
											if(!$i) $n = '当'; else $n = $i;
											echo '<option value="'.$i.'">'.$n.'天</option>';
                                                            }
                                                            ?>
                                                        </select>
                                                    </div>
                                                    <div class="col-sm-3">有效,有效期</div>
                                                    <div class="col-sm-3">
                                                        <select name="limit" id="limit" class="form-control">
                                                            <?php
										for($i=1; $i<=90; $i++) {
											echo '<option value="'.$i.'">'.$i.'天</option>';
                                                            }
                                                            ?>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="pull-left alert form hidden form-area" style="width:700px;position:relative;" id="form2">
                                        <div class="arrow_in"></div>
                                        <h4 style="margin-top:20px;">领券设置</h4>
                                        <div class="form-group">
                                            <label class="col-xs-12 col-sm-3 col-md-2 control-label"><span class="text-danger">*</span> 库存</label>
                                            <div class="col-sm-9 col-xs-12">
                                                <div class="input-group">
                                                    <input type="text" class="form-control" name="quantity" value="300"/>
                                                    <span class="input-group-addon">份</span>
                                                </div>
                                                <div class="help-block">库存只能是大于0的数字</div>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="col-xs-12 col-sm-3 col-md-2 control-label"><span class="text-danger"></span> 领券限制</label>
                                            <div class="col-sm-9 col-xs-12">
                                                <div class="input-group">
                                                    <input type="text" class="form-control" name="get_limit" value="1"/>
                                                    <span class="input-group-addon">份</span>
                                                </div>
                                                <div class="help-block">默认领券限制为1</div>
                                            </div>
                                        </div>
                                        <?php  if(COUPON_TYPE == WECHAT_COUPON) { ?>
                                        <div class="form-group">
                                            <label class="col-xs-12 col-sm-3 col-md-2 control-label"></label>
                                            <div class="col-sm-9 col-xs-12">
                                                <div class="checkbox">
                                                    <label><input type="checkbox" name="can_share" value="1" checked /> 用户可以分享领券链接</label>
                                                </div>
                                                <div class="checkbox">
                                                    <label><input type="checkbox" name="can_give_friend" value="1" checked /> 用户领券后可转赠其他好友</label>
                                                </div>
                                            </div>
                                        </div>
                                        <h4 style="margin-top:20px;">销券设置</h4>
                                        <div class="form-group">
                                            <label class="col-xs-12 col-sm-3 col-md-2 control-label">销券方式</label>
                                            <div class="col-sm-9 col-xs-12">
                                                <div class="radio">
                                                    <label><input type="radio"  class="" name="code_type" value="1"/> 仅卡券号</label>
                                                    <div class="help-block">只显示卡券号，验证后可进行销券</div>
                                                </div>
                                                <div class="radio">
                                                    <label><input type="radio"  class="" name="code_type" value="2"/> 二维码</label>
                                                    <div class="help-block">包含卡券信息的二维码，扫描后可进行销券</div>
                                                </div>
                                                <div class="radio">
                                                    <label><input type="radio"  class="" name="code_type" value="3" checked/> 条形码</label>
                                                    <div class="help-block">包含卡券信息的条形码，扫描后可进行销券</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="col-xs-12 col-sm-3 col-md-2 control-label"><span class="text-danger">*</span> 操作提示</label>
                                            <div class="col-sm-9 col-xs-12">
                                                <input type="text" class="form-control" name="notice" id="notice" value="请在付款时出示此券"/>
                                                <div class="help-block">建议引导用户到店出示卡券，由店员完成核销操作。不超过16个字符</div>
                                            </div>
                                        </div>
                                        <?php  } ?>
                                    </div>
                                    <div class="pull-left alert form hidden form-area" style="width:700px;position:relative;" id="form3">
                                        <div class="arrow_in"></div>
                                        <h4 style="margin-top:20px;"><?php  echo $coupon_title;?>详情</h4>
                                        <div class="form-group">
                                            <label class="col-xs-12 col-sm-3 col-md-2 control-label"><span class="text-danger">*</span> 使用须知</label>
                                            <div class="col-sm-9 col-xs-12">
                                                <textarea name="description" id="description" class="form-control" rows="10"></textarea>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="col-xs-12 col-sm-3 col-md-2 control-label"><span class="text-danger">*</span> 客服电话</label>
                                            <div class="col-sm-9 col-xs-12">
                                                <input type="text" class="form-control" name="service_phone"/>
                                                <div class="help-block">手机或固话</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="pull-left alert form hidden form-area" style="width:700px;position:relative;" id="form4">
                                        <input type="hidden" name="location-select" value="" autocomplete="off"/>
                                        <input type="hidden" name="groups" value="" autocomplete="off"/>
                                        <div class="arrow_in"></div>
                                        <h4 style="margin-top:20px;">服务信息</h4>
                                        <div class="form-group">
                                            <label class="col-xs-12 col-sm-3 col-md-2 control-label"><span class="text-danger"></span> 适用门店</label>
                                            <div class="col-sm-9 col-xs-12">
                                                <label class="radio"><a href="#location-store-modal" data-toggle="modal" class="js-location-store-modal">选择适用门店</a></label>
                                                <div class="js-location-contain"></div>
                                                <div class="help-block">默认为适用于全部门店</div>
                                            </div>
                                        </div>
                                        <?php  if(COUPON_TYPE == WECHAT_COUPON) { ?>
                                        <div class="form-group">
                                            <label class="col-xs-12 col-sm-3 col-md-2 control-label"><span class="text-danger">*</span> 可用会员组</label>
                                            <div class="col-sm-9 col-xs-12">
                                                <label class="radio"><a href="#groups-modal" data-toggle="modal" class="js-groups-modal">选择可用会员组</a></label>
                                                <div class="js-groups-contain"></div>
                                                <div class="help-block">默认为全部用户组可用</div>
                                            </div>
                                        </div>
                                        <?php  } ?>
                                    </div>
                                    <div class="pull-left alert form hidden form-area" style="width:700px;position:relative;" id="form6">
                                        <div class="arrow_in"></div>
                                        <h4 style="margin-top:20px;">营销入口</h4>
                                        <div class="form-group">
                                            <label class="col-xs-12 col-sm-3 col-md-2 control-label"><span class="text-danger"></span> 营销场景的自定义入口名称</label>
                                            <div class="col-sm-9 col-xs-12">
                                                <input type="text" class="form-control" name="promotion_url_name" value="个人中心"/>
                                                <div class="help-block">如：个人中心。</div>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="col-xs-12 col-sm-3 col-md-2 control-label"><span class="text-danger"></span> 跳转链接</label>
                                            <div class="col-sm-9 col-xs-12">
                                                <input type="text" class="form-control" name="promotion_url" value="<?php  echo murl('mc/home', array(), true, true);?>"/>
                                                <div class="help-block">入口跳转链接地址。需要以"http://"或"https://"开头</div>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="col-xs-12 col-sm-3 col-md-2 control-label"><span class="text-danger"></span> 营销入口右侧的提示语</label>
                                            <div class="col-sm-9 col-xs-12">
                                                <input type="text" class="form-control" name="promotion_url_sub_title" value="点击进入"/>
                                                <div class="help-block">营销入口右侧的提示语.不超过6个汉字</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="col-sm-12" style="text-align: center;">
                                    <button name="submit" type="button" class="btn btn-primary col-lg-1" onclick="CouponManageSubmit();">提交</button>
                                    </div>
                                </div>
                            </div>

                        </form>

                </div>
            </div>
        </div>
    </div>
</div>



<script>
    $('.list li,.card-dispose,.shop-panel').hover(function(){
        $(this).find('.cicon').show();
        $(this).addClass('hover');
    }, function(){
        $(this).find('.cicon').hide();
        $(this).removeClass('hover');
    });
    $('#form1').mouseover(function(){
        var bg_color = $(':input[name="color-value"]').val();
        if(!bg_color) {
            bg_color = '#a9d92d';
        }
        $('#color-purview').css('background-color', bg_color);
        if($(':input[name="title"]').val()) {
            $('#title-purview').html($(':input[name="title"]').val());
        }
        if($(':input[name="sub_title"]').val()) {
            $('#sub-title-purview').html($(':input[name="sub_title"]').val());
        }
        if($(':input[name="brand_name"]').val()) {
            $('#brand_name').html($(':input[name="brand_name"]').val());
        }
        $('.logo-area img').attr('src', $('#logo_upload img').attr('src'));
        var time_type = $(':radio[name="time_type"]:checked').val();
        var time = '';
        if(time_type == 1) {
            var startime = $("input[name='time_limit[start]']").val();
            var endtime = $("input[name='time_limit[end]']").val();
            time = '有效期:'+startime+'~'+endtime;
        } else if(time_type == 2) {
            var deadline = parseInt($('#deadline').val());
            var limit = parseInt($('#limit').val());
            var now = new Date();
            now.setHours(0, 0, 0);
            var unixtime =Date.parse(now)/1000;
            unixtime += (deadline*86400);
            var startime = new Date(parseInt(unixtime) * 1000).toLocaleString().substr(0,9).replace(/\//g, "-");
            unixtime += (limit*86400);
            var endtime = new Date(parseInt(unixtime) * 1000).toLocaleString().substr(0,9).replace(/\//g, "-");
            time = '有效期:'+startime+'~'+endtime;
        }
        $('#sub-time-purview').html(time);
    });

    $('.area').click(function() {
        $(this).find('.cicon a').children().trigger('click');
    });
    $('.cicon a').click(function(){
        $('.form').addClass('hidden');
        var top = $(this).offset().top;
        $('#'+$(this).attr('data-id')).css('margin-top',(top-300))
        $('#'+$(this).attr('data-id')).removeClass('hidden');
        return false;
    })

    $('#form2').mouseover(function(){
        var code_type = $('#form2 :radio[name="code_type"]:checked').val() || 0;
        if(code_type) {
            $('#destroy_title').hide();
            $('.code_preview').hide();
            $('.code_preview_' + code_type).show();
        }
        $('#notice-purview').html($('#form2 :text[name="notice"]').val());
    });
    //初始化checkbox状态
    $('input[name$="[]"]').prop('checked', false);

    function CouponManageSubmit() {
        var goostatus = $("input[name='goostatus']:checked").val();
        var merchantslogo =  $("input[name='merchantslogo']").val();//商家logo
        var brand_names =  $("input[name='brand_names']").val();//商家名称
        var color =  $("input[name='color']").val();//背景颜色
        var title =  $("input[name='title']").val();//标题
        var sub_title =  $("input[name='sub_title']").val();//副标题
        var discount =  $("input[name='discount']").val();// 折扣额度
        var description =  $("#description").val();
        var service_phone =  $("input[name='service_phone']").val();//客服电话
        var quantity =  $("input[name='quantity']").val();// 库存
        var get_limit =  $("input[name='get_limit']").val();// 限制数量
        var promotion_url_name =  $("input[name='promotion_url_name']").val();//自定义入口
        var promotion_url =  $("input[name='promotion_url']").val();// 跳转路径
        var promotion_url_sub_title =  $("input[name='promotion_url_sub_title']").val();// 提醒语句
        var least_cost =  $("input[name='least_cost']").val();// 减免金额的满
        var reduce_cost =  $("input[name='reduce_cost']").val();// 减免金额的减
        var gift =  $("#gift").val();// 礼品券详情
        var deal_detail =  $("#deal_detail").val();// 团购券详情
        var time_start =  $("input[name='time_limit[start]']").val();// 开始时间
        var time_end =  $("input[name='time_limit[end]").val();// 开始时间
        var time_type = $("input[name='time_type']:checked").val();//计时方式
        var typenameid =  $("#typenameid").val();// 领取后结束时间
        var default_detail =  $("#default_detail").val();// 领取后结束时间

        var deadline = parseInt($('#deadline').val());
        var limit = parseInt($('#limit').val());
        var now = new Date();
        now.setHours(0, 0, 0);
        var unixtime =Date.parse(now)/1000;
        unixtime += (deadline*86400);
        var startime = new Date(parseInt(unixtime) * 1000).toLocaleString().substr(0,9).replace(/\//g, "-");
        unixtime += (limit*86400);
        var endtime = new Date(parseInt(unixtime) * 1000).toLocaleString().substr(0,9).replace(/\//g, "-");

            var url =  "{php echo $this->createWebUrl('couponmanage', array('op' => 'CouponManageSubmit'))}";
            var params = {
                'goostatus':goostatus,
                'merchantslogo':merchantslogo,
                'brand_title':brand_names,
                'color':color,
                'title':title,
                'sub_title':sub_title,
                'discount':discount,
                'description':description,
                'service_phone':service_phone,
                'quantity':quantity,
                'get_limit':get_limit,
                'promotion_url_name':promotion_url_name,
                'promotion_url':promotion_url,
                'promotion_url_sub_title':promotion_url_sub_title,
                'least_cost':least_cost,
                'reduce_cost':reduce_cost,
                'gift':gift,
                'deal_detail':deal_detail,
                'time_start':time_start,
                'time_type':time_type,
                'time_end':time_end,
                'deadline':deadline,
                'limit':limit,
                'typenameid':typenameid,
                'startime':startime,
                'endtime':endtime,
                'default_detail':default_detail,
            };
            $.ajax({
                url: url,
                type: "post",
                data: params,
                dataType: 'json',
                success: function (data) {
                    if (data['message']['code'] == 0) {
                        swal({
                            title: "添加失败",
                            text: "卡号错误或不存在卡号，请重新读卡！",
                            confirmButtonText: "确定",
                            type: "error",
                        });
                        return;
                    }
                    else{
                        swal({
                            title: "添加成功",
                            confirmButtonText: "确定",
                            type: "success",
                        },function(){
                            window.location="{php echo $this->createWebUrl('couponmanage')}";
                            }
                        );

                    }
                }

            });
    }

</script>

{template 'web/common/footer'}