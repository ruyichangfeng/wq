<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>{$school['title']}</title>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width initial-scale=1.0 maximum-scale=1.0 user-scalable=yes" />
        <link type="text/css" rel="stylesheet" href="{OSSURL}public/mobile/css/bindingFormFor.css" />
        <link type="text/css" rel="stylesheet" href="{OSSURL}public/mobile/css/greenStyle.css?v=4.60120" />
        <script type="text/javascript" src="{OSSURL}public/mobile/js/jquery-1.11.3.min.js?v=4.6"></script>
        {php echo register_jssdk();}
        <!--<script src="http://libs.baidu.com/jquery/1.10.2/jquery.min.js"></script>-->
        <script src="{OSSURL}public/mobile/js/tx.js"></script>
        <script type="text/javascript" src="{OSSURL}public/mobile/js/swipe.js"></script>
        <script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
        <script src="{OSSURL}public/mobile/js/jquery.js"></script>
        <script src="{OSSURL}public/mobile/js/PromptBoxUtil.js"></script>
        <style>

            #birthday{
                border-bottom:1px solid #c6c6c6;position:relative;display:block;height:30px;line-height:30px;opacity:1;
            }
            #selMonth{
                margin-left:-40px;
                position:relative;
                z-index:10;
                opacity:0;
            }
            .bangdingForm{margin:5px 10px;background:#fff;border:1px solid #d0d0d0;border-radius:5px;}
            .bangdingBox .changeBox{margin:10px;display:none;}
            .bangdingBox .changeBox ul{width:95%;}
            .bangdingBox .changeBox ul li{width:96%;position:relative;padding:10px 0;overflow:hidden;}
            .bangdingBox .changeBox ul li span{display:block;height:30px;line-height:30px;}
            .bangdingBox .changeBox ul li span input{border:none;height:30px;font-size:15px;width:100%;border-bottom:1px solid #c6c6c6;}
            .bangdingBox .changeBox ul li span textarea{border:none;height:30px;font-size:15px;width:100%;border-bottom:1px solid #c6c6c6;}
            .bangdingBox .changeBox ul li span.l{position:absolute;width:100px;left:0;top:10px;color:#313131;}
            .bangdingBox .changeBox ul li span.r{margin-left:100px;border-bottom:1px solid #c6c6c6;position:relative;}
            .bangdingBox .changeBox ul li span.r label{width:100%;height:100%;display: block;text-align: left;}
            .bangdingBox .changeBox ul li span.r select{position:absolute;left:0;top:0;width:100%;height:100%;filter:alpha(opacity=0);-moz-opacity:0;opacity:0;}
            .bangdingBox .changeBox ul li span.r i{width:0;height:0;border-width:0 0 6px 6px;border-style:solid;border-color:transparent transparent #666 transparent;position:absolute;right:5px;bottom:5px;}
            .bangdingBox .changeBox ul li span.remind{margin-left:100px;overflow:hidden;display:block;height:auto;}
            .bangdingBox .changeBox ul li span.remind i{float:left;width:12px;height:12px;margin-top:5px;}
            .bangdingBox .changeBox ul li span.remind i img{width:100%;height:100%;}
            .bangdingBox .changeBox ul li span.remind label{display:block;margin-left:15px;line-height:auto;font-size:14px;line-height:22px;text-align:left;}
            .submitBtn{margin:30px 10px 10px 10px;height:50px;line-height:50px;border-radius:5px;text-align:center;color:white;cursor:pointer;}
        </style>
    </head>
<body>
<div class="all">
    <div class="header mainColor">
        <div class="l">
            <a class="backOff" style="background:url({OSSURL}public/mobile/img/ic_arrow_left_48px_white.svg) no-repeat;background-size: 55% 55%;background-position: 50%;" href="javascript:history.go(-1);"></a>
        </div>
        <div class="m">
            <span>完善个人信息</span>
        </div>
    </div>
    <div class="_header"></div>
    <div class="bangdingForm">
        <div class="bangdingBox">
            <div id="parentBox" class="changeBox activeBox">
                <ul>
                    <li>
                        <span class="l">姓&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;名：</span>
								<span class="r">
									<input id="tname" type="text" value="{$user['tname']}" />
								</span>
                    </li>
                    <li>
                    <span class="l">性&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;别：</span>
                    <span class="r">
                    <label>{if $user['sex'] == 1}男{elseif $user['sex'] == 2}女{else}请选择{/if}</label>
                    <select id="sex">
                    <option value="">请选择</option>
                    <option value="1" {if $user['sex'] == 1} selected{/if}>男</option>
                    <option value="2" {if $user['sex'] == 2} selected{/if}>女</option>
                    </select>
                    <i></i>
                    </span>
                    </li>
                    <li>
                        <span class="l">手机号码：</span>
								<span class="r">
									<input id="mobile" type="tel" maxlength="11" value="{$user['mobile']}" />
								</span>
                    </li>

                    <li>
                        <span class="l">生&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;日：</span>
								<span class="r">
									<input id="birthdate" type="date" value="{if $user['birthdate'] > 0 }{php echo date('Y-m-d', $user['birthdate'])}{/if}" />
								</span>
                    </li>
                    <li>
                        <span class="l">电子邮箱：</span>
								<span class="r">
									<input id="email" type="email"  value="{$user['email']}" />
								</span>
                    </li>
                    <!--<li>-->
                        <!--<span class="l">分&nbsp;&nbsp;中&nbsp;&nbsp;心：</span>-->
								<!--<span class="r">-->
									<!--<label>{if $user['centerName'] != null}{$user['centerName']}{else}请选择{/if}</label>-->
										<!--<select id="centerid">-->
                                            <!--<option value="">请选择</option>-->
                                            <!--{loop $districtCenter $row}-->
                                                <!--{if $user['district_center_id'] == $row['sid']}-->
                                                    <!--<option value="{$row['sid']}" selected>{$row['sname']}</option>-->
                                                <!--{else}-->
                                                    <!--<option value="{$row['sid']}">{$row['sname']}</option>-->
                                                <!--{/if}-->
                                            <!--{/loop}-->
                                        <!--</select>-->
									<!--<i></i>-->
								<!--</span>-->
                    <!--</li>-->
                    <li>
                        <span class="l">授课科目1：</span>
								<span class="r">
									<label>{if $user['km1_name'] != null}{$user['km1_name']}{else}请选择{/if}</label>
										<select id="km1">
                                            <option value="">请选择</option>
                                            {loop $km $row}
                                                {if $user['km_id1'] == $row['sid']}
                                                    <option value="{$row['sid']}" selected>{$row['sname']}</option>
                                                {else}
                                                    <option value="{$row['sid']}">{$row['sname']}</option>
                                                {/if}
                                            {/loop}
                                        </select>
									<i></i>
								</span>
                    </li>
                    <li>
                        <span class="l">授课科目2：</span>
								<span class="r">
									<label>{if $user['km2_name'] != null}{$user['km2_name']}{else}请选择{/if}</label>
										<select id="km2">
                                            <option value="">请选择</option>
                                            {loop $km $row}
                                            {if $user['km_id2'] == $row['sid']}
                                            <option value="{$row['sid']}" selected>{$row['sname']}</option>
                                            {else}
                                            <option value="{$row['sid']}">{$row['sname']}</option>
                                            {/if}
                                            {/loop}
                                        </select>
									<i></i>
								</span>
                    </li>
                    <li>
                        <span class="l">授课科目3：</span>
								<span class="r">
									<label>{if $user['km3_name'] != null}{$user['km3_name']}{else}请选择{/if}</label>
										<select id="km3">
                                            <option value="">请选择</option>
                                            {loop $km $row}
                                            {if $user['km_id3'] == $row['sid']}
                                            <option value="{$row['sid']}" selected>{$row['sname']}</option>
                                            {else}
                                            <option value="{$row['sid']}">{$row['sname']}</option>
                                            {/if}
                                            {/loop}
                                        </select>
									<i></i>
								</span>
                    </li>
                    <li style="height: 60px;">
                        <span class="l" >教学特点：</span>
                        <span class="r" style="border: 1px solid #c6c6c6;height: 60px;">
                            <textarea style="height: 60px;" name="headinfo" id="headinfo">{if $user['headinfo']}{$user['headinfo']}{/if}</textarea>
                        </span>
                    </li>
                    <li style="height: 60px;">
                        <span class="l" >教学成果：</span>
                        <span class="r" style="border: 1px solid #c6c6c6;height: 60px;">
                            <textarea style="height: 60px;" name="info" id="info">{if $user['info']}{$user['info']}{/if}</textarea>
                        </span>
                    </li>
                    <li style="height: 60px;">
                        <span class="l" >教学经验：</span>
                        <span class="r" style="border: 1px solid #c6c6c6;height: 60px;">
                            <textarea style="height: 60px;" name="jinyan" id="jinyan">{if $user['jinyan']}{$user['jinyan']}{/if}</textarea>
                        </span>
                    </li>
                    <!--上传付款码图片-->
                    <li style="height: 100px; margin-top:10px;margin-right:5px;">
                        <span class="l">付款码图片：</span>
								<span class="r" style="border-bottom:0px solid #c6c6c6;" onclick="uploadImg()">
                                    <input type="hidden" id="qrImg" name="backImage" value="{$user['qrImg']}"/>
                                    {if !empty($user['qrImg'])}
                                        <img src="{php echo tomedia($user['qrImg']);}" style="height:80px;width:80%;margin: 10px 5px 10px 0;">
                                    {else}
                                        <img id = "qr_img" alt="image"  src="http://weimeizhan.oss-cn-shenzhen.aliyuncs.com/public/mobile/img/insertImage.png" style="height:80px;width:80%;margin: 10px 5px 10px 0;">
                                    {/if}
                                </span>
                    </li>
                </ul>
                <div class="submitBtn mainColor" onclick="Tijiao();">提交</div>
            </div>
        </div>
    </div>
</div>
</body>
<script type="text/javascript">
    var PB = new PromptBox();
    var campus = $("#campus").val();
    var subjectId = $('#subjectId').val();
    $(document).ready(function() {
//        $("#njid").change(function() {
//            var type = 2;
//            var gradeId = $("#njid option:selected").attr('value');
//
//            changeNj();
//            changeGrade(gradeId,type, function() {
//            });
//
//        });
        $("#centerid").change(function() {
            changeCenter();
        });
        $("#km1").change(function() {
            changeKm1();
        });
        $("#km2").change(function() {
            changeKm2();
        });
        $("#km3").change(function() {
            changeKm3();
        });
        $("#sex").change(function() {
            changeSex();
        });
        $("#subjectId").change(function() {
            changeGx();
        });
    });
    function changeNj(){
        $("#njid").parent().find("label").html($("#njid").find("option:selected").text());
    }
    function changeCenter(){
        $("#centerid").parent().find("label").html($("#centerid").find("option:selected").text());
    }
    function changeKm1(){
        $("#km1").parent().find("label").html($("#km1").find("option:selected").text());
    }
    function changeKm2(){
        $("#km2").parent().find("label").html($("#km2").find("option:selected").text());
    }
    function changeKm3(){
        $("#km3").parent().find("label").html($("#km3").find("option:selected").text());
    }
    function changeBj(){
        $("#bjid").parent().find("label").html($("#bjid").find("option:selected").text());
    }
    function changeSex(){
        $("#sex").parent().find("label").html($("#sex").find("option:selected").text());
    }
    function changeGx(){
        $("#subjectId").parent().find("label").html($("#subjectId").find("option:selected").text());
    }
    function changeGrade(gradeId, type, __result) {

        //$('#njidid').val(gradeId);

        var schoolid = "{$schoolid}";
        var classlevel = [];
        //获取班次
        $.post("{php echo $this->createMobileUrl('indexajax',array('op'=>'getbjlist'))}", {'gradeId': gradeId, 'schoolid': schoolid}, function(data) {

            data = JSON.parse(data);
            classlevel = data.bjlist;

            var html = '';
            html += '<select id="bj_id"><option value="">请选择班级</option>';
            if (classlevel != '') {
                for (var i in classlevel) {
                    html += '<option value="' + classlevel[i].sid + '">' + classlevel[i].sname + '</option>';
                }
            }

            $('#bjid').html(html);
        });

    }


    function Tijiao(){
        var activeBoxID = $(".bangdingBox").find(".activeBox").attr("id");
        var isidcard = "{$signset['is_idcard']}";
        var isbj = "{$signset['is_bj']}";
        var isbir = "{$signset['is_bir']}";
        var isbd = "{$signset['is_bd']}";

        if(activeBoxID == "parentBox"){
            if($("#tname").val() == null || $("#s_name").val() == ""){
                PB.prompt("学生姓名不能为空！");
                return;
            }
            if($("#mobile").val() == null || $("#mobile").val() == ""){
                PB.prompt("手机号码不能为空！");
                return;
            }
            if(!$("#mobile").val().match(/^(0|86|17951)?(13[0-9]|15[012356789]|17[0-9]|18[0-9]|14[57])[0-9]{8}$/)){
                PB.prompt("手机格式不正确！");
                return;
            }

            if($("#birthdate").val() == null || $("#birthdate").val() == ""){
                PB.prompt("请输入出身日期");
                return;
            }
            if($("#sex").val() == null || $("#sex").val() == ""){
                PB.prompt("请选择性别！");
                return;
            }
            if(($("#km1").val() == null || $("#km1").val() == "") && ($("#km2").val() == null || $("#km2").val() == "") && ($("#km3").val() == null || $("#km3").val() == "")){
                PB.prompt("至少选择一个科目！");
                return;
            }
        }
        if(confirm("确认提交？")){
            var submitData = commitData();
            $.post("{php echo $this->createMobileUrl('updateinfo',array('op'=>'POST'))}",submitData,function(data){
                if(data.result){
                    PB.prompt(data.msg);
                    window.location.href = "{php echo $this->createMobileUrl('myschool', array('schoolid' => $schoolid), true)}"
                }else{
                    PB.prompt(data.msg);
                }
            },'json');
        }
    }

    function commitData(){
        var submitData = {
            openid :"{$openid}",
            schoolid :"{$schoolid}",
            weid :"{$weid}",
            uid :"{$fan['uid']}",
            tid : "{$user['id']}",
            tname : $("#tname").val(),
            mobile : $("#mobile").val(),
            sex    : $("#sex").val(),
            birthdate : $("#birthdate").val(),
            email : $("#email").val(),
            district_center_id : $("#centerid").val(),
            km_id1 : $("#km1").val(),
            km_id2 : $("#km2").val(),
            km_id3 : $("#km3").val(),
            info : $("#info").val(),
            headinfo : $("#headinfo").val(),
            jinyan : $("#jinyan").val(),
            qrImg:  $("#qrImg").val()
        };
        return submitData;

    }
    var images = {
        localId: [],
        serverId: []
    };

    function uploadImg(){

        wxChooseImage();
    }

    /**
     * 微信选择图片
     */
    function wxChooseImage(){
        wx.chooseImage({
            success: function (res) {
                images.localId = res.localIds;
                var obj=new Image();
                obj.src=res.localIds[0];
                imagesUploadWx();
            }
        });
    };

    function imagesUploadWx() {
        wx.uploadImage({
            localId: images.localId[0],
            isShowProgressTips:1,//// 默认为1，显示进度提示
            success: function (res) {
                $("#qrImg").val(res.serverId);
                saveImage();
            },
            fail: function (res) {
                alert(JSON.stringify(res));
            }
        });
    };
    function saveImage() {
        PB.prompt("照片上传中，请稍等~","forever");
        var url = "{php echo $this->createMobileUrl('updateinfo',array('op'=>'uploadImg'))}";
        var submitData = commitData();
        $.post(url, submitData, function(data) {
            if (data.result) {
                PB.prompt(data.msg);
                location.reload();
            } else {
                PB.prompt(data.msg);
            }
        },'json');
    }
</script>
</html>