{template 'web/common/header'}
<div class="wrapper wrapper-content ">
    <div class="row">
        <div class="col-sm-12">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>微信支付设置</h5>
                    <h5 style="float: right"><a class="glyphicon glyphicon-refresh" href="{php echo $this->createWebUrl('wechatsetting')}"></a></h5>
                    <div class="hr-line-dashed"></div>
                    <div class="row">
                        <div class="col-sm-12">
                            <div class="tabs-container">
                                <ul class="nav nav-tabs">
                                    <li class=""><a href="{php echo $this->createWebUrl('YunPay')}" ><img width="20" src="{HLMMS_IMG}yunpay_ico.png"> 云支付</a>
                                    </li>
                                    <li class="active"><a data-toggle="tab" href="#tab-1" aria-expanded="true"><i class="fa fa-weixin" style="color:#0abc89"></i>支付配置</a>
                                    </li>
                                    <li class=""><a data-toggle="tab" href="#tab-2" aria-expanded="false"></i><i class="fa fa-list"  style="color: #e10c14"></i>收款列表</a>
                                    </li>
                                    <li class=""><a  href="{php echo $this->createWebUrl('alipaysetting')}" ><img width="20" src="{HLMMS_IMG}alipay_ico.png">支付宝支付</a>
                                    </li>
                                </ul>
                                <div class="tab-content">
                                    <div id="tab-1" class="tab-pane active">
                                        <div class="panel-body">
                                            <form action="" method="post" class="form-horizontal form" enctype="multipart/form-data" id="form1" >
                                                <div class="form-group">
                                                    <label class="col-xs-12 col-sm-3 col-md-2 control-label"><span style="color:red">*</span>公众账号ID(appid)</label>
                                                    <div class="col-sm-9 col-xs-12">
                                                        <input id="wechatAppId" type="text" name="wechatAppId" class="form-control" value="{$set_wechat_info['set_wechatAppId']}" />
                                                        <span>公众账号ID(appid)</span>
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <label class="col-xs-12 col-sm-3 col-md-2 control-label"><span style="color:red">*</span>公众账号AppSecret</label>
                                                    <div class="col-sm-9 col-xs-12">
                                                        <input id="wechatAppSecret" type="text" name="wechatAppSecret" class="form-control" value="{$set_wechat_info['set_wechatAppSecret']}" />
                                                        <span>公众账号AppSecret</span>
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <label class="col-xs-12 col-sm-3 col-md-2 control-label"><span style="color:red">*</span>商户号(mchid)</label>
                                                    <div class="col-sm-9 col-xs-12">
                                                        <input id="wechatMchid" type="text" name="wechatMchid" class="form-control" value="{$set_wechat_info['set_wechatMchid']}" />
                                                        <span>商户号(mchid)</span>
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <label class="col-xs-12 col-sm-3 col-md-2 control-label"><span style="color:red">*</span>商户支付密钥key</label>
                                                    <div class="col-sm-9 col-xs-12">
                                                        <input id="wechatApiKey" type="text" name="wechatApiKey" class="form-control" value="{$set_wechat_info['set_wechatApiKey']}" />
                                                        <span>商户支付密钥key</span>
                                                    </div>
                                                </div>
                                                <div class="form-group" style="display: none">
                                                    <label class="col-xs-12 col-sm-3 col-md-2 control-label"><span style="color:red">*</span>订单号前缀</label>
                                                    <div class="col-sm-9 col-xs-12">
                                                        <input id="out_order_prefix" name="out_order_prefix" class="form-control" value="{$set_wechat_info['out_order_prefix']}" />
                                                        <span>订单前缀，如：AABBCC，不可为汉字</span>
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <label class="col-xs-12 col-sm-3 col-md-2 control-label"><span style="color:red">*</span>商品或支付单简要描述</label>
                                                    <div class="col-sm-9 col-xs-12">
                                                        <input id="wechat_description" name="wechat_description" class="form-control" value="{$set_wechat_info['set_wechat_description']}" />
                                                        <span>商品或支付单简要描述：如：XX企业产品订单，很好的产品</span>
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <label class="col-xs-12 col-sm-3 col-md-2 control-label">证书(apiclient_cert.pem)</label>
                                                    <div class="col-sm-9 col-xs-12">
                                                        <input class="form-control" type="file" name="wechat_apiclient_cert" />
                                                        <span>证书apiclient_cert.pem{if $set_wechat_info['set_wechat_apiclient_cert']}<span style="color: red;">已上传</span>{else}<span style="color: red;">未上传</span>{/if}</span>
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <label class="col-xs-12 col-sm-3 col-md-2 control-label">证书密钥(apiclient_key.pem)</label>
                                                    <div class="col-sm-9 col-xs-12">
                                                        <input class="form-control" type="file" name="wechat_apiclient_key" />
                                                        <span>证书apiclient_key.pem{if $set_wechat_info['set_wechat_apiclient_key']}<span style="color: red;">已上传</span>{else}<span style="color: red;">未上传</span>{/if}</span>
                                                    </div>
                                                </div>
                                                <div class="form-group col-sm-12">
                                                    <input type="submit" name="wechatPaySetSubmit" value="提交" class="btn btn-primary col-lg-1" />
                                                    <input type="hidden" name="token" value="{$_W['token']}" />
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                    <div id="tab-2" class="tab-pane">
                                        <div class="panel-body">
                                            <div class="col-sm-2 col-xs-2">
                                                <select data-placeholder="请选择操作员"  class="chosen-select" name="wechatConsumTableDataOperator" id="wechatConsumTableDataOperator"  style="width: 100%" tabindex="4">
                                                    {if in_array('0', $thisoperatorlist) }
                                                    <option value="0"   hassubinfo="true" selected>无操作员选择</option>
                                                    {else}
                                                    <option value="0"   hassubinfo="true">无操作员选择</option>
                                                    {/if}

                                                    {loop $accountlist $key $value}
                                                    <option value="{$value['uid']}" hassubinfo="true">{$value['username']}</option>
                                                    {/loop}

                                                </select>
                                            </div>
                                            <div class="col-sm-2">
                                                {php echo tpl_form_field_daterange('wechatConsumTablelimittime', array('starttime' => '2018-01-01','endtime' => $endtime));}
                                            </div>
                                            <div class="col-sm-2">
                                                <button class="btn btn-outline btn-primary" type="button" onclick="CalculationSum();" id="btn_searchsubmit"><i class="fa fa-search"></i> 搜索</button>
                                            </div>
                                            <div class="col-xs-2">
                                                <div class="input-group m-b">
                                                    <input type="text" disabled="disabled" name="StoreCalculationSum" class="form-control" value="" id='StoreCalculationSum'/>
                                                    <span class="input-group-addon">元</span>
                                                </div>
                                            </div>
                                            <table id="wechatConsumTableData" data-mobile-responsive="true"></table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>

    $(document).ready(function(){

        $('#wechatConsumTableDataOperator').chosen({
            allow_single_deselect: true,
            disable_search_threshold: 1,
            no_results_text: '暂无选项！',
            enable_split_word_search:true,
            width: '95%'
        });

        CalculationSum();
    });

    function CalculationSum() {
        $('#wechatConsumTableData').bootstrapTable('refresh');
        var wechatConsumTableDataOperator= $("#wechatConsumTableDataOperator").val();
        var start_wechatStartTime=$('input[name="wechatConsumTablelimittime[start]"]').val();
        var end_wechatEndTime= $('input[name="wechatConsumTablelimittime[end]"]').val();
        var url = "{php echo $this->createWebUrl('memberinfo', array('op' => 'CalculationSum'))}";
        $.ajax({
            url: url,
            type: "post",
            data: {wechatConsumTableDataOperator:wechatConsumTableDataOperator,start_wechatStartTime:start_wechatStartTime,end_wechatEndTime:end_wechatEndTime},
            dataType: 'json',
            success: function (data) {
                if (data['message']['code'] == 1) {
                    $("#StoreCalculationSum").attr("value",Math.round(data['message']['msg']*100)/100);
                    $('#wechatConsumTableData').bootstrapTable('refresh');
                    return;
                }
            }
        });


    }
    $(document).ready(function(){
        $('#wechatConsumTableData').bootstrapTable({
            url: '{php echo $this->createWebUrl('member', array('op' => 'getWechatConsumTableData'));}',
            method:"post",
            dataType: "json",
            contentType: "application/x-www-form-urlencoded",
            cache:false,  //是否使用缓存
            search:false, //显示搜索框
            clickToSelect: true,
            showPaginationSwitch:false,//是否显示数据条数选择框
            striped:true,//隔行变色
            queryParamsType:'',
            showRefresh: true,
            queryParams: querypayParamspage,//传递参数（*）
            sidePagination: "server",           //分页方式：client客户端分页，server服务端分页（*）
            pageNumber:1,                       //初始化加载第一页，默认第一页
            pageSize: 10,                       //每页的记录行数（*）
            pageList: [10, 20, 40, 100],
            pagination: true,
            height: 556,
            selectItemName:"id",
            uniqueId: "id",
            columns: [{
                radio: true
            },{
                field: 'wpi_Out_trade_no',
                title: '单据号',
                align: "center",
                valign: "middle"
            },{
                field: 'wpi_MemberName',
                title: '会员姓名',
                align: "center",
                valign: "middle",
                formatter:memberIdFormatter
            },{
                field: 'wpi_ConsumeType',
                title: '消费方式',
                align: "center",
                valign: "middle"
            },{
                field: 'wpi_PayStatus',
                title: '支付状态',
                align: "center",
                valign: "middle",
                formatter:memberPayStatusFormatter
            },{
                field: 'wpi_MoneyTotalFee',
                title: '总金额(元)',
                align: "center",
                valign: "middle"
            }, {
                field: 'wpi_AddTime',
                title: '支付时间',
                align: "center",
                valign: "middle",
                formatter:memberPayAddTimeFormatter
            }, {
                field: 'store_id',
                title: '收款商家',
                align: "center",
                valign: "middle",
                formatter:memberPayToStoreFormatter
            },{
                field: 'username',
                title: '操作员',
                align: "center",
                valign: "middle"
            } ,{
                field: 'id',
                title: '操作',
                align: "center",
                valign: "middle",
                formatter:actionFormatter
            },]
        });
        function querypayParamspage (params) {
            var temp = {  //这里的键的名字和控制器的变量名必须一直，这边改动，控制器也需要改成一样的
                pageSize: params.pageSize,  //页面大小
                pageNumber: params.pageNumber, //页码
                wechatConsumTableDataOperator: $("#wechatConsumTableDataOperator").val(),
                start_wechatStartTime:$('input[name="wechatConsumTablelimittime[start]"]').val(),
                end_wechatEndTime: $('input[name="wechatConsumTablelimittime[end]"]').val(),

            };
            return temp;
        }
        function memberIdFormatter(value, row, index) {
            if(value == 0){
                return "非会员";
            }else{
                return value;
            }
        }
        function memberPayStatusFormatter(value, row, index) {
            var paystatusValue = value;
            var result = "";
            if(paystatusValue == 1){
                result += "支付成功";
            }else{
                result += "支付失败";
            }
            return result;
        }
        function memberPayAddTimeFormatter(value, row, index) {
            return new Date(parseInt(value) * 1000).toLocaleString().replace(/:\d{1,2}$/,'');
        }
        function memberPayToStoreFormatter(value, row, index) {
            return "{php echo util::getSetStoreName()}";
        }
        function actionFormatter(value, row, index) {
            var id = value;
            var result = "";
            result += "<button type=\"button\" class='btn btn-xs btn-primary' onclick=\"WechatRefundOne(" + id + ")\"><i class='fa fa-mail-reply'></i>未结算退款</button> ";
            result += " <button type=\"button\" class='btn btn-xs btn-primary' onclick=\"WechatRefundTwo(" + id + ")\"><i class='fa fa-mail-reply'></i>余额退款</button>";
            return result;
        }
    });
    //未结算退款
    function WechatRefundOne(orderid) {

    }
    //余额退款
    function WechatRefundTwo(orderid) {

    }
</script>
{template 'web/common/footer'}