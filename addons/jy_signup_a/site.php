<?php/** * 我要报名模块微站定义 * * @author Michael Hu * @url http://bbs.9ye.cc/ */ 	session_start();defined('IN_IA') or exit('Access Denied');require_once IA_ROOT."/addons/jy_signup_a/wechatDemo/lib/WxPay.Api.php";include IA_ROOT."/addons/jy_signup_a/wechatDemo/WxPay.JsApiPay.php";  include IA_ROOT.'/addons/jy_signup_a/taobao/TopSdk.php';class jy_signup_aModuleSite extends WeModuleSite {	 function __construct(){				global $_W,$_GPC;									 $weid=$_W['uniacid'];		if ($_W['container'] == 'wechat') {         if($_W['fans']['follow']==0){					 //跳到引导页					 $item=pdo_fetchcolumn("SELECT yindaoye FROM ".tablename('jy_signup_a_setting')." WHERE weid=".$weid);					  $q_guanzhu = pdo_fetchcolumn("SELECT q_guanzhu FROM ".tablename('jy_signup_a_setting')." WHERE weid=".$weid);						if($q_guanzhu==1){              if(!empty($item)){                header("Location:".$item);  							exit();                }						}				 }		}		// $sitem = pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_setting')." WHERE weid=".$weid);		//		// $files = json_decode($sitem['filename'],true);		// $content = 123;		// $mobile = '13426738990';		// foreach ($files as $key => $value) {		// 		if($value['value']==1){		// 				//验证码		// 				$_config[$value['file']] = date('Y-m-d H:i:s', time());		// 		}else if($value['value']==2){		// 				//用户昵称		// 				$_config[$value['file']] = (string)$content;		// 		}		// }		//  $_config = json_encode($_config);		//		//		// $c = new TopClient;		// $c->appkey = $sitem['dayu_appkey'];		// $c->secretKey = $sitem['dayu_secretkey'];		// $req = new AlibabaAliqinFcSmsNumSendRequest;		// $req->setExtend(time());		// $req->setSmsType("normal");		// $req->setSmsFreeSignName($sitem['dayu_sign']);		// $req->setSmsParam($_config);		// $req->setRecNum($mobile);		// $req->setSmsTemplateCode($sitem['dayu_temp']);		// $resp = $c->execute($req);		// // if($resp->code!=0){		// // 	//  message($resp->sub_msg,referer(),'error');		// // 	echo $resp->sub_msg;		// // }else{		// //		// // }		// 		 var_dump($resp);		// exit;// include IA_ROOT."/addons/jy_signup_a/upgrade.php";		// include		// include IA_ROOT."/addons/jy_signup_a/upgrade.php";		// exit;	}	public function doMobileIndex() {		//首页		global $_W,$_GPC;		if ( strpos($_SERVER['HTTP_USER_AGENT'], 'MicroMessenger') == false ) {			$weixin=0;			$weid=$_GPC['i'];		}		else		{			$weixin=1;			$weid=$_W['uniacid'];		}		$sitem=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_setting')." WHERE weid=".$weid);		$hd=pdo_fetchall("SELECT a.*,b.name as catename FROM ".tablename('jy_signup_a_hd')." as a left join ".tablename('jy_signup_a_cate')." as b on a.hdcateid=b.id WHERE a.weid=".$weid." AND a.enabled=1 AND a.isshow=1 "." ORDER BY a.displayorder DESC,a.id ASC");		include $this->template('index');	}	public function doMobileMdhd_list() {		//首页		global $_W,$_GPC;		if ( strpos($_SERVER['HTTP_USER_AGENT'], 'MicroMessenger') == false ) {			$weixin=0;			$weid=$_GPC['i'];		}		else		{			$weixin=1;			$weid=$_W['uniacid'];		}		$id=$_GPC['id'];		if(empty($id))		{			message("操作错误！，请返回重试");		}		else		{			$mendian=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_mendian')." WHERE weid=".$weid." AND id=".$id);			if(empty($mendian))			{				message("门店已不存在，请返回重试！");			}		}		$sitem=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_setting')." WHERE weid=".$weid);		$temp_mendian=pdo_fetchall("SELECT * FROM ".tablename('jy_signup_a_mendian_hd')." WHERE weid=".$weid." AND mendianid=".$id);		foreach ($temp_mendian as $key => $value) {			$mendian_ids.= $value['hdid'].",";		}		if(!empty($mendian_ids))		{			$mendian_ids=substr($mendian_ids, 0 , -1);			$condition .= " AND a.id IN (".$mendian_ids.") ";		}		else		{			$condition .= " AND 0";		}		$hd=pdo_fetchall("SELECT a.*,b.name as catename FROM ".tablename('jy_signup_a_hd')." as a left join ".tablename('jy_signup_a_cate')." as b on a.hdcateid=b.id WHERE a.weid=".$weid." AND a.enabled=1 AND a.isshow=1 ".$condition."  ORDER BY a.displayorder DESC,a.id ASC");		include $this->template('mdhd_list');	}	public function doMobileLocation() {		global $_W,$_GPC;		if ( strpos($_SERVER['HTTP_USER_AGENT'], 'MicroMessenger') == false ) {			$weixin=0;			$weid=$_GPC['i'];			session_start();			$mid=$_SESSION['mid'];		}		else		{			$weixin=1;			$weid=$_W['uniacid'];			//checkAuth();			$from_user=$_W['openid'];      $member_temp=pdo_fetch("SELECT uid,nickname,follow FROM ".tablename('mc_mapping_fans')." WHERE openid='$from_user' AND uniacid=".$weid);			if(empty($member_temp['nickname']) || $member_temp['uid']==0)			{        $_temp =  $member_temp = pdo_fetch("SELECT uid,nickname,follow FROM ".tablename('mc_mapping_fans')." WHERE openid='$from_user' order by uid desc limit 1 ");				$uid = $member_temp['uid'];			}			else			{				$uid = $member_temp['uid'];        $uid=$member_temp['uid'];				$_W['member']['uid']=$uid;				// unset($member_temp);			}			if(empty($uid))			{				echo "<script>					window.location.href = '".$this->createMobileUrl('userinfo',array('op'=>'geren',array('id'=>$_GPC['id'])))."';				</script>";			}			else			{				$member=pdo_fetch("SELECT id FROM ".tablename('jy_signup_a_member')." WHERE weid=".$weid." AND from_user='".$from_user."' AND status=1");				$mid=$member['id'];			}		}		if(empty($mid))		{			echo 1;			exit;		}		else		{			pdo_update('jy_signup_a_member',array('lat'=>$_GPC['lat'],'lng'=>$_GPC['lng']),array('id'=>$mid));			echo 1;			exit;		}	}	public function doMobileDetail() {		//首页		global $_W,$_GPC;		if ( strpos($_SERVER['HTTP_USER_AGENT'], 'MicroMessenger') == false ) {			$weixin=0;			$weid=$_GPC['i'];			session_start();			$mid=$_SESSION['mid'];		}		else		{			$weixin=1;			$weid=$_W['uniacid'];			//checkAuth();			$from_user=$_W['openid'];			$member_temp=pdo_fetch("SELECT uid,nickname,follow FROM ".tablename('mc_mapping_fans')." WHERE openid='$from_user' AND uniacid=".$weid);			if(empty($member_temp['nickname']) || $member_temp['uid']==0)			{        $member_temp=pdo_fetch("SELECT uid,nickname,follow FROM ".tablename('mc_mapping_fans')." WHERE openid='$from_user' order by uid desc limit 1 ");				$uid = $member_temp['uid'];			}			else			{				$uid = $member_temp['uid'];        $uid=$member_temp['uid'];				$_W['member']['uid']=$uid;				// unset($member_temp);			}			if(empty($uid))			{				echo "<script>					window.location.href = '".$this->createMobileUrl('userinfo',array('op'=>'detail','id'=>$_GPC['id']))."';				</script>";			}			else			{				$member=pdo_fetch("SELECT id FROM ".tablename('jy_signup_a_member')." WHERE weid=".$weid." AND from_user='".$from_user."' AND status=1");				$mid=$member['id'];			}		}		$id=$_GPC['id'];		$op=$_GPC['op'];		if($_GPC['op']=='cy')		{			if(!empty($mid))			{				$cy=pdo_fetch("SELECT a.* FROM ".tablename('jy_signup_a_hd_cy')." as a left join ".tablename('jy_signup_a_member')." as b on a.mid=b.id WHERE a.hdid=".$id." AND a.weid=$weid AND b.id=".$mid);				if(empty($cy))				{					if($hd['price']>0)					{						echo 3;						exit;					}					else					{						if($cy['deadline']>=time())						{							$data=array(								'weid'=>$weid,								'hdid'=>$id,								'mid'=>$mid,								'status'=>1,								'createtime'=>TIMESTAMP,								);							pdo_insert("jy_signup_a_hd_cy",$data);							pdo_update("jy_signup_a_hd",array('num'=>($hd['num']+1)),array('id'=>$id));						}						else						{							echo 4;							exit;						}					}				}				echo 1;				exit;			}			else			{				echo 2;				exit;			}		}		elseif ($_GPC['op']=='pl') {			if(!empty($mid))			{				$data=array(					'weid'=>$weid,					'hdid'=>$id,					'mid'=>$mid,					'description'=>$_GPC['pl'],					'createtime'=>TIMESTAMP,				);				pdo_insert("jy_signup_a_hdcomment",$data);				$hd=pdo_fetch("SELECT id,pl FROM ".tablename('jy_signup_a_hd')." WHERE weid=".$weid." AND id=".$id);				pdo_update("jy_signup_a_hd",array('pl'=>$hd['pl']+1),array('id'=>$id));				$member=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_member')." WHERE weid=".$weid." AND id=".$mid);				if(!empty($member['wechatid']))				{					$temp=pdo_fetch("SELECT nickname,avatar FROM ".tablename('mc_members')." WHERE uniacid=".$weid." AND uid=".$member['wechatid']);					$member['avatar']=$temp['avatar'];					$member['nicheng']=$temp['nickname'];				}				else				{					$sitem=pdo_fetch("SELECT thumb FROM ".tablename('jy_signup_a_setting')." WHERE weid=".$weid);					if(!empty($sitem['thumb']))					{						$member['avatar']="{$_W['attachurl']}{$sitem['thumb']}";					}					else					{						$member['avatar']='../addons/jy_signup_a/images/no-50.png';					}				}				$html="<div class='peopleData'><img class='peopleData-head' src='".$member['avatar']."'/><div class='peopleData-leftData'><div class='peopleData-name'><span>".$member['nicheng']."</span><div class='peopleData-name-support' data-support='0'><img src='../addons/jy_signup_a/images/icon-agree.png'/><span>0</span></div></div><div class='peopleData-name gray mart10'>".$_GPC['pl']."</div></div></div>";				return json_encode(array('status'=>1,'log'=>$html));				exit;			}			else			{				return json_encode(array('status'=>2));				exit;			}		}		elseif ($_GPC['op']=='hq') {			$id=$_GPC['id'];			$pindex=$_GPC['pindex'];			$pl=pdo_fetchall("SELECT a.*,b.wechatid,b.nicheng FROM ".tablename('jy_signup_a_hdcomment')." as a left join ".tablename('jy_signup_a_member')." as b on a.mid=b.id WHERE a.weid=".$weid." AND a.hdid=".$id." ORDER BY a.createtime DESC LIMIT ".($pindex * 10).",10");			foreach ($pl as $key => $value) {				if(!empty($value['wechatid']))				{					$temp=pdo_fetch("SELECT nickname,avatar FROM ".tablename('mc_members')." WHERE uniacid=".$weid." AND uid=".$value['wechatid']);					$value['nicheng']=$temp['nickname'];					$value['avatar']=$temp['avatar'];				}				else				{					$sitem=pdo_fetch("SELECT thumb FROM ".tablename('jy_signup_a_setting')." WHERE weid=".$weid);					if(!empty($sitem['thumb']))					{						$value['avatar']="{$_W['attachurl']}{$sitem['thumb']}";					}					else					{						$value['avatar']='../addons/jy_signup_a/images/no-50.png';					}				}				if(!empty($mid))				{					$temp2=pdo_fetch("SELECT id FROM ".tablename('jy_signup_a_hdcomment_zan')." WHERE weid=".$weid." AND hdid=".$id." AND mid=".$mid." AND hdcommentid=".$value['id']);				}				if(!empty($temp2['id']))				{					$html.="<div class='peopleData'><img class='peopleData-head' src='".$value['avatar']."'/><div class='peopleData-leftData'><div class='peopleData-name'><span>".$value['nicheng']."</span><div class='peopleData-name-support' data-support='1' data-id='".$value['id']."' onclick='supportFunc(this)'><img src='../addons/jy_signup_a/images/icon-agree-on.png'/><span>".$value['num']."</span></div></div><div class='peopleData-name gray mart10'>".$value['description']."</div></div></div>";				}				else				{					$html.="<div class='peopleData'><img class='peopleData-head' src='".$value['avatar']."'/><div class='peopleData-leftData'><div class='peopleData-name'><span>".$value['nicheng']."</span><div class='peopleData-name-support' data-support='0' data-id='".$value['id']."' onclick='supportFunc(this)'><img src='../addons/jy_signup_a/images/icon-agree.png'/><span>".$value['num']."</span></div></div><div class='peopleData-name gray mart10'>".$value['description']."</div></div></div>";				}			}			return json_encode(array('status'=>1,'log'=>$html,'num'=>count($pl)));			exit;		}		elseif ($_GPC['op']=='sc') {			if(!empty($mid))			{				$temp=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_hd_sc')." WHERE weid=".$weid." AND mid=".$mid." AND hdid=".$id);				$hd=pdo_fetch("SELECT id,sc FROM ".tablename('jy_signup_a_hd')." WHERE weid=".$weid." AND id=".$id);				if(!empty($temp))				{					pdo_delete("jy_signup_a_hd_sc",array('id'=>$temp['id']));					pdo_update("jy_signup_a_hd",array('sc'=>$hd['sc']-1),array('id'=>$id));				}				else				{					$data=array(						'weid'=>$weid,						'hdid'=>$id,						'mid'=>$mid,						'createtime'=>TIMESTAMP,					);					pdo_insert("jy_signup_a_hd_sc",$data);					pdo_update("jy_signup_a_hd",array('sc'=>$hd['sc']+1),array('id'=>$id));				}				echo 1;				exit;			}			else			{				echo 2;				exit;			}		}		elseif ($_GPC['op']=='zan') {			if(!empty($mid))			{				$hdcommentid=$_GPC['hdcommentid'];				$hdcomment=pdo_fetch("SELECT id,num FROM ".tablename('jy_signup_a_hdcomment')." WHERE weid=".$weid." AND id=".$hdcommentid);				$temp=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_hdcomment_zan')." WHERE weid=".$weid." AND hdid=".$id." AND mid=".$mid." AND hdcommentid=".$hdcommentid);				if(!empty($temp))				{					pdo_delete("jy_signup_a_hdcomment_zan",array('weid'=>$weid,'hdid'=>$id,'mid'=>$mid,'hdcommentid'=>$hdcommentid));					pdo_update("jy_signup_a_hdcomment",array('num'=>$hdcomment['num']-1),array('id'=>$hdcommentid));				}				else				{					pdo_update("jy_signup_a_hdcomment",array('num'=>$hdcomment['num']+1),array('id'=>$hdcommentid));					$data=array(							'weid'=>$weid,							'hdid'=>$id,							'mid'=>$mid,							'hdcommentid'=>$hdcommentid,							'createtime'=>TIMESTAMP,						);					pdo_insert("jy_signup_a_hdcomment_zan",$data);				}				echo 1;				exit;			}			else			{				echo 2;				exit;			}		}		else		{			$sitem=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_setting')." WHERE weid=".$weid);			$hd=pdo_fetch("SELECT a.*,b.name as catename FROM ".tablename('jy_signup_a_hd')." as a left join ".tablename('jy_signup_a_cate')." as b on a.hdcateid=b.id WHERE a.weid=".$weid." AND a.id=".$id);			$mendian=pdo_fetchall("SELECT b.mendianname,b.tel FROM ".tablename('jy_signup_a_mendian_hd')." as a left join ".tablename('jy_signup_a_mendian')." as b on a.mendianid=b.id WHERE a.weid=".$weid." AND a.hdid=".$hd['id']);			$mendian_num=count($mendian);			if($mendian_num==1)			{				$hd['mendianname']=$mendian[0]['mendianname'];				$hd['tel']=$mendian[0]['tel'];			}			$thumb=unserialize($hd['thumb']);			$cy=pdo_fetchall("SELECT b.wechatid,b.thumb FROM ".tablename('jy_signup_a_hd_cy')." as a left join ".tablename('jy_signup_a_member')." as b on a.mid=b.id WHERE a.weid=".$weid." AND a.hdid=".$id." ORDER BY a.createtime DESC LIMIT 6 ");			foreach ($cy as $key => $value) {				if(!empty($value['thumb']))				{					$cy[$key]['avatar']=tomedia($value['thumb']);				}				else				{					if(!empty($value['wechatid']))					{						$temp=pdo_fetch("SELECT avatar FROM ".tablename('mc_members')." WHERE uniacid=".$weid." AND uid=".$value['wechatid']);						$cy[$key]['avatar']=$temp['avatar'];					}				}			}	       $done_num=pdo_fetchcolumn("SELECT count(id) FROM ".tablename('jy_signup_a_hd_card')." WHERE weid=".$weid." AND hdid=".$id);			$done=pdo_fetchall("SELECT b.wechatid,b.thumb FROM ".tablename('jy_signup_a_hd_card')." as a left join ".tablename('jy_signup_a_member')." as b on a.mid=b.id WHERE a.weid=".$weid." AND a.hdid=".$id." ORDER BY a.createtime DESC LIMIT 6 ");			foreach ($done as $key => $value) {				if(!empty($value['thumb']))				{					$done[$key]['avatar']=tomedia($value['thumb']);				}				else				{					if(!empty($value['wechatid']))					{						$temp=pdo_fetch("SELECT avatar FROM ".tablename('mc_members')." WHERE uniacid=".$weid." AND uid=".$value['wechatid']);						$done[$key]['avatar']=$temp['avatar'];					}				}			}			$pl=pdo_fetchall("SELECT a.*,b.wechatid,b.nicheng,b.thumb FROM ".tablename('jy_signup_a_hdcomment')." as a left join ".tablename('jy_signup_a_member')." as b on a.mid=b.id WHERE a.weid=".$weid." AND a.hdid=".$id." ORDER BY a.createtime DESC LIMIT 10 ");			foreach ($pl as $key => $value) {				if(!empty($value['thumb']))				{					$pl[$key]['avatar']=tomedia($value['thumb']);				}				else				{					if(!empty($value['wechatid']))					{						$temp=pdo_fetch("SELECT nickname,avatar FROM ".tablename('mc_members')." WHERE uniacid=".$weid." AND uid=".$value['wechatid']);						$pl[$key]['nicheng']=$temp['nickname'];						$pl[$key]['avatar']=$temp['avatar'];					}				}				if(!empty($mid))				{					$temp2=pdo_fetch("SELECT id FROM ".tablename('jy_signup_a_hdcomment_zan')." WHERE weid=".$weid." AND hdid=".$id." AND mid=".$mid." AND hdcommentid=".$value['id']);					if(!empty($temp2))					{						$pl[$key]['zan']=1;					}				}			}			if(!empty($mid))			{				$cj=pdo_fetch("SELECT id FROM ".tablename('jy_signup_a_hd_cy')." WHERE weid=".$weid." AND mid=".$mid." AND hdid=".$id);				if(!empty($cj))				{					$cj=1;				}				else				{					$cj=0;				}				$sc=pdo_fetch("SELECT id FROM ".tablename('jy_signup_a_hd_sc')." WHERE weid=".$weid." AND mid=".$mid." AND hdid=".$id);				if(!empty($sc))				{					$sc=1;				}				else				{					$sc=0;				}				$xz=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_hd_card')." WHERE weid=".$weid." AND mid=".$mid." AND hdid=".$id);			}			$data2=array(					'weid'=>$weid,					'hdid'=>$hd['id'],					'createtime'=>TIMESTAMP,				);			if(!empty($mid))			{				$data2['mid']=$mid;			}			else			{				$data2['mid']=0;			}            $content_01 = $hd["description"];//从数据库获取富文本content            $content_02 = htmlspecialchars_decode($content_01);//把一些预定义的 HTML 实体转换为字符            $content_03 = str_replace("&nbsp;","",$content_02);//将空格替换成空            $contents = strip_tags($content_03);//函数剥去字符串中的 HTML、XML 以及 PHP 的标签,获取纯文本内容            $sharedesc = mb_substr($contents, 0, 100,"utf-8");//返回字符串中的前100字符串长度的字符            if(!empty($sharedesc))            {                $sitem['sharedesc']=$sharedesc;            }            $thumb=unserialize($hd['thumb']);            if(!empty($thumb))            {                $sitem['sharelogo']=$thumb[0];            }			pdo_insert("jy_signup_a_hd_pv",$data2);			pdo_update('jy_signup_a_hd',array('pv'=>$hd['pv']+1),array('id'=>$hd['id']));			include $this->template('detail');		}	}	public function doMobileSignup() {		//首页		global $_W,$_GPC;		if ( strpos($_SERVER['HTTP_USER_AGENT'], 'MicroMessenger') == false ) {			$weixin=0;			$weid=$_GPC['i'];			session_start();			$mid=$_SESSION['mid'];			if(!empty($mid))			{				$member=pdo_fetch("SELECT a.wechatid,b.credit1 FROM ".tablename('jy_signup_a_member')." as a left join ".tablename('mc_members')." as b on a.wechatid=b.uid WHERE a.weid=".$weid." AND a.id=".$mid." AND a.status=1");			}		}		else		{			$weixin=1;			$weid=$_W['uniacid'];			//checkAuth();			$from_user=$_W['openid'];			//  $member_temp=pdo_fetch("SELECT uid,nickname,follow FROM ".tablename('mc_mapping_fans')." WHERE openid='$from_user' AND uniacid=".$weid);      $_temp = $member_temp=pdo_fetch("SELECT uid,nickname,follow FROM ".tablename('mc_mapping_fans')." WHERE openid='$from_user' AND uniacid=".$weid);			if(empty($member_temp['nickname']) || $member_temp['uid']==0)			{        $_temp =  $member_temp = pdo_fetch("SELECT uid,nickname,follow FROM ".tablename('mc_mapping_fans')." WHERE openid='$from_user' order by uid desc limit 1 ");				$uid = $member_temp['uid'];			}			else			{				$uid = $member_temp['uid'];        $uid=$member_temp['uid'];				$_W['member']['uid']=$uid;				// unset($member_temp);			}			if(empty($uid))			{				echo "<script>					window.location.href = '".$this->createMobileUrl('userinfo',array('op'=>'signup'))."';				</script>";			}			else			{				$member=pdo_fetch("SELECT a.id,a.wechatid,b.credit1 FROM ".tablename('jy_signup_a_member')." as a left join ".tablename('mc_members')." as b on a.wechatid=b.uid WHERE a.weid=".$weid." AND a.from_user='".$from_user."' AND a.status=1");				$mid=$member['id'];			}		}		$sitem=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_setting')." WHERE weid=".$weid);		if(!empty($sitem['gongzuorenyuan'])){			 $gongzuorenyuan = explode(',',$sitem['gongzuorenyuan']);		}		if(empty($mid))		{			echo "<script>					window.location.href = '".$this->createMobileUrl('login',array('id'=>$_GPC['id']))."';				</script>";		}		else		{			$op=$_GPC['op'];			$id=$_GPC['id'];			$cy=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_hd_cy')." WHERE weid=".$weid." AND mid=".$mid." AND hdid=".$id);			$xz=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_hd_card')." WHERE weid=".$weid." AND mid=".$mid." AND hdid=".$id);			$hd=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_hd')." WHERE weid=".$weid." AND id=".$id);			$attr_arr=array();			$attr_arr2=array();			$ziliao=pdo_fetchall('SELECT a.enabled,b.name,b.id,b.type FROM '.tablename('jy_signup_a_hd_attr')." as a left join ".tablename('jy_signup_a_attr')." as b on a.attr_id=b.id WHERE a.weid=".$weid." AND a.hdid=".$id." AND b.enabled=1 ORDER BY a.id ASC");			foreach ($ziliao as $key => $value) {				if($value['enabled']==0)				{					array_push($attr_arr, $value['id']);				}				else				{					array_push($attr_arr2, $value['id']);				}				$temp_val=pdo_fetch("SELECT zhi FROM ".tablename('jy_signup_a_hd_attr_value')." WHERE weid=".$weid." AND hdid=".$id." AND mid=".$mid." AND attr_id=".$value['id']);				$zl_val[$value['id']]=$temp_val['zhi'];				if($value['type']==3)				{					$xx[$value['id']]=pdo_fetchall("SELECT id,name FROM ".tablename('jy_signup_a_attr')." WHERE weid=".$weid." AND parentid=".$value['id']." AND enabled=1");				}			}			if($op=='add')			{				$now=time();				if($hd['starttime']>$now)				{					echo 4;					exit;				}				if($hd['endtime']<$now)				{					echo 5;					exit;				}				$data=array(					'weid'=>$weid,					'hdid'=>$id,					'mid'=>$mid,				);				pdo_delete('jy_signup_a_hd_attr_value',array('weid'=>$weid,'hdid'=>$id,'mid'=>$mid));				// 获取自定义字段marek				foreach ($ziliao as $key => $value) {					if (!empty($_GPC['zl_'.$value['id']]))					{						$zl_data=array(								'weid'=>$weid,								'hdid'=>$id,								'mid'=>$mid,								'createtime'=>TIMESTAMP,								'attr_id'=>$value['id'],								'zhi'=>$_GPC['zl_'.$value['id']],							);							if($this->_getType($value['id'])==6){								$mobile = $_GPC['zl_'.$value['id']];							}						pdo_insert("jy_signup_a_hd_attr_value",$zl_data);					}				}        		// 付费报名				if($hd['price']>0 && empty($cy))				{					$data['pl']=$_GPC['pl'];					$cy2=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_hd_cy_temp')." WHERE weid=".$weid." AND mid=".$mid." AND hdid=".$id);					if(empty($cy2))					{						$data['createtime']=TIMESTAMP;						pdo_insert("jy_signup_a_hd_cy_temp",$data);					}					else					{						pdo_update("jy_signup_a_hd_cy_temp",$data,array('id'=>$cy2['id']));					}					echo 2;					exit;				}				else				{					if(!empty($cy))					{						pdo_update("jy_signup_a_hd_cy",$data,array('id'=>$cy['id']));						$text="修改【".$hd['hdname']."】报名信息成功！";					}					else					{						$data['status']=1;						$data['createtime']=TIMESTAMP;						if($hd['jifen']>0)						{							$data['jifen']=$hd['jifen'];							if(!empty($member['wechatid']))							{								if($member['credit1']<$hd['jifen'])								{									echo 3;									exit;								}								else								{									pdo_update("mc_members",array('credit1'=>$member['credit1']-$hd['jifen']),array('uid'=>$member['wechatid']));								}							}							else							{								echo 3;								exit;							}						}						pdo_insert("jy_signup_a_hd_cy",$data);						pdo_update('jy_signup_a_hd',array('num'=>$hd['num']+1),array('id'=>$id));						$msgtmp=$sitem['msgtmp'];						$account=$sitem['msguser'];						$product = $sitem['product'];						$pswd=$sitem['msgpass'];						$msgtmp = str_replace('#action',$hd['hdname'],$msgtmp);						$content=rawurlencode($msgtmp);						//不需要审核						if(empty($hd['shenhe']))						{							if($hd['renshu']==0)							{								$data=array(									'weid'=>$weid,									'hdid'=>$id,									'mid'=>$mid,									'status'=>1,									'createtime'=>TIMESTAMP,								);								pdo_insert("jy_signup_a_hd_card",$data);								$text="<a href='".$_W['siteroot'].'app/'.substr($this->createMobileUrl('detail',array('id'=>$id)),2)."'>恭喜您！活动【".$hd['hdname'].'】'."报名成功，点击查看报名详情！</a>";							}							else							{								$card_count=pdo_fetchcolumn("SELECT count(id) FROM ".tablename('jy_signup_a_hd_card')." WHERE weid=".$weid." AND hdid=".$id);								if($card_count<$hd['renshu'])								{									$data=array(										'weid'=>$weid,										'hdid'=>$id,										'mid'=>$mid,										'status'=>1,										'createtime'=>TIMESTAMP,									);									pdo_insert("jy_signup_a_hd_card",$data);									$text="<a href='".$_W['siteroot'].'app/'.substr($this->createMobileUrl('detail',array('id'=>$id)),2)."'>恭喜您！活动【".$hd['hdname'].'】'."报名成功，点击查看报名详情！</a>";								}								else								{									if(!empty($mobile) && !empty($account) && !empty($pswd) && !empty($product))									{										if($sitem['metype']==1){											  //阿里大鱼												$files = json_decode($sitem['filename'],true);												foreach ($files as $key => $value) {														if($value['value']==1){																//验证码																$_config[$value['file']] = date('Y-m-d H:i:s', time());														}else if($value['value']==2){																//用户昵称																$_config[$value['file']] = (string)$content;														}												}												$_config = json_encode($_config);												$c = new TopClient;												$c->appkey = $sitem['dayu_appkey'];												$c->secretKey = $sitem['dayu_secretkey'];												$req = new AlibabaAliqinFcSmsNumSendRequest;												$req->setExtend(time());												$req->setSmsType("normal");												$req->setSmsFreeSignName($sitem['dayu_sign']);												$req->setSmsParam($_config);												$req->setRecNum($mobile);												$req->setSmsTemplateCode($sitem['dayu_temp']);												$resp = $c->execute($req);												if($resp->code!=0){													 message($resp->sub_msg,referer(),'error');												}										}else{											//短信通											$target ='http://120.24.55.238/msg/HttpSendSM?account='.$account.'&pswd='.$pswd.'&mobile='.$mobile.'&msg='.$content.'&needstatus=true&product='.$product.'';											$return_str = file_get_contents($target);										}									}									$text="恭喜您,提交报名【".$hd['hdname']."】进入等位状态！";									if(!empty($hd['paiwei']))									{										$text.="在您前面还有".($card_count-$done_num-1)."人等位!我们会随时通知您等位情况。";									}								}							}						}						else						{							if(!empty($mobile) && !empty($account) && !empty($pswd) && !empty($product))							{								$target ='http://120.24.55.238/msg/HttpSendSM?account='.$account.'&pswd='.$pswd.'&mobile='.$mobile.'&msg='.$content.'&needstatus=true&product='.$product.'';								$return_str = file_get_contents($target);							}							$text="恭喜您,报名【".$hd['hdname']."】成功！等待审核！点击查看报名详情！";						}					}          			// hook1					load()->func('communication');					$access_token = WeAccount::token();					$url = "https://api.weixin.qq.com/cgi-bin/message/custom/send?access_token={$access_token}";					$nickname = empty($_temp['nickname'])?'无名氏':$_temp['nickname'];					$_kgtxt = urlencode($nickname."用户报名了【".$hd['hdname']."】活动 于".date("Y-m-d H:i:s",time())."时间参加");					if(!empty($gongzuorenyuan)){						  foreach ($gongzuorenyuan as $key => $value) {								$data = array(									"touser"=>$value,									"msgtype"=>"text",									"text"=>array("content"=>$_kgtxt)								);								$response = ihttp_request($url, urldecode(json_encode($data)));						  }					}					if($weixin==1 && !empty($from_user))					{						$text=urlencode($text);						$data = array(						  "touser"=>$from_user,						  "msgtype"=>"text",						  "text"=>array("content"=>$text)						);						$response = ihttp_request($url, urldecode(json_encode($data)));					}					if(!empty($_GPC['pl']))					{						$data=array(								'weid'=>$weid,								'hdid'=>$id,								'mid'=>$mid,								'description'=>$_GPC['pl'],								'createtime'=>TIMESTAMP,							);						pdo_insert('jy_signup_a_hdcomment',$data);						pdo_update("jy_signup_a_hd",array('pl'=>$hd['pl']+1),array('id'=>$id));					}					echo 1;					exit;				}			}			elseif ($op=='no') {				if(!empty($xz) && empty($hd['qx']))				{					//已被选中，无法取消报名					echo 3;					exit;				}				else				{					if(empty($cy))					{						echo 4;						exit;					}					else					{						if(!empty($hd['paiwei']) && !empty($hd['renshu']) && empty($hd['shenhe']) && !empty($xz))						{							$card_count=pdo_fetchcolumn("SELECT count(id) FROM ".tablename('jy_signup_a_hd_card')." WHERE weid=".$weid." AND hdid=".$id);							$xz_all=pdo_fetchall("SELECT mid FROM ".tablename('jy_signup_a_hd_card')." WHERE weid=".$weid." AND hdid=".$id);							if(!empty($xz_all))							{								$cy_condition=" AND a.mid NOT IN ( ";								foreach ($xz_all as $key => $value) {									$cy_condition.=$value['mid'].",";								}								$cy_condition=substr($cy_condition, 0,-1);								$cy_condition.=") ";							}							$cy_first=pdo_fetch("SELECT a.*,b.from_user FROM ".tablename('jy_signup_a_hd_cy')." as a left join ".tablename('jy_signup_a_member')." as b on a.mid=b.id WHERE a.weid=".$weid." AND a.hdid=".$id.$cy_condition." ORDER BY a.createtime DESC LIMIT 1");							if(!empty($cy_first))							{								$data2=array(									'weid'=>$weid,									'hdid'=>$id,									'mid'=>$cy_first['mid'],									'status'=>1,									'createtime'=>TIMESTAMP,								);								pdo_insert("jy_signup_a_hd_card",$data2);								if(!empty($cy_first['from_user']))								{									$text="恭喜您！活动【".$hd['hdname'].'】'."报名成功，点击查看报名详情！";									load()->func('communication');									$access_token = WeAccount::token();									$url = "https://api.weixin.qq.com/cgi-bin/message/custom/send?access_token={$access_token}";									$text=urlencode($text);									$data = array(									  "touser"=>$cy_first['from_user'],									  "msgtype"=>"text",									  "text"=>array("content"=>$text)									);									$response = ihttp_request($url, urldecode(json_encode($data)));								}							}						}						pdo_delete("jy_signup_a_hd_cy",array('hdid'=>$id,'mid'=>$mid,'weid'=>$weid));						pdo_update("jy_signup_a_hd",array('num'=>$hd['num']-1),array('id'=>$id));						pdo_delete("jy_signup_a_hd_card",array('hdid'=>$id,'mid'=>$mid,'weid'=>$weid));						if(!empty($cy['plid']) && !empty($hd['tk']))						{							$data=array(									'weid'=>$weid,									'mid'=>$mid,									'hdid'=>$id,									'bmname'=>$cy['nicheng'],									'bmmobile'=>$cy['mobile'],									'plid'=>$cy['plid'],									'cytime'=>$cy['createtime'],									'status'=>0,									'createtime'=>TIMESTAMP,								);							pdo_insert("jy_signup_a_hd_tk",$data);							echo 2;							exit;						}						else						{							if(!empty($cy['jifen']) && !empty($hd['tk']) )							{								if(!empty($member['wechatid']))								{									pdo_update("mc_members",array('credit1'=>$member['credit1']+$cy['jifen']),array('uid'=>$member['wechatid']));								}							}							echo 1;							exit;						}					}				}			}			else			{				 // $hd=pdo_fetch("SELECT * FROM ".tablename("jy_signup_a_hd")." WHERE id=".$_GPC['id']);                load()->func('tpl');				$member=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_member')." WHERE weid=".$weid." AND id=".$mid);				include $this->template('signup');			}		}	}	public function _getType($id){		 global $_W,$_GPC;		 $sql = "SELECT type FROM ".tablename('jy_signup_a_attr')." where id=".$id;		 return pdo_fetchcolumn($sql);	}	public function doMobilePc_money() {		//pc端支付		global $_W,$_GPC;		if ( strpos($_SERVER['HTTP_USER_AGENT'], 'MicroMessenger') == false ) {			$weid=$_GPC['i'];			$weixin=0;			session_start();			$mid=$_SESSION['mid'];		}		else		{			$weixin=1;			$weid=$_W['uniacid'];			$this->checkAuth();			$from_user=$_W['openid'];      $member_temp=pdo_fetch("SELECT uid,nickname,follow FROM ".tablename('mc_mapping_fans')." WHERE openid='$from_user' AND uniacid=".$weid);			if(empty($member_temp['nickname']) || $member_temp['uid']==0)			{        $member_temp=pdo_fetch("SELECT uid,nickname,follow FROM ".tablename('mc_mapping_fans')." WHERE openid='$from_user' order by uid desc limit 1 ");				$uid = $member_temp['uid'];			}			else			{				$uid = $member_temp['uid'];        $uid=$member_temp['uid'];				$_W['member']['uid']=$uid;				// unset($member_temp);			}			if(empty($uid))			{				echo "<script>					window.location.href = '".$this->createMobileUrl('userinfo',array('op'=>'pc_money','id'=>$_GPC['id']))."';				</script>";			}			else			{				$member=pdo_fetch("SELECT id FROM ".tablename('jy_signup_a_member')." WHERE weid=".$weid." AND from_user='".$from_user."' AND status=1");				$mid=$member['id'];			}		}		if(empty($mid))		{			echo "<script>					window.location.href = '".$this->createMobileUrl('login')."';				</script>";		}		else		{			$sitem=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_setting')." WHERE weid=".$weid);		}		include $this->template('pc_money');	}	public function doMobileMoney() {		global $_W, $_GPC;		$from_user=$_W['openid'];		$weid=$_W['uniacid'];		$uid = $_W['member']['uid'];	$sitem=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_setting')." WHERE weid=".$weid);		if($_GPC['done']==1){			$trade_no = $_GPC['tid'];			$input = new WxPayOrderQuery();			$input->SetOut_trade_no($trade_no);			$res = WxPayApi::orderQuery($input,$sitem['bro_appid'],$sitem['bro_mch'],$sitem['bro_my']);			$data = array(				'weid'=>$weid,				'uniacid'=>$weid,				'result'=>strtolower($res['return_code']),				'from'=>'notify',				'tid'=>$trade_no,				'uniontid'=>$trade_no,				'fee'=>$res['total_fee']/100,					'user'=>$res['openid'],				'tag'=>array(					'transaction_id'=>$res['transaction_id'],				),			);			// var_dump($data);			$this->payResult($data);			exit;		}	if($sitem['bro_wx']==1){       //借用湖区借用接口			 if(empty($_COOKIE['bro_openid'])){				    $code = $_GET['code'];						if(empty($code)){									include IA_ROOT."/addons/jy_signup_a/wechatapi.php";									$wapi = new WechatAPI();									$file =  ATTACHMENT_ROOT.'json_jy_signup_'.$this->weid.'.json';									$token = $wapi->getAccessToken($file,$sitem['bro_appid'],$sitem['bro_appsecret']);									$url = $_W['siteroot'] . 'app/index.php?' . $_SERVER['QUERY_STRING']."&id=".$_GPC['id'];									$callback = urlencode($url);									 $forward = 'https://open.weixin.qq.com/connect/oauth2/authorize?appid='.$sitem['bro_appid'].'&redirect_uri='.$callback.'&response_type=code&scope=snsapi_base&state='.$state.'#wechat_redirect';									 header("Location: ".$forward);						}else{							$url = "https://api.weixin.qq.com/sns/oauth2/access_token?appid=".$_W['oauth_account']['key']."&secret=".$_W['oauth_account']['secret']."&code=".$code."&grant_type=authorization_code";							load()->func('communication');							$response = ihttp_get($url);								$oauth = @json_decode($response['content'], true);								if (!is_error($response)) {												$from_user2 = $oauth['openid'];										  	setcookie('bro_openid',$oauth['openid'], time()+3600*24);								}else{									  message('微信授权获取用户信息失败,请重新尝试: ' . $response['message'],$this->createMobileUrl('index'),'error');								}						}			 }else{				   $from_user2 = $_COOKIE['bro_openid'];			 }       $member_temp=pdo_fetch("SELECT uid,nickname,follow FROM ".tablename('mc_mapping_fans')." WHERE openid='$from_user' AND uniacid=".$weid); 			if(empty($member_temp['nickname']) || $member_temp['uid']==0) 			{         $member_temp=pdo_fetch("SELECT uid,nickname,follow FROM ".tablename('mc_mapping_fans')." WHERE openid='$from_user' order by uid desc limit 1 "); 				$uid = $member_temp['uid']; 			} 			else 			{ 				$uid = $member_temp['uid'];         $uid=$member_temp['uid']; 				$_W['member']['uid']=$uid; 				// unset($member_temp); 			}				if(empty($uid))				{					echo "<script>						window.location.href = '".$this->createMobileUrl('userinfo',array('op'=>'money','id'=>$_GPC['id']))."';					</script>";				}				if(!empty($from_user))				{					$id=$_GPC['id'];					if(!empty($id))					{						$hd=pdo_fetch("SELECT * FROM ".tablename("jy_signup_a_hd")." WHERE id=".$id);						if(empty($hd))						{							message("活动不存在!");						}						$total=$hd['price'];						$tid=TIMESTAMP.$id;						$params['tid'] = $tid;						$params['fee'] = $total;						$params['user'] = $from_user2;						$params['title'] = "支付";						$params['ordersn'] = random(8);						$params['virtual'] =  true;						if(!$this->inMobile) {							message('支付功能只能在手机上使用');						}						if (empty($uid)) {							checkauth();						}						$params['module'] = $this->module['name'];						$pars = array();						$pars[':uniacid'] = $_W['uniacid'];						$pars[':module'] = $params['module'];						$pars[':tid'] = $params['tid'];						$sql = 'SELECT * FROM ' . tablename('core_paylog') . ' WHERE `uniacid`=:uniacid AND `module`=:module AND `tid`=:tid';						$log = pdo_fetch($sql, $pars);						if(!empty($log) && $log['status'] == '1') {							message('这个订单已经支付成功, 不需要重复支付.');						}						$setting = uni_setting($_W['uniacid'], array('payment', 'creditbehaviors'));						// var_dump(222);						//						// exit;						// if(!is_array($setting['payment'])) {						// 	message('没有有效的支付方式, 请联系网站管理员.');						// }						if (empty($log)) {									$log = array(													'uniacid' => $_W['uniacid'],													'acid' => $_W['acid'],													'openid' => $from_user2,													'module' => $this->module['name'], //模块名称，请保证$this可用													'tid' => $params['tid'],													'fee' => $total,													'card_fee' => $total,													'status' => '0',													'is_usecard' => '0',													'uniontid'=>$params['tid']									);									pdo_insert('core_paylog', $log);						}					  	$tools = new JsApiPay();					  	 $total_fee = $total*100;						 //②、统一下单							$input = new WxPayUnifiedOrder();							$input->SetAppid($sitem['bro_appid']);							$input->SetMch_id($sitem['bro_mch']);							$input->SetBody($params['tid']);							$input->SetKey($sitem['bro_my']);							$input->SetOut_trade_no($params['tid']);							$input->SetTotal_fee($total_fee);							$input->SetGoods_tag('支付');							$input->SetNotify_url( $_W['siteroot'] . 'payment/wechat/notify.php');							$input->SetTrade_type("JSAPI");							$input->SetOpenid($from_user2);							$order = WxPayApi::unifiedOrder($input);							$jsApiParameters = $tools->GetJsApiParameters($order,$sitem['bro_my']);							include $this->template('pay2');					}					else					{						echo "操作错误！，请返回重试";						exit;					}				}				else{					$id=$_GPC['id'];					echo $id."用户授权错误，请返回重试！";				}				exit;	}	else{    $member_temp=pdo_fetch("SELECT uid,nickname,follow FROM ".tablename('mc_mapping_fans')." WHERE openid='$from_user' AND uniacid=".$weid);    if(empty($member_temp['nickname']) || $member_temp['uid']==0)    {      $member_temp=pdo_fetch("SELECT uid,nickname,follow FROM ".tablename('mc_mapping_fans')." WHERE openid='$from_user' order by uid desc limit 1 ");      $uid = $member_temp['uid'];    }    else    {      $uid = $member_temp['uid'];      $uid=$member_temp['uid'];      $_W['member']['uid']=$uid;      // unset($member_temp);    }		if(empty($uid))		{			echo "<script>				window.location.href = '".$this->createMobileUrl('userinfo',array('op'=>'money','id'=>$_GPC['id']))."';			</script>";		}		if(!empty($from_user))		{			$id=$_GPC['id'];			if(!empty($id))			{				$hd=pdo_fetch("SELECT * FROM ".tablename("jy_signup_a_hd")." WHERE id=".$id);				if(empty($hd))				{					message("活动不存在!");				}				$total=$hd['price'];				$tid=TIMESTAMP.$id;				$params['tid'] = $tid;				$params['fee'] = $total;				$params['user'] = $from_user;				$params['title'] = "支付";				$params['ordersn'] = random(8);				$params['virtual'] =  true;				if(!$this->inMobile) {					message('支付功能只能在手机上使用');				}				if (empty($uid)) {					checkauth();				}				$params['module'] = $this->module['name'];				$pars = array();				$pars[':uniacid'] = $_W['uniacid'];				$pars[':module'] = $params['module'];				$pars[':tid'] = $params['tid'];				$sql = 'SELECT * FROM ' . tablename('core_paylog') . ' WHERE `uniacid`=:uniacid AND `module`=:module AND `tid`=:tid';				$log = pdo_fetch($sql, $pars);				if(!empty($log) && $log['status'] == '1') {					message('这个订单已经支付成功, 不需要重复支付.');				}				$setting = uni_setting($_W['uniacid'], array('payment', 'creditbehaviors'));				if(!is_array($setting['payment'])) {					message('没有有效的支付方式, 请联系网站管理员.');				}				if (empty($log)) {			        $log = array(			                'uniacid' => $_W['uniacid'],			                'acid' => $_W['acid'],			                'openid' => $from_user,			                'module' => $this->module['name'], //模块名称，请保证$this可用			                'tid' => $params['tid'],			                'fee' => $total,			                'card_fee' => $total,			                'status' => '0',			                'is_usecard' => '0',											'uniontid'=>$params['tid']			        );			        pdo_insert('core_paylog', $log);				}				$params=base64_encode(json_encode($params));				echo "<script>						window.location.href = '".url('mc/cash/wechat')."&params=".$params."';					</script>";			}			else			{				echo "操作错误！，请返回重试";				exit;			}		}		else{			$id=$_GPC['id'];			echo $id."用户授权错误，请返回重试！";		}	}	}	public function payResult($params) {		global $_W,$_GPC;		$api = $this->module['config']['api'];		$uniacid =  $weid =$_W['uniacid'];		$from_user=$_W['openid'];		$sitem=pdo_fetch("SELECT bro_wx FROM ".tablename('jy_signup_a_setting')." WHERE weid=".$weid);		if($sitem['bro_wx']==1){				$from_user=$_W['openid'];		}else{				$from_user=$params['user'];		}		$hdid=substr($params['tid'], 10);		$params['module'] = $this->module['name'];		$pars = array();		$pars[':uniacid'] = $_W['uniacid'];		$pars[':module'] = $params['module'];		$pars[':tid'] = $params['tid'];		$sql = 'SELECT * FROM ' . tablename('core_paylog') . ' WHERE `uniacid`=:uniacid AND `module`=:module AND `tid`=:tid';		$log = pdo_fetch($sql, $pars);		if($log['fee']!=$params['fee'])		{			echo '非法操作！发布失败!';		}		$member_temp=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_member')." WHERE from_user='".$from_user."' AND weid=".$uniacid." AND status=1");		$mid=$member_temp['id'];	  if(!empty($mid)){			$temp=pdo_fetch("SELECT id FROM ".tablename('jy_signup_a_hd_cy')." WHERE weid=".$uniacid." AND hdid=".$hdid." AND mid=".$mid);		}		if ($params['result'] == 'success' && $params['from'] == 'notify') {			if(empty($temp))			{				$hd=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_hd')." WHERE id=".$hdid);				$cy=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_hd_cy_temp')." WHERE weid=".$uniacid." AND mid=".$mid." AND hdid=".$hdid);				$data=array(					'weid'=>$uniacid,					'hdid'=>$hdid,					'mid'=>$mid,					'status'=>1,					'createtime'=>TIMESTAMP,					);				$data['plid']=$log['plid'];				pdo_insert("jy_signup_a_hd_cy",$data);				pdo_update("jy_signup_a_hd",array('num'=>($hd['num']+1)),array('id'=>$hdid));				if($hd['shenhe']==1)				{					if(!empty($params['user']))					{						$text="恭喜您,提交【".$hd['hdname']."】报名信息成功！";					}				}				else				{					if(empty($hd['renshu']))					{						$data=array(							'weid'=>$uniacid,							'hdid'=>$hdid,							'mid'=>$mid,							'status'=>1,							'createtime'=>TIMESTAMP,						);						pdo_insert("jy_signup_a_hd_card",$data);						$text="<a href='".$_W['siteroot'].'app/'.substr($this->createMobileUrl('detail',array('id'=>$hdid)),2)."'>恭喜您！活动【".$hd['hdname'].'】'."报名成功，点击查看报名详情！</a>";					}					else					{						$card_count=pdo_fetchcolumn("SELECT count(id) FROM ".tablename('jy_signup_a_hd_card')." WHERE weid=".$uniacid." AND hdid=".$hdid);						if($card_count<$hd['renshu'])						{							$data=array(								'weid'=>$uniacid,								'hdid'=>$hdid,								'mid'=>$mid,								'status'=>1,								'createtime'=>TIMESTAMP,							);							pdo_insert("jy_signup_a_hd_card",$data);							$text="<a href='".$_W['siteroot'].'app/'.substr($this->createMobileUrl('detail',array('id'=>$hdid)),2)."'>恭喜您！活动【".$hd['hdname']."】报名成功，点击查看报名详情！</a>";						}						else						{							$text="恭喜您,提交报名【".$hd['hdname']."】进入等位状态！";							if(!empty($hd['paiwei']))							{								$text.="在您前面还有".($card_count-$done_num-1)."人等位!我们会随时通知您等位情况。";							}						}					}				}				$text=urlencode($text);				$access_token = WeAccount::token();				$data = array(				  "touser"=>$_W['openid'],				  "msgtype"=>"text",				  "text"=>array("content"=>$text)				);				$url = "https://api.weixin.qq.com/cgi-bin/message/custom/send?access_token={$access_token}";				load()->func('communication');				$response = ihttp_request($url, urldecode(json_encode($data)));				if(!empty($cy['pl']))				{					$data=array(							'weid'=>$uniacid,							'hdid'=>$hdid,							'mid'=>$mid,							'description'=>$cy['pl'],							'createtime'=>TIMESTAMP,						);					pdo_insert('jy_signup_a_hdcomment',$data);					pdo_update("jy_signup_a_hd",array('pl'=>$hd['pl']+1),array('id'=>$id));				}			}else{				echo "<script>					window.location.href = '".$_W['siteroot'].'app/' .substr($this->createMobileUrl('detail',array('id'=>$hdid)),2)."';				</script>";			}			message('报名成功！', $this->createMobileUrl('detail',array('id'=>$hdid)), 'success');		}		if ($params['from'] == 'return') {			if ($params['result'] == 'success') {				echo "<script>					window.location.href = '".$_W['siteroot'].'app/' .substr($this->createMobileUrl('detail',array('id'=>$hdid)),2)."';				</script>";			}			else			{				message('支付失败！', $this->createMobileUrl('index'), 'success');			}		}	}	public function doMobileGeren() {		//首页		global $_W,$_GPC;		if ( strpos($_SERVER['HTTP_USER_AGENT'], 'MicroMessenger') == false ) {			$weixin=0;			$weid=$_GPC['i'];			session_start();			$mid=$_SESSION['mid'];		}		else		{			$weixin=1;			$weid=$_W['uniacid'];			//checkAuth();			$from_user=$_W['openid'];      $member_temp=pdo_fetch("SELECT uid,nickname,follow FROM ".tablename('mc_mapping_fans')." WHERE openid='$from_user' AND uniacid=".$weid);      if(empty($member_temp['nickname']) || $member_temp['uid']==0)      {        $member_temp=pdo_fetch("SELECT uid,nickname,follow FROM ".tablename('mc_mapping_fans')." WHERE openid='$from_user' order by uid desc limit 1 ");        $uid = $member_temp['uid'];      }      else      {        $uid = $member_temp['uid'];        $uid=$member_temp['uid'];        $_W['member']['uid']=$uid;        // unset($member_temp);      }			if(empty($uid))			{				echo "<script>					window.location.href = '".$this->createMobileUrl('userinfo',array('op'=>'geren',array('id'=>$_GPC['id'])))."';				</script>";			}			else			{				$member=pdo_fetch("SELECT id FROM ".tablename('jy_signup_a_member')." WHERE weid=".$weid." AND from_user='".$from_user."' AND status=1");				$mid=$member['id'];			}		}		$sitem=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_setting')." WHERE weid=".$weid);		if(empty($mid))		{			echo "<script>					window.location.href = '".$this->createMobileUrl('login')."';				</script>";		}		else		{			$member=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_member')." WHERE weid=".$weid." AND id=".$mid);			if(!empty($member['wechatid']))			{				$temp=pdo_fetch("SELECT avatar,nickname,credit1 FROM ".tablename('mc_members')." WHERE uniacid=".$weid." AND uid=".$member['wechatid']);				$member['nicheng']=$temp['nickname'];				$member['avatar']=$temp['avatar'];				$member['jifen']=$temp['credit1'];				$dy=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_dianyuan')." WHERE weid=".$weid." AND uid=".$member['wechatid']);			}			if(empty($member['jifen']))			{				$member['jifen']=0;			}			$url=pdo_fetchall("SELECT * FROM ".tablename('jy_signup_a_url')." WHERE weid=".$weid." AND enabled=1 ORDER BY displayorder DESC,id ASC ");		}		include $this->template('geren');	}	public function doMobileDy() {		//首页		global $_W,$_GPC;		if ( strpos($_SERVER['HTTP_USER_AGENT'], 'MicroMessenger') == false ) {			$weixin=0;			$weid=$_GPC['i'];			session_start();			$mid=$_SESSION['mid'];			if(!empty($mid))			{				$member=pdo_fetch("SELECT wechatid FROM ".tablename('jy_signup_a_member')." WHERE weid=".$weid." AND id=".$mid." AND status=1");				$uid=$member['wechatid'];			}		}		else		{			$weixin=1;			$weid=$_W['uniacid'];			//checkAuth();			$from_user=$_W['openid'];      $member_temp=pdo_fetch("SELECT uid,nickname,follow FROM ".tablename('mc_mapping_fans')." WHERE openid='$from_user' AND uniacid=".$weid);			if(empty($member_temp['nickname']) || $member_temp['uid']==0)			{        $_temp =  $member_temp = pdo_fetch("SELECT uid,nickname,follow FROM ".tablename('mc_mapping_fans')." WHERE openid='$from_user' order by uid desc limit 1 ");				$uid = $member_temp['uid'];			}			else			{				$uid = $member_temp['uid'];        $uid=$member_temp['uid'];				$_W['member']['uid']=$uid;				// unset($member_temp);			}			if(empty($uid))			{				echo "<script>					window.location.href = '".$this->createMobileUrl('userinfo',array('op'=>'dy'))."';				</script>";			}			else			{				$member=pdo_fetch("SELECT id FROM ".tablename('jy_signup_a_member')." WHERE weid=".$weid." AND from_user='".$from_user."' AND status=1");				$mid=$member['id'];			}		}		$sitem=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_setting')." WHERE weid=".$weid);		if(!empty($uid))		{			$temp=pdo_fetch("SELECT avatar,nickname FROM ".tablename('mc_members')." WHERE uniacid=".$weid." AND uid=".$uid);			$member['nicheng']=$temp['nickname'];			$member['avatar']=$temp['avatar'];			$dy=pdo_fetchall("SELECT * FROM ".tablename('jy_signup_a_dianyuan')." WHERE weid=".$weid." AND uid=".$uid);			if(empty($dy))			{				echo "<script>					window.location.href = '".$this->createMobileUrl('dylogin')."';				</script>";			}		}		else		{			$dyid=$_SESSION['dyid'];			if(empty($dyid))			{				echo "<script>						window.location.href = '".$this->createMobileUrl('dylogin')."';					</script>";			}			else			{				$dy=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_dianyuan')." WHERE weid=".$weid." AND id=".$dyid." AND status=1");				if(!empty($dy['uid']))				{					$temp=pdo_fetch("SELECT avatar,nickname FROM ".tablename('mc_members')." WHERE uniacid=".$weid." AND uid=".$dy['uid']);					$member['nicheng']=$temp['nickname'];					$member['avatar']=$temp['avatar'];				}				else				{					$member['nicheng']=$dy['username'];				}				$s=1;				if(empty($dy))				{					echo "<script>						window.location.href = '".$this->createMobileUrl('dylogin')."';					</script>";				}			}		}		if(!empty($dy))		{			$type=$_GPC['type'];			$hdid=$_GPC['hdid'];			$mdid=$_GPC['mdid'];			if($s==1)			{				$mendian_ids.=$dy['mendianid'].",";			}			else			{				foreach ($dy as $key => $value) {					$mendian_ids.=$value['mendianid'].",";				}			}			$mendian_ids=substr($mendian_ids, 0,-1);			$mendian_arr=" AND id IN (".$mendian_ids.") ";			$hd_arr=" AND a.mendianid IN (".$mendian_ids.") ";			$mendian=pdo_fetchall("SELECT id,mendianname FROM ".tablename('jy_signup_a_mendian')." WHERE weid=".$weid.$mendian_arr);			if(!empty($mdid))			{				$condition=" AND a.mendianid=".$mdid;			}			$huodong=pdo_fetchall("SELECT b.id,b.hdname FROM ".tablename('jy_signup_a_mendian_hd')." as a left join ".tablename('jy_signup_a_hd')." as b on a.hdid=b.id WHERE a.weid=".$weid.$hd_arr.$condition." AND b.enabled=1 AND b.isshow=1 ");			$all_hd=pdo_fetchall("SELECT b.id FROM ".tablename('jy_signup_a_mendian_hd')." as a left join ".tablename('jy_signup_a_hd')." as b on a.hdid=b.id WHERE a.weid=".$weid.$hd_arr." AND b.enabled=1 AND b.isshow=1 ");			if(!empty($all_hd))			{				foreach ($all_hd as $key => $value) {					$temp_hx_hd2.=$value['id'].",";				}				$temp_hx_hd2=substr($temp_hx_hd2, 0 , -1);				$hx_hdids.=" AND a.hdid IN ( ".$temp_hx_hd2." ) ";			}			else			{				$hx_hdids=" AND 0 ";			}			if(!empty($mdid))			{				$mendian_xz=pdo_fetch("SELECT mendianname FROM ".tablename('jy_signup_a_mendian')." WHERE weid=".$weid." AND id=".$mdid);				$hx_hd=pdo_fetchall("SELECT hdid FROM ".tablename('jy_signup_a_mendian_hd')." WHERE weid=".$weid." AND mendianid=".$mdid);				foreach ($hx_hd as $key => $value) {					$temp_hx_hd.=$value['hdid'].",";				}				if(!empty($hx_hd))				{					$temp_hx_hd=substr($temp_hx_hd, 0 , -1);					$hx_hdids.=" AND a.hdid IN ( ".$temp_hx_hd." ) ";				}				else				{					$hx_hdids.=" AND 0 ";				}			}			if(!empty($hdid))			{				$hd_xz=pdo_fetch("SELECT hdname FROM ".tablename('jy_signup_a_hd')." WHERE weid=".$weid." AND id=".$hdid);				$hx_hdids.=" AND a.hdid IN (".$hdid.") ";			}			if(!empty($_GPC['type']))			{				if($_GPC['type']==1)				{					$hx_hdids.=" AND a.status=1 ";				}				else				{					$hx_hdids.=" AND a.status=0 ";				}			}			$hexiao=pdo_fetchall("SELECT a.id,a.status,a.createtime,b.nicheng,b.mobile,c.nickname,c.avatar FROM ".tablename('jy_signup_a_hd_card')." as a left join ".tablename('jy_signup_a_member')." as b on a.mid=b.id left join ".tablename('mc_members')." as c on b.wechatid=c.uid  WHERE a.weid= ".$weid.$hx_hdids);			include $this->template('dy');		}	}	public function doMobileCard() {		global $_W,$_GPC;		if ( strpos($_SERVER['HTTP_USER_AGENT'], 'MicroMessenger') == false ) {			$weixin=0;			$weid=$_GPC['i'];		}		else		{			$weixin=1;			$weid=$_W['uniacid'];		}		$cardid=$_GPC['cardid'];		$card=pdo_fetch("SELECT a.hdid,a.mid,a.status,b.username FROM ".tablename('jy_signup_a_hd_card')." as a left join ".tablename('jy_signup_a_dianyuan')." as b on a.hxid=b.id WHERE a.weid=".$weid." AND a.id=".$cardid);		$bm=pdo_fetch("SELECT c.avatar FROM ".tablename('jy_signup_a_hd_cy')." as a left join ".tablename('jy_signup_a_member')." as b on a.mid=b.id left join ".tablename('mc_members')." as c on b.wechatid=c.uid WHERE a.weid=".$weid." AND a.hdid=".$card['hdid']." AND a.mid=".$card['mid']);		if(empty($bm['avatar']))		{			if (!empty($sitem['thumb']))			{				$bm['avatar']=$_W['attachurl'].$sitem['thumb'];			}			else			{				$bm['avatar']='../addons/jy_signup_a/images/no-50.png';			}		}		if(empty($card['status']))		{			$hexiao='<div class="msg_btm txtAC"><span>'.$card['username'].'&nbsp;核销</span></div>';		}		else		{			$hexiao='<div class="msg_btm txtAC"><span>仍未核销</span></div>';		}		$zl_list=pdo_fetchall("SELECT a.*,b.type,b.name FROM ".tablename('jy_signup_a_hd_attr_value')." as a left join ".tablename('jy_signup_a_attr')." as b on a.attr_id=b.id WHERE a.weid=".$weid." AND a.mid=".$card['mid']." AND hdid=".$card['hdid']);		foreach ($zl_list as $key => $value) {			$zl.='<div class="white marB8p">'.$value['name'].":".$value['zhi'].'</div>';		}		if($card['status']==1)		{			$html='<div><div class="mainBg msg_top"><div class="txtAC"><img class="msg_headImg" src="'.$bm['avatar'].'"/></div><div class="msg_conMsg txtAC">'.$zl.'<div class="gray2 font14">未核销</div></div></div>'.$hexiao.'<img id="close" src="../addons/jy_signup_a/images/close.png"/></div>';		}		else		{			$html='<div><div class="mainBg msg_top"><div class="txtAC"><img class="msg_headImg" src="'.$bm['avatar'].'"/></div><div class="msg_conMsg txtAC">'.$zl.'<div class="gray2 font14">已核销</div></div></div>'.$hexiao.'<img id="close" src="../addons/jy_signup_a/images/close.png"/></div>';		}		//echo "ads";		return json_encode(array('status'=>1,'log'=>$html));		exit;	}	public function doMobileDy_edit() {		global $_W,$_GPC;		if ( strpos($_SERVER['HTTP_USER_AGENT'], 'MicroMessenger') == false ) {			$weixin=0;			$weid=$_GPC['i'];			session_start();			$mid=$_SESSION['mid'];			if(!empty($mid))			{				$member=pdo_fetch("SELECT wechatid FROM ".tablename('jy_signup_a_member')." WHERE weid=".$weid." AND id=".$mid." AND status=1");				$uid=$member['wechatid'];			}		}		else		{			$weixin=1;			$weid=$_W['uniacid'];			//checkAuth();			$from_user=$_W['openid'];      $member_temp=pdo_fetch("SELECT uid,nickname,follow FROM ".tablename('mc_mapping_fans')." WHERE openid='$from_user' AND uniacid=".$weid);			if(empty($member_temp['nickname']) || $member_temp['uid']==0)			{        $_temp =  $member_temp = pdo_fetch("SELECT uid,nickname,follow FROM ".tablename('mc_mapping_fans')." WHERE openid='$from_user' order by uid desc limit 1 ");				$uid = $member_temp['uid'];			}			else			{				$uid = $member_temp['uid'];        $uid=$member_temp['uid'];				$_W['member']['uid']=$uid;				// unset($member_temp);			}			if(empty($uid))			{				echo "<script>					window.location.href = '".$this->createMobileUrl('userinfo',array('op'=>'dy'))."';				</script>";			}			else			{				$member=pdo_fetch("SELECT id FROM ".tablename('jy_signup_a_member')." WHERE weid=".$weid." AND from_user='".$from_user."' AND status=1");				$mid=$member['id'];			}		}		$sitem=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_setting')." WHERE weid=".$weid);		if(!empty($uid))		{			$temp=pdo_fetch("SELECT avatar,nickname FROM ".tablename('mc_members')." WHERE uniacid=".$weid." AND uid=".$uid);			$member['nicheng']=$temp['nickname'];			$member['avatar']=$temp['avatar'];			$dy=pdo_fetch("SELECT a.*,b.avatar FROM ".tablename('jy_signup_a_dianyuan')." as a left join ".tablename('mc_members')." as b on a.uid=b.uid WHERE a.weid=".$weid." AND a.uid=".$uid." AND a.status=1");			if(empty($dy))			{				echo "<script>					window.location.href = '".$this->createMobileUrl('dylogin')."';				</script>";			}		}		else		{			$dyid=$_SESSION['dyid'];			if(empty($dyid))			{				echo "<script>						window.location.href = '".$this->createMobileUrl('dylogin')."';					</script>";			}			else			{				$dy=pdo_fetch("SELECT a.*,b.avatar FROM ".tablename('jy_signup_a_dianyuan')." as a left join ".tablename('mc_members')." as b on a.uid=b.uid WHERE a.weid=".$weid." AND a.id=".$dyid." AND a.status=1");				if(empty($dy))				{					echo "<script>						window.location.href = '".$this->createMobileUrl('dylogin')."';					</script>";				}			}		}		$op=$_GPC['op'];		if($op=='add')		{			$data=array(					'weid'=>$weid,					'username'=>$_GPC['username'],					'mobile'=>$_GPC['mobile'],					'mail'=>$_GPC['mail'],					'QQ'=>$_GPC['qq'],					'wechat'=>$_GPC['wechat'],					'password'=>$_GPC['password'],					'description'=>$_GPC['description'],				);			pdo_update('jy_signup_a_dianyuan',$data,array('id'=>$dy['id']));			echo 1;			exit;		}		include $this->template('dy_edit');	}	public function doMobileDylogin() {		global $_W,$_GPC;		if ( strpos($_SERVER['HTTP_USER_AGENT'], 'MicroMessenger') == false ) {			$weixin=0;			$weid=$_GPC['i'];			session_start();			$mid=$_SESSION['mid'];			if(!empty($mid))			{				$member=pdo_fetch("SELECT wechatid FROM ".tablename('jy_signup_a_member')." WHERE weid=".$weid." AND id=".$mid." AND status=1");				$uid=$member['wechatid'];			}		}		else		{			$weixin=1;			$weid=$_W['uniacid'];			//checkAuth();			$from_user=$_W['openid'];      $member_temp=pdo_fetch("SELECT uid,nickname,follow FROM ".tablename('mc_mapping_fans')." WHERE openid='$from_user' AND uniacid=".$weid);			if(empty($member_temp['nickname']) || $member_temp['uid']==0)			{        $_temp =  $member_temp = pdo_fetch("SELECT uid,nickname,follow FROM ".tablename('mc_mapping_fans')." WHERE openid='$from_user' order by uid desc limit 1 ");				$uid = $member_temp['uid'];			}			else			{				$uid = $member_temp['uid'];        $uid=$member_temp['uid'];				$_W['member']['uid']=$uid;				// unset($member_temp);			}			if(empty($uid))			{				echo "<script>					window.location.href = '".$this->createMobileUrl('userinfo',array('op'=>'dylogin'))."';				</script>";			}			else			{				$member=pdo_fetch("SELECT id FROM ".tablename('jy_signup_a_member')." WHERE weid=".$weid." AND from_user='".$from_user."' AND status=1");				$mid=$member['id'];			}		}		$sitem=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_setting')." WHERE weid=".$weid);		$op=$_GPC['op'];		if($op=='add')		{			$mobile=intval($_GPC['mobile']);			$pwd=$_GPC['pwd'];			$temp_dy=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_dianyuan')." WHERE weid=".$weid." AND status=1 AND mobile=".$mobile);			if(empty($temp_dy))			{				echo 2;			}			else			{				if($pwd!=$temp_dy['password'])				{					echo 3;				}				else				{					$_SESSION['dyid']=$temp_dy['id'];					echo 1;				}			}			exit;		}		if(!empty($uid))		{			$dy=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_dianyuan')." WHERE weid=".$weid." AND uid=".$uid." AND status=1");			if(!empty($dy))			{				echo "<script>					window.location.href = '".$this->createMobileUrl('dy')."';				</script>";			}			else			{				include $this->template('dylogin');			}		}		else		{			$dyid=$_SESSION['dyid'];			if(!empty($dyid))			{				$dy=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_dianyuan')." WHERE weid=".$weid." AND id=".$dyid." AND status=1");				if(!empty($dy))				{					echo "<script>							window.location.href = '".$this->createMobileUrl('dy')."';						</script>";				}				else				{					include $this->template('dylogin');				}			}			else			{				include $this->template('dylogin');			}		}	}	public function doMobileMyCard() {		//首页		global $_W,$_GPC;		if ( strpos($_SERVER['HTTP_USER_AGENT'], 'MicroMessenger') == false ) {			$weixin=0;			$weid=$_GPC['i'];			session_start();			$mid=$_SESSION['mid'];		}		else		{			$weixin=1;			$weid=$_W['uniacid'];			//checkAuth();			$from_user=$_W['openid'];      $member_temp=pdo_fetch("SELECT uid,nickname,follow FROM ".tablename('mc_mapping_fans')." WHERE openid='$from_user' AND uniacid=".$weid);			if(empty($member_temp['nickname']) || $member_temp['uid']==0)			{        $_temp =  $member_temp = pdo_fetch("SELECT uid,nickname,follow FROM ".tablename('mc_mapping_fans')." WHERE openid='$from_user' order by uid desc limit 1 ");				$uid = $member_temp['uid'];			}			else			{				$uid = $member_temp['uid'];        $uid=$member_temp['uid'];				$_W['member']['uid']=$uid;				// unset($member_temp);			}			if(empty($uid))			{				echo "<script>					window.location.href = '".$this->createMobileUrl('userinfo',array('op'=>'mycard'))."';				</script>";			}			else			{				$member=pdo_fetch("SELECT id FROM ".tablename('jy_signup_a_member')." WHERE weid=".$weid." AND from_user='".$from_user."' AND status=1");				$mid=$member['id'];			}		}		$sitem=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_setting')." WHERE weid=".$weid);		if(empty($mid))		{			echo "<script>					window.location.href = '".$this->createMobileUrl('login')."';				</script>";		}		else		{			$hd=pdo_fetchall("SELECT a.id as cardid,a.status,b.* FROM ".tablename('jy_signup_a_hd_card')." as a left join ".tablename('jy_signup_a_hd')." as b on a.hdid=b.id WHERE a.weid=".$weid." AND a.mid=".$mid." ORDER BY a.createtime DESC,b.createtime DESC");		}		include $this->template('mycard');	}	public function doMobileMyplan() {		//首页		global $_W,$_GPC;		if ( strpos($_SERVER['HTTP_USER_AGENT'], 'MicroMessenger') == false ) {			$weixin=0;			$weid=$_GPC['i'];			session_start();			$mid=$_SESSION['mid'];		}		else		{			$weixin=1;			$weid=$_W['uniacid'];			//checkAuth();			$from_user=$_W['openid'];      $member_temp=pdo_fetch("SELECT uid,nickname,follow FROM ".tablename('mc_mapping_fans')." WHERE openid='$from_user' AND uniacid=".$weid);			if(empty($member_temp['nickname']) || $member_temp['uid']==0)			{        $_temp =  $member_temp = pdo_fetch("SELECT uid,nickname,follow FROM ".tablename('mc_mapping_fans')." WHERE openid='$from_user' order by uid desc limit 1 ");				$uid = $member_temp['uid'];			}			else			{				$uid = $member_temp['uid'];        $uid=$member_temp['uid'];				$_W['member']['uid']=$uid;				// unset($member_temp);			}			if(empty($uid))			{				echo "<script>					window.location.href = '".$this->createMobileUrl('userinfo',array('op'=>'myplan'))."';				</script>";			}			else			{				$member=pdo_fetch("SELECT id FROM ".tablename('jy_signup_a_member')." WHERE weid=".$weid." AND from_user='".$from_user."' AND status=1");				$mid=$member['id'];			}		}		$sitem=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_setting')." WHERE weid=".$weid);		if(empty($mid))		{			echo "<script>					window.location.href = '".$this->createMobileUrl('login')."';				</script>";		}		else		{			$hd=pdo_fetchall("SELECT b.* FROM ".tablename('jy_signup_a_hd_cy')." as a left join ".tablename('jy_signup_a_hd')." as b on a.hdid=b.id WHERE a.weid=".$weid." AND a.mid=".$mid." ORDER BY a.createtime DESC,b.createtime DESC");		}		include $this->template('myplan');	}	public function doMobileMylike() {		//首页		global $_W,$_GPC;		if ( strpos($_SERVER['HTTP_USER_AGENT'], 'MicroMessenger') == false ) {			$weixin=0;			$weid=$_GPC['i'];			session_start();			$mid=$_SESSION['mid'];		}		else		{			$weixin=1;			$weid=$_W['uniacid'];			//checkAuth();			$from_user=$_W['openid'];      $member_temp=pdo_fetch("SELECT uid,nickname,follow FROM ".tablename('mc_mapping_fans')." WHERE openid='$from_user' AND uniacid=".$weid);			if(empty($member_temp['nickname']) || $member_temp['uid']==0)			{        $_temp =  $member_temp = pdo_fetch("SELECT uid,nickname,follow FROM ".tablename('mc_mapping_fans')." WHERE openid='$from_user' order by uid desc limit 1 ");				$uid = $member_temp['uid'];			}			else			{				$uid = $member_temp['uid'];        $uid=$member_temp['uid'];				$_W['member']['uid']=$uid;				// unset($member_temp);			}			if(empty($uid))			{				echo "<script>					window.location.href = '".$this->createMobileUrl('userinfo',array('op'=>'mylike'))."';				</script>";			}			else			{				$member=pdo_fetch("SELECT id FROM ".tablename('jy_signup_a_member')." WHERE weid=".$weid." AND from_user='".$from_user."' AND status=1");				$mid=$member['id'];			}		}		$sitem=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_setting')." WHERE weid=".$weid);		if(empty($mid))		{			echo "<script>					window.location.href = '".$this->createMobileUrl('login')."';				</script>";		}		else		{			$hd=pdo_fetchall("SELECT b.* FROM ".tablename('jy_signup_a_hd_sc')." as a left join ".tablename('jy_signup_a_hd')." as b on a.hdid=b.id WHERE a.weid=".$weid." AND a.mid=".$mid." ORDER BY a.createtime DESC,b.createtime DESC");		}		include $this->template('mylike');	}	public function doMobileChange() {		//首页		global $_W,$_GPC;		if ( strpos($_SERVER['HTTP_USER_AGENT'], 'MicroMessenger') == false ) {			$weixin=0;			$weid=$_GPC['i'];			session_start();			$mid=$_SESSION['mid'];		}		else		{			$weixin=1;			$weid=$_W['uniacid'];			//checkAuth();			$from_user=$_W['openid'];      $member_temp=pdo_fetch("SELECT uid,nickname,follow FROM ".tablename('mc_mapping_fans')." WHERE openid='$from_user' AND uniacid=".$weid);			if(empty($member_temp['nickname']) || $member_temp['uid']==0)			{        $_temp =  $member_temp = pdo_fetch("SELECT uid,nickname,follow FROM ".tablename('mc_mapping_fans')." WHERE openid='$from_user' order by uid desc limit 1 ");				$uid = $member_temp['uid'];			}			else			{				$uid = $member_temp['uid'];        $uid=$member_temp['uid'];				$_W['member']['uid']=$uid;				// unset($member_temp);			}			if(empty($uid))			{				echo "<script>					window.location.href = '".$this->createMobileUrl('userinfo',array('op'=>'change'))."';				</script>";			}			else			{				$member=pdo_fetch("SELECT id FROM ".tablename('jy_signup_a_member')." WHERE weid=".$weid." AND from_user='".$from_user."' AND status=1");				$mid=$member['id'];			}		}		$sitem=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_setting')." WHERE weid=".$weid);		if(empty($mid))		{			echo "<script>					window.location.href = '".$this->createMobileUrl('login')."';				</script>";		}		else		{			$op=$_GPC['op'];			if($op=='add')			{				$temp=pdo_fetch("SELECT id FROM ".tablename('jy_signup_a_member')." WHERE weid=".$weid." AND mobile='".$_GPC['mobile']."'");				if($temp['id']!=$mid && !empty($temp))				{					echo 2;					exit;				}				pdo_update('jy_signup_a_member',array('pwd'=>$_GPC['password'],'mobile'=>$_GPC['mobile']),array('id'=>$mid));				echo 1;				exit;			}			else			{				$member=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_member')." WHERE weid=".$weid." AND id=".$mid);				include $this->template('change');			}		}	}	public function doMobileList() {		//首页		global $_W,$_GPC;		if ( strpos($_SERVER['HTTP_USER_AGENT'], 'MicroMessenger') == false ) {			$weixin=0;			$weid=$_GPC['i'];		}		else		{			$weixin=1;			$weid=$_W['uniacid'];		}		$id=$_GPC['id'];		$hd=pdo_fetch("SELECT hdname FROM ".tablename('jy_signup_a_hd')." WHERE weid=".$weid." AND enabled=1 AND isshow=1 AND id=".$id);		$sitem=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_setting')." WHERE weid=".$weid);		$cy=pdo_fetchall("SELECT b.wechatid,b.nicheng,b.thumb FROM ".tablename('jy_signup_a_hd_cy')." as a left join ".tablename('jy_signup_a_member')." as b on a.mid=b.id WHERE a.weid=".$weid." AND a.hdid=".$id." ORDER BY a.createtime DESC");		foreach ($cy as $key => $value) {			if(!empty($value['thumb']))			{				$cy[$key]['avatar']=tomedia($value['thumb']);			}			else			{				if(!empty($value['wechatid']))				{					$temp=pdo_fetch("SELECT nickname,avatar FROM ".tablename('mc_members')." WHERE uniacid=".$weid." AND uid=".$value['wechatid']);					$cy[$key]['avatar']=$temp['avatar'];					$cy[$key]['nicheng']=$temp['nickname'];				}			}		}		include $this->template('list');	}	public function doMobileMdlist() {		global $_W,$_GPC;		if ( strpos($_SERVER['HTTP_USER_AGENT'], 'MicroMessenger') == false ) {			$weixin=0;			$weid=$_GPC['i'];			session_start();			$mid=$_SESSION['mid'];			if(!empty($mid))			{				$member=pdo_fetch("SELECT id,lat,lng FROM ".tablename('jy_signup_a_member')." WHERE weid=".$weid." AND id=".$mid." AND status=1");			}		}		else		{			$weixin=1;			$weid=$_W['uniacid'];			//checkAuth();			$from_user=$_W['openid'];      $member_temp=pdo_fetch("SELECT uid,nickname,follow FROM ".tablename('mc_mapping_fans')." WHERE openid='$from_user' AND uniacid=".$weid);			if(empty($member_temp['nickname']) || $member_temp['uid']==0)			{        $_temp =  $member_temp = pdo_fetch("SELECT uid,nickname,follow FROM ".tablename('mc_mapping_fans')." WHERE openid='$from_user' order by uid desc limit 1 ");				$uid = $member_temp['uid'];			}			else			{				$uid = $member_temp['uid'];        $uid=$member_temp['uid'];				$_W['member']['uid']=$uid;				// unset($member_temp);			}			if(empty($uid))			{				echo "<script>					window.location.href = '".$this->createMobileUrl('userinfo',array('op'=>'geren',array('id'=>$_GPC['id'])))."';				</script>";			}			else			{				$member=pdo_fetch("SELECT id,lat,lng FROM ".tablename('jy_signup_a_member')." WHERE weid=".$weid." AND from_user='".$from_user."' AND status=1");				$mid=$member['id'];			}		}		$id=$_GPC['hdid'];		$hd=pdo_fetch("SELECT hdname FROM ".tablename('jy_signup_a_hd')." WHERE weid=".$weid." AND enabled=1 AND isshow=1 AND id=".$id);		$sitem=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_setting')." WHERE weid=".$weid);		$mendian=pdo_fetchall("SELECT b.* FROM ".tablename('jy_signup_a_mendian_hd')." as a left join ".tablename('jy_signup_a_mendian')." as b on a.mendianid=b.id WHERE a.weid=".$weid." AND a.hdid= ".$id);		if(!empty($member['lat']))		{			$x1=(M_PI/180)*$member['lng'];	        $y1=(M_PI/180)*$member['lat'];	        $r=6371;			$mendian=pdo_fetchall("SELECT b.*,(ACOS(SIN((PI()/180)*b.lat)*SIN(".$y1.")+COS((PI()/180)*b.lat)*COS(".$y1.")*COS((PI()/180)*b.lng-".$x1."))*".$r.") as juli from ".tablename('jy_signup_a_mendian_hd')." as a left join ".tablename('jy_signup_a_mendian')." as b on a.mendianid=b.id WHERE a.weid=".$weid." AND a.hdid= ".$id." ORDER BY juli ASC");		}		else		{			$mendian=pdo_fetchall("SELECT b.* FROM ".tablename('jy_signup_a_mendian_hd')." as a left join ".tablename('jy_signup_a_mendian')." as b on a.mendianid=b.id WHERE a.weid=".$weid." AND a.hdid= ".$id);		}		if($this->isMobile()){			$mobile=1;		}		include $this->template('mdlist');	}	public function isMobile()	{	    // 如果有HTTP_X_WAP_PROFILE则一定是移动设备	    if (isset ($_SERVER['HTTP_X_WAP_PROFILE']))	    {	        return true;	    }	    // 如果via信息含有wap则一定是移动设备,部分服务商会屏蔽该信息	    if (isset ($_SERVER['HTTP_VIA']))	    {	        // 找不到为flase,否则为true	        return stristr($_SERVER['HTTP_VIA'], "wap") ? true : false;	    }	    // 脑残法，判断手机发送的客户端标志,兼容性有待提高	    if (isset ($_SERVER['HTTP_USER_AGENT']))	    {	        $clientkeywords = array ('nokia',	            'sony',	            'ericsson',	            'mot',	            'samsung',	            'htc',	            'sgh',	            'lg',	            'sharp',	            'sie-',	            'philips',	            'panasonic',	            'alcatel',	            'lenovo',	            'iphone',	            'ipod',	            'blackberry',	            'meizu',	            'android',	            'netfront',	            'symbian',	            'ucweb',	            'windowsce',	            'palm',	            'operamini',	            'operamobi',	            'openwave',	            'nexusone',	            'cldc',	            'midp',	            'wap',	            'mobile'	            );	        // 从HTTP_USER_AGENT中查找手机浏览器的关键字	        if (preg_match("/(" . implode('|', $clientkeywords) . ")/i", strtolower($_SERVER['HTTP_USER_AGENT'])))	        {	            return true;	        }	    }	    // 协议法，因为有可能不准确，放到最后判断	    if (isset ($_SERVER['HTTP_ACCEPT']))	    {	        // 如果只支持wml并且不支持html那一定是移动设备	        // 如果支持wml和html但是wml在html之前则是移动设备	        if ((strpos($_SERVER['HTTP_ACCEPT'], 'vnd.wap.wml') !== false) && (strpos($_SERVER['HTTP_ACCEPT'], 'text/html') === false || (strpos($_SERVER['HTTP_ACCEPT'], 'vnd.wap.wml') < strpos($_SERVER['HTTP_ACCEPT'], 'text/html'))))	        {	            return true;	        }	    }	    return false;	}	public function doMobileList2() {		//首页		global $_W,$_GPC;		if ( strpos($_SERVER['HTTP_USER_AGENT'], 'MicroMessenger') == false ) {			$weixin=0;			$weid=$_GPC['i'];		}		else		{			$weixin=1;			$weid=$_W['uniacid'];		}		$id=$_GPC['id'];		$hd=pdo_fetch("SELECT hdname FROM ".tablename('jy_signup_a_hd')." WHERE weid=".$weid." AND enabled=1 AND isshow=1 AND id=".$id);		$sitem=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_setting')." WHERE weid=".$weid);		$cy=pdo_fetchall("SELECT b.wechatid,b.nicheng,b.thumb FROM ".tablename('jy_signup_a_hd_card')." as a left join ".tablename('jy_signup_a_member')." as b on a.mid=b.id WHERE a.weid=".$weid." AND a.hdid=".$id." ORDER BY a.createtime DESC");		foreach ($cy as $key => $value) {			if(!empty($value['thumb']))			{				$cy[$key]['avatar']=tomedia($value['thumb']);			}			else			{				if(!empty($value['wechatid']))				{					$temp=pdo_fetch("SELECT nickname,avatar FROM ".tablename('mc_members')." WHERE uniacid=".$weid." AND uid=".$value['wechatid']);					$cy[$key]['avatar']=$temp['avatar'];					$cy[$key]['nicheng']=$temp['nickname'];				}			}		}		include $this->template('list');	}	public function doMobileLogin() {		//首页		global $_W,$_GPC;		if ( strpos($_SERVER['HTTP_USER_AGENT'], 'MicroMessenger') == false ) {			$weixin=0;			$weid=$_GPC['i'];		}		else		{			$weixin=1;			$weid=$_W['uniacid'];			//checkAuth();			$from_user=$_W['openid'];      $member_temp=pdo_fetch("SELECT uid,nickname,follow FROM ".tablename('mc_mapping_fans')." WHERE openid='$from_user' AND uniacid=".$weid);			if(empty($member_temp['nickname']) || $member_temp['uid']==0)			{        $_temp =  $member_temp = pdo_fetch("SELECT uid,nickname,follow FROM ".tablename('mc_mapping_fans')." WHERE openid='$from_user' order by uid desc limit 1 ");				$uid = $member_temp['uid'];			}			else			{				$uid = $member_temp['uid'];        $uid=$member_temp['uid'];				$_W['member']['uid']=$uid;				// unset($member_temp);			}			if(empty($uid))			{				echo "<script>					window.location.href = '".$this->createMobileUrl('userinfo',array('op'=>'login','id'=>$_GPC['id']))."';				</script>";			}		}		$sitem=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_setting')." WHERE weid=".$weid);		$op=$_GPC['op'];		$id=$_GPC['id'];		if($op=='add')		{			$mobile=$_GPC['mobile'];			$member=pdo_fetch("SELECT id,pwd,from_user FROM ".tablename('jy_signup_a_member')." WHERE weid=".$weid." AND mobile='".$mobile."'");			if(!empty($member))			{				$password=$_GPC['password'];				if($member['pwd']==$password)				{					if(!empty($weixin))					{						pdo_update('jy_signup_a_member',array('from_user'=>$from_user),array('id'=>$member['id']));						pdo_update("jy_signup_a_member",array('status'=>0),array('from_user'=>$from_user));						pdo_update("jy_signup_a_member",array('status'=>1),array('id'=>$member['id']));					}					else					{						session_start();						$_SESSION['mid']=$member['id'];					}					return json_encode(array('status'=>1,'id'=>$id));					//echo 1;					exit;				}				else				{					return json_encode(array('status'=>2));					//echo 2;					exit;				}			}			else			{				//echo 3;				return json_encode(array('status'=>3));				exit;			}		}		include $this->template('login');	}	public function doMobileLogout() {		//首页		global $_W,$_GPC;		if ( strpos($_SERVER['HTTP_USER_AGENT'], 'MicroMessenger') == false ) {			$weixin=0;			$weid=$_GPC['i'];			session_start();			$mid=$_SESSION['mid'];			$_SESSION['mid']=0;		}		else		{			$weixin=1;			$weid=$_W['uniacid'];			//checkAuth();			$from_user=$_W['openid'];      $member_temp=pdo_fetch("SELECT uid,nickname,follow FROM ".tablename('mc_mapping_fans')." WHERE openid='$from_user' AND uniacid=".$weid);			if(empty($member_temp['nickname']) || $member_temp['uid']==0)			{        $_temp =  $member_temp = pdo_fetch("SELECT uid,nickname,follow FROM ".tablename('mc_mapping_fans')." WHERE openid='$from_user' order by uid desc limit 1 ");				$uid = $member_temp['uid'];			}			else			{				$uid = $member_temp['uid'];        $uid=$member_temp['uid'];				$_W['member']['uid']=$uid;				// unset($member_temp);			}			if(empty($uid))			{				echo "<script>					window.location.href = '".$this->createMobileUrl('userinfo',array('op'=>'logout'))."';				</script>";			}			else			{				$member=pdo_fetch("SELECT id FROM ".tablename('jy_signup_a_member')." WHERE weid=".$weid." AND from_user='".$from_user."' AND status=1");				$mid=$member['id'];				pdo_update("jy_signup_a_member",array('status'=>0),array('id'=>$mid));			}		}		$sitem=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_setting')." WHERE weid=".$weid);		if(empty($mid))		{			echo "<script>					window.location.href = '".$this->createMobileUrl('login')."';				</script>";		}		else		{			echo "<script>					window.location.href = '".$this->createMobileUrl('login')."';				</script>";		}	}	public function doMobileZhuce() {		//首页		global $_W,$_GPC;		if ( strpos($_SERVER['HTTP_USER_AGENT'], 'MicroMessenger') == false ) {			$weixin=0;			$weid=$_GPC['i'];		}		else		{			$weixin=1;			$weid=$_W['uniacid'];		}		$sitem=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_setting')." WHERE weid=".$weid);		$op=$_GPC['op'];		if($op=='add')		{			$mobile=$_GPC['mobile'];			$member=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_member')." WHERE weid=".$weid." AND mobile='".$mobile."'");			if(empty($member))			{				$password=$_GPC['password'];				$data=array(						'weid'=>$weid,						'mobile'=>$mobile,						'pwd'=>$_GPC['password'],						'nicheng'=>$_GPC['nicheng'],						'status'=>1,						'type'=>0,						'createtime'=>TIMESTAMP,					);				pdo_insert('jy_signup_a_member',$data);				if(empty($weixin))				{					$member=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_member')." WHERE weid=".$weid." AND mobile='".$mobile."'");					session_start();					$_SESSION['mid']=$member['id'];				}				echo 1;				exit;			}			else			{				echo 2;				exit;			}		}		include $this->template('zhuce');	}	public function doMobileBind() {		//首页		global $_W,$_GPC;		$weid=$_W['uniacid'];		//checkAuth();		$from_user=$_W['openid'];    $member_temp=pdo_fetch("SELECT uid,nickname,follow FROM ".tablename('mc_mapping_fans')." WHERE openid='$from_user' AND uniacid=".$weid);    if(empty($member_temp['nickname']) || $member_temp['uid']==0)    {      $_temp =  $member_temp = pdo_fetch("SELECT uid,nickname,follow FROM ".tablename('mc_mapping_fans')." WHERE openid='$from_user' order by uid desc limit 1 ");      $uid = $member_temp['uid'];    }    else    {      $uid = $member_temp['uid'];      $uid=$member_temp['uid'];      $_W['member']['uid']=$uid;      // unset($member_temp);    }		if(empty($uid))		{			echo "<script>				window.location.href = '".$this->createMobileUrl('userinfo',array('op'=>'bind','id'=>$_GPC['id']))."';			</script>";		}		else		{			$member=pdo_fetch("SELECT id,from_user FROM ".tablename('jy_signup_a_member')." WHERE weid=".$weid." AND from_user='".$from_user."' AND type=1");			$mid=$member['id'];			if(empty($mid))			{				$data=array(						'weid'=>$weid,						'from_user'=>$from_user,						'wechatid'=>$uid,						'status'=>1,						'type'=>1,						'createtime'=>TIMESTAMP,					);				pdo_insert('jy_signup_a_member',$data);				$mid=pdo_insertid();			}			if(!empty($mid))			{				if(!empty($member['from_user']))				{					pdo_update("jy_signup_a_member",array('status'=>0),array('from_user'=>$member['from_user']));				}				if(empty($member['status']))				{					pdo_update("jy_signup_a_member",array('status'=>1),array('id'=>$member['id']));				}				$id=$_GPC['id'];				if(empty($id))				{					echo "<script>						window.location.href = '".$this->createMobileUrl('index')."';					</script>";				}				else				{					echo "<script>						window.location.href = '".$this->createMobileUrl('signup',array('id'=>$id))."';					</script>";				}			}			else			{				echo "出错了，请返回重试!";			}		}	}	public function doWebShua() {		//基本设置		global $_W,$_GPC;		$weid=$_W['uniacid'];		checklogin();		if(checksubmit()) {			$pv_min=intval($_GPC['pv_min']);			$pv_max=intval($_GPC['pv_max']);			$sc_min=intval($_GPC['sc_min']);			$sc_max=intval($_GPC['sc_max']);			if(empty($pv_min) || empty($pv_max) || empty($sc_min) || empty($sc_max))			{				message("请输入有效的值！");			}			if($pv_min>$pv_max)			{				message("浏览量最小值不得大于最大值!");			}			if($sc_min>$sc_max)			{				message("人气最小值不得大于最大值!");			}			$data=array(					'weid'=>$weid,					'pv_min'=>$pv_min,					'pv_max'=>$pv_max,					'sc_min'=>$sc_min,					'sc_max'=>$sc_max,					'createtime'=>TIMESTAMP,				);			pdo_insert("jy_signup_a_shua",$data);			$list=pdo_fetchall("SELECT pv,sc,id FROM ".tablename("jy_signup_a_hd")." WHERE weid=".$weid." AND enabled=1 AND isshow=1 ");			foreach ($list as $key => $value) {				$pv_temp=rand($pv_min,$pv_max);				$sc_temp=rand($sc_min,$sc_max);				pdo_update("jy_signup_a_hd",array('pv'=>$value['pv']+$pv_temp,'sc'=>$value['sc']+$sc_temp),array('id'=>$value['id']));			}			message("设置成功!",$this->createWebUrl('shua'),'success');		}		include $this->template('web/shua');	}	public function doWebSetting() {		//基本设置		global $_W,$_GPC;		$weid=$_W['uniacid'];		checklogin();		load()->func('tpl');		$item=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_setting')." WHERE weid=".$weid);		$files = $item['filename'];		$files = json_decode($files,true);		// var_dump($files);		if(empty($item))		{			$item['color']='#46CEC0';			$item['thumb']='../addons/jy_signup_a/images/no-50.png';		}		if(checksubmit()) {			if(is_array($_GPC['filename'])){				foreach ($_GPC['filename'] as $key => $value) {					 $filename[]  = array(						   'file'=>$value,							 'value'=>$_GPC['filevalues'][$key],					 );				}				 $filename = json_encode($filename);			}			$data=array(					'weid'=>$weid,					'aname'=>$_GPC['aname'],					'jifen'=>$_GPC['jifen'],					'title'=>$_GPC['title'],					'sharetitle'=>$_GPC['sharetitle'],					'sharedesc'=>$_GPC['sharedesc'],					'sharelogo'=>$_GPC['sharelogo'],					'color'=>$_GPC['color'],					'thumb'=>$_GPC['thumb'],					'copyright'=>$_GPC['copyright'],					'copyrighturl'=>$_GPC['copyrighturl'],					'createtime'=>TIMESTAMP,					'gongzuorenyuan'=>$_GPC['gongzuorenyuan'],					'is_must'=>$_GPC['is_must'],					'msguser'=>$_GPC['msguser'],					'msgpass'=>$_GPC['msgpass'],					'msgtmp'=>$_GPC['msgtmp'],					'product'=>$_GPC['product'],					'yindaoye'=>$_GPC['yindaoye'],					'q_guanzhu'=>$_GPC['q_guanzhu'],                    'list_show'=>$_GPC['list_show'],					'bro_wx'=>$_GPC['bro_wx'],					'bro_appid'=>$_GPC['bro_appid'],					'bro_mch'=>$_GPC['bro_mch'],					'bro_my'=>$_GPC['bro_my'],					'bro_appsecret'=>$_GPC['bro_appsecret'],					'metype'=>$_GPC['metype'],                    'gps'=>$_GPC['gps'],					'filename'=>$filename,					'dayu_appkey'=>$_GPC['dayu_appkey'],					'dayu_secretkey'=>$_GPC['dayu_secretkey'],					'dayu_sign'=>$_GPC['dayu_sign'],					'dayu_temp'=>$_GPC['dayu_temp'],				);			if(empty($item['id']))			{				pdo_insert("jy_signup_a_setting",$data);			}			else			{				pdo_update("jy_signup_a_setting",$data,array('weid'=>$weid));			}			message("设置成功!",$this->createWebUrl('setting'),'success');		}		include $this->template('web/setting');	}	public function doWebBrands() {		//品牌管理		global $_W,$_GPC;		$weid=$_W['uniacid'];		checklogin();		$operation = !empty($_GPC['op']) ? $_GPC['op'] : 'display';	    if ($operation == 'display') {	        if (!empty($_GPC['displayorder'])) {	            foreach ($_GPC['displayorder'] as $id => $displayorder) {	                pdo_update('jy_signup_a_brands', array('displayorder' => $displayorder), array('id' => $id));	            }	            message('品牌更新成功！', $this->createWebUrl('brands', array('op' => 'display')), 'success');	        }	        $category = pdo_fetchall("SELECT * FROM " . tablename('jy_signup_a_brands') . " WHERE weid = '{$_W['weid']}' ORDER BY displayorder DESC,id ASC");	        foreach ($category as $key => $value) {	        	$category[$key]['num']=pdo_fetchcolumn("SELECT count(id) FROM ".tablename('jy_signup_a_hd')." WHERE brand_id=".$value['id']." AND enabled=1");	        	$category[$key]['m_num']=pdo_fetchcolumn("SELECT count(id) FROM ".tablename('jy_signup_a_mendian')." WHERE brand_id=".$value['id']);	        }	        include $this->template('web/brands');	    } elseif ($operation == 'post') {	        $id = intval($_GPC['id']);	        load()->func('tpl');	        if (!empty($id)) {	            $category = pdo_fetch("SELECT * FROM " . tablename('jy_signup_a_brands') . " WHERE id = '$id'");	            $m_list = pdo_fetchall("SELECT * FROM ".tablename('jy_signup_a_mendian')."  WHERE weid = ".$weid." AND brand_id=".$id);				$g_list = pdo_fetchall("SELECT * FROM ".tablename('jy_signup_a_hd')."  WHERE weid = ".$weid." AND brand_id=".$id." AND enabled=1");				//查询每个商品拥有几家门店		        foreach ($g_list as $key => $value) {		        	$g_list[$key]['num']=pdo_fetchcolumn('SELECT count(id) FROM '.tablename('jy_signup_a_mendian_hd')." WHERE weid=".$weid." AND hdid=".$value['id']);		        }		        //查询每个门店拥有几家商品		        foreach ($m_list as $key => $value) {		        	$m_list[$key]['num']=pdo_fetchcolumn('SELECT count(id) FROM '.tablename('jy_signup_a_mendian_hd')." WHERE weid=".$weid." AND mendianid=".$value['id']);		        }	        } else {	            $category = array(	                'displayorder' => 0,	                'status' =>1,	            );	        }	        if (checksubmit('submit')) {	            if (empty($_GPC['catename'])) {	                message('抱歉，请输入品牌名称！');	            }	            if (empty($_GPC['thumb'])) {	                message('抱歉，请输入品牌logo！');	            }	            $data = array(	                'weid' => $_W['weid'],	                'title' => $_GPC['catename'],	                'thumb' => $_GPC['thumb'],	                'content' => $_GPC['content'],	                'displayorder' => intval($_GPC['displayorder']),	                'status' => intval($_GPC['status']),	                'createtime' =>TIMESTAMP,	            );	            if (!empty($id)) {	                pdo_update('jy_signup_a_brands', $data, array('id' => $id));	            } else {	                pdo_insert('jy_signup_a_brands', $data);	                $id = pdo_insertid();	            }	            message('更新品牌成功！', $this->createWebUrl('brands', array('op' => 'display')), 'success');	        }	        include $this->template('web/brands');	    } elseif ($operation == 'delete') {	        $id = intval($_GPC['id']);	        $category = pdo_fetch("SELECT id FROM " . tablename('jy_signup_a_brands') . " WHERE id = '$id'");	        if (empty($category)) {	            message('抱歉，品牌不存在或是已经被删除！', $this->createWebUrl('brands', array('op' => 'display')), 'error');	        }	        pdo_delete('jy_signup_a_brands', array('id' => $id));	        message('品牌删除成功！', $this->createWebUrl('brands', array('op' => 'display')), 'success');	    }	}	public function doWebMendian() {		//门店管理		global $_GPC, $_W;		$foo = !empty($_GPC['foo']) ? $_GPC['foo'] : 'mendian';		$condition = '';		$weid=$_W['uniacid'];		if ($foo == 'mendian') {			$pindex = max(1, intval($_GPC['page']));			$psize = 20;			load()->func('tpl');			if (!empty($_GPC['keyword'])) {				$condition .= " AND mendianname LIKE '%{$_GPC['keyword']}%' OR province LIKE '%{$_GPC['keyword']}%' OR city LIKE '%{$_GPC['keyword']}%'";			}			if(!empty($_GPC['brand_id']))			{				$condition .=" AND brand_id=".$_GPC['brand_id'];			}			$brands = pdo_fetchall("SELECT * FROM ".tablename('jy_signup_a_brands')." WHERE weid=".$weid." AND status=1");			$list = pdo_fetchall("SELECT * FROM ".tablename('jy_signup_a_mendian')." WHERE weid=".$weid." $condition LIMIT ".($pindex - 1) * $psize.",{$psize}");			foreach ($list as $key => $value) {				$num=pdo_fetchcolumn("SELECT count(id) FROM ".tablename('jy_signup_a_mendian_hd')." WHERE mendianid=".$value['id']." AND weid=".$weid);				$list[$key]['num']=$num;			}			$total = pdo_fetchcolumn('SELECT COUNT(*) FROM ' . tablename('jy_signup_a_mendian') . " WHERE weid=".$weid."  $condition ");			$pager = pagination($total, $pindex, $psize);		}		if ($foo == 'dianzhang') {			$list = pdo_fetchall("SELECT * FROM ".tablename('jy_signup_a_mendian')." WHERE weid = ".$weid." $condition");			$id = intval($_GPC['id']);			if (!empty($id)) {				$mendian = pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_mendian')." WHERE id = :id", array(':id' => $id));				if (empty($mendian)) {					message('抱歉，该门店不存在或是已经删除！', '', 'error');				}			}			$dz_list=pdo_fetchall("SELECT * FROM ".tablename("jy_signup_a_dianyuan")." WHERE weid=".$weid." AND mendianid=".$id." AND status=1 AND type=1");			$total=count($dz_list);			if (checksubmit('submit')) {				if (empty($_GPC['username'])) {					message('请输入用户名！');				}				if (!empty($_GPC['mail'])) {					if(ereg('([_a-z0-9-]+)(\.[_a-z0-9-]+)*@([a-z0-9-]+)(\.[a-z0-9-]+)*(\.[a-z]{2,4})$', $_GPC['mail'])){					}					else{message('邮箱地址错误!');}				}				$data = array(						'weid' => $_W['weid'],						'username' =>$_GPC['username'],						'mobile' => $_GPC['mobile'],						'mail' => $_GPC['mail'],						'description' => $_GPC['description'],						'QQ' => $_GPC['QQ'],						'wechat' => $_GPC['wechat'],						'password' =>$_GPC['password'],						'mendianid' =>$id,						'type' =>1,				);					$data['createtime']=TIMESTAMP;					pdo_insert('jy_signup_a_dianyuan', $data);				message('信息更新成功！', $this->createWebUrl('mendian', array('foo' => 'mendian')), 'success');			}		}		if ($foo == 'deletedy') {			$id = intval($_GPC['id']);			$item = pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_dianyuan')." WHERE id = ".$id);			if (empty($item)) {				message('抱歉，该用户不存在或是已经删除！', '', 'error');			}			//pdo_delete('jy_signup_a_dianyuan', array('id' => $id));			pdo_update('jy_signup_a_dianyuan',array('status'=>0,'from_user'=>'','uid'=>0),array('id'=>$id));			message('删除成功！', referer(), 'success');		}		if($foo =='remove')		{			$mendianid=intval($_GPC['id']);			$id =intval($_GPC['dyid']);			$item = pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_dianyuan')." WHERE id = ".$id);			if (empty($item)) {				message('抱歉，该用户不存在或是已经删除！', '', 'error');			}			pdo_update('jy_signup_a_dianyuan',array('type'=>0),array('id' =>$id));			message('解除店长关系成功！请选择其他人做为店长！',$this->createWebUrl('mendian',array('foo' => 'dianyuan','id' =>$mendianid)),'success');		}		if ($foo == 'dianyuan') {			$shopid=intval($_GPC['id']);			$pindex = max(1, intval($_GPC['page']));			$psize = 10;			$list = pdo_fetchall("SELECT a.*,b.nickname,b.avatar FROM ".tablename('jy_signup_a_dianyuan')." as a left join ".tablename('mc_members')." as b on a.uid=b.uid WHERE a.weid = ".$weid." AND a.status!=0 $condition"." AND mendianid=".$shopid." LIMIT ".($pindex - 1) * $psize.",{$psize}");			$total = pdo_fetchcolumn('SELECT COUNT(*) FROM ' . tablename('jy_signup_a_dianyuan') . " WHERE weid = '{$_W['weid']}'"." AND status!=0 $condition"." AND mendianid=".$shopid);			$pager = pagination($total, $pindex, $psize);		}		if($foo =='update')		{			$mendianid=intval($_GPC['id']);			$id =intval($_GPC['dyid']);			$item = pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_dianyuan')." WHERE id = ".$id);			if (empty($item)) {				message('抱歉，该用户不存在或是已经删除！', '', 'error');			}			pdo_update('jy_signup_a_dianyuan',array('type'=>1),array('id' =>$id));			message('设定店长关系成功！',$this->createWebUrl('mendian',array('foo' => 'dianyuan','id' =>$mendianid)),'success');		}		if($foo =='updated')		{			$mendianid=intval($_GPC['id']);			$id =intval($_GPC['dyid']);			$item = pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_dianyuan')." WHERE id = ".$id);			if (empty($item)) {				message('抱歉，该用户不存在或是已经删除！', '', 'error');			}			pdo_update('jy_signup_a_dianyuan',array('status'=>1),array('id' =>$id));			message('审核店员成功！',$this->createWebUrl('mendian',array('foo' => 'dianyuan','id' =>$mendianid)),'success');		}		if($foo =='newdy')		{			$mendianid=intval($_GPC['id']);			if (!empty($mendianid)) {				$mendian = pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_mendian')." WHERE id = ".$mendianid);				if (empty($mendian)) {					message('抱歉，该门店不存在或是已经删除！', '', 'error');				}			}			if (checksubmit('submit')) {				if (empty($_GPC['username'])) {					message('请输入用户名！');				}				if (!empty($_GPC['mail'])) {					if(ereg('([_a-z0-9-]+)(\.[_a-z0-9-]+)*@([a-z0-9-]+)(\.[a-z0-9-]+)*(\.[a-z]{2,4})$', $_GPC['mail']))					{					}					else{						message('邮箱地址错误!');					}				}				$data = array(					'weid' => $_W['weid'],					'username' =>$_GPC['username'],					'mobile' => $_GPC['mobile'],					'mail' => $_GPC['mail'],					'description' => $_GPC['description'],					'QQ' => $_GPC['QQ'],					'wechat' => $_GPC['wechat'],					'mendianid' =>$mendianid,					'password' =>$_GPC['password'],					'createtime' =>TIMESTAMP,				);				pdo_insert('jy_signup_a_dianyuan', $data);				message('信息更新成功！', $this->createWebUrl('mendian', array('foo' => 'dianyuan','id' =>$mendianid)), 'success');			}		}		if($foo =='editdy')		{			$mendianid=intval($_GPC['id']);			$id =intval($_GPC['dyid']);			if (!empty($mendianid)) {				$mendian = pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_mendian')." WHERE id = ".$mendianid);				if (empty($mendian)) {					message('抱歉，该门店不存在或是已经删除！', '', 'error');				}			}			$item = pdo_fetch("SELECT a.*,b.nickname,b.avatar FROM ".tablename('jy_signup_a_dianyuan')." as a left join ".tablename('mc_members')." as b on a.uid=b.uid WHERE a.id = ".$id);			if (empty($item)) {				message('抱歉，该用户不存在或是已经删除！', '', 'error');			}			if (checksubmit('submit')) {				if (empty($_GPC['username'])) {					message('请输入用户名！');				}				if (!empty($_GPC['mail'])) {					if(ereg('([_a-z0-9-]+)(\.[_a-z0-9-]+)*@([a-z0-9-]+)(\.[a-z0-9-]+)*(\.[a-z]{2,4})$', $_GPC['mail']))					{					}					else{						message('邮箱地址错误!');					}				}				$data = array(					'weid' => $_W['weid'],					'username' =>$_GPC['username'],					'mobile' => $_GPC['mobile'],					'mail' => $_GPC['mail'],					'description' => $_GPC['description'],					'QQ' => $_GPC['QQ'],					'wechat' => $_GPC['wechat'],					'password' =>$_GPC['password'],				);				pdo_update('jy_signup_a_dianyuan', $data, array('id' => $id));				message('信息更新成功！', $this->createWebUrl('mendian', array('foo' => 'dianyuan','id' =>$mendianid)), 'success');			}		}		if ($foo == 'del')		{			$id = intval($_GPC['id']);			$item = pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_mendian')." WHERE id = :id" , array(':id' => $id));			if (empty($item)) {				message('抱歉，该门店不存在或是已经删除！', '', 'error');			}			pdo_delete('jy_signup_a_mendian', array('id' => $item['id']));			pdo_delete("jy_signup_a_mendian_hd",array('mendianid'=>$item['id']));			message('删除成功！', referer(), 'success');		}		if ($foo =='edit'){			$id = intval($_GPC['id']);			load()->func('tpl');			if (!empty($id)) {				$item = pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_mendian')." WHERE id = :id", array(':id' => $id));				if (empty($item)) {					message('抱歉，该门店不存在或是已经删除！', '', 'error');				}			}			$brands = pdo_fetchall("SELECT * FROM ".tablename('jy_signup_a_brands')." WHERE weid=".$weid." AND status=1");			if(!empty($_GPC['brand_id']) || !empty($item['brand_id']))			{				if(!empty($item['brand_id']))				{					$brand_id=$item['brand_id'];				}				else				{					$brand_id=$_GPC['brand_id'];				}				$b_temp=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_brands')." WHERE id=".$brand_id." AND weid=".$weid);				$item['brand']=$b_temp['title'];			}			if (checksubmit('submit')) {				if (empty($_GPC['mendianname'])) {					message('请输入门店名！');				}				if (empty($_GPC['brand_id']))				{					message("请选择所属门店");				}				if (!empty($_GPC['mail'])) {					if(ereg('([_a-z0-9-]+)(\.[_a-z0-9-]+)*@([a-z0-9-]+)(\.[a-z0-9-]+)*(\.[a-z]{2,4})$', $_GPC['mail'])){					}					else{message('邮箱地址错误!');}				}				$data = array(						'weid' => $_W['weid'],						'brand_id'=>$_GPC['brand_id'],						'mendianname' =>$_GPC['mendianname'],						'thumb' => $_GPC['thumb'],						'tel' => $_GPC['tel'],						'mail' => $_GPC['mail'],						'description' => $_GPC['description'],						'lng' =>$_GPC['location']['lng'],						'lat' =>$_GPC['location']['lat'],						'province' => $_GPC['reside']['province'],						'city' => $_GPC['reside']['city'],						'dist' => $_GPC['reside']['district'],						'address' => $_GPC['address'],				);				if (empty($id)) {					$data['createtime']=TIMESTAMP;					pdo_insert('jy_signup_a_mendian', $data);					$id=pdo_insertid();				} else {					pdo_update('jy_signup_a_mendian', $data, array('id' => $id));				}				message('信息更新成功！', $this->createWebUrl('mendian', array('foo' => 'mendian')), 'success');			}		}		include $this->template('web/mendian');	}	public function doWebDianyuan()	{		global $_W, $_GPC;		$weid=$_W['weid'];		$foo = !empty($_GPC['foo']) ? $_GPC['foo'] : 'dianyuan';		$condition = '';		if (!empty($_GPC['keyword'])) {				$condition .= " AND b.mendianname LIKE '%{$_GPC['keyword']}%' OR b.province LIKE '%{$_GPC['keyword']}%' OR b.city LIKE '%{$_GPC['keyword']}%' OR a.username LIKE '%{$_GPC['keyword']}%'";			}		$pindex = max(1, intval($_GPC['page']));		$psize = 20;		$sql = "SELECT a.*, b.mendianname,b.tel,b.province,b.city,b.dist,c.nickname,c.avatar FROM " . tablename('jy_signup_a_dianyuan') . " AS a				LEFT JOIN " . tablename('jy_signup_a_mendian') . " AS b ON a.mendianid = b.id left join ".tablename('mc_members')." as c on a.uid=c.uid WHERE a.weid = ".$weid." AND a.status!=0 $condition ORDER BY b.city DESC  LIMIT " . ($pindex - 1) * $psize . ",{$psize}";		$list = pdo_fetchall($sql);		$total = count(pdo_fetchall("SELECT a.*, b.mendianname,b.tel,b.province,b.city,b.dist FROM " . tablename('jy_signup_a_dianyuan') . " AS a				LEFT JOIN " . tablename('jy_signup_a_mendian') . " AS b ON a.mendianid = b.id WHERE a.weid = ".$weid." AND a.status!=0 $condition"));		$pager = pagination($total, $pindex, $psize);		include $this->template('web/dianyuan');	}	public function doMobileDybind()	{		global $_W,$_GPC;		$id=$_GPC['id'];		$weid=$_W['uniacid'];		//checkAuth();		$from_user=$_W['openid'];    $member_temp=pdo_fetch("SELECT uid,nickname,follow FROM ".tablename('mc_mapping_fans')." WHERE openid='$from_user' AND uniacid=".$weid);    if(empty($member_temp['nickname']) || $member_temp['uid']==0)    {      $_temp =  $member_temp = pdo_fetch("SELECT uid,nickname,follow FROM ".tablename('mc_mapping_fans')." WHERE openid='$from_user' order by uid desc limit 1 ");      $uid = $member_temp['uid'];    }    else    {      $uid = $member_temp['uid'];      $uid=$member_temp['uid'];      $_W['member']['uid']=$uid;      // unset($member_temp);    }		if(empty($uid))		{			echo "<script>				window.location.href = '".$this->createMobileUrl('userinfo',array('op'=>'dybind','id'=>$id))."';			</script>";		}		else		{			$sitem=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_setting')." WHERE weid=".$weid);			$item = pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_dianyuan')." WHERE id = ".$id);			if (empty($item)) {				message('抱歉，该用户不存在或是已经删除！', '', 'error');			}			$dy = pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_dianyuan')." WHERE weid=".$weid." AND uid = ".$uid);			if (!empty($dy['uid']))			{				pdo_update("jy_signup_a_dianyuan",array('from_user'=>'','uid'=>0),array('id'=>$dy['id']));			}			pdo_update("jy_signup_a_dianyuan",array('from_user'=>$from_user,'uid'=>$uid),array('id'=>$id));		}		include $this->template('dybind');	}	public function doMobileHexiao()	{		global $_W,$_GPC;		$id=$_GPC['id'];		$cardid=$_GPC['cardid'];		$weid=$_W['uniacid'];		//checkAuth();		 $from_user=$_W['openid'];     $member_temp=pdo_fetch("SELECT uid,nickname,follow FROM ".tablename('mc_mapping_fans')." WHERE openid='$from_user' AND uniacid=".$weid);     if(empty($member_temp['nickname']) || $member_temp['uid']==0)     {       $_temp =  $member_temp = pdo_fetch("SELECT uid,nickname,follow FROM ".tablename('mc_mapping_fans')." WHERE openid='$from_user' order by uid desc limit 1 ");       $uid = $member_temp['uid'];     }     else     {       $uid = $member_temp['uid'];       $uid=$member_temp['uid'];       $_W['member']['uid']=$uid;       // unset($member_temp);     }		if(empty($uid))		{			echo "<script>				window.location.href = '".$this->createMobileUrl('userinfo',array('op'=>'hexiao','id'=>$id))."';			</script>";		}		else		{			$sitem=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_setting')." WHERE weid=".$weid);			$hd = pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_hd')." WHERE id = ".$id);			if (empty($hd)) {				message('抱歉，该活动不存在或是已经删除！', '', 'error');			}			$mendian_arr=pdo_fetchall("SELECT mendianid FROM ".tablename('jy_signup_a_mendian_hd')." WHERE weid=".$weid." AND hdid=".$hd['id']);			if(!empty($mendian_arr))			{				foreach ($mendian_arr as $key => $value) {					$temp_mendian.=$value['mendianid'].",";				}				$temp_mendian=substr($temp_mendian, 0 ,-1);				$mendian_ids=" AND mendianid IN (".$temp_mendian.") ";			}			else			{				$mendian_ids=' AND 0 ';			}			$dy = pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_dianyuan')." WHERE weid=".$weid." AND uid = ".$uid.$mendian_ids);			#hook2			if (empty($dy)) {				include $this->template('hexiao2');			}			else			{				$card=pdo_fetch("SELECT a.*,c.nickname FROM ".tablename('jy_signup_a_hd_card')." a				 left join ".tablename('jy_signup_a_member')." b on a.mid=b.id				 left join ".tablename('mc_members')." c on b.wechatid=c.uid				 WHERE a.id=".$cardid);				if($card['status']==1)				{					$sitem=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_setting')." WHERE weid=".$weid);					if(!empty($sitem['gongzuorenyuan'])){						 $gongzuorenyuan = explode(',',$sitem['gongzuorenyuan']);					}					load()->func('communication');					$access_token = WeAccount::token();					$url = "https://api.weixin.qq.com/cgi-bin/message/custom/send?access_token={$access_token}";					$_kgtxt = urlencode($card['nickname']."用户已成功参加【".$hd['hdname']."】活动，核销人员".$dy['username']);					foreach ($gongzuorenyuan as $key => $value) {						$data = array(							"touser"=>$value,							"msgtype"=>"text",							"text"=>array("content"=>$_kgtxt)						);						$response = ihttp_request($url, urldecode(json_encode($data)));						// var_dump($response);					}					pdo_update("jy_signup_a_hd_card",array('status'=>0,'hxid'=>$dy['id'],'hexiaotime'=>TIMESTAMP),array('id'=>$cardid));					include $this->template('hexiao');				}				else				{					include $this->template('hexiao3');				}			}		}	}	public function doWebQuyu() {		global $_W,$_GPC;		$weid=$_W['uniacid'];		checklogin();		$operation = !empty($_GPC['op']) ? $_GPC['op'] : 'display';	    if ($operation == 'display') {	        if (!empty($_GPC['displayorder'])) {	            foreach ($_GPC['displayorder'] as $id => $displayorder) {	                pdo_update('jy_signup_a_quyu', array('displayorder' => $displayorder), array('id' => $id));	            }	            message('区域更新成功！', $this->createWebUrl('quyu', array('op' => 'display')), 'success');	        }	        $children = array();	        $category = pdo_fetchall("SELECT * FROM " . tablename('jy_signup_a_quyu') . " WHERE weid = '{$_W['weid']}' ORDER BY displayorder DESC,id ASC");	        foreach ($category as $index => $row) {	            if (!empty($row['parentid'])) {	                $children[$row['parentid']][] = $row;	                unset($category[$index]);	                $category2 = pdo_fetchall("SELECT * FROM " . tablename('jy_signup_a_quyu') . " WHERE weid = '{$_W['weid']}' AND parentid=".$row['id']." ORDER BY displayorder DESC,id ASC");	            	foreach ($category2 as $key => $value) {	            		$children2[$row['id']][]=$value;	            	}	            }	        }	        include $this->template('web/quyu');	    } elseif ($operation == 'post') {	        $parentid = intval($_GPC['parentid']);	        $id = intval($_GPC['id']);	        if (!empty($id)) {	            $category = pdo_fetch("SELECT * FROM " . tablename('jy_signup_a_quyu') . " WHERE id = '$id'");	        } else {	            $category = array(	                'displayorder' => 0,	                'enabled' => 1,	                'status' => 2,	            );	        }	        if (!empty($parentid)) {	            $parent = pdo_fetch("SELECT id, name FROM " . tablename('jy_signup_a_quyu') . " WHERE id = '$parentid'");	            if (empty($parent)) {	                message('抱歉，该类型不存在或是已经被删除！', $this->createWebUrl('post'), 'error');	            }	        }	        if (checksubmit('submit')) {	            if (empty($_GPC['catename'])) {	                message('抱歉，请输入字段名称！');	            }	            $data = array(	                'weid' => $_W['weid'],	                'name' => $_GPC['catename'],	                'description' => $_GPC['description'],	                'enabled' => intval($_GPC['enabled']),	                'displayorder' => intval($_GPC['displayorder']),	                'enabled' => intval($_GPC['enabled']),	                'parentid' => intval($parentid),	            );	            if (!empty($id)) {	                unset($data['parentid']);	                pdo_update('jy_signup_a_quyu', $data, array('id' => $id));	            } else {	                pdo_insert('jy_signup_a_quyu', $data);	                $id = pdo_insertid();	            }	            message('更新信息设置成功！', $this->createWebUrl('quyu', array('op' => 'display')), 'success');	        }	        include $this->template('web/quyu');	    } elseif ($operation == 'delete') {	        $id = intval($_GPC['id']);	        $category = pdo_fetch("SELECT id, parentid FROM " . tablename('jy_signup_a_quyu') . " WHERE id = '$id'");	        if (empty($category)) {	            message('抱歉，不存在或是已经被删除！', $this->createWebUrl('quyu', array('op' => 'display')), 'error');	        }	        pdo_delete('jy_signup_a_quyu', array('id' => $id, 'parentid' => $id), 'OR');	        message('删除成功！', $this->createWebUrl('quyu', array('op' => 'display')), 'success');	    }	}	public function doWebAttr() {		global $_W,$_GPC;		$weid=$_W['uniacid'];		checklogin();        load()->func('tpl');		$operation = !empty($_GPC['op']) ? $_GPC['op'] : 'display';	    if ($operation == 'display') {	        if (!empty($_GPC['displayorder'])) {	            foreach ($_GPC['displayorder'] as $id => $displayorder) {	                pdo_update('jy_signup_a_attr', array('displayorder' => $displayorder), array('id' => $id));	            }	            message('自定义字段更新成功！', $this->createWebUrl('attr', array('op' => 'display')), 'success');	        }	        $children = array();	        $category = pdo_fetchall("SELECT * FROM " . tablename('jy_signup_a_attr') . " WHERE weid = '{$_W['weid']}' ORDER BY displayorder DESC,id ASC");	        foreach ($category as $index => $row) {	            if (!empty($row['parentid'])) {	                $children[$row['parentid']][] = $row;	                unset($category[$index]);	            }	        }	        include $this->template('web/attr');	    } elseif ($operation == 'post') {	        $parentid = intval($_GPC['parentid']);	        $id = intval($_GPC['id']);	        if (!empty($id)) {	            $category = pdo_fetch("SELECT * FROM " . tablename('jy_signup_a_attr') . " WHERE id = '$id'");	        } else {	            $category = array(	                'displayorder' => 0,	                'type' => 1,	                'enabled' => 1,	            );	        }	        if (!empty($parentid)) {	            $parent = pdo_fetch("SELECT id, name FROM " . tablename('jy_signup_a_attr') . " WHERE id = '$parentid'");	            if (empty($parent)) {	                message('抱歉，该类型不存在或是已经被删除！', $this->createWebUrl('post'), 'error');	            }	        }	        if (checksubmit('submit')) {	            if (empty($_GPC['catename'])) {	                message('抱歉，请输入字段名称！');	            }	            $data = array(	                'weid' => $_W['weid'],	                'name' => $_GPC['catename'],	                'description' => $_GPC['description'],	                'enabled' => intval($_GPC['enabled']),	                'displayorder' => intval($_GPC['displayorder']),	                'type' => intval($_GPC['type']),	                'enabled' => intval($_GPC['enabled']),	                'parentid' => intval($parentid),	            );	            if (!empty($id)) {	                unset($data['parentid']);	                pdo_update('jy_signup_a_attr', $data, array('id' => $id));	            } else {	                pdo_insert('jy_signup_a_attr', $data);	                $id = pdo_insertid();	            }	            message('更新信息设置成功！', $this->createWebUrl('attr', array('op' => 'display')), 'success');	        }	        include $this->template('web/attr');	    } elseif ($operation == 'delete') {	        $id = intval($_GPC['id']);	        $category = pdo_fetch("SELECT id, parentid FROM " . tablename('jy_signup_a_attr') . " WHERE id = '$id'");	        if (empty($category)) {	            message('抱歉，不存在或是已经被删除！', $this->createWebUrl('attr', array('op' => 'display')), 'error');	        }	        pdo_delete('jy_signup_a_attr', array('id' => $id, 'parentid' => $id), 'OR');	        message('删除成功！', $this->createWebUrl('attr', array('op' => 'display')), 'success');	    }	}	public function doWebUnbind()	{		global $_W,$_GPC;		$id=$_GPC['id'];		$mendianid=$_GPC['mendianid'];		$weid=$_W['uniacid'];		$item = pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_dianyuan')." WHERE id = ".$id);		if (empty($item)) {			message('抱歉，该用户不存在或是已经删除！', '', 'error');		}		pdo_update("jy_signup_a_dianyuan",array('from_user'=>'','uid'=>0),array('id'=>$id));		message('解除绑定成功！请绑定其他人！',$this->createWebUrl('mendian',array('foo' => 'dianyuan','id' =>$mendianid)),'success');	}	public function doWebCate() {		//活动分类		global $_W,$_GPC;		$weid=$_W['uniacid'];		checklogin();		$operation = !empty($_GPC['op']) ? $_GPC['op'] : 'display';	    if ($operation == 'display') {	        if (!empty($_GPC['displayorder'])) {	            foreach ($_GPC['displayorder'] as $id => $displayorder) {	                pdo_update('jy_signup_a_cate', array('displayorder' => $displayorder), array('id' => $id));	            }	            message('活动类型更新成功！', $this->createWebUrl('cate', array('op' => 'display')), 'success');	        }	        $category = pdo_fetchall("SELECT * FROM " . tablename('jy_signup_a_cate') . " WHERE weid = '{$_W['weid']}' ORDER BY displayorder DESC,id ASC");	        include $this->template('web/cate');	    } elseif ($operation == 'post') {	        $id = intval($_GPC['id']);	        if (!empty($id)) {	            $category = pdo_fetch("SELECT * FROM " . tablename('jy_signup_a_cate') . " WHERE id = '$id'");	        } else {	            $category = array(	                'displayorder' => 0,	                'enabled'=>1,	            );	        }	        if (checksubmit('submit')) {	            if (empty($_GPC['catename'])) {	                message('抱歉，请输入活动类型！');	            }	            $temp=pdo_fetch("SELECT id FROM ".tablename('jy_signup_a_cate')." WHERE weid=".$weid." AND name='".$_GPC['catename']."'");	            if(!empty($temp) && $id!=$temp['id'])	            {	            	message('已存在该活动类型！', $this->createWebUrl('cate', array('op' => 'display')), 'error');	            }	            $data = array(	                'weid' => $_W['weid'],	                'name' => $_GPC['catename'],	                'description' => $_GPC['description'],	                'enabled' => intval($_GPC['enabled']),	                'displayorder' => intval($_GPC['displayorder']),	            );	            if (!empty($id)) {	                pdo_update('jy_signup_a_cate', $data, array('id' => $id));	            } else {	                pdo_insert('jy_signup_a_cate', $data);	                $id = pdo_insertid();	            }	            message('更新活动类型设置成功！', $this->createWebUrl('cate', array('op' => 'display')), 'success');	        }	        include $this->template('web/cate');	    } elseif ($operation == 'delete') {	        $id = intval($_GPC['id']);	        $category = pdo_fetch("SELECT id FROM " . tablename('jy_signup_a_cate') . " WHERE id = '$id'");	        if (empty($category)) {	            message('抱歉，活动类型设置不存在或是已经被删除！', $this->createWebUrl('cate', array('op' => 'display')), 'error');	        }	        pdo_delete('jy_signup_a_cate', array('id' => $id));	        message('活动类型设置删除成功！', $this->createWebUrl('cate', array('op' => 'display')), 'success');	    }	}	public function doWeburl() {		global $_W, $_GPC;		$weid = $_W ['uniacid'];		checklogin ();		$operation = ! empty ( $_GPC ['op'] ) ? $_GPC ['op'] : 'display';		if ($operation == 'display') {			if (! empty ( $_GPC ['displayorder'] )) {				foreach ( $_GPC ['displayorder'] as $id => $displayorder ) {					pdo_update ( 'jy_signup_a_url', array (							'displayorder' => $displayorder					), array (							'id' => $id					) );				}				message ( '推广设置更新成功！', $this->createWebUrl ( 'url', array (						'op' => 'display'				) ), 'success' );			}			$category = pdo_fetchall ( "SELECT * FROM " . tablename ( 'jy_signup_a_url' ) . " WHERE weid = '{$_W['weid']}' ORDER BY displayorder DESC,id ASC" );			include $this->template ( 'web/url' );		} elseif ($operation == 'post') {			$id = intval ( $_GPC ['id'] );			load()->func('tpl');			if (! empty ( $id )) {				$category = pdo_fetch ( "SELECT * FROM " . tablename ( 'jy_signup_a_url' ) . " WHERE id = '$id'" );			} else {				$category = array (						'displayorder' => 0,						'thumb' => '',						'url' => '',						'enabled' => 1				);			}			if (checksubmit ( 'submit' )) {				if (empty ( $_GPC ['catename'] )) {					message ( '抱歉，请输入推广设置！' );				}				$temp = pdo_fetch ( "SELECT id FROM " . tablename ( 'jy_signup_a_url' ) . " WHERE weid=" . $weid . " AND name='" . $_GPC ['catename'] . "'" );				if (! empty ( $temp ) && $id != $temp ['id']) {					message ( '已存在该推广设置！', $this->createWebUrl ( 'url', array (							'op' => 'display'					) ), 'error' );				}				$data = array (						'weid' => $_W ['weid'],						'name' => $_GPC ['catename'],						'description' => $_GPC ['description'],						'enabled' => intval ( $_GPC ['enabled'] ),						'thumb' => $_GPC ['thumb'],						'url' => $_GPC ['url'],						'displayorder' => intval ( $_GPC ['displayorder'] )				);				if (! empty ( $id )) {					pdo_update ( 'jy_signup_a_url', $data, array (							'id' => $id					) );				} else {					pdo_insert ( 'jy_signup_a_url', $data );					$id = pdo_insertid ();				}				message ( '更新推广设置设置成功！', $this->createWebUrl ( 'url', array (						'op' => 'display'				) ), 'success' );			}			include $this->template ( 'web/url' );		} elseif ($operation == 'delete') {			$id = intval ( $_GPC ['id'] );			$category = pdo_fetch ( "SELECT id FROM " . tablename ( 'jy_signup_a_url' ) . " WHERE id = '$id'" );			if (empty ( $category )) {				message ( '抱歉，推广设置设置不存在或是已经被删除！', $this->createWebUrl ( 'url', array (						'op' => 'display'				) ), 'error' );			}			pdo_delete ( 'jy_signup_a_url', array (					'id' => $id			) );			message ( '推广设置设置删除成功！', $this->createWebUrl ( 'url', array (					'op' => 'display'			) ), 'success' );		}	}	public function doWebHuodong() {		//活动管理		global $_W,$_GPC;		$weid=$_W['uniacid'];		checklogin();		$op=$_GPC['op'];		if(empty($op))		{			$op='display';			if (!empty($_GPC['keyword'])) {				$condition .= " AND a.hdname LIKE '%{$_GPC['keyword']}%' OR a.province LIKE '%{$_GPC['keyword']}%' OR a.city LIKE '%{$_GPC['keyword']}%'";			}			$brand_id=$_GPC['brand_id'];			if(!empty($brand_id))			{				$condition .= " AND a.brand_id=".$brand_id;			}			$mendianid=$_GPC['mendianid'];			if(!empty($mendianid))			{				$temp_mendian=pdo_fetchall("SELECT * FROM ".tablename('jy_signup_a_mendian_hd')." WHERE weid=".$weid." AND mendianid=".$mendianid);				foreach ($temp_mendian as $key => $value) {					$mendian_ids.= $value['hdid'].",";				}				if(!empty($mendian_ids))				{					$mendian_ids=substr($mendian_ids, 0 , -1);					$condition .= " AND a.id IN (".$mendian_ids.") ";				}				else				{					$condition .= " AND 0";				}			}			$brands = pdo_fetchall("SELECT * FROM ".tablename('jy_signup_a_brands')." WHERE weid=".$weid." AND status=1");			$list=pdo_fetchall("SELECT a.*,b.title as name FROM ".tablename('jy_signup_a_hd')." as a  left join ".tablename('jy_signup_a_brands')." as b on a.brand_id=b.id WHERE a.weid=".$weid." AND a.enabled=1 $condition ORDER BY a.displayorder DESC,a.id ASC");			if (checksubmit('submit')) {	            foreach ($_GPC['displayorder'] as $id => $displayorder) {	                pdo_update('jy_signup_a_hd', array('displayorder' => $displayorder), array('id' => $id));	            }	            message('活动排序更新成功！', $this->createWebUrl('huodong'), 'success');	        }		}		if($op=='mdids')		{			$id=$_GPC['id'];			$brand_id=$_GPC['brand_id'];			if(!empty($brand_id))			{				$mendian=pdo_fetchall("SELECT id,mendianname FROM ".tablename('jy_signup_a_mendian')." WHERE weid=".$weid." AND brand_id=".$brand_id);				$mendian_ids=array();				if(!empty($id))				{					$temp_mendian=pdo_fetchall("SELECT mendianid FROM ".tablename('jy_signup_a_mendian_hd')." WHERE weid=".$weid." AND hdid=".$id);					foreach ($temp_mendian as $key => $value) {						array_push($mendian_ids, $value['mendianid']);					}				}				foreach ($mendian as $key => $value) {					if(in_array($value['id'], $mendian_ids))					{						$html.='<input type="checkbox" name="mendian_ids[]" value="'.$value['id'].'" checked>'.$value['mendianname']."&nbsp;&nbsp;&nbsp;";					}					else					{						$html.='<input type="checkbox" name="mendian_ids[]" value="'.$value['id'].'">'.$value['mendianname']."&nbsp;&nbsp;&nbsp;";					}				}				return json_encode(array('status'=>1,'log'=>$html));				exit;			}			else			{				return json_encode(array('status'=>2));				exit;			}		}		if($op=='add')		{			load()->func('tpl');			$mendianid=$_GPC['mendianid'];			$id=$_GPC['id'];			if(!empty($id))			{				$item=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_hd')." WHERE id=".$id);				$item['thumb'] = unserialize($item['thumb']);				if(!empty($item['brand_id']))				{					$mendian=pdo_fetchall("SELECT id,mendianname FROM ".tablename('jy_signup_a_mendian')." WHERE weid=".$weid." AND brand_id=".$item['brand_id']);					$temp_mendian=pdo_fetchall("SELECT mendianid FROM ".tablename('jy_signup_a_mendian_hd')." WHERE weid=".$weid." AND hdid=".$id);					$mendian_ids=array();					foreach ($temp_mendian as $key => $value) {						array_push($mendian_ids, $value['mendianid']);					}				}			}			else			{				$item=array(						'pl'=>0,						'sc'=>0,						'num'=>0,						'pv'=>0,						'shenhe'=>1,						'deadline'=>TIMESTAMP+3600*24*30,						'mendianid'=>$mendianid,						'starttime'=>TIMESTAMP+3600*24*7,						'endtime'=>TIMESTAMP+3600*24*30,					);			}			$brands = pdo_fetchall("SELECT * FROM ".tablename('jy_signup_a_brands')." WHERE weid=".$weid." AND status=1");			$hdcate=pdo_fetchall("SELECT name,id FROM ".tablename('jy_signup_a_cate')." WHERE enabled=1 AND weid=".$weid." ORDER BY displayorder DESC,id ASC");			if(!empty($id))			{				$attr_arr=array();				$attr_arr2=array();				$ziliao=pdo_fetchall('SELECT a.enabled,b.name,b.id,b.type FROM '.tablename('jy_signup_a_hd_attr')." as a left join ".tablename('jy_signup_a_attr')." as b on a.attr_id=b.id WHERE a.weid=".$weid." AND a.hdid=".$id." AND b.enabled=1 ORDER BY a.id ASC");				foreach ($ziliao as $key => $value) {					if($value['enabled']==0)					{						array_push($attr_arr, $value['id']);					}					else					{						array_push($attr_arr2, $value['id']);					}					$xz_attr.=$value['id'].",";				}				if(!empty($ziliao))				{					$xz_attr=substr($xz_attr,0,-1);					$xz_attr=" AND id NOT IN ( ".$xz_attr.") ";				}			}			$attr = pdo_fetchall("SELECT * FROM " . tablename('jy_signup_a_attr') . " WHERE weid = ".$weid." AND enabled=1 AND parentid=0 ".$xz_attr." ORDER BY displayorder DESC,id ASC");			if (checksubmit('submit')) {				if (empty($_GPC['hdname'])) {					message('请输入活动标题！');				}				if (empty($_GPC['hdcateid'])) {					message('请选择活动类型！');				}				if (empty($_GPC['thumb'])) {					message('请上传活动图片！');				}				if (empty($_GPC['address'])) {					message('请填写活动地址！');				}				if (empty($_GPC['reside'])) {					message('请选择活动地区！');				}				if (empty($_GPC['description'])) {					message('请选择活动描述！');				}				if (empty($_GPC['brand_id'])) {					message('请选择活动所属品牌！');				}				$data = array(						'weid' => $_W['weid'],						'hdname' =>$_GPC['hdname'],						'brand_id' => $_GPC['brand_id'],						'hdcateid' => $_GPC['hdcateid'],						'renshu' => $_GPC['renshu'],						'time' => $_GPC['time'],						'deadline' => strtotime($_GPC['deadline']),						'starttime' => strtotime($_GPC['time2']['start']),						'endtime' => strtotime($_GPC['time2']['end']),						'address' => $_GPC['address'],						'province' => $_GPC['reside']['province'],						'city' => $_GPC['reside']['city'],						'dist' => $_GPC['reside']['district'],						'lng' =>$_GPC['location']['lng'],						'lat' =>$_GPC['location']['lat'],						'sc' => $_GPC['sc'],						'pv' => $_GPC['pv'],						'tk' => $_GPC['tk'],						'qx' => $_GPC['qx'],						'shenhe' => $_GPC['shenhe'],						'description' => $_GPC['description'],						'is_must'=>$_GPC['is_must'],						'baoming'=>$_GPC['baoming'],						'paiwei'=>$_GPC['paiwei'],						'xiugai'=>$_GPC['xiugai'],						'isshow' => $_GPC['isshow'],						'diyjf'=>$_GPC['diyjf']				);				if($_GPC['hdtype']==0)				{					$data['price']=0;					$data['jifen']=0;				}				if($_GPC['hdtype']==1)				{					$data['price']=$_GPC['price'];					$data['jifen']=0;				}				if($_GPC['hdtype']==2)				{					$data['price']=0;					$data['jifen']=$_GPC['jifen'];				}				if (is_array($_GPC['thumb'])) {	                $data['thumb'] = serialize($_GPC['thumb']);	            }				if (empty($id)) {					$data['createtime']=TIMESTAMP;					pdo_insert('jy_signup_a_hd', $data);					$id=pdo_insertid();				} else {					pdo_update('jy_signup_a_hd', $data, array('id' => $id));				}				pdo_delete('jy_signup_a_hd_attr',array('hdid'=>$id));				if(!empty($_GPC['attr_hd']))				{					$attr_hd=$_GPC['attr_hd'];					foreach ($attr_hd as $key => $value) {						$enabled=substr($value, 0 , 1 );						$attr_id=substr($value, 2 );						$data2=array(								'weid'=>$weid,								'attr_id'=>$attr_id,								'hdid'=>$id,								'enabled'=>$enabled,								'createtime'=>TIMESTAMP,							);						pdo_insert('jy_signup_a_hd_attr',$data2);					}				}				pdo_delete("jy_signup_a_mendian_hd",array('hdid'=>$id));				if(!empty($_GPC['mendian_ids']))				{					$mendian_ids=$_GPC['mendian_ids'];					foreach ($mendian_ids as $key => $value) {						$data=array(								'weid'=>$weid,								'hdid'=>$id,								'mendianid'=>$value,								'createtime'=>TIMESTAMP,							);						pdo_insert("jy_signup_a_mendian_hd",$data);					}				}				message('信息更新成功！', $this->createWebUrl('huodong'), 'success');			}		}		if($op=='shua')		{			$id=$_GPC['id'];			if(empty($id))			{				message("操作错误！，请返回重试");			}			else			{				$hd=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_hd')." WHERE weid=".$weid." AND id=".$id);				if(empty($hd))				{					message("您所选择的活动已不存在!");				}			}			if (checksubmit('submit')) {				$num=intval($_GPC['num']);				if(empty($num))				{					message("请输入需要刷的量！");				}				$starttime=$_GPC['starttime'];				$endtime=$_GPC['endtime'];				$starttime=strtotime($starttime);				$endtime=strtotime($endtime);				if($starttime>$endtime)				{					message("刷量开始时间必须小于刷量结束时间!");				}				if($starttime>=$hd['deadline'])				{					message("刷量开始时间不得大于活动报名截止时间");				}				if($endtime>=$hd['deadline'])				{					$endtime=$hd['deadline'];				}				$temp=pdo_fetchall("SELECT a.mid FROM ".tablename('jy_signup_a_hd_cy')." as a left join ".tablename('jy_signup_a_member')." as b on a.mid=b.id WHERE a.weid=".$weid." AND a.hdid=".$id." AND b.type=2");				$condition="";				if(!empty($temp))				{					$condition=" AND id NOT in ( ";					foreach ($temp as $key => $value) {						$condition.=$value['mid'].",";					}					$condition=substr($condition,0,-1);					$condition.=") ";				}				$member=pdo_fetchall("SELECT id FROM ".tablename('jy_signup_a_member')." WHERE weid=".$weid." AND type=2 AND status=1 ".$condition." LIMIT ".$num);				$data=array(						'weid'=>$weid,						'hdid'=>$id,						'status'=>0,					);				if(empty($member))				{					message("没有符合条件的虚拟用户，请添加新的虚拟用户！");				}				foreach ($member as $key => $value) {					$data['mid']=$value['id'];					$createtime=mt_rand($starttime,$endtime);					$data['createtime']=$createtime;					pdo_insert("jy_signup_a_hd_cy",$data);				}				pdo_update("jy_signup_a_hd",array('num'=>$hd['num']+count($member)),array('id'=>$id));				message("一共添加了".count($member)."条虚拟用户报名数据!",$this->createWebUrl('huodong'),'success');			}		}		if($op=='del')		{			$id=$_GPC['id'];			pdo_update("jy_signup_a_hd",array('enabled'=>0),array('id'=>$id));			message("删除成功！",$this->createWebUrl('huodong'),'success');		}		include $this->template('web/huodong');	}	public function doWebBmexport() {		global $_W,$_GPC;		$weid=$_W['uniacid'];		checklogin();		$now_day=strtotime(date('Y-m-d', time()));		$time = $_GPC['time'];		$starttime = empty($time['start']) ? $now_day : strtotime($time['start']);		$endtime   = empty($time['end'])   ? $now_day + 7*86400 : strtotime($time['end']) + 86399;		if (!empty($_GPC['time'])) {			$condition.=" AND a.createtime>=$starttime AND a.createtime<=$endtime ";		}		if (!empty($_GPC['keyword'])) {			$condition .= " AND ( b.nickname LIKE '%{$_GPC['keyword']}%'";			$condition .=")";		}		$id=$_GPC['id'];		$list=pdo_fetchall("SELECT a.createtime,a.jifen,b.id,b.wechatid,b.nicheng,b.mobile,c.fee as price FROM ".tablename('jy_signup_a_hd_cy')." as a left join ".tablename('jy_signup_a_member')." as b on a.mid=b.id left join ".tablename('core_paylog')." as c on a.plid=c.plid WHERE a.weid=".$weid." AND hdid=".$id);		$fushu_ziliao=array();		foreach ($list as $key => $value) {			if(!empty($value['wechatid']))			{				$temp=pdo_fetch("SELECT nickname FROM ".tablename('mc_members')." WHERE uniacid=".$weid." AND uid=".$value['wechatid']);				$list[$key]['nicheng']=$temp['nickname'];			}			$temp_pl=pdo_fetchall("SELECT * FROM ".tablename('jy_signup_a_hdcomment')." WHERE weid=".$weid." AND hdid=".$id." AND mid=".$value['id']);			$i=1;			$pl='';			if(count($temp_pl)==1)			{				$pl=$temp_pl[0]['description'];			}			if(count($temp_pl)>1)			{				foreach ($temp_pl as $key2 => $value2) {					$pl.=$i."、".$value2['description']." ";					$i++;				}			}			$list[$key]['pl']=$pl;			$zl=array();			$temp_zl=pdo_fetchall("SELECT a.*,b.type,b.name FROM ".tablename('jy_signup_a_hd_attr_value')." as a left join ".tablename('jy_signup_a_attr')." as b on a.attr_id=b.id WHERE a.weid=".$weid." AND a.mid=".$value['id']." AND hdid=".$id);			if(count($temp_zl)>0)			{				foreach ($temp_zl as $key3 => $value3) {					if(!in_array($value3['name'], $fushu_ziliao))					{						array_push($fushu_ziliao, $value3['name']);					}					$zl[$value3['name']]=$value3['zhi'];				}			}			$list[$key]['zl']=$zl;			if($value['price']>0)			{				$list[$key]['fy']=$value['price']."元";			}			else			{				if($value['jifen']>0)				{					$list[$key]['fy']=$value['jifen']."积分";				}				else				{					$list[$key]['fy']="免费";				}			}		}		ob_end_clean();		require_once '../framework/library/phpexcel/PHPExcel.php';		// Create new PHPExcel object		$objPHPExcel = new PHPExcel();		// Set document properties		$objPHPExcel->getProperties()->setCreator("Maarten Balliauw")									 ->setLastModifiedBy("Maarten Balliauw")									 ->setTitle("Office 2007 XLSX Test Document")									 ->setSubject("Office 2007 XLSX Test Document")									 ->setDescription("Test document for Office 2007 XLSX, generated using PHP classes.")									 ->setKeywords("office 2007 openxml php")									 ->setCategory("Test result file");		// Add some data		$objPHPExcel->setActiveSheetIndex(0)					->setCellValue('A1', '用户ID')					->setCellValue('B1', '用户昵称')					->setCellValue('C1', '用户手机')					->setCellValue('D1', '费用/积分')					->setCellValue('E1', '评论')					->setCellValue('F1', '报名时间');		$fushu_id=71;		if(!empty($fushu_ziliao))		{            foreach ($fushu_ziliao as $key6 => $value6) {                if($fushu_id<91)                {                    $objPHPExcel->setActiveSheetIndex(0)->setCellValue(chr($fushu_id).'1', $value6);                }                else{                    $fushu_id_new=$fushu_id-26;                    $objPHPExcel->setActiveSheetIndex(0)->setCellValue('A'.chr($fushu_id_new).'1', $value6);                }                $fushu_id++;            }		}		$i=2;		foreach ($list as $key => $row) {			$objPHPExcel->setActiveSheetIndex(0)			->setCellValue('A'.$i, $row['id'])			->setCellValue('B'.$i, $row['nicheng'])			->setCellValue('C'.$i, ' '.$row['mobile'])			->setCellValue('D'.$i, $row['fy'])			->setCellValue('E'.$i, $row['pl'])			->setCellValue('F'.$i, date('Y-m-d H:i',$row['createtime']));			$fushu_id=71;			if(!empty($fushu_ziliao))			{                foreach ($fushu_ziliao as $key6 => $value6) {                    if($fushu_id<91)                    {                        $objPHPExcel->setActiveSheetIndex(0)->setCellValue(chr($fushu_id).$i, ' '.$row['zl'][$value6]);                    }                    else{                        $fushu_id_new=$fushu_id-26;                        $objPHPExcel->setActiveSheetIndex(0)->setCellValue('A'.chr($fushu_id_new).$i, ' '.$row['zl'][$value6]);                    }                    $fushu_id++;                }			}			$i++;		}		$objPHPExcel->getActiveSheet()->getStyle('A1:G1')->getFont()->setBold(true);		$objPHPExcel->getActiveSheet()->getColumnDimension('B')->setWidth(20);		$objPHPExcel->getActiveSheet()->getColumnDimension('C')->setWidth(40);		$objPHPExcel->getActiveSheet()->getColumnDimension('D')->setWidth(40);		$objPHPExcel->getActiveSheet()->getColumnDimension('E')->setWidth(40);		$objPHPExcel->getActiveSheet()->getColumnDimension('F')->setWidth(40);		$objPHPExcel->getActiveSheet()->getColumnDimension('G')->setWidth(40);		// Rename worksheet		$objPHPExcel->getActiveSheet()->setTitle('活动报名数据'."_".date('Y-m-d'));		// Set active sheet index to the first sheet, so Excel opens this as the first sheet		$objPHPExcel->setActiveSheetIndex(0);		// Redirect output to a client’s web browser (Excel2007)		header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');		header('Content-Disposition: attachment;filename="'.'活动报名数据'."_".date('Ymd').'.xlsx"');		header('Cache-Control: max-age=0');		$objWriter = PHPExcel_IOFactory::createWriter($objPHPExcel, 'Excel2007');		$objWriter->save('php://output');		ob_flush();		flush();		message("导出成功",$this->createWebUrl('baoming'),'success');	}	public function doWebBaoming() {		global $_W,$_GPC;		$weid=$_W['uniacid'];		checklogin();		$op=$_GPC['op'];		if(empty($op))		{			$op='display';			if (!empty($_GPC['keyword'])) {				$condition .= " AND a.hdname LIKE '%{$_GPC['keyword']}%' OR a.province LIKE '%{$_GPC['keyword']}%' OR a.city LIKE '%{$_GPC['keyword']}%'";			}			$mendianid=$_GPC['mendianid'];			if(!empty($mendianid))			{				$condition .= " AND a.mendianid=".$mendianid;			}			$list=pdo_fetchall("SELECT a.*,b.title as name FROM ".tablename('jy_signup_a_hd')." as a  left join ".tablename('jy_signup_a_brands')." as b on a.brand_id=b.id WHERE a.weid=".$weid." AND a.enabled=1 $condition ");		}		if($op=='add')		{			$id=$_GPC['id'];			if (checksubmit('submit')) {				$late=pdo_fetchall("SELECT * FROM ".tablename('jy_signup_a_hd_card')." WHERE weid=".$weid." AND hdid=".$id);				$late_arr=array();				foreach ($late as $key => $value) {					array_push($late_arr, $value['mid']);				}				if (!empty($_GPC['ids'])) {					$late_done=array();					foreach ($_GPC['ids'] as $key => $value) {						if(in_array($value, $late_arr))						{							array_push($late_done, $value);						}						else						{							$temp_member=pdo_fetch("SELECT from_user FROM ".tablename('jy_signup_a_member')." WHERE weid=".$weid." AND id=".$value);							if(!empty($temp_member['from_user']))							{								$hd=pdo_fetch("SELECT hdname FROM ".tablename('jy_signup_a_hd')." WHERE weid=".$weid." AND id=".$id);								$text="<a href='".$_W['siteroot'].'app/'.substr($this->createMobileUrl('detail',array('id'=>$id)),2)."'>恭喜您！活动【".$hd['hdname'].'】'."报名成功，点击查看报名详情！</a>";								$text=urlencode($text);		                        $access_token = WeAccount::token();		                        $data = array(		                           "touser"=>$temp_member['from_user'],		                           "msgtype"=>"text",		                           "text"=>array("content"=>$text)		                        );		                        $url = "https://api.weixin.qq.com/cgi-bin/message/custom/send?access_token={$access_token}";		                        load()->func('communication');		                        $response = ihttp_request($url, urldecode(json_encode($data)));							}							$data=array(									'weid'=>$weid,									'hdid'=>$id,									'mid'=>$value,									'status'=>1,									'createtime'=>TIMESTAMP,								);							pdo_insert("jy_signup_a_hd_card",$data);							array_push($late_done, $value);						}					}					foreach ($late_arr as $key => $value) {						if(in_array($value, $late_done))						{						}						else						{							$temp_member=pdo_fetch("SELECT from_user FROM ".tablename('jy_signup_a_member')." WHERE weid=".$weid." AND id=".$value);							if(!empty($temp_member['from_user']))							{								$hd=pdo_fetch("SELECT hdname FROM ".tablename('jy_signup_a_hd')." WHERE weid=".$weid." AND id=".$id);								$text="<a href='".$_W['siteroot'].'app/'.substr($this->createMobileUrl('detail',array('id'=>$id)),2)."'>很遗憾！你报名的【".$hd['hdname'].'】'."活动已被取消选中！赶紧去看看详情吧！</a>";								$text=urlencode($text);		                        $access_token = WeAccount::token();		                        $data = array(		                           "touser"=>$temp_member['from_user'],		                           "msgtype"=>"text",		                           "text"=>array("content"=>$text)		                        );		                        $url = "https://api.weixin.qq.com/cgi-bin/message/custom/send?access_token={$access_token}";		                        load()->func('communication');		                        $response = ihttp_request($url, urldecode(json_encode($data)));							}							pdo_delete("jy_signup_a_hd_card",array('weid'=>$weid,'hdid'=>$id,'mid'=>$value));						}					}				}				else				{					foreach ($late_arr as $key => $value) {						$temp_member=pdo_fetch("SELECT from_user FROM ".tablename('jy_signup_a_member')." WHERE weid=".$weid." AND id=".$value);						if(!empty($temp_member['from_user']))						{							$hd=pdo_fetch("SELECT hdname FROM ".tablename('jy_signup_a_hd')." WHERE weid=".$weid." AND id=".$id);							$text="<a href='".$_W['siteroot'].'app/'.substr($this->createMobileUrl('detail',array('id'=>$id)),2)."'>很遗憾！你报名的【".$hd['hdname'].'】'."活动已被取消选中！赶紧去看看详情吧！</a>";							$text=urlencode($text);	                        $access_token = WeAccount::token();	                        $data = array(	                           "touser"=>$temp_member['from_user'],	                           "msgtype"=>"text",	                           "text"=>array("content"=>$text)	                        );	                        $url = "https://api.weixin.qq.com/cgi-bin/message/custom/send?access_token={$access_token}";	                        load()->func('communication');	                        $response = ihttp_request($url, urldecode(json_encode($data)));						}						pdo_delete("jy_signup_a_hd_card",array('weid'=>$weid,'hdid'=>$id,'mid'=>$value));					}				}				message("设置成功！",$this->createWebUrl('baoming'),'success');			}			$hd=pdo_fetch("SELECT renshu,price FROM ".tablename('jy_signup_a_hd')." WHERE id=".$id);			$list=pdo_fetchall("SELECT a.createtime,a.jifen,b.id,b.wechatid,b.nicheng,b.mobile,b.type,b.thumb,c.fee as price,c.uniontid,a.id as cid FROM ".tablename('jy_signup_a_hd_cy')." as a left join ".tablename('jy_signup_a_member')." as b on a.mid=b.id left join ".tablename('core_paylog')." as c on a.plid=c.plid WHERE a.weid=".$weid." AND hdid=".$id);			$sitem=pdo_fetch("SELECT thumb FROM ".tablename('jy_signup_a_setting')." WHERE weid=".$weid);			foreach ($list as $key => $value) {				if(!empty($value['wechatid']))				{					$temp=pdo_fetch("SELECT nickname,avatar FROM ".tablename('mc_members')." WHERE uniacid=".$weid." AND uid=".$value['wechatid']);					$list[$key]['avatar']=$temp['avatar'];					$list[$key]['nicheng']=$temp['nickname'];				}				else				{					if(!empty($sitem['thumb']))					{						$list[$key]['avatar']="{$_W['attachurl']}{$sitem['thumb']}";					}					else					{						$list[$key]['avatar']='../addons/jy_signup_a/images/no-50.png';					}				}				$list[$key]['pl']=pdo_fetchall("SELECT * FROM ".tablename('jy_signup_a_hdcomment')." WHERE weid=".$weid." AND hdid=".$id." AND mid=".$value['id']);				$list[$key]['zl']=pdo_fetchall("SELECT a.*,b.type,b.name FROM ".tablename('jy_signup_a_hd_attr_value')." as a left join ".tablename('jy_signup_a_attr')." as b on a.attr_id=b.id WHERE a.weid=".$weid." AND a.mid=".$value['id']." AND hdid=".$id);			}			$done=pdo_fetchall("SELECT mid FROM ".tablename('jy_signup_a_hd_card')." WHERE weid=".$weid." AND hdid=".$id);			$done_arr=array();			foreach ($done as $key => $value) {				array_push($done_arr, $value['mid']);			}		}		include $this->template('web/baoming');	}	public function doWebALL() {		global $_W,$_GPC;		$weid=$_W['uniacid'];		checklogin();		load()->func('tpl');		$hd_all=pdo_fetchall("SELECT * FROM ".tablename('jy_signup_a_hd')." WHERE weid=".$weid." AND enabled=1 AND isshow=1 ");		$now_day=strtotime(date('Y-m-d', time()));		$time = $_GPC['time'];		$starttime = empty($time['start']) ? $now_day : strtotime($time['start']);		$endtime   = empty($time['end'])   ? $now_day + 7*86400 : strtotime($time['end']) + 86399;		if (!empty($_GPC['time'])) {			$condition.=" AND a.createtime>=$starttime AND a.createtime<=$endtime ";		}		$hdid=intval($_GPC['hdid']);		if(!empty($hdid))		{			$condition.=" AND a.hdid=".$hdid;		}		$list=pdo_fetchall("SELECT a.createtime,a.jifen,b.id,b.wechatid,b.nicheng,b.mobile,b.type,b.thumb,c.fee as price,c.uniontid,d.id as hdid,d.hdname,a.id as cid FROM ".tablename('jy_signup_a_hd_cy')." as a left join ".tablename('jy_signup_a_member')." as b on a.mid=b.id left join ".tablename('core_paylog')." as c on a.plid=c.plid left join ".tablename('jy_signup_a_hd')." as d on a.hdid=d.id WHERE a.weid=".$weid.$condition);		$sitem=pdo_fetch("SELECT thumb FROM ".tablename('jy_signup_a_setting')." WHERE weid=".$weid);		foreach ($list as $key => $value) {			if(!empty($value['wechatid']))			{				$temp=pdo_fetch("SELECT nickname,avatar FROM ".tablename('mc_members')." WHERE uniacid=".$weid." AND uid=".$value['wechatid']);				$list[$key]['avatar']=$temp['avatar'];				$list[$key]['nicheng']=$temp['nickname'];			}			else			{				if(!empty($sitem['thumb']))				{					$list[$key]['avatar']=tomedia($sitem['thumb']);				}				else				{					$list[$key]['avatar']='../addons/jy_signup_a/images/no-50.png';				}			}			$list[$key]['pl']=pdo_fetchall("SELECT * FROM ".tablename('jy_signup_a_hdcomment')." WHERE weid=".$weid." AND hdid=".$value['hdid']." AND mid=".$value['id']);			$list[$key]['zl']=pdo_fetchall("SELECT a.*,b.type,b.name FROM ".tablename('jy_signup_a_hd_attr_value')." as a left join ".tablename('jy_signup_a_attr')." as b on a.attr_id=b.id WHERE a.weid=".$weid." AND a.mid=".$value['id']." AND hdid=".$value['hdid']);		}		include $this->template('web/all');	}	public function doWebAllexport() {		global $_W,$_GPC;		$weid=$_W['uniacid'];		checklogin();		$now_day=strtotime(date('Y-m-d', time()));		$time = $_GPC['time'];		$starttime = empty($time['start']) ? $now_day : strtotime($time['start']);		$endtime   = empty($time['end'])   ? $now_day + 7*86400 : strtotime($time['end']) + 86399;		if (!empty($_GPC['time'])) {			$condition.=" AND a.createtime>=$starttime AND a.createtime<=$endtime ";		}		if (!empty($_GPC['keyword'])) {			$condition .= " AND ( b.nickname LIKE '%{$_GPC['keyword']}%'";			$condition .=")";		}		$hdid=intval($_GPC['hdid']);		if(!empty($hdid))		{			$condition.=" AND a.hdid=".$hdid;		}		$list=pdo_fetchall("SELECT a.createtime,a.hdid,a.jifen,b.id,b.wechatid,b.nicheng,b.mobile,c.fee as price,c.uniontid,d.hdname FROM ".tablename('jy_signup_a_hd_cy')." as a left join ".tablename('jy_signup_a_member')." as b on a.mid=b.id left join ".tablename('core_paylog')." as c on a.plid=c.plid left join ".tablename('jy_signup_a_hd')." as d on a.hdid=d.id WHERE a.weid=".$weid.$condition);        $fushu_ziliao=array();		foreach ($list as $key => $value) {			if(!empty($value['wechatid']))			{				$temp=pdo_fetch("SELECT nickname FROM ".tablename('mc_members')." WHERE uniacid=".$weid." AND uid=".$value['wechatid']);				$list[$key]['nicheng']=$temp['nickname'];			}			$pl='';			$temp_pl=pdo_fetchall("SELECT * FROM ".tablename('jy_signup_a_hdcomment')." WHERE weid=".$weid." AND hdid=".$value['hdid']." AND mid=".$value['id']);			$i=1;            if(count($temp_pl)==1)            {                $pl=$temp_pl[0]['description'];            }            if(count($temp_pl)>1)            {                foreach ($temp_pl as $key2 => $value2) {                    $pl.=$i."、".$value2['description']." ";                    $i++;                }            }			$list[$key]['pl']=$pl;			$i=1;            $zl=array();			$temp_zl=pdo_fetchall("SELECT a.*,b.type,b.name FROM ".tablename('jy_signup_a_hd_attr_value')." as a left join ".tablename('jy_signup_a_attr')." as b on a.attr_id=b.id WHERE a.weid=".$weid." AND a.mid=".$value['id']." AND hdid=".$value['hdid']);            if(count($temp_zl)>0)            {                foreach ($temp_zl as $key3 => $value3) {                    if(!in_array($value3['name'], $fushu_ziliao))                    {                        array_push($fushu_ziliao, $value3['name']);                    }                    $zl[$value3['name']]=$value3['zhi'];                }            }			$list[$key]['zl']=$zl;			if($value['price']>0)			{				$list[$key]['fy']=$value['price']."元";			}			else			{				if($value['jifen']>0)				{					$list[$key]['fy']=$value['jifen']."积分";				}				else				{					$list[$key]['fy']="免费";				}			}			$temp=pdo_fetch("SELECT a.status,a.hexiaotime,b.username FROM ".tablename('jy_signup_a_hd_card')." as a left join ".tablename('jy_signup_a_dianyuan')." as b on a.hxid=b.id WHERE a.weid=".$weid." AND a.hdid=".$value['hdid']." AND a.mid= ".$value['id']);			if(!empty($temp['status']))			{				$list[$key]['hx']='未核销';				$list[$key]['hexiaotime']="";			}			else			{				$list[$key]['hx']='已核销';				$list[$key]['username']=$temp['username'];				$list[$key]['hexiaotime']=date('Y-m-d H:i',$temp['hexiaotime']);			}		}		ob_end_clean();		require_once '../framework/library/phpexcel/PHPExcel.php';		// Create new PHPExcel object		$objPHPExcel = new PHPExcel();		// Set document properties		$objPHPExcel->getProperties()->setCreator("Maarten Balliauw")									 ->setLastModifiedBy("Maarten Balliauw")									 ->setTitle("Office 2007 XLSX Test Document")									 ->setSubject("Office 2007 XLSX Test Document")									 ->setDescription("Test document for Office 2007 XLSX, generated using PHP classes.")									 ->setKeywords("office 2007 openxml php")									 ->setCategory("Test result file");		// Add some data			$objPHPExcel->setActiveSheetIndex(0)					->setCellValue('A1', '用户ID')					->setCellValue('B1', '用户昵称')					->setCellValue('C1', '用户手机')					->setCellValue('D1', '活动名称')					->setCellValue('E1', '费用/积分')					->setCellValue('F1', '评论')					->setCellValue('G1', '报名时间')					->setCellValue('H1', '核销状态')					->setCellValue('I1', '核销店员')					->setCellValue('J1', '核销时间')					->setCellValue('K1', '商户订单号');            $fushu_id=76;            if(!empty($fushu_ziliao))            {                foreach ($fushu_ziliao as $key6 => $value6) {                    if($fushu_id<91)                    {                        $objPHPExcel->setActiveSheetIndex(0)->setCellValue(chr($fushu_id).'1', $value6);                    }                    else{                        $fushu_id_new=$fushu_id-26;                        $objPHPExcel->setActiveSheetIndex(0)->setCellValue('A'.chr($fushu_id_new).'1', $value6);                    }                    $fushu_id++;                }            }			$i=2;			foreach ($list as $key => $row) {				if(!empty($row['createtime']))				{					$createtime=date('Y-m-d H:i',$row['createtime']);				}				else				{					$createtime="";				}				$objPHPExcel->setActiveSheetIndex(0)				->setCellValue('A'.$i, $row['id'])				->setCellValue('B'.$i, $row['nicheng'])				->setCellValue('C'.$i, $row['mobile'])				->setCellValue('D'.$i, $row['hdname'])				->setCellValue('E'.$i, $row['fy'])				->setCellValue('F'.$i, $row['pl'])				->setCellValue('G'.$i, $createtime)				->setCellValue('H'.$i, $row['hx'])				->setCellValue('I'.$i, $row['username'])				->setCellValue('J'.$i, $row['hexiaotime'])				->setCellValue('K'.$i, ' '.$row['uniontid']);                $fushu_id=76;                if(!empty($fushu_ziliao))                {                    foreach ($fushu_ziliao as $key6 => $value6) {                        if($fushu_id<91)                        {                            $objPHPExcel->setActiveSheetIndex(0)->setCellValue(chr($fushu_id).$i, ' '.$row['zl'][$value6]);                        }                        else{                            $fushu_id_new=$fushu_id-26;                            $objPHPExcel->setActiveSheetIndex(0)->setCellValue('A'.chr($fushu_id_new).$i, ' '.$row['zl'][$value6]);                        }                        $fushu_id++;                    }                }				$i++;			}        $objPHPExcel->getActiveSheet()->getStyle('A1:L1')->getFont()->setBold(true);		$objPHPExcel->getActiveSheet()->getColumnDimension('B')->setWidth(20);		$objPHPExcel->getActiveSheet()->getColumnDimension('C')->setWidth(40);		$objPHPExcel->getActiveSheet()->getColumnDimension('D')->setWidth(40);		$objPHPExcel->getActiveSheet()->getColumnDimension('E')->setWidth(40);		$objPHPExcel->getActiveSheet()->getColumnDimension('F')->setWidth(40);		$objPHPExcel->getActiveSheet()->getColumnDimension('G')->setWidth(40);		$objPHPExcel->getActiveSheet()->getColumnDimension('H')->setWidth(40);		$objPHPExcel->getActiveSheet()->getColumnDimension('I')->setWidth(40);		$objPHPExcel->getActiveSheet()->getColumnDimension('J')->setWidth(40);		$objPHPExcel->getActiveSheet()->getColumnDimension('K')->setWidth(40);		$objPHPExcel->getActiveSheet()->getColumnDimension('L')->setWidth(40);        //$objPHPExcel->getActiveSheet()->getStyle('K1')->getNumberFormat()->setFormatCode(PHPExcel_Cell_DataType::TYPE_STRING);		// Rename worksheet		$objPHPExcel->getActiveSheet()->setTitle('活动报名数据'."_".date('Y-m-d'));		// Set active sheet index to the first sheet, so Excel opens this as the first sheet		$objPHPExcel->setActiveSheetIndex(0);		// Redirect output to a client’s web browser (Excel2007)		header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');		header('Content-Disposition: attachment;filename="'.'活动报名数据'."_".date('Ymd').'.xlsx"');		header('Cache-Control: max-age=0');		$objWriter = PHPExcel_IOFactory::createWriter($objPHPExcel, 'Excel2007');		$objWriter->save('php://output');		ob_flush();		flush();		message("导出成功",$this->createWebUrl('all'),'success');	}	public function doWebS_export() {		global $_W,$_GPC;		$weid=$_W['uniacid'];		checklogin();		$now_day=strtotime(date('Y-m-d', time()));		$time = $_GPC['time'];		$starttime = empty($time['start']) ? $now_day : strtotime($time['start']);		$endtime   = empty($time['end'])   ? $now_day + 7*86400 : strtotime($time['end']) + 86399;		if (!empty($_GPC['time'])) {			$condition.=" AND a.createtime>=$starttime AND a.createtime<=$endtime ";		}		if (!empty($_GPC['keyword'])) {			$condition .= " AND ( b.nickname LIKE '%{$_GPC['keyword']}%'";			$condition .=")";		}		$id=$_GPC['id'];		$hd=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_hd')." WHERE weid=".$weid." AND id=".$id);		$renyuan=pdo_fetchall("SELECT mid FROM ".tablename('jy_signup_a_hd_card')." WHERE weid=".$weid." AND hdid=".$id);		$ry=array();		foreach ($renyuan as $key => $value) {			array_push($ry, $value['mid']);		}		$ry_str=implode(',', $ry);		$ry_str="( ".$ry_str." )";		$list=pdo_fetchall("SELECT a.createtime,a.jifen,b.id,b.wechatid,b.nicheng,b.mobile,c.fee as price,c.uniontid FROM ".tablename('jy_signup_a_hd_cy')." as a left join ".tablename('jy_signup_a_member')." as b on a.mid=b.id left join ".tablename('core_paylog')." as c on a.plid=c.plid WHERE a.weid=".$weid." AND hdid=".$id." AND a.mid IN ".$ry_str);        $fushu_ziliao=array();		foreach ($list as $key => $value) {			if(!empty($value['wechatid']))			{				$temp=pdo_fetch("SELECT nickname FROM ".tablename('mc_members')." WHERE uniacid=".$weid." AND uid=".$value['wechatid']);				$list[$key]['nicheng']=$temp['nickname'];			}			$pl='';			$temp_pl=pdo_fetchall("SELECT * FROM ".tablename('jy_signup_a_hdcomment')." WHERE weid=".$weid." AND hdid=".$id." AND mid=".$value['id']);			$i=1;            if(count($temp_pl)==1)            {                $pl=$temp_pl[0]['description'];            }            if(count($temp_pl)>1)            {                foreach ($temp_pl as $key2 => $value2) {                    $pl.=$i."、".$value2['description']." ";                    $i++;                }            }			$list[$key]['pl']=$pl;			$i=1;            $zl=array();            $temp_zl=pdo_fetchall("SELECT a.*,b.type,b.name FROM ".tablename('jy_signup_a_hd_attr_value')." as a left join ".tablename('jy_signup_a_attr')." as b on a.attr_id=b.id WHERE a.weid=".$weid." AND a.mid=".$value['id']." AND hdid=".$id);            if(count($temp_zl)>0)            {                foreach ($temp_zl as $key3 => $value3) {                    if(!in_array($value3['name'], $fushu_ziliao))                    {                        array_push($fushu_ziliao, $value3['name']);                    }                    $zl[$value3['name']]=$value3['zhi'];                }            }			$list[$key]['zl']=$zl;			if($value['price']>0)			{				$list[$key]['fy']=$value['price']."元";			}			else			{				if($value['jifen']>0)				{					$list[$key]['fy']=$value['jifen']."积分";				}				else				{					$list[$key]['fy']="免费";				}			}			$temp=pdo_fetch("SELECT a.status,a.hexiaotime,b.username FROM ".tablename('jy_signup_a_hd_card')." as a left join ".tablename('jy_signup_a_dianyuan')." as b on a.hxid=b.id WHERE a.weid=".$weid." AND a.hdid=".$id." AND a.mid= ".$value['id']);			if(!empty($temp['status']))			{				$list[$key]['hx']='未核销';				$list[$key]['hexiaotime']="";			}			else			{				$list[$key]['hx']='已核销';				$list[$key]['username']=$temp['username'];				$list[$key]['hexiaotime']=date('Y-m-d H:i',$temp['hexiaotime']);			}		}		ob_end_clean();		require_once '../framework/library/phpexcel/PHPExcel.php';		// Create new PHPExcel object		$objPHPExcel = new PHPExcel();		// Set document properties		$objPHPExcel->getProperties()->setCreator("Maarten Balliauw")									 ->setLastModifiedBy("Maarten Balliauw")									 ->setTitle("Office 2007 XLSX Test Document")									 ->setSubject("Office 2007 XLSX Test Document")									 ->setDescription("Test document for Office 2007 XLSX, generated using PHP classes.")									 ->setKeywords("office 2007 openxml php")									 ->setCategory("Test result file");		// Add some data		if ($hd['price']>0)		{			$objPHPExcel->setActiveSheetIndex(0)					->setCellValue('A1', '用户ID')					->setCellValue('B1', '用户昵称')					->setCellValue('C1', '用户手机')					->setCellValue('D1', '费用/积分')					->setCellValue('E1', '评论')					->setCellValue('F1', '报名时间')					->setCellValue('G1', '核销状态')					->setCellValue('H1', '核销店员')					->setCellValue('I1', '核销时间')					->setCellValue('J1', '商户订单号');			$i=2;            $fushu_id=75;            if(!empty($fushu_ziliao))            {                foreach ($fushu_ziliao as $key6 => $value6) {                    if($fushu_id<91)                    {                        $objPHPExcel->setActiveSheetIndex(0)->setCellValue(chr($fushu_id).'1', $value6);                    }                    else{                        $fushu_id_new=$fushu_id-26;                        $objPHPExcel->setActiveSheetIndex(0)->setCellValue('A'.chr($fushu_id_new).'1', $value6);                    }                    $fushu_id++;                }            }			foreach ($list as $key => $row) {				$objPHPExcel->setActiveSheetIndex(0)				->setCellValue('A'.$i, $row['id'])				->setCellValue('B'.$i, $row['nicheng'])				->setCellValue('C'.$i, ' '.$row['mobile'])				->setCellValue('D'.$i, $row['fy'])				->setCellValue('E'.$i, $row['pl'])				->setCellValue('F'.$i, date('Y-m-d H:i',$row['createtime']))				->setCellValue('G'.$i, $row['hx'])				->setCellValue('H'.$i, $row['username'])				->setCellValue('I'.$i, $row['hexiaotime'])				->setCellValue('J'.$i, ' '.$row['uniontid']);                $fushu_id=75;                if(!empty($fushu_ziliao))                {                    foreach ($fushu_ziliao as $key6 => $value6) {                        if($fushu_id<91)                        {                            $objPHPExcel->setActiveSheetIndex(0)->setCellValue(chr($fushu_id).$i, ' '.$row['zl'][$value6]);                        }                        else{                            $fushu_id_new=$fushu_id-26;                            $objPHPExcel->setActiveSheetIndex(0)->setCellValue('A'.chr($fushu_id_new).$i, ' '.$row['zl'][$value6]);                        }                        $fushu_id++;                    }                }				$i++;			}		}		else		{			$objPHPExcel->setActiveSheetIndex(0)					->setCellValue('A1', '用户ID')					->setCellValue('B1', '用户昵称')					->setCellValue('C1', '用户手机')					->setCellValue('D1', '费用/积分')					->setCellValue('E1', '评论')					->setCellValue('F1', '报名时间')					->setCellValue('G1', '核销状态')					->setCellValue('H1', '核销店员')					->setCellValue('I1', '核销时间');			$i=2;            $fushu_id=74;            if(!empty($fushu_ziliao))            {                foreach ($fushu_ziliao as $key6 => $value6) {                    $objPHPExcel->setActiveSheetIndex(0)->setCellValue(chr($fushu_id).'1', $value6);                    $fushu_id++;                }            }			foreach ($list as $key => $row) {				$objPHPExcel->setActiveSheetIndex(0)				->setCellValue('A'.$i, $row['id'])				->setCellValue('B'.$i, $row['nicheng'])				->setCellValue('C'.$i, $row['mobile'])				->setCellValue('D'.$i, $row['fy'])				->setCellValue('E'.$i, $row['pl'])				->setCellValue('F'.$i, date('Y-m-d H:i',$row['createtime']))				->setCellValue('G'.$i, $row['hx'])				->setCellValue('H'.$i, $row['username'])				->setCellValue('I'.$i, $row['hexiaotime']);                $fushu_id=74;                if(!empty($fushu_ziliao))                {                    foreach ($fushu_ziliao as $key6 => $value6) {                        $objPHPExcel->setActiveSheetIndex(0)->setCellValue(chr($fushu_id).$i, ' '.$row['zl'][$value6]);                        $fushu_id++;                    }                }				$i++;			}		}		$objPHPExcel->getActiveSheet()->getStyle('A1:J1')->getFont()->setBold(true);		$objPHPExcel->getActiveSheet()->getColumnDimension('B')->setWidth(20);		$objPHPExcel->getActiveSheet()->getColumnDimension('C')->setWidth(40);		$objPHPExcel->getActiveSheet()->getColumnDimension('D')->setWidth(40);		$objPHPExcel->getActiveSheet()->getColumnDimension('E')->setWidth(40);		$objPHPExcel->getActiveSheet()->getColumnDimension('F')->setWidth(40);		$objPHPExcel->getActiveSheet()->getColumnDimension('G')->setWidth(40);		$objPHPExcel->getActiveSheet()->getColumnDimension('H')->setWidth(40);		$objPHPExcel->getActiveSheet()->getColumnDimension('I')->setWidth(40);		$objPHPExcel->getActiveSheet()->getColumnDimension('J')->setWidth(40);		// Rename worksheet		$objPHPExcel->getActiveSheet()->setTitle('活动成功报名数据'."_".date('Y-m-d'));		// Set active sheet index to the first sheet, so Excel opens this as the first sheet		$objPHPExcel->setActiveSheetIndex(0);		// Redirect output to a client’s web browser (Excel2007)		header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');		header('Content-Disposition: attachment;filename="'.'活动成功报名数据'."_".date('Ymd').'.xlsx"');		header('Cache-Control: max-age=0');		$objWriter = PHPExcel_IOFactory::createWriter($objPHPExcel, 'Excel2007');		$objWriter->save('php://output');		ob_flush();		flush();		message("导出成功",$this->createWebUrl('baoming'),'success');	}	public function doWebSuccess() {		global $_W,$_GPC;		$weid=$_W['uniacid'];		checklogin();		$op=$_GPC['op'];		if(empty($op))		{			$op='display';			if (!empty($_GPC['keyword'])) {				$condition .= " AND b.hdname LIKE '%{$_GPC['keyword']}%' OR b.province LIKE '%{$_GPC['keyword']}%' OR b.city LIKE '%{$_GPC['keyword']}%'";			}			$mendianid=$_GPC['mendianid'];			if(!empty($mendianid))			{				$condition .= " AND b.mendianid=".$mendianid;			}			$list=pdo_fetchall("SELECT b.*,count(a.id) as num2,c.title as name FROM ".tablename('jy_signup_a_hd_card')." as a left join ".tablename('jy_signup_a_hd')." as b on a.hdid=b.id left join ".tablename('jy_signup_a_brands')." as c on b.brand_id=c.id WHERE a.weid=".$weid." AND b.enabled=1 GROUP BY a.hdid");		}		if($op=='add')		{			$id=$_GPC['id'];			$hd=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_hd')." WHERE weid=".$weid." AND id=".$id);			$renyuan=pdo_fetchall("SELECT mid FROM ".tablename('jy_signup_a_hd_card')." WHERE weid=".$weid." AND hdid=".$id);			$ry=array();			foreach ($renyuan as $key => $value) {				array_push($ry, $value['mid']);			}			if(!empty($ry))            {                $ry_str=implode(',', $ry);                $ry_str="( ".$ry_str." )";            }            else            {                $ry_str="( 0 )";            }			$list=pdo_fetchall("SELECT a.createtime,b.id,b.wechatid,b.nicheng,b.mobile,b.type,b.thumb,c.uniontid,a.id as cid FROM ".tablename('jy_signup_a_hd_cy')." as a left join ".tablename('jy_signup_a_member')." as b on a.mid=b.id left join ".tablename('core_paylog')." as c on a.plid=c.plid WHERE a.weid=".$weid." AND hdid=".$id." AND a.mid IN ".$ry_str);			foreach ($list as $key => $value) {				if(!empty($value['wechatid']))				{					$temp=pdo_fetch("SELECT nickname,avatar FROM ".tablename('mc_members')." WHERE uniacid=".$weid." AND uid=".$value['wechatid']);					$list[$key]['avatar']=$temp['avatar'];					$list[$key]['nicheng']=$temp['nickname'];				}				else				{					$sitem=pdo_fetch("SELECT thumb FROM ".tablename('jy_signup_a_setting')." WHERE weid=".$weid);					if(!empty($sitem['thumb']))					{						$list[$key]['avatar']=tomedia($sitem['thumb']);					}					else					{						$list[$key]['avatar']='../addons/jy_signup_a/images/no-50.png';					}				}				$list[$key]['pl']=pdo_fetchall("SELECT * FROM ".tablename('jy_signup_a_hdcomment')." WHERE weid=".$weid." AND hdid=".$id." AND mid=".$value['id']);				$list[$key]['zl']=pdo_fetchall("SELECT a.*,b.type,b.name FROM ".tablename('jy_signup_a_hd_attr_value')." as a left join ".tablename('jy_signup_a_attr')." as b on a.attr_id=b.id WHERE a.weid=".$weid." AND a.mid=".$value['id']." AND hdid=".$id);			}		}		include $this->template('web/success');	}	public function doWebPl() {		global $_W,$_GPC;		$weid=$_W['uniacid'];		checklogin();		$op=$_GPC['op'];		if(empty($op))		{			$op='display';			if (!empty($_GPC['keyword'])) {				$condition .= " AND ( b.hdname LIKE '%{$_GPC['keyword']}%' OR b.province LIKE '%{$_GPC['keyword']}%' OR b.city LIKE '%{$_GPC['keyword']}%')";			}			$mendianid=$_GPC['mendianid'];			if(!empty($mendianid))			{				$hd_arr=pdo_fetchall("SELECT hdid FROM ".tablename('jy_signup_a_mendian_hd')." WHERE weid=".$weid." AND mendianid=".$mendianid);				if(empty($hd_arr))				{					$condition .= " AND 0 ";				}				else				{					foreach ($hd_arr as $key => $value) {						$hd_str.=$value['hdid'].",";					}					$hd_str=substr($hd_str, 0 ,-1);					$condition.=" AND a.hdid IN (".$hd_str.") ";				}			}			$mendian=pdo_fetchall("SELECT * FROM ".tablename('jy_signup_a_mendian')." WHERE weid=".$weid);			$list=pdo_fetchall("SELECT count(a.id) as num2,b.*,c.title as name FROM ".tablename('jy_signup_a_hdcomment')." as a left join ".tablename('jy_signup_a_hd')." as b on a.hdid=b.id left join ".tablename('jy_signup_a_brands')." as c on b.brand_id=c.id WHERE a.weid=".$weid.$condition."  AND b.enabled=1 GROUP BY a.hdid ");		}		if($op=='add')		{			$id=$_GPC['id'];			$list=pdo_fetchall("SELECT a.id as plid,a.description,a.num,b.* FROM ".tablename('jy_signup_a_hdcomment')." as a left join ".tablename('jy_signup_a_member')." as b on a.mid=b.id WHERE a.weid=".$weid." AND a.hdid=".$id."");			//$list=pdo_fetchall("SELECT a.mobile,a.nicheng as name,a.createtime,b.id,b.wechatid,b.nicheng,b.mobile as bmmobile FROM ".tablename('jy_signup_a_hd_cy')." as a left join ".tablename('jy_signup_a_member')." as b on a.mid=b.id WHERE a.weid=".$weid." AND hdid=".$id);			foreach ($list as $key => $value) {				if(!empty($value['wechatid']))				{					$temp=pdo_fetch("SELECT nickname,avatar FROM ".tablename('mc_members')." WHERE uniacid=".$weid." AND uid=".$value['wechatid']);					$list[$key]['avatar']=$temp['avatar'];					$list[$key]['nickname']=$temp['nickname'];				}				else				{					$sitem=pdo_fetch("SELECT thumb FROM ".tablename('jy_signup_a_setting')." WHERE weid=".$weid);					if(!empty($sitem['thumb']))					{						$list[$key]['avatar']="{$_W['attachurl']}{$sitem['thumb']}";					}					else					{						$list[$key]['avatar']='../addons/jy_signup_a/images/no-50.png';					}				}			}		}		if($op=='del')		{			$id=$_GPC['id'];			$hdid=$_GPC['hdid'];			pdo_delete("jy_signup_a_hdcomment",array('id'=>$id));			message("删除成功！",$this->createWebUrl('pl',array('id'=>$hdid,'op'=>'add')),'success');		}		include $this->template('web/pl');	}	public function doWebHexiao() {		global $_W,$_GPC;		$weid=$_W['uniacid'];		checklogin();		$op=$_GPC['op'];		if(empty($op))		{			$op='display';			if (!empty($_GPC['keyword'])) {				$condition .= " AND b.hdname LIKE '%{$_GPC['keyword']}%' OR b.province LIKE '%{$_GPC['keyword']}%' OR b.city LIKE '%{$_GPC['keyword']}%'";			}			$mendianid=$_GPC['mendianid'];			if(!empty($mendianid))			{				$hd_arr=pdo_fetchall("SELECT hdid FROM ".tablename('jy_signup_a_mendian_hd')." WHERE weid=".$weid." AND mendianid=".$mendianid);				if(empty($hd_arr))				{					$condition .= " AND 0 ";				}				else				{					foreach ($hd_arr as $key => $value) {						$hd_str.=$value['hdid'].",";					}					$hd_str=substr($hd_str, 0 ,-1);					$condition.=" AND a.hdid IN (".$hd_str.") ";				}			}			$list=pdo_fetchall("SELECT b.*,count(a.id) as num2,c.title as name FROM ".tablename('jy_signup_a_hd_card')." as a left join ".tablename('jy_signup_a_hd')." as b on a.hdid=b.id left join ".tablename('jy_signup_a_brands')." as c on b.brand_id=c.id  WHERE a.weid=".$weid." AND a.status=0 GROUP BY a.hdid");		}		if($op=='add')		{			$id=$_GPC['id'];			$renyuan=pdo_fetchall("SELECT mid,status FROM ".tablename('jy_signup_a_hd_card')." WHERE weid=".$weid." AND hdid=".$id);			$ry=array();			$cs=array();			foreach ($renyuan as $key => $value) {				array_push($ry, $value['mid']);				if($value['status']==0)				{					array_push($cs,$value['mid']);				}			}			$ry_str=implode(',', $ry);			$ry_str="( ".$ry_str." )";			$list=pdo_fetchall("SELECT a.createtime,b.id,b.wechatid,b.nicheng,b.mobile,b.type,b.thumb FROM ".tablename('jy_signup_a_hd_cy')." as a left join ".tablename('jy_signup_a_member')." as b on a.mid=b.id WHERE a.weid=".$weid." AND hdid=".$id." AND a.mid IN ".$ry_str);			foreach ($list as $key => $value) {				if(!empty($value['wechatid']))				{					$temp=pdo_fetch("SELECT nickname,avatar FROM ".tablename('mc_members')." WHERE uniacid=".$weid." AND uid=".$value['wechatid']);					$list[$key]['avatar']=$temp['avatar'];					$list[$key]['nicheng']=$temp['nickname'];				}				else				{					$sitem=pdo_fetch("SELECT thumb FROM ".tablename('jy_signup_a_setting')." WHERE weid=".$weid);					if(!empty($sitem['thumb']))					{						$list[$key]['avatar']="{$_W['attachurl']}{$sitem['thumb']}";					}					else					{						$list[$key]['avatar']='../addons/jy_signup_a/images/no-50.png';					}				}				$list[$key]['pl']=pdo_fetchall("SELECT * FROM ".tablename('jy_signup_a_hdcomment')." WHERE weid=".$weid." AND hdid=".$id." AND mid=".$value['id']);				$list[$key]['zl']=pdo_fetchall("SELECT a.*,b.type,b.name FROM ".tablename('jy_signup_a_hd_attr_value')." as a left join ".tablename('jy_signup_a_attr')." as b on a.attr_id=b.id WHERE a.weid=".$weid." AND a.mid=".$value['id']." AND hdid=".$id);				if(in_array($value['id'],$cs))				{					$temp=pdo_fetch("SELECT b.username,c.mendianname FROM ".tablename('jy_signup_a_hd_card')." as a left join ".tablename('jy_signup_a_dianyuan')." as b on a.hxid=b.id left join ".tablename('jy_signup_a_mendian')." as c on b.mendianid=c.id WHERE a.weid=".$weid." AND a.mid=".$value['id']." AND hdid= ".$id);					//$temp=pdo_fetch("SELECT a.username,b.mendianname FROM ".tablename('jy_signup_a_dianyuan')." as a left join ".tablename('jy_signup_a_mendian')." as b on a.mendianid=b.id WHERE a.weid=".$weid." AND a.id= ".$value['hxid']);					$list[$key]['hx']=$temp['username'];					$list[$key]['mendianname']=$temp['mendianname'];				}			}		}		include $this->template('web/hexiao');	}	public function doWebTk() {		//体现管理		global $_W, $_GPC;		$weid=$_W['uniacid'];		$status=$_GPC['status'];		if(empty($status))		{			$status=0;		}		$member=pdo_fetchall("SELECT a.*,b.nicheng,b.mobile,b.wechatid,c.fee,c.uniontid,d.hdname,e.avatar,e.nickname FROM ".tablename('jy_signup_a_hd_tk')." as a left join ".tablename('jy_signup_a_member')." as b on a.mid=b.id left join ".tablename('core_paylog')." as c on a.plid=c.plid left join ".tablename('jy_signup_a_hd')." as d on a.hdid=d.id left join ".tablename('mc_members')." as e on b.wechatid=e.uid WHERE a.weid=".$weid." AND a.status=".$status." ORDER BY a.createtime desc ");		$sitem=pdo_fetch("SELECT thumb FROM ".tablename('jy_signup_a_setting')." WHERE weid=".$weid);		foreach ($member as $key => $value) {			if(!empty($value['wechatid']))			{				$member[$key]['nicheng']=$value['nickname'];			}			else			{				if(!empty($sitem['thumb']))				{					$member[$key]['avatar']="{$_W['attachurl']}{$sitem['thumb']}";				}				else				{					$member[$key]['avatar']='../addons/jy_signup_a/images/no-50.png';				}			}			$member[$key]['zl']=pdo_fetchall("SELECT a.*,b.type,b.name FROM ".tablename('jy_signup_a_hd_attr_value')." as a left join ".tablename('jy_signup_a_attr')." as b on a.attr_id=b.id WHERE a.weid=".$weid." AND a.mid=".$value['id']." AND hdid=".$value['hdid']);		}		$total=count($member);		if(checksubmit('submit')) {			$select=$_GPC['select'];			$filename = date('Y-m-d G时i分')."退款名录.txt";			$encoded_filename = urlencode($filename);			$encoded_filename = str_replace("+", "%20", $encoded_filename);			header("Content-Type: application/octet-stream");			if (preg_match("/MSIE/", $_SERVER['HTTP_USER_AGENT']) ) {				header('Content-Disposition:  attachment; filename="' . $encoded_filename . '"');			} elseif (preg_match("/Firefox/", $_SERVER['HTTP_USER_AGENT'])) {				header('Content-Disposition: attachment; filename*="utf8' .  $filename . '"');			} else {				header('Content-Disposition: attachment; filename="' .  $filename . '"');			}			Header( "Accept-Ranges:   bytes ");			foreach ($select as $key => $value) {				$temp=pdo_fetch("SELECT a.plid,b.fee,b.uniontid FROM ".tablename('jy_signup_a_hd_tk')." as a left join ".tablename('core_paylog')." as b on a.plid=b.plid WHERE a.weid=".$weid." AND a.id=".$value);				echo $temp['uniontid']." ".$temp['fee']." "."活动报名退款";				echo "\r\n";				pdo_update('jy_signup_a_hd_tk',array('status'=>2),array('id'=>$value));			}			exit;			message("导出成功",$this->createWebUrl('tk'),'success');		}		if(checksubmit('submit2')) {			$select=$_GPC['select'];			foreach ($select as $key => $value) {				$temp=pdo_fetch("SELECT b.from_user,c.hdname FROM ".tablename('jy_signup_a_hd_tk')." as a left join ".tablename('jy_signup_a_member')." as b on a.mid=b.id left join ".tablename('jy_signup_a_hd')." as c on a.hdid=c.id WHERE a.weid=".$weid." AND a.id=".$value);				if(!empty($temp['from_user']))				{					$text="你报名的活动'".$temp['hdname']."'申请退款成功,请查收！";					$text=urlencode($text);					$access_token = WeAccount::token();					$data = array(					  "touser"=>$temp['from_user'],					  "msgtype"=>"text",					  "text"=>array("content"=>$text)					);					$url = "https://api.weixin.qq.com/cgi-bin/message/custom/send?access_token={$access_token}";					load()->func('communication');					$response = ihttp_request($url, urldecode(json_encode($data)));				}				pdo_update("jy_signup_a_hd_tk",array('status'=>1),array('id'=>$value));			}			message("设置成功",$this->createWebUrl('tk'),'success');		}		if(checksubmit('submit3')) {			$select=$_GPC['select'];			foreach ($select as $key => $value) {				$temp=pdo_fetch("SELECT b.from_user,c.hdname FROM ".tablename('jy_signup_a_hd_tk')." as a left join ".tablename('jy_signup_a_member')." as b on a.mid=b.id left join ".tablename('jy_signup_a_hd')." as c on a.hdid=c.id WHERE a.weid=".$weid." AND a.id=".$value);				if(!empty($temp['from_user']))				{					$text="你报名的活动'".$temp['hdname']."'申请退款失败！";					$text=urlencode($text);					$access_token = WeAccount::token();					$data = array(					  "touser"=>$temp['from_user'],					  "msgtype"=>"text",					  "text"=>array("content"=>$text)					);					$url = "https://api.weixin.qq.com/cgi-bin/message/custom/send?access_token={$access_token}";					load()->func('communication');					$response = ihttp_request($url, urldecode(json_encode($data)));				}				pdo_update("jy_signup_a_hd_tk",array('status'=>3),array('id'=>$value));			}			message("设置成功",$this->createWebUrl('tk'),'success');		}		if(checksubmit('submit4')) {			$select=$_GPC['select'];			foreach ($select as $key => $value) {				$temp=pdo_fetch("SELECT b.from_user,c.hdname FROM ".tablename('jy_signup_a_hd_tk')." as a left join ".tablename('jy_signup_a_member')." as b on a.mid=b.id left join ".tablename('jy_signup_a_hd')." as c on a.hdid=c.id WHERE a.weid=".$weid." AND a.id=".$value);				if(!empty($temp['from_user']))				{					$text="你报名的活动'".$temp['hdname']."'申请退款被系统管理员拒绝！";					$text=urlencode($text);					$access_token = WeAccount::token();					$data = array(					  "touser"=>$temp['from_user'],					  "msgtype"=>"text",					  "text"=>array("content"=>$text)					);					$url = "https://api.weixin.qq.com/cgi-bin/message/custom/send?access_token={$access_token}";					load()->func('communication');					$response = ihttp_request($url, urldecode(json_encode($data)));				}				pdo_update("jy_signup_a_hd_tk",array('status'=>4),array('id'=>$value));			}			message("设置成功",$this->createWebUrl('tk'),'success');		}		include $this->template('web/tk');	}	public function doWebMember() {		global $_W,$_GPC;		$weid=$_W['uniacid'];		checklogin();		$op=$_GPC['op'];		if(empty($op))		{			$op='display';		}		if($op=='display')		{			$list=pdo_fetchall("SELECT * FROM ".tablename('jy_signup_a_member')." WHERE weid=".$weid);			foreach ($list as $key => $value) {				if(!empty($value['wechatid']))				{					$temp=pdo_fetch("SELECT nickname,avatar FROM ".tablename('mc_members')." WHERE uniacid=".$weid." AND uid=".$value['wechatid']);					$list[$key]['avatar']=$temp['avatar'];					$list[$key]['nicheng']=$temp['nickname'];				}				else				{					$sitem=pdo_fetch("SELECT thumb FROM ".tablename('jy_signup_a_setting')." WHERE weid=".$weid);					if(!empty($sitem['thumb']))					{						$list[$key]['avatar']="{$_W['attachurl']}{$sitem['thumb']}";					}					else					{						$list[$key]['avatar']='../addons/jy_signup_a/images/no-50.png';					}				}				$list[$key]['cy']=pdo_fetchcolumn("SELECT count(id) FROM ".tablename('jy_signup_a_hd_cy')." WHERE weid=".$weid." AND mid=".$value['id']);				$list[$key]['pl']=pdo_fetchcolumn("SELECT count(id) FROM ".tablename('jy_signup_a_hdcomment')." WHERE weid=".$weid." AND mid=".$value['id']);				$list[$key]['zan']=pdo_fetchcolumn("SELECT count(id) FROM ".tablename('jy_signup_a_hdcomment_zan')." WHERE weid=".$weid." AND mid=".$value['id']);			}		}		if($op=='add')		{			 $category = array(	                'status' =>1,	            );			if (checksubmit('submit')) {	            if (empty($_GPC['nicheng'])) {	                message('抱歉，请输入虚拟用户的昵称！');	            }	            if (empty($_GPC['thumb'])) {	                message('抱歉，请上传虚拟用户的头像！');	            }	            $data = array(	                'weid' => $_W['weid'],	                'nicheng' => $_GPC['nicheng'],	                'thumb' => $_GPC['thumb'],	                'type' => 2,	                'status' => intval($_GPC['status']),	                'createtime'=>TIMESTAMP,	            );	            pdo_insert('jy_signup_a_member', $data);	            message('添加虚拟用户用户数据成功！', $this->createWebUrl('member', array('op' => 'display')), 'success');	        }		}		if($op=='mingxi')		{			$id=$_GPC['id'];			$row=pdo_fetch("SELECT * FROM ".tablename('jy_signup_a_member')." WHERE weid=".$weid." AND id=".$id);			if(!empty($row['wechatid']))			{				$temp=pdo_fetch("SELECT nickname,avatar FROM ".tablename('mc_members')." WHERE uniacid=".$weid." AND uid=".$row['wechatid']);				$row['avatar']=$temp['avatar'];				$row['nicheng']=$temp['nickname'];			}			else			{				$sitem=pdo_fetch("SELECT thumb FROM ".tablename('jy_signup_a_setting')." WHERE weid=".$weid);				if(!empty($sitem['thumb']))				{					$row['avatar']="{$_W['attachurl']}{$sitem['thumb']}";				}				else				{					$row['avatar']='../addons/jy_signup_a/images/no-50.png';				}			}			$row['cy']=pdo_fetchcolumn("SELECT count(id) FROM ".tablename('jy_signup_a_hd_cy')." WHERE weid=".$weid." AND mid=".$row['id']);			$row['pl']=pdo_fetchcolumn("SELECT count(id) FROM ".tablename('jy_signup_a_hdcomment')." WHERE weid=".$weid." AND mid=".$row['id']);			$row['zan']=pdo_fetchcolumn("SELECT count(id) FROM ".tablename('jy_signup_a_hdcomment_zan')." WHERE weid=".$weid." AND mid=".$row['id']);			$cy=pdo_fetchall("SELECT a.createtime,b.id,b.hdname,b.address,b.province,b.city,b.pl,b.enabled,c.title as name FROM ".tablename('jy_signup_a_hd_cy')." as a left join ".tablename('jy_signup_a_hd')." as b on a.hdid=b.id left join ".tablename('jy_signup_a_brands')." as c on b.brand_id=c.id WHERE a.weid=".$weid." AND a.mid=".$id." and enabled=1");			$pl=pdo_fetchall("SELECT a.description,a.num as num2,a.createtime,b.hdname,b.address,b.province,b.city,b.pl FROM ".tablename('jy_signup_a_hdcomment')." as a left join ".tablename('jy_signup_a_hd')." as b on a.hdid=b.id WHERE a.weid=".$weid." AND a.mid=".$id);			$zan=pdo_fetchall("SELECT a.createtime,b.description,b.num as num2,c.hdname,c.address,c.province,c.city,c.pl FROM ".tablename('jy_signup_a_hdcomment_zan')." as a left join ".tablename('jy_signup_a_hdcomment')." as b on a.hdcommentid=b.id left join ".tablename('jy_signup_a_hd')." as c on a.hdid=c.id WHERE a.weid=".$weid." AND a.mid=".$id);		}		include $this->template('web/member');	}	public function doWebStat() {		global $_W,$_GPC;		$weid=$_W['uniacid'];		checklogin();		$total=pdo_fetchcolumn("SELECT count(id) FROM ".tablename('jy_signup_a_member')." WHERE weid=".$weid);		$hd=pdo_fetchcolumn("SELECT count(id) FROM ".tablename('jy_signup_a_hd')." WHERE weid=".$weid." AND enabled=1");		$cy=pdo_fetchcolumn("SELECT count(id) FROM ".tablename('jy_signup_a_hd_cy')." WHERE weid=".$weid);		$pl=pdo_fetchcolumn("SELECT count(id) FROM ".tablename('jy_signup_a_hdcomment')." WHERE weid=".$weid);		$success=pdo_fetchcolumn("SELECT count(id) FROM ".tablename('jy_signup_a_hd_card')." WHERE weid=".$weid);		$zan=pdo_fetchcolumn("SELECT count(id) FROM ".tablename('jy_signup_a_hdcomment_zan')." WHERE weid=".$weid);		$list=pdo_fetchall("SELECT count(a.id) as num2,b.hdname as title FROM ".tablename('jy_signup_a_hd_cy')." as a left join ".tablename('jy_signup_a_hd')." as b on a.hdid=b.id WHERE a.weid=".$weid." GROUP BY a.hdid ORDER BY num2 DESC LIMIT 10 ");		$list2=pdo_fetchall("SELECT count(a.id) as num2,b.hdname as title FROM ".tablename('jy_signup_a_hdcomment')." as a left join ".tablename('jy_signup_a_hd')." as b on a.hdid=b.id WHERE a.weid=".$weid." GROUP BY a.hdid ORDER BY num2 DESC LIMIT 10 ");		$list3=pdo_fetchall("SELECT count(a.id) as num2,b.description as title FROM ".tablename('jy_signup_a_hdcomment_zan')." as a left join ".tablename('jy_signup_a_hdcomment')." as b on a.hdcommentid=b.id WHERE a.weid=".$weid." GROUP BY a.hdcommentid ORDER BY num2 DESC LIMIT 10 ");		$list4=pdo_fetchall("SELECT count(a.id) as num2,b.nicheng as title,b.wechatid FROM ".tablename('jy_signup_a_hd_cy')." as a left join ".tablename('jy_signup_a_member')." as b on a.mid=b.id WHERE a.weid=".$weid." GROUP BY a.mid ORDER BY num2 DESC LIMIT 10 ");		foreach ($list4 as $key => $value) {			if(!empty($value['wechatid']))			{				$temp=pdo_fetch("SELECT nickname FROM ".tablename('mc_members')." WHERE uid=".$value['wechatid']);				$list4[$key]['title']=$temp['nickname'];			}		}		include $this->template('web/stat');	}	public function doWebDelmember(){		global $_W,$_GPC;		include IA_ROOT."/addons/jy_signup_a/inc/delmember.php";		// pdo_delete('jy_signup_a_hd_attr_value',array('mid'=>$mid));		// pdo_delete('jy_signup_a_hd_card',array('mid'=>$mid));		// message('删除成功',referer(),'success');	}  /**   * 用户信息   */	public function doMobileUserinfo() {		global $_W,$_GPC;			if (!empty($_W['openid']) && intval($_W['account']['level']) >= 3) {        $userinfo = mc_fansinfo($_W['openid']);        $userinfo['tag']['subscribe'] = $userinfo['follow'];        $userinfo = $userinfo['tag'];        $userinfo['headimgurl'] =  $userinfo['avatar'];        unset($userinfo['avatar']);			}			// if(empty($_W['oauth_account'])){			// 	return error(-1, '未指定网页授权公众号, 无法获取用户信息.');			// }			// if(empty($_W['oauth_account']['key']) || empty($_W['oauth_account']['secret'])){			// 	return error(-2, '公众号未设置 appId 或 secret.');			// }			// if(intval($_W['oauth_account']['level']) < 4){			// 	return error(-3, '公众号非认证服务号, 无法获取用户信息.');			// }			$state = 'weihezisid-'.$_W['session_id'];			$_SESSION['dest_url'] = base64_encode($_SERVER['QUERY_STRING']);			$op=$_GPC['op'];			 $code = $_GET['code'];$from_user = $_W['openid'];			if(empty($code)){				if($userinfo['subscribe']==0)				{					 $url = $_W['siteroot'] . 'app/' . $this->createMobileUrl('userinfo',array('op'=>$op,'id'=>$_GPC['id'],'foo'=>$_GPC['foo'],'fdbk'=>$_GPC['fdbk']));					$callback = urlencode($url);					$forward = 'https://open.weixin.qq.com/connect/oauth2/authorize?appid='.$_W['oauth_account']['key'].'&redirect_uri='.$callback.'&response_type=code&scope=snsapi_userinfo&state='.$state.'#wechat_redirect';					header("Location: ".$forward);				}				else				{            // echo 123;					//用户已经关注改公众号了					 $weid=$_W['uniacid'];					$fans_temp=pdo_fetchall("SELECT uniacid FROM ".tablename('mc_mapping_fans')." WHERE openid='$from_user' ");		            $fan_temp = '';		            if(empty($fans_temp[0])){		               $_isUnique =  false;		            }else{		                $_isUnique = 'not';		            }		            foreach ($fans_temp as $key => $value) {		                if($value['uniacid']==$weid){		                    $fan_temp=pdo_fetch("SELECT * FROM ".tablename('mc_mapping_fans')." WHERE openid='$from_user' AND uniacid=".$weid);		                    $_isUnique = true;		                }		            }					if(!empty($userinfo) && !empty($userinfo['headimgurl']) && !empty($userinfo['nickname']))					{						$userinfo['avatar'] = $userinfo['headimgurl'];						unset($userinfo['headimgurl']);            $weid=$_W['uniacid'];            $fans_temp=pdo_fetchall("SELECT uniacid FROM ".tablename('mc_mapping_fans')." WHERE openid='$from_user' ");                if(empty($fans_temp[0])){                    $_isUnique =  false;                }else{                    $_isUnique = 'not';                  }                  foreach ($fans_temp as $key => $value) {                      if($value['uniacid']==$weid){                          $fan_temp=pdo_fetch("SELECT * FROM ".tablename('mc_mapping_fans')." WHERE openid='$from_user' AND uniacid=".$weid);                          $_isUnique = true;                      }                  }						//开启了强制注册，自定义注册						$default_groupid = pdo_fetchcolumn('SELECT groupid FROM ' .tablename('mc_groups') . ' WHERE uniacid = :uniacid AND isdefault = 1', array(':uniacid' => $_W['uniacid']));						$data = array(							'uniacid' => $_W['uniacid'],							'email' => md5($_W['openid']).'@9yetech.com'.$op,							'salt' => random(8),							'groupid' => $default_groupid,							'createtime' => TIMESTAMP,							'nickname' 		=> $userinfo['nickname'],							'avatar' 		=> $userinfo['avatar'],							'gender' 		=> $userinfo['sex'],							'nationality' 	=> $userinfo['country'],							'resideprovince'=> $userinfo['province'] . '省',							'residecity' 	=> $userinfo['city'] . '市',						);						$data['password'] = md5($_W['openid'] . $data['salt'] . $_W['config']['setting']['authkey']);						if(empty($fan_temp))						{							pdo_insert('mc_members', $data);							$uid = pdo_insertid();						}						else						{							pdo_update('mc_members' ,$data ,array('uid'=>$fan_temp['uid']));							$uid=$fan_temp['uid'];						}						$record = array(							'openid' 		=> $_W['openid'],							'uid' 			=> $uid,							'acid' 			=> $_W['acid'],							'uniacid' 		=> $_W['uniacid'],							'salt' 			=> random(8),							'updatetime' 	=> TIMESTAMP,							'nickname' 		=> $userinfo['nickname'],							'follow' 		=> $userinfo['subscribe'],							'followtime' 	=> $userinfo['subscribe_time'],							'unfollowtime' 	=> 0,							'tag' 			=> base64_encode(iserializer($userinfo))						);            $record['uid'] = $uid;            if(empty($fan_temp)&&!$_isUnique)            {              pdo_insert('mc_mapping_fans', $record);            }            else if($_isUnique=='not'){            }                  else            {              $temp=pdo_update('mc_mapping_fans' ,$record ,array('fanid'=>$fan_temp['fanid']));            }					}				}			}			else			{				//未关注，通过网页授权				$url = "https://api.weixin.qq.com/sns/oauth2/access_token?appid=".$_W['oauth_account']['key']."&secret=".$_W['oauth_account']['secret']."&code=".$code."&grant_type=authorization_code";				load()->func('communication');				$response = ihttp_get($url);				$oauth = @json_decode($response['content'], true);				$url = "https://api.weixin.qq.com/sns/userinfo?access_token={$oauth['access_token']}&openid={$oauth['openid']}&lang=zh_CN";				$response = ihttp_get($url);				if (!is_error($response)) {					$userinfo = array();					$userinfo = @json_decode($response['content'], true);					$userinfo['avatar'] = $userinfo['headimgurl'];					unset($userinfo['headimgurl']);					$_SESSION['userinfo'] = base64_encode(iserializer($userinfo));						if(!empty($userinfo) && !empty($userinfo['avatar']) && !empty($userinfo['nickname']))						{							$weid=$_W['uniacid'];							$fans_temp=pdo_fetchall("SELECT uniacid FROM ".tablename('mc_mapping_fans')." WHERE openid='$from_user' ");					        if(empty($fans_temp[0])){					            $_isUnique =  false;					        }else{					            $_isUnique = 'not';				            }				            foreach ($fans_temp as $key => $value) {				                if($value['uniacid']==$weid){				                    $fan_temp=pdo_fetch("SELECT * FROM ".tablename('mc_mapping_fans')." WHERE openid='$from_user' AND uniacid=".$weid);				                    $_isUnique = true;				                }				            }							//开启了强制注册，自定义注册							$default_groupid = pdo_fetchcolumn('SELECT groupid FROM ' .tablename('mc_groups') . ' WHERE uniacid = :uniacid AND isdefault = 1', array(':uniacid' => $_W['uniacid']));							$data = array(								'uniacid' => $_W['uniacid'],								'email' => md5($_W['openid']).'@9yetech.com'.$op,								'salt' => random(8),								'groupid' => $default_groupid,								'createtime' => TIMESTAMP,								'nickname' 		=> $userinfo['nickname'],								'avatar' 		=> rtrim($userinfo['avatar'], '0') . 132,								'gender' 		=> $userinfo['sex'],								'nationality' 	=> $userinfo['country'],								'resideprovince'=> $userinfo['province'] . '省',								'residecity' 	=> $userinfo['city'] . '市',							);							$data['password'] = md5($_W['openid'] . $data['salt'] . $_W['config']['setting']['authkey']);							if(empty($fan_temp))							{								pdo_insert('mc_members', $data);								$uid = pdo_insertid();							}							else							{								pdo_update('mc_members' ,$data ,array('uid'=>$fan_temp['uid']));								$uid=$fan_temp['uid'];							}							$record = array(								'openid' 		=> $_W['openid'],								'uid' 			=> $uid,								'acid' 			=> $_W['acid'],								'uniacid' 		=> $_W['uniacid'],								'salt' 			=> random(8),								'updatetime' 	=> TIMESTAMP,								'nickname' 		=> $userinfo['nickname'],								'follow' 		=> $userinfo['subscribe'],								'followtime' 	=> $userinfo['subscribe_time'],								'unfollowtime' 	=> 0,								'tag' 			=> base64_encode(iserializer($userinfo))							);							$record['uid'] = $uid;							if(empty($fan_temp)&&!$_isUnique) 							{ 								pdo_insert('mc_mapping_fans', $record); 							} 							else if($_isUnique=='not'){              }				            else 							{ 								$temp=pdo_update('mc_mapping_fans' ,$record ,array('fanid'=>$fan_temp['fanid'])); 							}						}				} else {					message('微信授权获取用户信息失败,请重新尝试: ' . $response['message']);				}			}		echo "<script>					window.location.href = '".$this->createMobileUrl($op,array('id'=>$_GPC['id'],'foo'=>$_GPC['foo'],'fdbk'=>$_GPC['fdbk']))."';				</script>";	}}