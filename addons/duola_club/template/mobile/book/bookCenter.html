<html>
<head>
    <meta charset="utf-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black"/>
    <meta content="telephone=no" name="format-detection" />
    <style>
        body > a:first-child,body > a:first-child img{ width: 0px !important; height: 0px !important; overflow: hidden; position: absolute}
        body{padding-bottom: 0 !important;}
    </style>
    <meta id="viewport" name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0">
    <title>{$school['title']}</title>
    <link rel="stylesheet" href="{MODULE_URL}public/mobile/css/weixin.css">
    <link rel="stylesheet" href="{MODULE_URL}public/mobile/css/weui.css">
    <link rel="stylesheet" href="{OSSURL}public/mobile/css/reset.css">
    <link type="text/css" rel="stylesheet" href="{OSSURL}public/mobile/css/greenStyle.css?v=4.60120" />
    <link rel="stylesheet" href="{MODULE_URL}public/mobile/css/jAlert.css">
    <link rel="stylesheet" href="{MODULE_URL}template/mobile/style/css/weui.css">
    <script src="http://libs.baidu.com/jquery/1.10.2/jquery.min.js"></script>
    <script src="{MODULE_URL}public/mobile/js/jquery.js"></script>
    <script type="text/javascript" src="{MODULE_URL}public/mobile/js/jquery-1.11.3.min.js?v=4.9"></script>
    <script src="{MODULE_URL}public/mobile/js/zepto.min.js"></script>
    <script type="text/javascript" src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
    <script src="{MODULE_URL}public/mobile/js/weui.min.js"></script>
    {php echo register_jssdk();}
</head>
<body>
<style>
    dd.teacher_count li {font: 13px/18px "黑体";padding: 10px 60px 10px 34px;position: relative;background: url({OSSURL}public/mobile/img/teacher_inf.jpg) no-repeat 10px 15px;background-size: 15px 15px;border-bottom: 1px solid #ddd;}
    .teacher_count div.add > div {background-image: url("{OSSURL}public/mobile/img/state_add.png");}
    .teacher_count div.hot > div {background-image: url("{OSSURL}public/mobile/img/state_hot.png");}
    .teacher_count  div.new > div{ background-image: url("{OSSURL}public/mobile/img/state_new.png")}
    .suggestion{position:fixed; left:0; right:0; top:60%; bottom:15%;-webkit-box-sizing:border-box; box-sizing:border-box; background-color:rgba(0,0,0,0); text-align:center;font-size:16px;z-index:0;color:#fe6700;}
    .suggestion > div{ position:absolute; left:6%; right:6%; top:50%; padding: 0 20px; background-color:#fff; padding-bottom:10px; padding-top: 10px;}
    .sugges > h1{ font-size: 10px; color:#fe6700; padding-top: 40px;}
    .sugges > input{display: inline-block;width:50px;height:30px; padding: 0 0px; margin-bottom: 0px; border:0px solid #ccc;-webkit-box-sizing: border-box; box-sizing: border-box;font-size:15px;}
    .sugges > input::-webkit-input-placeholder{ color: #666;font:15px "黑体";}
    .suggestion>div>span{display:inline-block;width:30px;height:30px;background:#fff;font-size:24px;color:#aaa;-webkit-border-radius:100%;-moz-border-radius:100%;-o-border-radius:100%;border-radius:100%;line-height:30px;
        text-align:center;
        position:absolute;
        top:-15px;
        right:-15px;
        font-family:宋体b8b\4f53;
        cursor:default;
    }
    .newsList{width:100%;height:auto;background:white;border-top:1px solid #e1e1e1;border-bottom:1px solid #e1e1e1;}
    .newsList .top{width:100%;height:45px;line-height:45px;position:relative;}
    .newsList .top .title{height:45px;line-height:45px;margin:0 70px 0 10px;font-size:18px;white-space:nowrap; overflow:hidden; text-overflow:ellipsis;color:#333333;}
    .newsList .top .more{height:45px;line-height:45px;width:50px;position:absolute;right:10px;top:0;font-size:14px;white-space:nowrap; overflow:hidden; text-overflow:ellipsis;text-align:right;}
    .newsList .top .more a{color:#999999;}
    .newsList ul{width:100%;height:auto;}
    .newsList ul li{width:100%;height:125px;border-top:1px solid #e1e1e1;}
    .newsList ul li:hover{background:#eee;}
    .newsList ul li .img{float:left;width:90px;height:70px;background:#eee;overflow:hidden;position:relative;float:left;margin:15px 0 15px 10px;}
    .newsList ul li .img img{position:absolute;}
    .newsList ul li a {display: inline-block;height:20px;padding: 0 3% 0 10%;font-size: 12px;}
    .newsList ul li input{display: inline-block;width:50px;height:20px; padding: 0 0px; margin-bottom: 0px; border:0px solid #ccc;-webkit-box-sizing: border-box; box-sizing: border-box;font-size:15px;}
    .newsList ul li .content{height:70px;margin:15px 10px 15px 110px;position:relative;}
    .newsList ul li .maxWidth{margin-left:10px !important;}
    .newsList ul li .content .t{width:100%;height:20px;line-height:20px;color:#666666;font-size:16px;white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .newsList ul li .content .c{width:100%;height:20px;line-height:20px;color:#666666;font-size:12px;white-space:nowrap; overflow:hidden; text-overflow:ellipsis;margin-top:5px;}
    .newsList ul li .content .b{width:100%;height:40px;line-height:20px;font-size:10px;overflow:hidden;color:#999999;margin-top:10px;}
    .newsList ul li .content .time{width:70px;height:18px;line-height:22px;font-size:14px;color:#999999;position:absolute;right:0;bottom:0;text-align:right;}
    .btn{height:44px; display: inline-block; background-color:#7bb52d;font:20px "黑体";text-align:center;color:#fff;cursor:pointer;float: right;padding-left: 2px;}
    .btn-cancel{height:44px; display: inline-block; background-color:red;font:20px "黑体";text-align:center;color:#fff;cursor:pointer;float: right;padding-left: 2px;}
    .user > a::before{ content: ""; display: inline-block; float: left; height: 29px;width:29px; margin:5px 10px 10px 10px; vertical-align: middle; background-image: url({OSSURL}public/mobile/img/user_icon.png); background-size:  auto 35px;}
    .head{position:relative; width:100%; background:#1071b7; no-repeat center center; background-size:100% auto; -moz-background-size:100% auto; -webkit-background-size:100% auto;}
    .head .pdetail{height:90px; padding:10px 0 0 20px; -webkit-box-sizing:border-box;}
    .head .pdetail .img-circle{float:left; width:66px; height:86px; overflow:hidden; margin-right:20px;}
    .head .pdetail .img-circle span{font-size:14px;line-height:10px;padding-left: 5px;color: #E8ECF1;font-weight: bolder;}
    .head .pdetail .img-circle img{border-radius:50%;width:66px;height:66px;}
    .head .pdetail .pull-left span{display:block; color:#FFF; line-height:20px;}
    .head .pdetail .pull-left span.name{font-size:20px; display:inline-block; max-width:150px; height:25px; line-height:25px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; word-break:keep-all;padding-top: 20px;}
    .head .pdetail .pull-left span.type{font-size:13px;padding-top: 5px;}
    .head .pdetail .pull-right span{display:block; color:#FFF; line-height:20px;}
    .head .pdetail .pull-right span.name{font-size:15px; display:inline-block; max-width:150px; height:25px; line-height:25px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; word-break:keep-all;padding-top: 20px;}
    .head .pdetail .pull-right span.type{font-size:14px;}
    .page span{
        display: block;
    }
    .weui-navbar__item{
        padding: 0;
        font-size: 14px;
    }
</style>
<div class="head" style="position: fixed;z-index: 10000">
    <div class="pdetail">
        <input type="hidden" id="bigImage" name="bigImage"/>
        <div class="img-circle">
            <img src="{php echo tomedia($ownerData['userImg'])}">
            <!--<span class="type">修改头像</span>-->
        </div>
        <div class="pull-left">
            <span class="name">{$ownerData['nickname']}</span>
            {if $is_institution == true}<span class="type" style="font-size: 14px;color: orange">(共享漂流点)</span>{/if}
        </div>
        <!--<div class="pull-right" style="padding-right: 20px;float: left;">-->
        <!--<a {if $ownerData['jian_url'] != '#'}href="{$ownerData['jian_url']}"{else}onclick="alert('他还没有简记哦!');"{/if}><span class="name">简记专栏</span></a>-->
        <!--</div>-->
        <div  class="pull-right" style="padding-top: 10px;padding-right: 20px;text-align:center;">
            <img src="{MODULE_URL}public/mobile/img/write.png" style="width:32px;height: 32px;">
            <a {if $ownerData['jian_url'] != '#'}href="{$ownerData['jian_url']}"{else}onclick="alert('他还没有简记哦!');"{/if}><span class="type" style="font-size: 12px;">简记专栏</span></a>
        </div>
    </div>
    <div class="page">
        <div class="page__bd">
            <div class="weui-tab">
                <div class="weui-navbar">
                    <div class="weui-navbar__item">
                        <a href="#">
                            <span>我的闲书币</span>
                            <span id="showBalance">{$balance}</span>
                            <input id="balance" type="hidden" value="{$balance}" name="balance">
                        </a>
                    </div>
                    <div class="weui-navbar__item" onclick="goCart();">
                        <a>
                            <span style="display: inline-block">闲书车<a class="weui-badge" style="display: none" id="cart">0</a></span>
                            <span id="showChooseAmount">0</span>
                            <input id="chooseAmount" type="hidden" value="0" name="chooseAmount">
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="wrap" class="teacher_inf" style="padding-top: 38%;">
    <!--列表-->
    <dl>
        <dd class="newsList">
            <ul>
                {loop $books $item}
                <li>
                    <div class="weui-gallery" style="display: none" id="{$item['id']}_showImg" onclick="hideBigImg({$item['id']}+'_showImg')">
                        <span class="weui-gallery__img" style="background-image: url({$item['images_medium']});"></span>
                        <div class="weui-gallery__opr">
                        </div>
                    </div>
                    <div class="img" onclick="showBigImg({$item['id']}+'_showImg');">
                        <img alt src="{$item['images_medium']}" style="top: 0px; left: 0px; height: 100%; width: 100%; -webkit-touch-callout: none; -webkit-user-select: none;">
                    </div>
                    <!--通过hot、add和new分别设置热报、正在报名和新增 -->
                    <div class="content">
                        <div class="t">
                            {$item['title']}
                        </div>
                        <div class="c">
                            <span>{$item['author']}</span>
                        </div>
                        <div class="c">
                            <span>原价：{$item['price']}</span>
                            <span style="color: #dd8a37;font-size: 14px;">闲书币：{$item['price']}</span>
                            <input type="hidden" value="{$item['price']}" id="{$item['id']}">
                        </div>
                        <!--<div class="b"  style="text-overflow:ellipsis;white-space:nowrap;overflow:hidden;width:200px;">{$item['summary']}</div>-->
                        <div id="{$item['id']}jianjie" style="display: none;">
                            {$item['summary']}
                        </div>
                    </div>
                    <div class="tt">
                        <a class="weui-form-preview__btn weui-form-preview__btn_default" href="{php echo $this->createMobileUrl('mybook',array('schoolid'=>$schoolid,'bookid' => $item['id'],'owneropenid' => $item['openid'],'op' => 'show_img'))}">图片</a>
                        <a class="weui-form-preview__btn weui-form-preview__btn_default" data-jAlert data-title="简介" data-content="#{$item['id']}jianjie" href="#">简介</a>
                        <a class="weui-form-preview__btn weui-form-preview__btn_default" href="{php echo $this->createMobileUrl('commentlist',array('schoolid'=>$schoolid,'bookid' => $item['id']))}">书评</a>
                        <a class="weui-form-preview__btn weui-form-preview__btn_primary" onclick="addBook(this,{$item['id']});">订书</a>
                    </div>
                </li>
                {/loop}
            </ul>
        </dd>
    </dl>
</div>
<script type="text/javascript" src="{OSSURL}public/mobile/js/PromptBoxUtil.js?v=4.80309"></script>
<script src="{MODULE_URL}/template/mobile/style/js/weui.js" type="text/javascript"></script>
<script type="text/javascript">
    var PB = new PromptBox();
    var books = new Array();
    var oss = 'http://weimeizhan.oss-cn-shenzhen.aliyuncs.com/';
    function addBook(obj,bookid){
        //检查是否需要注册
        var needReg = "{$needReg}";
        if(needReg == true){
            //跳转至注册界面
            window.location.href = "{php echo $this->createMobileUrl('bangding', array('schoolid' => $schoolid,'userType' => 'bookUser'), true)}";
            return false;
        }
        var balance       = $("#balance").val();
//        var chooseAmount  = $("#chooseAmount").val();
        var chooseAmount = document.getElementById("showChooseAmount").innerHTML;
        var new_balance,new_chooseAmount;
        if($.inArray(bookid,books) != -1){
            Weui.alert('已加入闲书车！');
            return false;
        }
        new_chooseAmount = (chooseAmount*1 + $("#"+bookid).val()*1).toFixed(2);
        new_balance = (balance*1 - $("#"+bookid).val()*1).toFixed(2);
        var minCount = "{$bookMin['amount']}";
        var maxCount = "{$bookMax['amount']}";
        var orderCount = "{$orderCount}";
        var maxMoney = Number(orderCount*1) + Number(new_chooseAmount);
        if(Number(maxMoney) > Number(maxCount)){
            Weui.alert('小主,根据您的用户权限,您一天只能交易'+maxCount+'的书！');
            return false;
        }
        if(Number(new_chooseAmount) > Number(minCount)){
            Weui.alert('小主,根据您的用户权限,您单笔最多交易'+minCount+'的书！');
            return false;
        }
        $("#balance").val(new_balance);
        $("#chooseAmount").val(new_chooseAmount);
        books.push(bookid);
        //显示闲书车
        $("#cart").show();
        //金额显示
        document.getElementById("showChooseAmount").innerHTML = new_chooseAmount;
//        document.getElementById("showBalance").innerHTML = new_balance;
        //获取数量
        if(books.length > 0){
            document.getElementById("cart").innerHTML = books.length.toString();
        }
    }
    function goCart(){
       if(document.getElementById("showChooseAmount").innerHTML == 0){
           Weui.alert('闲书车是空的哦！');
           return false;
       }
       var min = "{$min}";
       if(Number($("#chooseAmount").val()) < Number(min)){
           Weui.alert('回选价格不能少于'+min+'闲书币,但当前已选'+$("#chooseAmount").val());
           return false;
       }
       window.location.href = "{php echo $this->createMobileUrl('bookcart',array('schoolid' => $schoolid,'ownerOpenId' => $ownerOpenId,'openid' => $openid,'orderType' => $orderType ,'orderId' => $orderId))}"+"&bookIds="+books.join(',');
    }
</script>
{php include $this->template('footer');}
<script src="{MODULE_URL}public/mobile/js/jAlert.js"></script>
<script src="{MODULE_URL}public/mobile/js/jAlert-functions.js"></script>
<script>
    $(document).ready(function(e) {
        $("#wrap").css("min-height", $(document).height());
        $.jAlert('attach');
    });
    function showBigImg(id) {
        $("#"+id).attr("style","z-index:100000");
        $("#"+id).show();
    }
    function hideBigImg(id) {
        $("#"+id).hide();
    }
</script>
<script type="text/javascript">
    $(function() {

        WeixinJSShowShareMenu();

        WeixinJSShowProfileMenuAndShare();

        wx.ready(function () {
            sharedata = {
                title: "{$ownerData['nickname']}的书库",
                desc: "{$content}",
                link: '{$links}',
                imgUrl: '{$imgsUrl}',
                success: function(){

                },
                cancel: function(){

                }
            };
            sharedata1 = {
                title: "{$ownerData['nickname']}的书库",
                desc: "{$content}",
                link: '{$links}',
                imgUrl: '{$imgsUrl}',
                success: function(){

                },
                cancel: function(){

                }
            };
            wx.onMenuShareAppMessage(sharedata);
            wx.onMenuShareTimeline(sharedata1);
        });

    });

    function WeixinJSShowShareMenu(){
        if (typeof wx != "undefined"){
            wx.ready(function () {
                wx.showMenuItems({
                    menuList: ['menuItem:share:appMessage','menuItem:share:timeline'] // 要显示的菜单项，所有menu项见附录3
                });
            });
        }
    }


    function WeixinJSShowProfileMenuAndShare(){

        if (typeof wx != "undefined"){
            wx.ready(function () {
                wx.showMenuItems({
                    menuList: ['menuItem:share:appMessage','menuItem:share:timeline','menuItem:profile','menuItem:addContact','menuItem:favorite'] // 要显示的菜单项，所有menu项见附录3
                });
            });
        }
    }
</script>
</body>
</html>