{template 'public/header'}

<body>
<!--加载进度开始-->
<div id="pageLoader" class="weui_loading_toast">
  <div class="weui_mask_transparent"></div>
  <div class="weui_toast">
    <div class="weui_loading"> 
      <!-- :) -->
      <div class="weui_loading_leaf weui_loading_leaf_0"></div>
      <div class="weui_loading_leaf weui_loading_leaf_1"></div>
      <div class="weui_loading_leaf weui_loading_leaf_2"></div>
      <div class="weui_loading_leaf weui_loading_leaf_3"></div>
      <div class="weui_loading_leaf weui_loading_leaf_4"></div>
      <div class="weui_loading_leaf weui_loading_leaf_5"></div>
      <div class="weui_loading_leaf weui_loading_leaf_6"></div>
      <div class="weui_loading_leaf weui_loading_leaf_7"></div>
      <div class="weui_loading_leaf weui_loading_leaf_8"></div>
      <div class="weui_loading_leaf weui_loading_leaf_9"></div>
      <div class="weui_loading_leaf weui_loading_leaf_10"></div>
      <div class="weui_loading_leaf weui_loading_leaf_11"></div>
    </div>
    <p class="weui_toast_content">数据加载中</p>
  </div>
</div>
<!--加载进度结束-->

<div class="ub ub-ver page bga" id="page0"> 
  <!--头部 star-->
  <header class="ub ub-ac ub-pc fixed ub-fh c-wh t-gra ubb b-bla01" style="top:0; left:0; z-index:999">
    <div class="ub uinn"><i class="iconfont icon-xiangzuo ulev1"></i></div>
    <div class="ub-f1 umar-a uinn3 uc-a1 ulev-1"> <i class="icon-dingwei iconfont ulev1"></i> <span id="adr">定位中...</span> </div>
    <div class="ub uinn"><i class="icon-sousuo iconfont ulev1"></i></div>
    <div class="ub uinn xiangxia">
    <span class="btn dropdown-toggle" id="dropdownMenu1" data-toggle="dropdown"><i class="icon-gengduo iconfont ulev1"></i></span>
     <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu1">
      <li role="presentation">
         <a role="menuitem" tabindex="-1" href="wm_list.html">
           <i class="iconfont icon-wujiaoxing"></i>收藏列表
         </a>
      </li>
      <li role="presentation" class="divider"></li>
      <li role="presentation">
          <a role="menuitem" tabindex="-1" href="{php echo $this->createMobileUrl('address', array('foo'=>'list'))}">
            <i class="iconfont icon-dingwei"></i>管理地址
          </a>
      </li>
   </ul>
    </div>
  </header>
  <!--头部 end-->

  <div style="height:2.5rem"></div>
  <!--banner star-->
  {if $adv[0]['id'] != ''}
  <div class="wm_banner">
    <div class="swiper-container">
      <div class="swiper-wrapper">
        {loop $adv $val}
        <a href="{$val['link']}">
          <div class="swiper-slide">
            <img src="{$_W['attachurl']}{$val['pic']}" width="1004" height="516" class="imgbox">
          </div>
        </a>  
        {/loop}
      </div>
      <!-- Add Pagination -->
      <div class="swiper-pagination"></div>
    </div>
  </div>
  {/if}
  <!--banner end-->

  <!--导航 star-->
  <div class="wm_menu c-wh ubb b-bla01">
    <ul>
      {loop $list $vo}
      <li class="ub ufl ub-ver t-line10 ub-ac uinn11">
        <a class="block ub ub-ver ub-ac" href="{php echo $this->createMobileUrl('takeout',array('foo'=>'list','type_id'=>$vo['id']))}">
          <img src="{$_W['attachurl']}{$vo['icon']}" width="60" height="60">
          <p class="ulev-2">{$vo['type_name']}</p>
        </a>
      </li>
      {/loop}
    </ul>
  </div>
     
  <!--导航 end--> 
  <!--猜你喜欢-->
  <div class="ub ub-ver ub-f1 ubb ubt b-bla01 c-wh uinn11 umar-t1">
    <div class="uinn ub ubb b-bla01">附近推荐商家</div>
    <div class="ub ub-f1 ub-ver">
      <ul class="wm_fav_ul" id="show">
          <!--循环开始-->
          
          <!--循环结束-->
      </ul>
      <a class="uinn13 tx-c block ubb b-bla01" href="pro_list.html"><font class="ulev-2 t-blu2">查看全部商家</font></a>
    </div>
  </div>
  <!--推荐商家--> 
  <!--订单按钮-->
  <a href="{php echo $this->createMobileUrl('takeout', array('foo'=>'myorder'))}" class="fixed c-red1 t-wh uinn211 block" style="right:0;bottom:1rem; z-index:999;border-bottom-left-radius:2rem;border-top-left-radius:2rem;">订单</a>
</div>

<iframe id="geoPage" width=0 height=0 frameborder=0  style="display:none;" scrolling="no" src="http://apis.map.qq.com/tools/geolocation?key=DEZBZ-EQKKJ-CBFFB-K2SOD-GGNA3-N7BKM&referer=o2o">
</iframe>

{template 'public/footerjs'}
<script type="text/javascript" src="{MODULE_URL}static/js/baidutmp.js"></script>
<script id='near' type="text/template">
    <%for(var i=0;i<json.length;i++){%>
    <!--循环开始-->
      <li class="uinn212 ubb b-bla01 ub-f1 ub ub-pc"> 
          <a class="ub picbox ub-img1 uba b-bla01" style="background-image:url(<%=json[i].icon%>)" href="<%=json[i].url%>"></a>
          <div class="ub-f1 umar-l umar-r">
          <a class=" ub ub-ver" href="<%=json[i].url%>">
            <div class="ub-f1 ub ub-ac">
              <div class="ub-f1 font-b"><%=json[i].merchant_name%></div>
              <div class="ub t-gra ulev-2">< <%=json[i].juli%></div>
            </div>
            <div class="ub-f1 ub ub-pc ub-ac">
              <div class="ub-f1 ulev-2 umar-t">
              <%for(var j=0;j<json[i].xing;j++){%>
                <i class="iconfont icon-wujiaoxing t-org"></i> 
              <%}%>
            <font class="t-gra">月销量680单</font>
            </div>
              <div class="ub ulev-2 t-gra"><%=json[i].merchant_timelong%>分钟</div>
            </div>
            <div class="ub-f1 ub ub-pc ub-ac t-line10 ubb b-bla01 uinn11">
              <div class="ub-f1 ulev-2 t-gra">起送价 ￥<%=json[i].merchant_price%> <font class="t-dgra">|</font> 配送费 ￥<%=json[i].merchant_song%>
            </div>
              <div class="ub ulev-2 t-blu uba b-blu uc-a15"><i class="iconfont icon-motuoche"></i>全能专送</div>
            </div>
            </a>
            <div class="ub ub-f1 ub-ver umar-t">
            <div class="absolute expend"><a href="javascript:void();" onclick="displayPanel(this);" class="arrow-down block"></a></div>
            <div class="slidePanel">
                <dl>
                    <dd class="ub-f1 ub ub-pc ub-ac ulev-2" >
                        <div class="ub youhui c-red1 t-wh ub-ac ub-pc uc-a15">减</div>
                        <div class="ub-f1 umar-l">在线支付满26减8
                    </dd>
                    <dd class="ub-f1 ub ub-pc ub-ac ulev-2" >
                        <div class="ub youhui c-org t-wh ub-ac ub-pc uc-a15">首</div>
                        <div class="ub-f1 umar-l">在线支付满26减8</div>
                    </dd>
                    <dd  class="ub-f1 ub ub-pc ub-ac ulev-2">
                        <div class="ub youhui c-blu t-wh ub-ac ub-pc uc-a15">专</div>
                        <div class="ub-f1 umar-l">在线支付满26减8</div>
                    </dd>
                    <dd class="ub-f1 ub ub-pc ub-ac ulev-2">
                        <div class="ub youhui c-org t-wh ub-ac ub-pc uc-a15">7</div>
                        <div class="ub-f1 umar-l">在线支付满26减8</div>
                    </dd>
                </dl>
            </div>
            </div>
          </div>
      </li>      
    <!--循环结束-->
    <%}%>           
</script>

<script type="text/javascript">
var loc;
var isMapInit = false;
//监听定位组件的message事件
window.addEventListener('message', function(event) {
  loc = event.data; // 接收位置信息
  console.log('location', loc);
  
  if(loc) { //定位成功
    localStorage['lat'] = loc.lat;
    localStorage['lng'] = loc.lng;
    localStorage['fadr'] = loc.province + loc.city + loc.addr;
    document.getElementById('adr').innerHTML = loc.addr;
    getInit();
  } else { //定位组件在定位失败后，也会触发message, event.data为null
    alert('地理位置获取失败'); 
  }
}, false);

//为防止定位组件在message事件监听前已经触发定位成功事件，在此处显示请求一次位置信息
document.getElementById("geoPage").contentWindow.postMessage('getLocation', '*');

//设置6s超时，防止定位组件长时间获取位置信息未响应
setTimeout(function() {
  if(!loc) {
    document.getElementById("geoPage").contentWindow.postMessage('getLocation.robust', '*');
  }
}, 6000);

var forumPage = 1;
function getInit(){
  var lat = localStorage['lat'];
  var lng = localStorage['lng'];

  forumPage = 1;

  var data = {};
  data['forumPage'] = forumPage;
  data['lat'] = lat;
  data['lng'] = lng;

  $.ajax({
    url: "{php echo $this->createMobileUrl('takeout', array('foo'=>'getIndex'));}",
    type:"POST",
    data: data,
    dataType:"json",
    success: function(res){
      if(res == 0){
        document.getElementById('pageLoader').style.display = 'none';
        document.getElementById('show').innerHTML = '<div class="weui_msg"><div class="weui_icon_area"><i class="weui_icon_msg weui_icon_warn"></i></div><div class="weui_text_area"><h2 class="weui_msg_title">暂无商铺</h2></div></div>';
      }else{
        var json = eval(res);
        var near = baidu.template("near",{json:json});
        document.getElementById('show').innerHTML = near; 
        document.getElementById('pageLoader').style.display = 'none';
        if(json.length == 10){
          document.getElementById('more').style.display = "block";  
        }
      }
    }
  });
}

function getMore(){
  forumPage = forumPage + 1;
    
  var data = {};
  data['forumPage'] = forumPage;
  
  $.ajax({
    url: "{php echo $this->createMobileUrl('takeout', array('foo'=>'getIndex'));}",
    type:"POST",
    data: data,
    dataType:"json",
    success: function(res){
      if(res == "0"){
        document.getElementById('more').innerHTML = '已无数据';
      }else{
        var json = eval(res);
        var near = baidu.template("near",{json:json});
                $("#show").append(near); 
        if(json.length<10){
          document.getElementById('more').innerHTML = "<div class='tx-c'>已无数据</div>";  
        }else{
          document.getElementById('more').style.display = "block";  
        }
      }
    }
  });
}
</script>

</body>
</html>
