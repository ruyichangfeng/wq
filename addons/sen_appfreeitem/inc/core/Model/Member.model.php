<?php 

class MemberTableHandle { static function listJoin($list,$openid_name = 'openid') { global $_W; foreach($list as &$item) { $item['uinfo'] = self::info($item[$openid_name]); } return $list; } static function info($openid) { global $_W; static $infos = array(); if(!isset($infos[$openid])) { $infos[$openid] = pdo_fetch("select * from ".tablename('intelligent_kindergarten_member')." where uniacid={$_W['uniacid']} and openid='$openid'"); } return $infos[$openid]; } static function flushNoticeTimes($openid) { global $_W; pdo_update('intelligent_kindergarten_member',array('update_time'=>date('Y-m-d H:i:s'),'notice_times'=>0),array('openid'=>$openid,'uniacid'=>$_W['uniacid'])); } static function sumCounts() { global $_W; static $counts; if(!$counts) { $res = pdo_fetch("select count(*) as num from ".tablename('intelligent_kindergarten_member')." where uniacid={$_W['uniacid']}"); $counts = $res['num']; } return $counts; } static function todayAddNum() { global $_W; static $num; if(!$num) { $res = pdo_fetch("select count(*) as num from ".tablename('intelligent_kindergarten_member')." where add_time>:today and uniacid={$_W['uniacid']}",array(':today'=>date("Y-m-d"))); $num = $res['num']; } return $num; } static function userList($openid,$sex = '',$begin = 0,$offset = 32) { global $_W; $sql = $sex ? " and  sex='$sex' " : ''; $list = pdo_fetchall("select * from ".tablename('intelligent_kindergarten_member')." where 1=1 and uniacid={$_W['uniacid']} $sql order by update_time desc limit $begin,$offset"); return $list; } static function nearbyList($openid,$begin = 0,$offset = 20) { global $_W; $info = self::info($openid); $list = pdo_fetchall("select *,ABS({$info['lng']}-lng) as lng_d,ABS({$info['lat']}-lat) as lat_d from ".tablename('intelligent_kindergarten_member')." where openid<>'$openid' and lat<>'' and lng<>'' and sex='{$info['choose_sex']}'  and isvisible='open' and uniacid={$_W['uniacid']} order by lng_d+lat_d asc limit $begin,$offset"); return $list; } static function appMember($userinfo) { global $_W; if($userinfo['sex'] === '0' || $userinfo['sex'] === 0) { $userinfo['sex'] = 2; } $data = array(); $data['openid'] = $userinfo['openid']; $data['nickname'] = $userinfo['nickname']; $data['sex'] = $userinfo['sex']; $data['province'] = $userinfo['province']; $data['city'] = $userinfo['city']; $data['country'] = $userinfo['country']; $data['headimgurl'] = $userinfo['avatar']; $data['uniacid'] = $_W['uniacid']; $data['acid'] = $_W['account']['acid']; $data['account'] = $_W['account']['name']; $data['add_time'] = date("Y-m-d H:i:s"); $data['age'] = ''; $data['isvisible'] = 'open'; if($data['sex'] == 2) { $data['choose_sex'] = 1; } else { $data['choose_sex'] = 2; } $info = self::info($userinfo['openid']); if($info) { $new_info = array(); unset($data['headimgurl']); unset($data['isvisible']); unset($data['nickname']); unset($data['update_time']); unset($data['add_time']); unset($data['age']); $data['update_time'] = date("Y-m-d H:i:s"); $r = self::update($data,array('openid'=>$userinfo['openid'],'uniacid'=>$_W['uniacid'])); if($r === false) { exit('update error'); } } else { $res = pdo_insert('intelligent_kindergarten_member',$data); if($res === false) { exit(' insert error'); } } } static function searchList($keyword='',$cond = array(),$begin=1,$offset=20) { global $_W; $sql = ''; if($cond) { foreach($cond as $k=>$v) { $sql .= " and $k = '$v' "; } } if($keyword) { $sql .= " and nickname like '%$keyword%' "; } return pdo_fetchall("select * from ".tablename('intelligent_kindergarten_member')." where 1=1 $sql and uniacid={$_W['uniacid']} order by add_time desc limit $begin,$offset"); } static function searchListCounts($keyword='',$cond = array(),$begin=1,$offset=20) { global $_W; $sql = ''; if($cond) { foreach($cond as $k=>$v) { $sql .= " and $k = '$v' "; } } if($keyword) { $sql .= " and nickname like '%$keyword%' "; } $res = pdo_fetch("select count(*) as num from ".tablename('intelligent_kindergarten_member')." where 1=1 $sql and uniacid={$_W['uniacid']}"); return $res['num']; } static function update($data,$where) { global $_W; $r = pdo_update('intelligent_kindergarten_member',$data,$where); return $r; } }

?>