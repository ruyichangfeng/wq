{template 'common/header'}
<SCRIPT src="{STATIC_ROOT}/js/jquery.lazyload.min.js" type=text/javascript></SCRIPT>
<meta name="referrer" content="never">
<style>
    .l_tableWrap .l_table_tit .l_formBar {
        border: 0;
        float: left;
        font-size: 0;
    }
    .y_sele {
        display: inline-block;
        padding: 5px 0 12px 12px;
    }
    .y_sele_tit {
        font-size: 14px;
        padding: 0 0 0 10px;
    }
    .l_table_search{
        margin-left: 10px;
        margin-bottom: 5px;
    }
</style>
<div class="clearfix">
    <div class="panel panel-default">
        <div class="panel-heading">
            文章列表
        </div>
        <div class="table-responsive panel-body" style="overflow:visible;">
            <div class="l_table_tit clearfix">
                <div class="btn-group l_table_search">
                    <a href="{php echo $this->createWebUrl('article', array('_wg' => 'edit'))}" class="btn btn-success">添加文章</a>
                </div>
                <div class="y_sele y_size03" >
                    <select id="category" class="form-control" style='width:100px;'>
                        {loop $cate $row}
                        <option <?php if($category_id == $row['id']){ echo 'selected';}?> value="{$row['id']}">{$row['name']}</option>
                        {/loop}
                    </select>
                </div>

                <div class="btn-group l_table_search">
                    <a id="delete_all" class="btn btn-danger">删除已选</a>
                </div>

                <div class="btn-group l_table_search">
                    <input placeholder="整数" type="text" id="time_step" class="form-control span7" name="time_step" value="{php echo date('Y-m-d H:i:s',$time ? $time : time());}">
                </div>
                <div class="btn-group l_table_search">
                    <a id="delete_time" class="btn btn-danger">删除次时间之前的文章</a>
                </div>
            </div>
            <style>
                .table > thead > tr > td, .table > tbody > tr > td, .table > tfoot > tr > td {
                    white-space: normal;
                }
            </style>
            <table class="table table-hover">
                <tr>
                    <th><input type="button" id="select_all" value="全选"></th>
                    <th style="width: 120px;">ID</th>
                    <th style="width: 190px">标题</th>
                    <th>图片</th>
                    <th>来源</th>
                    <th>点赞</th>
                    <th>阅读</th>
                    <th>时间</th>
                    <th style="width: 120px; text-align: center;">操作</th>
                </tr>
                {loop $list $row}
                <tr>
                    <td>
                        <input type="checkbox" data-id="{$row['id']}" class="select_id">
                    </td>
                    <td>
                        <p class="form-control-static">
                            {$row['id']} - (<?php echo $row['jump']? '链接':'本地';?>)
                        <a style="color: red;"><?php if($row['type']==2){echo '图集';}elseif($row['type']==3){echo '视频';}?></a>

                        </p>
                    </td>
                    <td>
                        <p class="form-control-static" title="{$row['buyproinfos']}">
                            <a target="_blank" href="<?php echo $row['jump'] ? $row['url'] : $this->webmobileUrl('detail',['category_id' => $category_id,'id'=>$row['id']]);?>">{$row['title']}</a>
                        </p>
                    </td>
                    <td>
                        <p class="form-control-static">
                         <?php $image = @json_decode($row['image'], true);
                            if($image) {
                               echo count($image).'图';
                               echo '<img width="100px" src="'.$this->formatArrImage($image[0])['url'].'"/>';
                                }else{echo 0;} ?>

                        </p>
                    </td>
                    <td>
                        <p class="form-control-static">
                            {$row['author']}
                        </p>
                    </td>

                    <td>
                        <p class="form-control-static">
                            {$row['praise']}
                        </p>
                    </td>
                    <td>
                        <p class="form-control-static">
                            {$row['read_times']}
                        </p>
                    </td>

                    <td>
                        <p class="form-control-static">
                            {php echo date('Y-m-d H:i:s',$row['time_step']);}
                        </p>
                    </td>
                    <td>
                        <div class="form-control-static">
                            <a class="btn btn-success btn-sm" href="{php echo $this->createWebUrl('article', array('_wg' => 'edit','category_id' => $category_id, 'id' => $row['id']))}" >编辑</a>
                            <a href="javascript:void(0);" class="del-article btn btn-default btn-sm" data-id="{$row['id']}" >删除</a>
                        </div>
                        <div>
                            <a href="{php echo $this->createWebUrl('comment', array('category_id' => $category_id, 'article_id' => $row['id']))}" class="btn btn-default btn-sm" >评论</a>
                            <a href="javascript:void(0);" class="slider btn btn-default btn-sm" data-id="{$row['id']}" >轮播</a>
                        </div>
                    </td>
                </tr>
                {/loop}
            </table>
        </div>
        <div class="panel-body text-right">
            {$show}
        </div>
    </div>
</div>
<script>




    require(['jquery','datetimepicker'], function ($,UM) {
        $('#time_step').datetimepicker({
            format: 'Y-m-d H:i:s',
            language: 'zh-CN',
            step:10,
            startDate:new Date()

        });
    });
    var url = "{php echo $this->createWebUrl('article',['']);}";
    var slider_url = "{php echo $this->createWebUrl('slider',['_wg' => 'setting']);}";
    var category_id = "{$category_id}";
    var url_del = "{php echo $this->createWebUrl('article',['_wg' => 'del']);}";
    $(function () {
        $('#category').change(function () {
            location = url+'&category_id='+$(this).val();
        });
        $('.slider').click(function () {
            var id = $(this).attr('data-id');
            $.post(slider_url,{id:id,category_id:category_id},function (data) {
                if(data.code !=0) {
                    alert(data.msg);
                } else {
                    alert('添加成功');
                }
            },"JSON");
        });
        $("img").lazyload({
            placeholder : "images/loading.gif",
            effect: "fadeIn"
        });
        $('.del-article').click(function () {
            if(!confirm('确认删除此轮播文章？')) {
                return false;
            }
            var id = $(this).attr('data-id');
            $.post(url_del,{id:id,category_id:category_id},function (data) {
                if(data.code != 0) {
                    alert(data.msg);
                }
                location.reload();
            },'JSON');
        });

        $('#select_all').click(function () {

            $('.select_id').attr("checked","checked");
//            $.post(url_del,{id:id,category_id:category_id},function (data) {
//                if(data.code != 0) {
//                    alert(data.msg);
//                }
//                location.reload();
//            },'JSON');
        });
        $('#delete_all').click(function () {
            var ids = [];
            $('.select_id').each(function (i, dos) {
                if($(dos).is(':checked')) {
                    ids.push($(dos).attr('data-id'));
                }
            });
            if(!ids) {
                return ;
            }
            ids = ids.join(",");
            $.post(url_del,{id:ids,category_id:category_id},function (data) {
                if(data.code != 0) {
                    alert(data.msg);
                }
                location.reload();
            },'JSON');
        });

        $('#delete_time').click(function () {

            if(!confirm('确认删除次时间之前的所有文章，删除后不能回复？')) {
                return false;
            }
            $.post(url_del,{time:$('#time_step').val(),category_id:category_id},function (data) {
                if(data.code != 0) {
                    alert(data.msg);
                }
                location.reload();
            },'JSON');
        });
    })
    </script>
{template 'common/footer'}
