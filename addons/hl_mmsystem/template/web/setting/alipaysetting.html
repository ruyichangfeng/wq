{template 'web/common/header'}
<div class="wrapper wrapper-content ">
    <div class="row">
        <div class="col-sm-12">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>支付宝设置</h5>
                    <h5 style="float: right"><a class="glyphicon glyphicon-refresh" href="{php echo $this->createWebUrl('alipaysetting')}"></a></h5>
                    <div class="hr-line-dashed"></div>
                    <div class="row">
                        <div class="col-sm-12">
                            <div class="tabs-container">
                                <ul class="nav nav-tabs">
                                    <li class=""><a  href="{php echo $this->createWebUrl('YunPay')}" ><img width="20" src="{HLMMS_IMG}yunpay_ico.png"> 云支付</a>
                                    </li>
                                    <li class="active"><a data-toggle="tab" href="#tab-1" aria-expanded="true"><img width="20" src="{HLMMS_IMG}alipay_ico.png"> 支付配置</a>
                                    </li>
                                    <li class=""><a data-toggle="tab" href="#tab-2" aria-expanded="false"></i><i class="fa fa-list"  style="color: #e10c14"></i>收款账单列表</a>
                                    </li>
                                    <li class=""><a href="{php echo $this->createWebUrl('wechatsetting')}" ><i class="fa fa-weixin" style="color:#0abc89"></i>微信支付</a>
                                    </li>
                                </ul>
                                <div class="tab-content">
                                    <div id="tab-1" class="tab-pane active">
                                        <div class="panel-body">
                                            <form action="" method="post" class="form-horizontal form" enctype="multipart/form-data" id="form1" >
                                                <div class="form-group">
                                                    <label class="col-xs-12 col-sm-3 col-md-2 control-label"><span style="color:red">*</span>支付宝账户</label>
                                                    <div class="col-sm-9 col-xs-12">
                                                        <input id="alipayAccountNumber" type="text" name="alipayAccountNumber" class="form-control" value="{$set_alipay_info['set_alipayAccountNumber']}" />
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <label class="col-xs-12 col-sm-3 col-md-2 control-label"><span style="color:red">*</span>合作伙伴身份（PID）</label>
                                                    <div class="col-sm-9 col-xs-12">
                                                        <input id="alipayPID" type="text" name="alipayPID" class="form-control" value="{$set_alipay_info['set_alipayPID']}" />
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <label class="col-xs-12 col-sm-3 col-md-2 control-label"><span style="color:red">*</span>合作伙伴MD5密钥</label>
                                                    <div class="col-sm-9 col-xs-12">
                                                        <input id="alipayMd5Key" type="text" name="alipayMd5Key" class="form-control" value="{$set_alipay_info['set_alipayMd5Key']}" />
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <label class="col-xs-12 col-sm-3 col-md-2 control-label"><span style="color:red">*</span>支付宝APPID</label>
                                                    <div class="col-sm-9 col-xs-12">
                                                        <input id="alipayAppId" type="text" name="alipayAppId" class="form-control" value="{$set_alipay_info['set_alipayAppId']}" />
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <label class="col-xs-12 col-sm-3 col-md-2 control-label"><span style="color:red">*</span>签名类型</label>
                                                    <div class="col-sm-9 col-xs-12">
                                                        <input id="alipaySignType" type="text" name="alipaySignType" class="form-control" value="{$set_alipay_info['set_alipay_sign_type']}" />
                                                        <span>支付宝签名类型：RSA、RSA2（推荐 RSA2）</span>
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <label class="col-xs-12 col-sm-3 col-md-2 control-label">支付宝公钥</label>
                                                    <div class="col-sm-9 col-xs-12">
                                                        <textarea class="form-control" rows="3" id="alipayRsaPublicKey" style="color: brown"  name="alipayRsaPublicKey" >{if $set_alipay_info['set_alipay_rsa_public_key'] != ''}证书内容已隐藏，如需修改请直接按要求粘贴证书内容。{/if}</textarea>
                                                        <span><i class="fa fa-lg fa-info-circle" style="color: crimson"></i> 重要：rsa2 的支付宝公钥(开放平台获取)内容粘贴到文本框内（去掉头-----BEGIN PUBLIC KEY-----）（去掉尾-----END PUBLIC KEY-----）</span>
                                                    </div>
                                                </div>
                                                <div class="form-group">
                                                    <label class="col-xs-12 col-sm-3 col-md-2 control-label">支付宝RAS密钥</label>
                                                    <div class="col-sm-9 col-xs-12">
                                                        <textarea class="form-control" rows="3" id="alipayRsaPrivateKey" style="color: brown" name="alipayRsaPrivateKey" >{if $set_alipay_info['set_alipay_rsa_private_key'] != ''}证书内容已隐藏，如需修改请直接按要求粘贴证书内容。{/if}</textarea>
                                                        <span><i class="fa fa-lg fa-info-circle" style="color: crimson"></i> 重要：rsa与rsa2的私钥相同，将私钥内容粘贴到文本域内（去掉头-----BEGIN RSA PRIVATE KEY-----）（去掉尾-----END RSA PRIVATE KEY-----）</span>
                                                    </div>
                                                </div>
                                                <div class="form-group col-sm-12">
                                                    <label class="col-xs-12 col-sm-3 col-md-2 control-label"></label>
                                                    <div class="col-sm-9 col-xs-12">
                                                    <input type="submit" name="alipayPaySetSubmit" value="提交" class="btn btn-primary col-lg-2" />
                                                    <input type="hidden" name="token" value="{$_W['token']}" />
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                    <div id="tab-2" class="tab-pane">
                                        <div class="panel-body">
                                            <div class="col-sm-2 col-xs-2">
                                                <select data-placeholder="请选择操作员"  class="chosen-select" name="alipayConsumTableDataOperator" id="alipayConsumTableDataOperator"  style="width: 100%" tabindex="4">
                                                    {if in_array('0', $thisoperatorlist) }
                                                    <option value="0"   hassubinfo="true" selected>无操作员选择</option>
                                                    {else}
                                                    <option value="0"   hassubinfo="true">无操作员选择</option>
                                                    {/if}

                                                    {loop $accountlist $key $value}
                                                    <option value="{$value['uid']}" hassubinfo="true">{$value['username']}</option>
                                                    {/loop}

                                                </select>
                                            </div>
                                            <div class="col-sm-2">
                                                {php echo tpl_form_field_daterange('alipayConsumTablelimittime', array('starttime' => '2018-01-01','endtime' => $endtime));}
                                            </div>
                                            <div class="col-sm-2">
                                                <button class="btn btn-outline btn-primary" type="button" onclick="CalculationSum();" id="btn_searchsubmit"><i class="fa fa-search"></i> 搜索</button>
                                            </div>
                                            <div class="col-xs-2">
                                                <div class="input-group m-b">
                                                    <input type="text" disabled="disabled" name="AlStoreCalculationSum" class="form-control" value="" id='AlStoreCalculationSum'/>
                                                    <span class="input-group-addon">元</span>
                                                </div>
                                            </div>
                                            <table id="alipayConsumTableData" data-mobile-responsive="true"></table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
              </div>
        </div>
    </div>
</div>
<script>
    $(document).ready(function(){
        $('#alipayConsumTableDataOperator').chosen({
            allow_single_deselect: true,
            disable_search_threshold: 1,
            no_results_text: '暂无选项！',
            enable_split_word_search:true,
            width: '95%'
        });

        CalculationSum();
        $('#alipayConsumTableData').bootstrapTable({
            url: '{php echo $this->createWebUrl('member', array('op' => 'getAlipayConsumTableData'));}',
            method:"post",
            dataType: "json",
            contentType: "application/x-www-form-urlencoded",
            cache:false,  //是否使用缓存
            search:false, //显示搜索框
            clickToSelect: true,
            showPaginationSwitch:false,//是否显示数据条数选择框
            striped:true,//隔行变色
            queryParamsType:'',
            queryParams: querypayParamspage,//传递参数（*）
            sidePagination: "server",           //分页方式：client客户端分页，server服务端分页（*）
            pageNumber:1,                       //初始化加载第一页，默认第一页
            pageSize: 10,                       //每页的记录行数（*）
            pageList: [10, 20, 40, 100],
            pagination: true,
            height: 556,
            selectItemName:"id",
            uniqueId: "id",
            columns: [{
                radio: true
            },{
                field: 'wpi_Out_trade_no',
                title: '单据号',
                align: "center",
                valign: "middle"
            },{
                field: 'wpi_MemberName',
                title: '会员姓名',
                align: "center",
                valign: "middle",
                formatter:memberIdFormatter
            },{
                field: 'wpi_PayType',
                title: '支付方式',
                align: "center",
                valign: "middle"
            },{
                field: 'wpi_ConsumeType',
                title: '消费方式',
                align: "center",
                valign: "middle"
            },{
                field: 'wpi_PayStatus',
                title: '支付状态',
                align: "center",
                valign: "middle",
                formatter:memberPayStatusFormatter
            },{
                field: 'wpi_MoneyTotalFee',
                title: '总金额(元)',
                align: "center",
                valign: "middle"
            }, {
                field: 'wpi_AddTime',
                title: '支付时间',
                align: "center",
                valign: "middle",
                formatter:memberPayAddTimeFormatter
            }, {
                field: 'store_id',
                title: '收款商家',
                align: "center",
                valign: "middle",
                formatter:memberPayToStoreFormatter
            }, {
                field: 'id',
                title: '操作',
                align: "center",
                valign: "middle",
                formatter:actionFormatter
            },]
        });
        function querypayParamspage (params) {
            var temp = {  //这里的键的名字和控制器的变量名必须一直，这边改动，控制器也需要改成一样的
                pageSize: params.pageSize,  //页面大小
                pageNumber: params.pageNumber, //页码
                alipayConsumTableDataOperator: $("#alipayConsumTableDataOperator").val(),
                start_alipayStartTime:$('input[name="alipayConsumTablelimittime[start]"]').val(),
                end_alipayEndTime: $('input[name="alipayConsumTablelimittime[end]"]').val(),

            };
            return temp;
        }
        function memberIdFormatter(value, row, index) {
            if(value == 0){
                return "非会员";
            }else{
                return value;
            }
        }
        function memberPayStatusFormatter(value, row, index) {
            var paystatusValue = value;
            var result = "";
            if(paystatusValue == 1){
                result += "支付成功";
            }else{
                result += "支付失败";
            }
            return result;
        }
        function memberPayAddTimeFormatter(value, row, index) {
            return new Date(parseInt(value) * 1000).toLocaleString().replace(/:\d{1,2}$/,'');
        }
        function memberPayToStoreFormatter(value, row, index) {
            return "{php echo util::getSetStoreName()}";
        }
        function actionFormatter(value, row, index) {
            var id = value;
            var result = "";
            result += "<button type=\"button\" class='btn btn-xs btn-primary' onclick=\"ViewCashRegister(" + id + ")\" title='退款'><i class='fa fa-mail-reply'></i></button>";
            return result;
        }

    });
    function CalculationSum() {
        $('#alipayConsumTableData').bootstrapTable('refresh');
        var alipayConsumTableDataOperator= $("#alipayConsumTableDataOperator").val();
        var start_alipayStartTime=$('input[name="alipayConsumTablelimittime[start]"]').val();
        var end_alipayEndTime= $('input[name="alipayConsumTablelimittime[end]"]').val();
        var url = "{php echo $this->createWebUrl('memberinfo', array('op' => 'AlipeyCalculationSum'))}";
        $.ajax({
            url: url,
            type: "post",
            data: {alipayConsumTableDataOperator:alipayConsumTableDataOperator,start_alipayStartTime:start_alipayStartTime,end_alipayEndTime:end_alipayEndTime},
            dataType: 'json',
            success: function (data) {
                if (data['message']['code'] == 1) {
                    $("#AlStoreCalculationSum").attr("value",Math.round(data['message']['msg']*100)/100);
                    $('#wechatConsumTableData').bootstrapTable('refresh');
                    return;
                }
            }
        });


    }
    //时间转换
</script>
{template 'web/common/footer'}