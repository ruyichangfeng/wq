<include file="Public/header.html"/>
<link rel="stylesheet" type="text/css" href="__ROOT__/Public/lib/froala_editor/css/font-awesome.min.css?1">
<link rel="stylesheet" type="text/css" href="__ROOT__/Public/lib/froala_editor/css/froala_editor.min.css" >
<link rel="stylesheet" type="text/css" href="__ROOT__/Public/lib/layui/css/modules/laydate/default/laydate.css" >


</head>
<body>
    <div class="x-body">
        <form class="layui-form">
             	
              <div class="layui-form-item" pane="">
			    <label class="layui-form-label">所属分类</label>
			    <div class="layui-input-block">
			    	<?php $goods['classify_id'] = ','.$goods['classify_id'].','; ?> 
		    	    <volist name="classify" id="v" >	
		    	    	<input  type="checkbox" value="{$v.id}" <?php if( strstr($goods['classify_id'],','.$v['id'].',')  ){ echo 'checked';} ?>   title="{$v.name}" name="classify_id[]"   >
			        </volist>
			    </div>
			  </div>
			  
			  <div class="layui-form-item" pane="">
			    <label class="layui-form-label">自定义属性</label>
			    <div class="layui-input-block">
		    	   <input  type="checkbox" value="1" <?php if( strstr($goods['diy_attr'],'1')  ){ echo 'checked';} ?>   title="精选" name="diy_attr[]"   >
		    	   <input  type="checkbox" value="2" <?php if( strstr($goods['diy_attr'],'2')  ){ echo 'checked';} ?>   title="热门" name="diy_attr[]"   >
			    </div>
			  </div>
             
             <div class="layui-form-item"  >
                <label  class="layui-form-label">商品标题 </label>
                <div class="layui-input-block">
                    <input type="text"  name="title"  lay-verify="required"   autocomplete="off" value="{$goods['title']}"  class="layui-input">
                </div>
              </div>
              
              <div class="layui-form-item"  >
                <label  class="layui-form-label">商品副标题 </label>
                <div class="layui-input-block">
                    <input type="text"  name="title_vice"  lay-verify="required" autocomplete="off" value="{$goods['title_vice']}"  class="layui-input">
                </div>
              </div>
              
              <div class="layui-form-item">
			    <div class="layui-inline">
			      <label class="layui-form-label">商品图片</label>
			      <div class="layui-input-inline">
			      	  <button type="button" class="layui-btn" onclick="$('#goods_img').click();">
					     <i class="layui-icon">&#xe67c;</i>上传图片
					 </button>
					  <input type="hidden"  id="goods_img_val" lay-verify="goods_img"  value="" >
					  <input style="display: none;" type="file" id="goods_img"  onchange="previewImage(this,1,'goods_img_val')"   multiple  class="input-file">
	                <div>
	                   <img id="imghead1" border="0"  style="margin-top: 5px;max-height:100px;"                   	
	                   <?php 
	                   	   if( empty($goods['goods_img']) ){
	                   	   	   echo 'src="__ROOT__/Public/images/z_add.png"   onclick="$(\'#goods_img\').click();"';
	                   	   }else{
	                   	       echo 'src="__ROOT__/Uploads/'.$goods['goods_img'].'"';
	                   	   }
	                    ?>
	                   >
	                   <div class="layui-form-mid layui-word-aux">500px*330px,建议白底图片</div>
			      </div>
			    </div>
			    
			    <div class="layui-inline">
			      <label class="layui-form-label">市场价</label>
			      <div class="layui-input-inline">
			        <input type="text" name="market_price" value="{$goods['market_price']}"  placeholder="￥"  lay-verify="required|number" autocomplete="off" class="layui-input">
			      </div>
			    </div>
			  </div>
			  
			  
			  
			  <div class="layui-form-item">
			  	<div class="layui-inline">
			      <label class="layui-form-label">初始价</label>
			      <div class="layui-input-inline">
			      	 <input type="text" name="initial_price" value="{$goods['initial_price']}" placeholder="￥" lay-verify="required|number"  autocomplete="off" class="layui-input">
			          <div class="layui-form-mid layui-word-aux">下一期初始价格</div>
			      </div>
			    </div>
			  	
			    <div class="layui-inline">
			      <label class="layui-form-label">当前价</label>
			      <div class="layui-input-inline">
			      	 <input type="text" name="discount_price" value="{$goods['discount_price']}" placeholder="￥" lay-verify="required|number"  autocomplete="off" class="layui-input">
			        <div class="layui-form-mid layui-word-aux">&nbsp;</div>
			      </div>
			    </div>
			 </div>
			  
	    	<div class="layui-form-item">
			    
			    <div class="layui-inline">
			      <label class="layui-form-label">成交保底价</label>
			      <div class="layui-input-inline" style="width: 82px;">
			        <input type="text" name="minimum_price" value="{$goods['minimum_price']}" placeholder="￥" lay-verify="required|number" autocomplete="off" class="layui-input">
			      </div>
			     <div class="layui-form-mid">-</div>
			      <div class="layui-input-inline" style="width: 82px;">
			        <input type="text" name="mini_price" value="{$goods['mini_price']}"  placeholder="￥" lay-verify="required|number"  autocomplete="off" class="layui-input">
			      </div>
			    </div>
			  
			    <div class="layui-inline">
			      <label class="layui-form-label">成交波动价</label>
			      <div class="layui-input-inline" style="width: 82px;">
			        <input type="text" name="start_price" value="{$goods['start_price']}" placeholder="￥" lay-verify="required|number" autocomplete="off" class="layui-input">
			      </div>
			      <div class="layui-form-mid">-</div>
			      <div class="layui-input-inline" style="width: 82px;">
			        <input type="text" name="end_price" value="{$goods['end_price']}" placeholder="￥" lay-verify="required|number"  autocomplete="off" class="layui-input">
			      </div>
			    </div>
			    
			  </div>

			   <div class="layui-form-item">
			    <div class="layui-inline">
			      <label class="layui-form-label">初始倒计时</label>
			      <div class="layui-input-inline">
			      	 <input type="text" name="initial_time" value="{$goods['initial_time']}" id="initial_time" readonly="readonly" placeholder="hh:mm:ss" lay-verify="required" autocomplete="off" class="layui-input">
			         <div class="layui-form-mid layui-word-aux">&nbsp;</div>
			      </div>
			    </div>
			    <div class="layui-inline">
			      <label class="layui-form-label">竞拍倒计时</label>
			      <div class="layui-input-inline">
			        <input type="text" name="auction_time" value="{$goods['auction_time']}"  placeholder="秒" lay-verify="required|number" autocomplete="off" class="layui-input">
			        <div class="layui-form-mid layui-word-aux">竞拍后重置的倒计时</div>
			      </div>
			    </div>
			  </div>
              
               <div class="layui-form-item">
			    <div class="layui-inline">
			      <label class="layui-form-label">竞拍费</label>
			      <div class="layui-input-inline">   
			      	 <input type="text" name="bidding_price" value="{$goods['bidding_price']}" placeholder="X虚拟币/次" lay-verify="required|number" autocomplete="off" class="layui-input">
			     </div>
			    </div>
			    
			    <div class="layui-inline">
			      <label class="layui-form-label">加价幅度 </label>
			      <div class="layui-input-inline" >
			        <input type="text" name="markup_range" value="{$goods['markup_range']}" placeholder="￥" lay-verify="required|number" autocomplete="off" class="layui-input">
			      </div>
			    </div>
			  </div>
			  
			  <div class="layui-form-item">
			    <div class="layui-inline">
			      <label class="layui-form-label">强制出价 </label>
			      <div class="layui-input-inline">  
			      	 <input type="text" name="mandatory_bid" value="{$goods['mandatory_bid']}" placeholder="X虚拟锤/次" lay-verify="required|number" autocomplete="off" class="layui-input">
			      </div>
			    </div>
			    
			   	<div class="layui-inline">
			      <label class="layui-form-label">状态 </label>
			      <div class="layui-input-inline">
			      	 <select name="state" lay-filter="aihao" <?php if($goods['state']==3 || $goods['state']==4){ echo 'disabled'; } ?>>
					     <option <?php if($goods['state']==1){ echo 'selected'; } ?> value="1" >待竞拍</option>
					     <option <?php if($goods['state']==2){ echo 'selected'; } ?> value="2" >竞拍中</option>
					     <option <?php if($goods['state']==3){ echo 'selected'; } ?> value="3" >竞拍结束</option>
					     <option <?php if($goods['state']==4){ echo 'selected'; } ?> value="4" >竞拍关闭</option>
					 </select>
			      </div>
			    </div>
			  </div>
			  
             <div class="layui-form-item layui-form-text">
			    <label class="layui-form-label">商品描述</label>
			    <div class="layui-input-block">
			      <textarea placeholder="请输入内容"  lay-verify="goods_desc"  id='goods_desc_edit' name="goods_desc" class="layui-textarea"><?php if(empty($goods['goods_desc'])){ echo '<p></p><p></p><p></p>';}else{ echo $goods['goods_desc']; } ?></textarea>
			    </div>
			  </div>
    
             <div class="layui-form-item" style="display: none;">
                <label for="L_sign" class="layui-form-label"></label>
               <button class="layui-btn" id="submitBtn" key="set-mine" lay-filter="save" lay-submit> </button>
            </div>
            
            <input type="hidden"  name="id" value="{$goods['id']}" />
             
        </form>
    </div>
    <script type="text/javascript" src="__ROOT__/Public/lib/layui/lay/modules/laydates.js?2018"></script>
    <include file="Public/footer.html"/>
    <script type="text/javascript" src="__ROOT__/Public/js/jquery.min.js"></script>
    <script type="text/javascript" src="__ROOT__/Public/js/tools.js"></script> 
	<script type="text/javascript" src="__ROOT__/Public/lib/froala_editor/js/froala_editor.min.js"></script>
	<script type="text/javascript" src="__ROOT__/Public/lib/froala_editor/js/plugins/colors.min.js"></script>
	<script type="text/javascript" src="__ROOT__/Public/lib/froala_editor/js/plugins/font_family.min.js"></script>
	<script type="text/javascript" src="__ROOT__/Public/lib/froala_editor/js/plugins/font_size.min.js"></script>
	<script type="text/javascript" src="__ROOT__/Public/lib/froala_editor/js/langs/zh_cn.js"></script>
	
   
    <script>
    	
	 $('#goods_desc_edit').editable({
		 inlineMode: false,
		 language: "zh_cn",
		 alwaysBlank: true, 
		 imageUploadURL:"{:U('Home/MainCtr/Goods/upload_img')}",
	  })
	
    	
      layui.use(['form','layer'], function(){
           var form = layui.form;
           var layer = layui.layer;
           
           laydate.render({
		     elem: '#initial_time',
		     type: 'time'
		   });
		   	
	       form.verify({
			    goods_img: function(value){
			       if(value.length ==0  && '{$goods["goods_img"]}' ==''){
			         return '请填上传商品图片';
			      }
			    }
			});
          
          form.on('submit(save)', function(data){
                
            	if($("input[type='checkbox']:checked").size() == 0){
		           parent.layer.msg('请选择所属分类', {icon: 2,offset: '40%',time:1500,shade: 0.3});
		           return false;
		        }
               
               if(  Number($("input[name='auction_time']").val()) < 15    ){
               	   parent.layer.msg('倒计时必须大于15秒', {icon: 2,offset: '40%',time:1500,shade: 0.3});
		           return false;
               }
                
				var tjing = parent.layer.msg('提交中...', {icon: 16,shade: 0.3,time: 60*1000}); 
		        var form = document.forms[0];
	  		    var formData = new FormData(form);  
			    if($("#goods_img_val").val()!=''){
			      formData.append("goods_img",convertBase64UrlToBlob($("#goods_img_val").val()));
				} 
				
				$.ajax({
			        url: "{:U('Home/MainCtr/Goods/do_goods')}",
			        type : "POST",
			        data :formData,
			        dataType:"text",
			        processData : false,         
			        contentType : false,      
			        success:function(data){
			            parent.layer.close(tjing);
		               if(data == '1'){
		              	 var index = parent.layer.getFrameIndex(window.name);
		                 parent.layer.msg('提交成功', {icon: 1,offset: '40%',time:2000,shade: 0.3},function(){ 
					        parent.location.reload();
						 })
		               }else if(data == '2'){
		              	 parent.layer.msg('提交失败', {icon: 2,offset: '40%',time:2000,shade: 0.3});
		               }else{
		              	 parent.layer.msg(data, {icon: 2,offset: '40%',time:2000,shade: 0.3});
		               }
		               
			        }
			    });
					
            return false;
          });
     });
    
    
    function convertBase64UrlToBlob(urlData){
	    var bytes=window.atob(urlData.split(',')[1]);    
	    var ab = new ArrayBuffer(bytes.length);
	    var ia = new Uint8Array(ab);
	    for (var i = 0; i < bytes.length; i++) {
	        ia[i] = bytes.charCodeAt(i);
	    }
	    return new Blob( [ab] , {type : 'image/jpg'});
    }
    
        
   function previewImage(file,flag,ob){
     var img =$('#imghead'+flag);
     var oFile = file.files[0]; 
    
     if(!new RegExp("(jpg|jpeg|png)+","gi").test(oFile.type)){  
          layer.msg("图片上传：文件类型必须是JPG、JPEG、PNG", {icon: 2,offset: '40%',time:2000,shade: 0.3});
          return;  
     }
     var reader = new FileReader();  
     var tjing =  parent.layer.msg('图片加载中', {icon: 16,shade: 0.3,time: 60*1000});
     reader.onload = function(e) {  
        var base64Img= e.target.result;
        var _ir=ImageResizer({  
        resizeMode:"auto"  
        ,dataSource:base64Img  
        ,dataSourceType:"base64"  
        ,maxWidth:1200   
        ,maxHeight:1200 
        ,onTmpImgGenerate:function(img){ }   
        ,success:function(resizeImgBase64,canvas){
		parent.layer.close(tjing);
		img.attr("src",resizeImgBase64);  
	    $('#'+ob).val(resizeImgBase64.substr(22));
		
        },debug:false});            
     };  
     reader.readAsDataURL(oFile);  
   }
        
        
    </script>
  
</body>

</html>