<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black"/>
    <meta content="telephone=no" name="format-detection" />
    <style>
        body > a:first-child,body > a:first-child img{ width: 0px !important; height: 0px !important; overflow: hidden; position: absolute}
        body{padding-bottom: 0 !important;}
        .weui-navbar__item span{
            display: block;
        }
        .tt a{display: inline-block;height:20px;padding: 0 0 0 15px;}
    </style>
    <meta id="viewport" name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0">
    <title>{$school['title']}</title>
    <link rel="stylesheet" href="{MODULE_URL}public/mobile/css/weixin.css">
    <link rel="stylesheet" href="{MODULE_URL}public/mobile/css/jAlert.css">
    <link type="text/css" rel="stylesheet" href="{OSSURL}public/mobile/css/greenStyle.css?v=4.60120" />
    <link rel="stylesheet" href="{MODULE_URL}public/mobile/css/weui.min.css">
    <link rel="stylesheet" href="{MODULE_URL}template/mobile/style/css/weui.css">
    <link rel="stylesheet" href="{OSSURL}public/mobile/css/resetnew.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <script src="http://cdn.static.runoob.com/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="{OSSURL}public/mobile/js/tx.js"></script>
    <script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
    <script type="text/javascript" src="{OSSURL}public/mobile/js/PromptBoxUtil.js?v=4.80309"></script>
    <script src="{MODULE_URL}public/mobile/js/zepto.min.js"></script>
    <script type="text/javascript" src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
</head>
<body>
<div class="page" id="content">
    <div class="page__hd">
        <h1 class="page__title">用户注册</h1>
    </div>
    <div class="page__bd">
        <div class="weui-cells weui-cells_form">
            <div class="weui-cell weui-cells_form">
                <div class="weui-cell__hd">
                    <label class="weui-label">姓名</label>
                </div>
                <div class="weui-cell__bd">
                    <input class="weui-input" type="text" id="s_name" placeholder="请输入名字"/>
                </div>
            </div>
            <div class="weui-cell weui-cells_form" onclick="test()">
                <div class="weui-cell__hd">
                    <label class="weui-label">手机号</label>
                </div>
                <div class="weui-cell__bd">
                    <input class="weui-input" type="tel" id="mobile" placeholder="请输入手机号">
                </div>
            </div>
            <div class="weui-cell weui-cells_form" data-toggle="modal" data-target="#myModal">
                <div class="weui-cell__hd">
                    <label class="weui-label">小区地址</label>
                </div>
                <div class="weui-cell__bd">
                    <input id="home_address" class="weui-input" type="text" placeholder="点击选择小区位置"  disabled>
                    <input id="lng" name="lng" type="hidden" value=""/>
                    <input id="lat" name="lat" type="hidden" value=""/>
                </div>
            </div>
            <div class="weui-cell weui-cell_select weui-cell_select-after">
                <div class="weui-cell__hd">
                    <label for="" class="weui-label">用户类型</label>
                </div>
                <div class="weui-cell__bd">
                    <select class="weui-select" name="select2" id="user_type" onchange="showSex();">
                        <option value="1">家长</option>
                        <option value="2">老师</option>
                    </select>
                </div>
            </div>
            <div class="weui-cell weui-cell_select weui-cell_select-after" style="display: none;" id="selectSex">
                <div class="weui-cell__hd">
                    <label for="" class="weui-label">选择性别</label>
                </div>
                <div class="weui-cell__bd">
                    <select class="weui-select" name="select2" id="sex">
                        <option value="1">男</option>
                        <option value="2">女</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="weui-btn-area">
            <a class="weui-btn weui-btn_primary" href="javascript:bangDing()" id="showTooltips">确定</a>
        </div>
        <div class="page_bd">
            <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-body">
                            <iframe id="iframe" width="100%" frameborder=1
                                    src="http://apis.map.qq.com/tools/locpicker?search=1&type=1&key=OB4BZ-D4W3U-B7VVO-4PJWW-6TKDJ-WPB77&referer=myapp">
                            </iframe>
                            <div class="weui-btn-area">
                                <a class="weui-btn weui-btn_primary" href="javascript:" data-dismiss="modal">确定</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="page">
    <!--success-->
    <div class="weui-msg" id="success" style="display: none;">
        <div class="weui-msg__icon-area"><i class="weui-icon-success weui-icon_msg"></i></div>
        <div class="weui-msg__text-area">
            <h2 class="weui-msg__title">操作成功</h2>
            <!--<p class="weui-msg__desc">内容详情，可根据实际需要安排，如果换行则不超过规定长度，居中展现<a href="javascript:void(0);">文字链接</a></p>-->
        </div>
        <div class="weui-msg__opr-area">
            <p class="weui-btn-area">
                <a href="{php echo $this->createMobileUrl('detail', array('schoolid' => $schoolid), true)}" class="weui-btn weui-btn_primary">确定</a>
            </p>
        </div>
    </div>
    <!--fail-->
    <div class="weui-msg" id="fail" style="display: none;">
        <div class="weui-msg__icon-area"><i class="weui-icon-warn weui-icon_msg"></i></div>
        <div class="weui-msg__text-area">
            <h2 class="weui-msg__title">操作失败</h2>
            <p class="weui-msg__desc" id="fail_desc"></p>
        </div>
        <div class="weui-msg__opr-area">
            <p class="weui-btn-area">
                <a href="javascript:$('#fail').hide();$('#content').show();" class="weui-btn weui-btn_primary">确定</a>
                <!--<a href="javascript:history.back();" class="weui-btn weui-btn_default">辅助操作</a>-->
            </p>
        </div>
    </div>
</div>
<script>
    //iframe页面调用方法
    $(function(){
        adaptHeight();//动态适配高度
        window.onresize = function() { //横屏、QQ浏览器变全屏模式下的时候，需要重新计算高度
            adaptHeight();
        }
        if(window.parent.document.getElementById("iframe").height >= 500){
            window.parent.document.getElementById("iframe").height = 400;
        }
        window.addEventListener('message', function(event) {
            var loc = event.data;
            document.getElementById("lng").value=loc.latlng.lng;
            document.getElementById("lat").value=loc.latlng.lat;
            document.getElementById("home_address").value=loc.poiaddress;
        }, false);

        function adaptHeight() {
            var winH = $(window).height();
            var bodyH = document.documentElement.clientHeight;
            if (winH > bodyH) {
                window.parent.document.getElementById("iframe").height=winH;
            } else {
                window.parent.document.getElementById("iframe").height=bodyH;
            }
        }
    });
</script>
<script src="{MODULE_URL}/template/mobile/style/js/weui.js" type="text/javascript"></script>
<script type="text/javascript">
    function showSex(){
        if($("#user_type").val() == 2 && $("#selectSex").css('display') == 'none'){
            $("#selectSex").show();
        }else{
            $("#selectSex").hide();
        }
    }
    function bangDing(){
        var userType = $("#user_type").val();
        if($("#s_name").val() == null || $("#s_name").val() == ""){
            Weui.alert({"title":"","content":"姓名不能为空！"});
            return;
        }else if($("#home_address").val() == null || $("#home_address").val() == ""){
            Weui.alert({"title":"","content":"小区住址不能为空！"});
            return;
        }else if($("#mobile").val() == null || $("#mobile").val() == ""){
            Weui.alert({"title":"","content":"手机号码不能为空！"});
            return;
        }else if(!$("#mobile").val().match(/^(0|86|17951)?(13[0-9]|15[012356789]|17[0-9]|18[0-9]|14[57])[0-9]{8}$/)){
            Weui.alert({"title":"","content":"手机格式不正确！"});
            return;
        }
        if(userType == 2){
            if($("#sex").val() == null || $("#sex").val() == ""){
                Weui.alert({"title":"","content":"请选择性别！"});
                return;
            }
        }
        Weui.confirm({"title":"确认提交?","content":'',"cancelCallback":function(e){},"sureCallback":function(e){
            if(userType == 1){
                var submitData = {
                    openid :"{$openid}",
                    schoolid :"{$schoolid}",
                    weid :"{$weid}",
                    uid :"{$fan['uid']}",
                    name : $("#s_name").val(),
                    mobile : $("#mobile").val(),
                    home_address : $("#home_address").val(),
                    lng : $("#lng").val(),
                    lat : $("#lat").val(),
                };
                var url = "{php echo $this->createMobileUrl('indexajax',array('op'=>'bdxs'))}";
            }else{
                var submitData = {
                    openid :"{$openid}",
                    schoolid :"{$schoolid}",
                    weid :"{$weid}",
                    uid :"{$fan['uid']}",
                    tname : $("#s_name").val(),
                    sex:$("#sex").val(),
                    mobile:$("#mobile").val(),
                    home_address : $("#home_address").val(),
                    lng : $("#lng").val(),
                    lat : $("#lat").val(),
                };
                var url = "{php echo $this->createMobileUrl('indexajax', array('op' => 'bdls'))}";
            }
            $.post(url,submitData,function(data){
                if(data.result){
                    $("#content").hide();
                    $("#success").show();
                }else{
                    document.getElementById("fail_desc").innerHTML = data.msg;
                    $("#content").hide();
                    $("#fail").show();
                }
            },'json');
        }});
    }
</script>
</body>
</html>