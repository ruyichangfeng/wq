<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" name="viewport">
		<meta http-equiv="cache-control" content="max-age=0" />
		<meta http-equiv="cache-control" content="no-cache" />
		<meta http-equiv="expires" content="0" />
		<meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
		<meta http-equiv="pragma" content="no-cache" />
		<link rel="stylesheet" href="{D_PATH}public/css/djkj.css"/>
		<link rel="stylesheet" href="{D_PATH}public/css/tjdd.css">
		<script src="//cdn.bootcss.com/jquery/2.2.3/jquery.min.js"></script>
		<title> 购买 </title>

		<script type="text/javascript">

		</script>
	</head>

	<body id="scroll-wrapper">

		<!-- body -->

		<div id="buy-item-page" class="page">
			<div id="address-box">

				<img class="icon" src="http://assets.quanzijishi.com/assets/imgs/icon-buy-address-location-e28ee3ec80.png" />
				<div id="address-info" style="display:none">
					<p class="line-1">
						<span class="receiver">
            <b class="receiver-name"></b>
          </span>
						<span class="phone">
            <b class="phone-number"></b>
          </span>
					</p>
					<p class="line-2 address">
						<b class="text"></b></p>
				</div>
				<img class="arrow" src="http://assets.quanzijishi.com/assets/imgs/icon-arrow-enter-c207529bfe.png" />

				<p id="select-address-hint">
					添加收货地址
				</p>

				<footer class="footer-border"></footer>
			</div>

			<div id="item-box">
				<div class="cover-wrapper">
					<img class="cover" src="{$_W['attachurl']}{$imgk[0]}" />
				</div>
				<div class="info-box">
					<p class="title">{$goods['title']}</p>
				</div>
				<footer class="footer-line">
					<span class="seller">卖家: {$user['nickname']}</span>
					{if $goods['type']==1}
					<p class="price">￥{$goods['price']}</p>
					{else}
					<p class="price special-price">{$goods['sprice']}</p>
					{/if}
				</footer>
			</div>

			<p class="label">支付方式</p>
			<div id="trade-method-box">
			<?php if($goods['type']==2){$goods['onlinepay']=0;$goods['offlinepay']=1;} ?>
				{if $goods['onlinepay']}
				<div id="pay-with-wx-switch" class="cell">
					<div class="inner">
						<img class="icon" src="http://assets.quanzijishi.com/assets/imgs/icon-buy-pay-with-wx-ddee39acf2.png" />
						<span>微信支付</span>

						<div id="checkbox-pay-with-wx" class="checkbox checked">

							<img src="http://assets.quanzijishi.com/assets/imgs/checkbox-radio-default-17f04b0496.png" class="icon-default" />

							<img src="http://assets.quanzijishi.com/assets/imgs/checkbox-radio-checked-b5695a4ad5.png" class="icon-checked" />

						</div>
					</div>
				</div>
				{/if}
				{if $goods['offlinepay']}
				<div id="offline-trade-switch" class="cell">
					<div class="inner no-icon">
						<img class="icon" src="http://assets.quanzijishi.com/assets/imgs/icon-buy-offline-trade-f4939e9679.png" />
						<span>平台外支付</span>

						<div id="checkbox-offline-trade" class="checkbox">

							<img src="http://assets.quanzijishi.com/assets/imgs/checkbox-radio-default-17f04b0496.png" class="icon-default" />

							<img src="http://assets.quanzijishi.com/assets/imgs/checkbox-radio-checked-b5695a4ad5.png" class="icon-checked" />

						</div>
					</div>
				</div>
				{/if}
			</div>
			{if $goods['type']==1}
			<div id="delivery-type-cell" class="border-cell margin-cell">
				<div class="inner no-icon">
					收货方式
					<div class="switch-box">
						{if $goods['kuaidi']}
						<span id="express-switch" class="switch">
            
            
            
            
  


<div id="express-checkbox" class="checkbox">
  
    <img src="http://assets.quanzijishi.com/assets/imgs/checkbox-radio-default-17f04b0496.png" class="icon-default"/>
    
      <img src="http://assets.quanzijishi.com/assets/imgs/checkbox-radio-checked-b5695a4ad5.png" class="icon-checked"/>
    
  
</div>
            <span class="switch-label"> 快递
              <span class="maingreen">￥{$goods['kuaidifee']}</span>
						</span>
						</span>
					    {/if}
					    {if $goods['face']}
						<span id="face-to-face-switch" class="switch">
            
            
            
            
  


<div id="face-to-face-checkbox" class="checkbox">
  
    <img src="http://assets.quanzijishi.com/assets/imgs/checkbox-radio-default-17f04b0496.png" class="icon-default"/>
    
      <img src="http://assets.quanzijishi.com/assets/imgs/checkbox-radio-checked-b5695a4ad5.png" class="icon-checked"/>
    
  
</div>
            <span class="switch-label"> 当面交易 </span>
						</span>
						{/if}
					</div>
				</div>
			</div>

			<div id="total-price-cell" class="cell no-hover">
				<div class="inner no-icon">
					实付金额
					<span class="right maingreen">￥<span class="total-price"></span></span>
				</div>
			</div>
			{/if}
			<div id="remark-box" class="margin-cell border-cell">
				<div class="inner no-icon">
					留言
					<input id="remark" class="right" placeholder="选填，当面交易建议再次写上地址" />
				</div>
			</div>

			<div id="wx-account" class="border-cell">
				<div class="inner no-icon">
					微信号
					<input id="wx-id" class="right" placeholder="选填，填写以后方便卖家联系你" value="{$ziliao['weixin']}" />
				</div>
			</div>

			<p id="guarantee-line">
				采用“微信担保交易”来保障交易安全
			</p>

			<section id="verify-dialog" class="dialog">
				<div class="inner">
					<header>
						<p>验证手机号码</p>
						<button class="header-close-btn">
        <img src="http://assets.quanzijishi.com/assets/imgs/icon-dialog-close-45fbbad593.png"/>
      </button>
					</header>
					<div class="body">
						<div>
							<p class="hint">接收短息手机号<span class="phone-number">19323332333</span></p>
							<input type="text" class="verify-code input" placeholder="请输入验证码">
							<button class="resend-btn btn btn-white btn-primary">
          <span class="timeout">60秒后</span>重新发送</button>
						</div>
					</div>
					<footer>
						<button class="confirm-btn btn btn-block btn-maingreen">提交</button>
					</footer>
				</div>
			</section>
			<section id="guarantee-dialog" class="dialog notice-dialog">
				<div class="inner">
					<header>
						<img class="logo" src="http://assets.quanzijishi.com/assets/imgs/icon-guarantee-6cd950ad8d.png" />
						<span class="title">本商城采用“微信担保交易”保障交易安全</span>
					</header>
					<div class="body">
						<div class="info">
							<img class="icon" src="http://assets.quanzijishi.com/assets/imgs/icon-seller-1f53ea711c.png" />
							<span>买家点击「立即购买」付款后，资金会到本商城担保的微信账户，保证资金安全。</span>
						</div>
						<div class="info">
							<img class="icon" src="http://assets.quanzijishi.com/assets/imgs/icon-delivery-603668838f.png" />
							<span>卖家快递发货或者当面交易。</span>
						</div>
						<div class="info">
							<img class="icon" src="http://assets.quanzijishi.com/assets/imgs/icon-rmb1-72e561f727.png" />
							<span>买家验货后，点击「确认收货」或者「确认服务」，款项才会支付给卖家。</span>
						</div>
						<div class="info">
							<img class="icon" src="http://assets.quanzijishi.com/assets/imgs/icon-order-success-e540055a60.png" />
							<span>双方互给评价，交易成功。</span>
						</div>
					</div>
					<footer>
						<button class="accept-btn btn btn-maingreen btn-block singe">我知道了</button>
					</footer>
				</div>
			</section>
			<section id="offline-trade-notice-dialog" class="dialog notice-dialog">
				<div class="inner">
					<header>
						<img class="logo" src="http://assets.quanzijishi.com/assets/imgs/icon-safe-notification-white-cc88684edd.png" />
						<span class="title">平台外支付</span>
					</header>
					<div class="body">
						<p>
							若商品允许「平台外支付」，则当买家选择此支付方式时，交易流程不经平台担保， 买家确定订单后将直接获得卖家微信号，在平台外与卖家交流并进行支付。
						</p>
					</div>
					<footer>
						<button class="accept-btn btn btn-maingreen btn-block singe" onclick="$('#offline-trade-notice-dialog').hide();">我知道了</button>
					</footer>
				</div>
			</section>
		</div>

		<section id="alert-dialog" class="dialog">
			<div class="inner">
				<header class="header title"> 提示 </header>
				<div class="body">
					<p class="content"> 内容 </p>
				</div>
				<footer class="footer">
					<button class="accept-btn btn btn-maingreen btn-block single" onclick="$('#alert-dialog').hide();">确定</button>
				</footer>
			</div>
		</section>

		<section id="confirm-dialog" class="dialog confirm-dialog">
			<div class="inner">
				<header class="header"> <span class="title">确认</span>
					<button class="header-close-btn">
              <img src="http://assets.quanzijishi.com/assets/imgs/icon-dialog-close-45fbbad593.png"/>
            </button>
				</header>
				<div class="body">
					<p class="content"> 内容 </p>
				</div>
				<footer>
					<button class="cancel-btn btn btn-white btn-block">取消</button>
					<button class="accept-btn btn btn-maingreen btn-block">确定</button>
				</footer>
			</div>
		</section>

		<section id="prompt-dialog" class="dialog confirm-dialog">
			<div class="inner">
				<header class="header"> <span class="title">请输入</span>
					<button class="header-close-btn">
              <img src="http://assets.quanzijishi.com/assets/imgs/icon-dialog-close-45fbbad593.png"/>
            </button>
				</header>
				<div class="body">
					<p class="content"> 内容 </p>
					<input class="input" type="text" value="" placeholder="请输入...">
				</div>
				<footer>
					<button class="cancel-btn btn btn-white btn-block">取消</button>
					<button class="accept-btn btn btn-maingreen btn-block">确定</button>
				</footer>
			</div>
		</section>

		<div id="loading-toast" class="weui_loading_toast" style="display: none;">
			<div class="weui_mask_transparent"></div>
			<div class="weui_toast">
				<div class="weui_loading loading-mark">
					<div class="weui_loading_leaf weui_loading_leaf_0"></div>
					<div class="weui_loading_leaf weui_loading_leaf_1"></div>
					<div class="weui_loading_leaf weui_loading_leaf_2"></div>
					<div class="weui_loading_leaf weui_loading_leaf_3"></div>
					<div class="weui_loading_leaf weui_loading_leaf_4"></div>
					<div class="weui_loading_leaf weui_loading_leaf_5"></div>
					<div class="weui_loading_leaf weui_loading_leaf_6"></div>
					<div class="weui_loading_leaf weui_loading_leaf_7"></div>
					<div class="weui_loading_leaf weui_loading_leaf_8"></div>
					<div class="weui_loading_leaf weui_loading_leaf_9"></div>
					<div class="weui_loading_leaf weui_loading_leaf_10"></div>
					<div class="weui_loading_leaf weui_loading_leaf_11"></div>
				</div>
				<p class="weui_toast_content">数据加载中</p>
			</div>
		</div>

		<div id="toast" style="display: none;">
			<div class="weui_mask_transparent"></div>
			<div class="weui_toast">
				<i class="weui_icon_toast"></i>
				<p class="content weui_toast_content">已完成</p>
			</div>
		</div>

		<!-- footer -->

		<footer id="footer" class="page-footer">
			<div class="blur-mask"></div>
			<div class="right-box">

				{if $goods['type']==1}总计：<span class="maingreen">￥<span class="total-price"></span></span>{/if}

				<button id="submit-btn" class="btn btn-primary btn-maingreen">提交订单</button>
			</div>
		</footer>


	</body>
	<script src="http://res.wx.qq.com/open/js/jweixin-1.1.0.js"></script>
	<script type="text/javascript">
	if(navigator.appName == 'Microsoft Internet Explorer'){
		if(navigator.userAgent.indexOf("MSIE 5.0")>0 || navigator.userAgent.indexOf("MSIE 6.0")>0 || navigator.userAgent.indexOf("MSIE 7.0")>0) {
			alert('您使用的 IE 浏览器版本过低, 推荐使用 Chrome 浏览器或 IE8 及以上版本浏览器.');
		}
	}
	window.sysinfo = {
		{if !empty($_W['uniacid'])}'uniacid': '{$_W['uniacid']}',{/if}
		{if !empty($_W['acid'])}'acid': '{$_W['acid']}',{/if}{if !empty($_W['openid'])}'openid': '{$_W['openid']}',{/if}
		{if !empty($_W['uid'])}'uid': '{$_W['uid']}',{/if}
		'siteroot': '{$_W['siteroot']}',
		'siteurl': '{$_W['siteurl']}',
		'attachurl': '{$_W['attachurl']}',
		'attachurl_local': '{$_W['attachurl_local']}',
		'attachurl_remote': '{$_W['attachurl_remote']}',
		{if defined('MODULE_URL')}'MODULE_URL': '{MODULE_URL}',{/if}
		'cookie' : {'pre': '{$_W['config']['cookie']['pre']}'}
	};
	// jssdk config 对象
	jssdkconfig = {php echo json_encode($_W['account']['jssdkconfig']);} || {};
	// 是否启用调试
	jssdkconfig.debug = false;
	jssdkconfig.jsApiList = [
		'openAddress'
	];
	</script>

<script type="text/javascript">
$(document).ready(function(){
	$('#address-box').click(function(){
		wx.openAddress({
	        success : function(result){
	            $(".receiver-name").html(result.userName);
	            $(".phone-number").html(result.telNumber);
	            $(".line-2.address").find('b').html(result.provinceName+result.cityName+result.countryName+result.detailInfo);
	            $("#address-info").show();
	            $("#select-address-hint").hide();
	        }
	    });
	});
	$('#checkbox-offline-trade').click(function(){
		$("#checkbox-pay-with-wx").removeClass("checked");
		$("#checkbox-offline-trade").addClass("checked");
		$("#delivery-type-cell").hide();
		$("#total-price-cell").hide();
		$('#offline-trade-notice-dialog').show();
		$(".total-price").html("{$goods['price']}");
	});
	$('#checkbox-pay-with-wx').click(function(){
		$("#checkbox-offline-trade").removeClass("checked");
		$("#checkbox-pay-with-wx").addClass("checked");
		$("#delivery-type-cell").show();
		$("#total-price-cell").show();
	});  
	$('#express-checkbox').click(function(){
		$("#face-to-face-checkbox").removeClass("checked");
		$("#express-checkbox").addClass("checked");

		$(".total-price").html("{php echo $goods['price']+$goods['kuaidifee']}");
	});
	$('#face-to-face-checkbox').click(function(){
		$("#express-checkbox").removeClass("checked");
		$("#face-to-face-checkbox").addClass("checked");
		$(".total-price").html("{$goods['price']}");
	});
	$("#submit-btn").click(function(){
		var wxpay = $("#checkbox-pay-with-wx").hasClass("checked");
		var offlinepay = $("#checkbox-offline-trade").hasClass("checked");

		var wxpay = $("#checkbox-pay-with-wx").hasClass("checked");

		var kuaidi=$("#express-checkbox").hasClass("checked");
		if (kuaidi) {kuaidi=1;}else{kuaidi=0;}
		var face=$("#face-to-face-checkbox").hasClass("checked");
		if (face) {face=1;}else{face=0;}
		var liuyan=$("#remark").val();
		var weixin=$("#wx-id").val();
		var name=$(".receiver-name").html();
		var phone=$(".phone-number").html();
	    var address=$(".line-2.address").find('b').html();
	    if (name=="") {alert2("请选择收货地址");return;}
	    if (offlinepay) {
	    	offlinepay=1;
	    }else{
	    	if (wxpay) {
				wxpay=1;
				if (kuaidi || face){}else{alert2("至少选择一种收货方式");return;}
			}else{
				face=1;
			}
	    }
	    if (weixin=="") {alert2("请填写微信方便卖家联系。");return;}
	    $("#loading-toast").show();

		$.ajax({
	 			type:'POST',
	 			url:"{php echo $this->createMobileUrl('ajax',['op'=>'order'])}",
	 			data:{'offlinepay':offlinepay,'wxpay':wxpay,'kuaidi':kuaidi,'face':face,'liuyan':liuyan,'weixin':weixin,'id':{$goods['id']},'name':name,'phone':phone,'address':address},
	 			success:function(data){
	 				var json=eval('('+data+')'); 
	 				
	 				if (json.code==2) {
	 					location.href="{php echo $this->createMobileUrl('order',['op'=>'pay'])}"+"&tid="+json.msg;
	 				}else if (json.code==1){
						location.href="{php echo $this->createMobileUrl('order',['op'=>'success'])}"+"&tid="+json.msg;
	 				}
	 				
	 			},
	 		});


	});

		

		
});
         function alert2(text){
					$("#alert-dialog").find("p").html(text);
					$("#alert-dialog").show();
					return 0;
		}

</script>
{template 'common/footer'}
</html>