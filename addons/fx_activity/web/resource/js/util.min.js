(function(window) {
	util.Guid = 1;
	util.guid = function() {
		return "random_name_" + util.Guid++
	};
	util.popover = function(a, b, c) {
		var d = "mall-popover-" + util.guid();
		if (c) {
			"object" != typeof c && (c = {
				html: c
			}), c = $.extend({
				placement: "left",
				html: "",
				bodyClick: "remove"
			}, c);
			var e = $(a),
				f = e.offset(),
				g = f.left,
				h = f.top,
				i = e.outerWidth(!0),
				j = e.outerHeight(!0),
				k = '<div class="mall-popover ' + c.placement + '" id="' + d + '">	<div class="arrow"></div>' + c.html + "</div>",
				l = $(k);
			l.click(function(a) {
				void 0 != a && (a.stopPropagation ? a.stopPropagation() : a.cancelBubble = !0)
			}), $.isFunction(b) && b(l, a), $("body").append(l), "remove" == c.bodyClick && $("body").one("click", function(a) {
				void 0 != a && (a.stopPropagation ? a.stopPropagation() : a.cancelBubble = !0), l.remove()
			});
			var m = l.outerWidth(!0),
				n = l.outerHeight(!0);
			return "top" == c.placement ? l.css({
				left: g - (m - i) / 2 + "px",
				top: h - n + "px"
			}) : "bottom" == c.placement ? l.css({
				left: g - (m - i) / 2 + "px",
				top: h + j + "px"
			}) : "right" == c.placement ? l.css({
				left: g + i + "px",
				top: h + j / 2 - n / 2 + "px"
			}) : l.css({
				left: g - m + "px",
				top: h + j / 2 - n / 2 + "px"
			}), l
		}
	};
	
	util.nailConfirm = function(a, b, c) {
		$(".nail-confirm").remove(), "string" == typeof c && (c = {
			html: c
		}), c = $.extend({
			html: "确认删除?",
			placement: "left"
		}, c), c.html = "<span> " + c.html + ' </span> <a class="btn btn-primary confirm">确定</a> <a class="btn btn-default cancel">取消</a>', util.popover(a, function(a, c) {
			a.addClass("nail-confirm").find("a").one("click", function(d) {
				d.stopPropagation();
				var e = $(this).hasClass("confirm");
				$.isFunction(b) && b(e, a, c), a.hide().remove()
			})
		}, c)
	};
	
	util.decode = function(a) {
		return unescape(a.replace(/\\(u[0-9a-fA-F]{4})/gm, "%$1"))
	};
	
	util.tips = function(msg, speed) {
		speed || (speed = 1500);
		var modalobj = $("#tips-container");
		0 == modalobj.length && ($(document.body).append('<div id="tips-container" class="text-center"><span></span></div>'), modalobj = $("#tips-container"));
		var reg = /^\".*\"$/;
		msg = reg.test(msg) ? eval(msg) : util.decode(msg), modalobj.hide().find("span").html(msg), $("#tips-container").fadeIn(), $("#tips-container").fadeOut(speed)
	}, util.serialize = function(a) {
		var b = a.serializeArray(),
			c = {};
		for (i in b) {
			var d = b[i];
			c[d.name] = d.value
		}
		return c
	};
	
	util.maps = function(val, callback, tpl){
			var modalobj = $('#map-dialog');
			if(modalobj.length == 0) {
				var content =
					'<div class="embed-responsive embed-responsive-16by9">'
						+'<iframe  class="embed-responsive-item" src="'+tpl+'" scrolling="no"></iframe>'
						+'</div>';
				var footer =
					'<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>' +
					'<button type="button" class="btn btn-primary">确认</button>';
				modalobj = util.dialog('请选择地点', content, footer, {containerName : 'map-dialog'});
				modalobj.find('.modal-dialog').css('width', '80%');
				modalobj.modal({'keyboard': false});
				modalobj.find('.input-group :text').keydown(function(e){
					if(e.keyCode == 13) {
						var kw = $(this).val();
						searchAddress(kw);
					}
				});
				modalobj.find('.input-group button').click(function(){
					var kw = $(this).parent().prev().val();
					searchAddress(kw);
				});
			}
			modalobj.off('shown.bs.modal');
			modalobj.on('shown.bs.modal', function(){
				marker.setPosition(point);
				map.panTo(marker.getPosition());
			});
			
			modalobj.find('button.btn-primary').off('click');
			modalobj.find('button.btn-primary').on('click', function(){
				if($.isFunction(callback)) {
					var point = JSON.parse(modalobj.find("iframe").contents().find("#poi_json").val());
					var address = modalobj.find("iframe").contents().find("#addr_cur").val();
					
					var val = {lng: point.lng, lat: point.lat, label: address};
					callback(val);
				}
				modalobj.modal('hide');
			});
			modalobj.modal('show');

	}; // end of map
	
})(window);